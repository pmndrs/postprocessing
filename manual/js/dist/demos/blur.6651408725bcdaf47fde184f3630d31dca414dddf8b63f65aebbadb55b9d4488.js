"use strict";(()=>{var Br=Object.defineProperty;var Mr=Object.getPrototypeOf;var xr=Reflect.get;var Rr=(u,r,e)=>r in u?Br(u,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[r]=e;var g=(u=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(u,{get:(r,e)=>(typeof require!="undefined"?require:r)[e]}):u)(function(u){if(typeof require!="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+u+'" is not supported')});var n=(u,r,e)=>Rr(u,typeof r!="symbol"?r+"":r,e);var re=(u,r,e)=>xr(Mr(u),e,r);var G=(u,r,e)=>new Promise((t,i)=>{var s=f=>{try{o(e.next(f))}catch(l){i(l)}},a=f=>{try{o(e.throw(f))}catch(l){i(l)}},o=f=>f.done?t(f.value):Promise.resolve(f.value).then(s,a);o((e=e.apply(u,r)).next())});var F=g("three");var Mt=g("three");var O=class{constructor(r=0){n(this,"nextId");this.nextId=r}getNextId(){return this.nextId++}reset(r=0){return this.nextId=r,this}};var Re=class Re extends Mt.EventDispatcher{constructor(e){super();n(this,"id");n(this,"_value");n(this,"_overrideValue");n(this,"muted");n(this,"locked");this.id=Re.idManager.getNextId(),this._value=e,this._overrideValue=null,this.locked=!1,this.muted=!1}get value(){var e;return(e=this._overrideValue)!=null?e:this._value}set value(e){this._value=e,this.setChanged()}get overrideValue(){return this._overrideValue}set overrideValue(e){this._overrideValue=e,this.setChanged()}mute(){this.muted=!0}unmute(){this.muted=!1}setChanged(){if(!this.muted){if(this.locked)throw new Error("Unable to change resource value inside change event handler");this.locked=!0,this.dispatchEvent({type:"change"}),this.locked=!1}}};n(Re,"idManager",new O);var xe=Re;var k=class k extends xe{constructor(r){super(r),k.increaseReferenceCount(r)}get value(){return super.value}set value(r){let e=super.value;super.value=r,r!==e&&(k.decreaseReferenceCount(e),k.increaseReferenceCount(r),e!==null&&!k.references.has(e)&&e.dispose())}dispose(){var r;(r=this.value)==null||r.dispose()}static decreaseReferenceCount(r){var i;if(r===null)return;let e=k.references,t=(i=e.get(r))!=null?i:0;t>0&&(t===1?e.delete(r):e.set(r,t-1))}static increaseReferenceCount(r){var i;if(r===null)return;let e=k.references,t=(i=e.get(r))!=null?i:0;e.set(r,t+1)}};n(k,"references",new Map);var $=k;var _e=g("three");var xt=g("three");var R=class extends xt.EventDispatcher{constructor(e){super();n(this,"data");this.data=new Map(e)}get size(){return this.data.size}get[Symbol.toStringTag](){return this.data[Symbol.toStringTag]}clear(){this.dispatchEvent({type:"clear"});let e=this.data.clear();return this.dispatchEvent({type:"change"}),e}delete(e){return this.data.has(e)?(this.dispatchEvent({type:"delete",key:e,value:this.data.get(e)}),this.data.delete(e),this.dispatchEvent({type:"change"}),!0):!1}get(e){return this.data.get(e)}has(e){return this.data.has(e)}set(e,t){return this.data.has(e)&&this.dispatchEvent({type:"delete",key:e,value:this.data.get(e)}),this.data.set(e,t),this.dispatchEvent({type:"add",key:e,value:t}),this.dispatchEvent({type:"change"}),this}entries(){return this.data.entries()}keys(){return this.data.keys()}values(){return this.data.values()}forEach(e,t){return this.data.forEach(e,t)}[Symbol.iterator](){return this.data[Symbol.iterator]()}};var Rt=g("three");var ie=class extends Rt.EventDispatcher{constructor(e){super();n(this,"data");this.data=new Set(e)}get size(){return this.data.size}get[Symbol.toStringTag](){return this.data[Symbol.toStringTag]}[Symbol.iterator](){return this.data[Symbol.iterator]()}clear(){this.data.size!==0&&(this.dispatchEvent({type:"clear"}),this.data.clear(),this.dispatchEvent({type:"change"}))}delete(e){return this.data.has(e)?(this.dispatchEvent({type:"delete",value:e}),this.data.delete(e),this.dispatchEvent({type:"change"}),!0):!1}has(e){return this.data.has(e)}add(e){return this.data.has(e)?this:(this.data.add(e),this.dispatchEvent({type:"add",value:e}),this.dispatchEvent({type:"change"}),this)}entries(){return this.data.entries()}keys(){return this.data.keys()}values(){return this.data.values()}forEach(e,t){return this.data.forEach(e,t)}};var I=class extends ${constructor(e=null){super(e);n(this,"uniformListeners");this.uniformListeners=new WeakMap}bindUniform(e){if(!this.uniformListeners.has(e)){let t=()=>{e.value=this.value};this.uniformListeners.set(e,t),this.addEventListener("change",t)}e.value=this.value}unbindUniform(e){this.uniformListeners.has(e)&&this.removeEventListener("change",this.uniformListeners.get(e))}};var Z=class Z extends _e.EventDispatcher{constructor(){super();n(this,"defines");n(this,"uniforms");n(this,"gBuffer");n(this,"textures");n(this,"_gBufferConfig");n(this,"propagateChangeEvent");let e=new ie(["Color"]),t=new R,i=new R,s=new R,a=()=>this.setChanged();e.addEventListener("change",a),t.addEventListener("change",a),i.addEventListener("change",a),s.addEventListener("change",a),s.addEventListener("add",o=>o.value.addEventListener("change",a)),s.addEventListener("delete",o=>o.value.removeEventListener("change",a)),s.addEventListener("clear",o=>{for(let f of o.target.values())f.removeEventListener("change",a)}),this.propagateChangeEvent=a,this.defines=t,this.uniforms=i,this.textures=s,this.gBuffer=e,this._gBufferConfig=null}get gBufferConfig(){return this._gBufferConfig}set gBufferConfig(e){this._gBufferConfig!==null&&this._gBufferConfig.removeEventListener("change",this.propagateChangeEvent),e!==null&&e.addEventListener("change",this.propagateChangeEvent),this._gBufferConfig=e,this.setChanged()}get buffers(){return this.textures}get hasDefaultBuffer(){return this.textures.has(Z.BUFFER_DEFAULT)}get defaultBuffer(){var e;return(e=this.textures.get(Z.BUFFER_DEFAULT))!=null?e:null}set defaultBuffer(e){this.setBuffer(Z.BUFFER_DEFAULT,e)}get frameBufferPrecisionHigh(){var e,t;return((t=(e=this.defaultBuffer)==null?void 0:e.value)==null?void 0:t.type)!==_e.UnsignedByteType}setChanged(){this.dispatchEvent({type:"change"})}setBuffer(e,t){if(t instanceof I)this.textures.set(e,t);else{let i=this.textures.get(e);i!=null?i.value=t:this.textures.set(e,new I(t))}}getBuffer(e){var t,i;return(i=(t=this.textures.get(e))==null?void 0:t.value)!=null?i:null}removeDefaultBuffer(){return this.textures.delete(Z.BUFFER_DEFAULT)}dispose(){var e;for(let t of this.textures.values())(e=t.value)==null||e.dispose()}};n(Z,"BUFFER_DEFAULT","BUFFER_DEFAULT");var se=Z;var ge=g("three");var E=g("three");var S=g("three");var Te="out vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}";var _=class extends S.ShaderMaterial{constructor(r){super(Object.assign({name:"FullscreenMaterial",glslVersion:S.GLSL3,blending:S.NoBlending,depthWrite:!1,depthTest:!1,vertexShader:Te},r)),Object.assign(this.uniforms,{projectionMatrix:new S.Uniform(null),projectionMatrixInverse:new S.Uniform(null),viewMatrix:new S.Uniform(null),viewMatrixInverse:new S.Uniform(null),cameraParams:new S.Uniform(new S.Vector3),resolution:new S.Uniform(new S.Vector4),inputBuffer:new S.Uniform(null)}),this.outputPrecision="lowp",this.onBeforeCompile=(e,t)=>{t.getRenderTarget()===null&&this.outputPrecision!=="lowp"&&(this.outputPrecision="lowp",this.needsUpdate=!1)}}get outputPrecision(){return this.defines.OUTPUT_COLOR_PRECISION}set outputPrecision(r){this.defines.OUTPUT_COLOR_PRECISION!==r&&(this.defines.OUTPUT_COLOR_PRECISION=r,this.needsUpdate=!0)}get frameBufferPrecisionHigh(){return this.defines.FRAME_BUFFER_PRECISION_HIGH!==void 0}set frameBufferPrecisionHigh(r){this.frameBufferPrecisionHigh!==r&&(r?this.defines.FRAME_BUFFER_PRECISION_HIGH=!0:delete this.defines.FRAME_BUFFER_PRECISION_HIGH,this.needsUpdate=!0)}get inputBuffer(){return this.uniforms.inputBuffer.value}set inputBuffer(r){this.frameBufferPrecisionHigh=r!==null&&r.type!==S.UnsignedByteType,this.uniforms.inputBuffer.value=r}get near(){return this.uniforms.cameraParams.value.x}get far(){return this.uniforms.cameraParams.value.y}copyCameraSettings(r){this.uniforms.projectionMatrix.value=r.projectionMatrix,this.uniforms.projectionMatrixInverse.value=r.projectionMatrixInverse,this.uniforms.viewMatrix.value=r.matrixWorldInverse,this.uniforms.viewMatrixInverse.value=r.matrixWorld;let e=this.uniforms.cameraParams.value;e.set(r.near,r.far,e.z);let t=this.defines.PERSPECTIVE_CAMERA!==void 0;r instanceof S.PerspectiveCamera?t||(this.defines.PERSPECTIVE_CAMERA=!0,this.needsUpdate=!0):t&&(delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(r,e){this.uniforms.resolution.value.set(r,e,1/r,1/e);let i=this.uniforms.cameraParams.value;i.z=r/e}};var ne=g("three");var D=-1,V=class extends ne.EventDispatcher{constructor(e=D,t=D,i=1){super();n(this,"baseSize");n(this,"preferredSize");n(this,"effectiveSize");n(this,"_pixelRatio");n(this,"_scale");n(this,"locked");this.baseSize=new ne.Vector2(1,1),this.preferredSize=new ne.Vector2(e,t),this.effectiveSize=new ne.Vector2,this._pixelRatio=1,this._scale=i,this.locked=!1,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){let e=this.baseSize,t=this.preferredSize,i=this.effectiveSize;i.copy(e),t.width!==D?i.width=t.width:t.height!==D&&(i.width=Math.round(t.height*(e.width/Math.max(e.height,1)))),t.height!==D?i.height=t.height:t.width!==D&&(i.height=Math.round(t.width/Math.max(e.width/Math.max(e.height,1),1))),i.multiplyScalar(this.scaledPixelRatio).floor()}get width(){return this.effectiveSize.width}get height(){return this.effectiveSize.height}get aspectRatio(){return this.baseSize.width/this.baseSize.height}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio!==e&&(this._pixelRatio=e,this.setChanged())}get scale(){return this._scale}set scale(e){this._scale!==e&&(this._scale=e,this.preferredSize.setScalar(D),this.setChanged())}get scaledPixelRatio(){return this._pixelRatio*this._scale}get baseWidth(){return this.baseSize.width}set baseWidth(e){this.baseSize.width!==e&&(this.baseSize.width=e,this.setChanged())}get baseHeight(){return this.baseSize.height}set baseHeight(e){this.baseSize.height!==e&&(this.baseSize.height=e,this.setChanged())}setBaseSize(e,t){(this.baseSize.width!==e||this.baseSize.height!==t)&&(this.baseSize.set(e,t),this.setChanged())}setSize(e,t){this.setBaseSize(e,t)}copyBaseSize(e){this.baseSize.equals(e.baseSize)||(this.baseSize.copy(e.baseSize),this.setChanged())}get preferredWidth(){return this.preferredSize.width}set preferredWidth(e){this.preferredSize.width!==e&&(this.preferredSize.width=e,this.setChanged())}get preferredHeight(){return this.preferredSize.height}set preferredHeight(e){this.preferredSize.height!==e&&(this.preferredSize.height=e,this.setChanged())}setPreferredSize(e,t){(this.preferredSize.width!==e||this.preferredSize.height!==t)&&(this.preferredSize.set(e,t),this.setChanged())}copyPreferredSize(e){this.preferredSize.equals(e.preferredSize)||(this.preferredSize.copy(e.preferredSize),this.setChanged())}resetPreferredSize(){(this.preferredSize.width!==D||this.preferredSize.height!==D)&&(this.preferredSize.set(D,D),this.setChanged())}copy(e){this.equals(e)||(this.preferredSize.copy(e.preferredSize),this.baseSize.copy(e.baseSize),this._pixelRatio=e.pixelRatio,this._scale=e.scale,this.setChanged())}equals(e){return this.scale===e.scale&&this.pixelRatio===e.pixelRatio&&this.baseSize.equals(e.baseSize)&&this.preferredSize.equals(e.preferredSize)}setChanged(){if(this.locked)throw new Error("Unable to change resolution inside change event handler");this.locked=!0,this.dispatchEvent({type:"change"}),this.locked=!1}get x(){return this.width}get y(){return this.height}};n(V,"AUTO_SIZE",D);var _t=g("three");var Ce=class extends _t.EventDispatcher{constructor(e){super();n(this,"listener");this.listener=t=>this.handleSceneEvent(t),this.handleSceneEvent({type:"childadded",target:e,child:e})}handleSceneEvent(e){var t,i;switch(e.type){case"childadded":{(t=e.child)==null||t.traverse(s=>{s.addEventListener("childadded",this.listener),s.addEventListener("childremoved",this.listener)});break}case"childremoved":{(i=e.child)==null||i.traverse(s=>{s.removeEventListener("childadded",this.listener),s.removeEventListener("childremoved",this.listener)});break}}this.dispatchEvent(e)}};var ae=class{constructor(){n(this,"defines");n(this,"uniforms");this.defines=new Map,this.uniforms=new Map}applyDefines(r,e){for(let t of this.defines.keys())delete r.defines[t];for(let t of e.entries())r.defines[t[0]]=t[1];return r.needsUpdate=!0,this}trackDefines(r){this.defines.clear();for(let e of r.entries())this.defines.set(e[0],e[1]);return this}applyUniforms(r,e){for(let t of this.uniforms.keys())delete r.uniforms[t];for(let t of e.entries())r.uniforms[t[0]]=t[1];return r.uniformsNeedUpdate=!0,this}trackUniforms(r){this.uniforms.clear();for(let e of r.entries())this.uniforms.set(e[0],e[1]);return this}dispose(){this.defines.clear(),this.uniforms.clear()}};var pt=g("three");var oe=class u extends V{constructor(){super();n(this,"offset");n(this,"effectiveOffset");n(this,"_enabled");this.offset=new pt.Vector2,this.effectiveOffset=new pt.Vector2,this._enabled=!1,this.addEventListener("change",()=>this.updateEffectiveOffset())}updateEffectiveOffset(){this.effectiveOffset.copy(this.offset).multiplyScalar(this.scaledPixelRatio).floor()}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.setChanged())}get offsetX(){return this.effectiveOffset.x}get offsetY(){return this.effectiveOffset.y}setOffset(e,t){(this.offset.x!==e||this.offset.y!==t)&&(this.offset.set(e,t),this.updateEffectiveOffset(),this.setChanged())}set(e,t,i,s){i===void 0||s===void 0?super.setPreferredSize(e,t):(this.offset.set(e,t),this.updateEffectiveOffset(),super.setPreferredSize(i,s))}copy(e){e instanceof u?this.equals(e)||(this.enabled=e.enabled,this.offset.copy(e.offset),this.effectiveOffset.copy(e.effectiveOffset),super.copy(e)):super.copy(e)}equals(e){return this.enabled===e.enabled&&this.offset.equals(e.offset)&&super.equals(e)}get x(){return this.effectiveOffset.x}get y(){return this.effectiveOffset.y}get z(){return this.width}get w(){return this.height}};var ye=class extends oe{};var Pe=g("three");var L=class extends ${constructor(e=null){var t;super(e);n(this,"texture");this.texture=new I((t=this.value)==null?void 0:t.texture)}get value(){return super.value}set value(e){super.value=e,this.texture.value=e!==null?e.texture:null}mute(){super.mute(),this.texture.mute()}unmute(){super.unmute(),this.texture.unmute()}};var Y=class Y extends Pe.EventDispatcher{constructor(){super();n(this,"defines");n(this,"uniforms");n(this,"renderTargets");let e=new R,t=new R,i=new R,s=()=>this.setChanged();e.addEventListener("change",s),t.addEventListener("change",s),i.addEventListener("change",s),i.addEventListener("add",a=>a.value.addEventListener("change",s)),i.addEventListener("delete",a=>a.value.removeEventListener("change",s)),i.addEventListener("clear",a=>{for(let o of a.target.values())o.removeEventListener("change",s)}),this.defines=e,this.uniforms=t,this.renderTargets=i}get buffers(){return this.renderTargets}get hasDefaultBuffer(){return this.renderTargets.has(Y.BUFFER_DEFAULT)}get defaultBuffer(){var e;return(e=this.renderTargets.get(Y.BUFFER_DEFAULT))!=null?e:null}set defaultBuffer(e){this.setBuffer(Y.BUFFER_DEFAULT,e)}get frameBufferPrecisionHigh(){var t;let e=(t=this.defaultBuffer)==null?void 0:t.value;return e==null?!1:e.texture.type!==Pe.UnsignedByteType}setChanged(){this.dispatchEvent({type:"change"})}setBuffer(e,t){if(t instanceof L)this.renderTargets.set(e,t);else{let i=this.renderTargets.get(e);i!=null?i.value=t:this.renderTargets.set(e,new L(t))}}getBuffer(e){var t,i;return(i=(t=this.renderTargets.get(e))==null?void 0:t.value)!=null?i:null}removeDefaultBuffer(){return this.renderTargets.delete(Y.BUFFER_DEFAULT)}dispose(){var e,t,i;for(let s of this.renderTargets.values())(t=(e=s.value)==null?void 0:e.depthTexture)==null||t.dispose(),(i=s.value)==null||i.dispose()}};n(Y,"BUFFER_DEFAULT","BUFFER_DEFAULT");var we=Y;var Tt=new E.Vector2,w=class w extends E.EventDispatcher{constructor(e){super();n(this,"id");n(this,"sceneListener");n(this,"shaderDataTracker");n(this,"fullscreenScene");n(this,"fullscreenCamera");n(this,"screen");n(this,"_name");n(this,"_enabled");n(this,"_attached");n(this,"_autoSyncDefaultBuffers");n(this,"_autoSRGB");n(this,"_timer");n(this,"_renderer");n(this,"_scene");n(this,"_camera");n(this,"_subpasses");n(this,"disposables");n(this,"materials");n(this,"resolution");n(this,"viewport");n(this,"scissor");n(this,"input");n(this,"output");this.sceneListener=t=>this.handleSceneEvent(t),this.shaderDataTracker=new ae,this.fullscreenScene=null,this.fullscreenCamera=null,this.screen=null,this._name=e,this._enabled=!0,this._attached=!1,this._autoSyncDefaultBuffers=!0,this._autoSRGB=!0,this._renderer=null,this._timer=null,this._scene=null,this._camera=null,this._subpasses=[],this.id=w.idManager.getNextId(),this.disposables=new Set,this.materials=new Set,this.resolution=new V,this.viewport=new oe,this.scissor=new ye,this.resolution.addEventListener("change",t=>this.handleResolutionEvent(t)),this.viewport.addEventListener("change",t=>this.handleViewportEvent(t)),this.scissor.addEventListener("change",t=>this.handleScissorEvent(t)),this.input=new se,this.output=new we,this.input.addEventListener("change",t=>this.handleInputEvent(t)),this.output.addEventListener("change",t=>this.handleOutputEvent(t))}get name(){return this._name}set name(e){this._name=e}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.dispatchEvent({type:"toggle"}))}get attached(){return this._attached}set attached(e){this._attached!==e&&(this._attached=e,this.input.setChanged(),this.output.setChanged(),this.resolution.setChanged())}get autoSyncDefaultBuffers(){return this._autoSyncDefaultBuffers}set autoSyncDefaultBuffers(e){this._autoSyncDefaultBuffers!==e&&(this._autoSyncDefaultBuffers=e,this.syncDefaultBuffers())}get autoSRGB(){return this._autoSRGB}set autoSRGB(e){this._autoSRGB!==e&&(this._autoSRGB=e,this.syncDefaultBuffers())}get subpasses(){return this._subpasses}set subpasses(e){for(let t of this.subpasses)t.attached=!1;for(let t of e)if(t.attached)throw new Error(`${t.name} is already attached to another pass`);this._subpasses=e,Object.freeze(this._subpasses),this.initializeSubpasses()}get timer(){return this._timer}set timer(e){this._timer=e;for(let t of this.subpasses)t.timer=e}get renderer(){return this._renderer}set renderer(e){this._renderer=e;try{(e==null?void 0:e.capabilities)!==void 0&&this.checkRequirements()}catch(t){console.warn(t),console.info("Disabling pass:",this),this.enabled=!1}for(let t of this.subpasses)t.renderer=e}get scene(){return this._scene}set scene(e){if(this._scene!==e){if(this._scene!==null&&w.sceneEventTargets.has(this._scene)){let t=w.sceneEventTargets.get(this._scene);t.removeEventListener("childadded",this.sceneListener),t.removeEventListener("childremoved",this.sceneListener)}if(this._scene=e,e!==null){w.sceneEventTargets.has(e)||w.sceneEventTargets.set(e,new Ce(e));let t=w.sceneEventTargets.get(e);t.addEventListener("childadded",this.sceneListener),t.addEventListener("childremoved",this.sceneListener)}for(let t of this.subpasses)t.scene=e}}get camera(){return this._camera}set camera(e){if(this._camera!==e){this._camera=e,e!==null&&this.fullscreenMaterial instanceof _&&this.fullscreenMaterial.copyCameraSettings(e);for(let t of this.subpasses)t.camera=e}}get fullscreenMaterial(){var e;return(e=this.screen)==null?void 0:e.material}set fullscreenMaterial(e){e!==null&&(this.screen!==null?this.screen.material=e:(this.screen=new E.Mesh(w.fullscreenGeometry,e),this.screen.frustumCulled=!1,this.fullscreenScene=new E.Scene,this.fullscreenCamera=new E.OrthographicCamera(-1,1,1,-1,0,1),this.fullscreenScene.add(this.screen)),this.materials.has(e)||(this.materials.add(e),this.updateFullscreenMaterialInput(e)))}initializeSubpasses(){for(let e of this.subpasses)e.timer=this.timer,e.renderer=this.renderer,e.scene=this.scene,e.camera=this.camera,e.resolution.copy(this.resolution),e.viewport.copy(this.viewport),e.scissor.copy(this.scissor),e.attached=!0}updateSubpassResolution(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:i}=this.resolution;for(let s of this.subpasses)s.resolution.pixelRatio=i,s.resolution.setBaseSize(e,t)}updateSubpassViewport(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:i}=this.viewport;for(let s of this.subpasses)s.viewport.pixelRatio=i,s.viewport.setBaseSize(e,t)}updateSubpassScissor(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:i}=this.scissor;for(let s of this.subpasses)s.scissor.pixelRatio=i,s.scissor.setBaseSize(e,t)}updateOutputBufferSize(){var e,t;(t=(e=this.output.defaultBuffer)==null?void 0:e.value)==null||t.setSize(this.resolution.width,this.resolution.height)}updateViewportAndScissor(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:i}=this.resolution;this.viewport.pixelRatio=i,this.viewport.setBaseSize(e,t),this.scissor.pixelRatio=i,this.scissor.setBaseSize(e,t)}updateFullscreenMaterialResolution(e){e instanceof _&&e.setSize(this.resolution.width,this.resolution.height)}updateFullscreenMaterialsResolution(){for(let e of this.materials)this.updateFullscreenMaterialResolution(e)}updateFullscreenMaterialInput(e){var t,i;e instanceof E.ShaderMaterial&&(e instanceof _&&(e.inputBuffer=(i=(t=this.input.defaultBuffer)==null?void 0:t.value)!=null?i:null),this.shaderDataTracker.applyDefines(e,this.input.defines).applyUniforms(e,this.input.uniforms))}updateFullscreenMaterialsInput(){for(let e of this.materials)this.updateFullscreenMaterialInput(e);this.shaderDataTracker.trackDefines(this.input.defines).trackUniforms(this.input.uniforms)}updateFullscreenMaterialsOutput(){for(let e of this.materials)e instanceof _&&(e.outputPrecision=this.output.frameBufferPrecisionHigh?"mediump":"lowp")}syncDefaultBuffers(){var o,f,l,p;let e=this.renderer,t=(f=(o=this.input.defaultBuffer)==null?void 0:o.value)!=null?f:null,i=(p=(l=this.output.defaultBuffer)==null?void 0:l.value)!=null?p:null;if(!this.autoSyncDefaultBuffers||e===null||t===null||i===null)return;let s=i.texture;s.needsUpdate=s.format!==t.format||s.internalFormat!==t.internalFormat||s.type!==t.type,s.needsUpdate&&(s.format=t.format,s.internalFormat=t.internalFormat,s.type=t.type),this.autoSRGB&&!this.output.frameBufferPrecisionHigh&&e.outputColorSpace===E.SRGBColorSpace&&s.colorSpace!==E.SRGBColorSpace&&(s.colorSpace=E.SRGBColorSpace,s.needsUpdate=!0),s.needsUpdate&&this.output.defaultBuffer.texture.setChanged()}isConvolutionPass(e){let t=this.fullscreenMaterial;if(t instanceof _&&/texture\s*\(\s*gBuffer.color/.test(t.fragmentShader))return!0;if(e){for(let i of this.subpasses)if(i.isConvolutionPass(e))return!0}return!1}checkRequirements(){}onInputChange(){}onOutputChange(){}onResolutionChange(){}onViewportChange(){}onScissorChange(){}onSceneChildAdded(e){}onSceneChildRemoved(e){}compile(){return G(this,null,function*(){if(this.renderer===null)return;let e=new E.Group;for(let i of this.materials)e.add(new E.Mesh(w.fullscreenGeometry,i));let t=[this.renderer.compileAsync(e,this.fullscreenCamera,this.fullscreenScene)];for(let i of this.subpasses)t.push(i.compile());yield Promise.all(t)})}createFramebuffer(){let{width:e,height:t}=this.resolution;return new E.WebGLRenderTarget(e,t,{depthBuffer:!1})}setChanged(){this.dispatchEvent({type:"change"})}applyViewport(e=null){let t=this.renderer;if(t===null)return;let i=this.viewport;if(i.enabled)e!==null?e.viewport.copy(i):t.setViewport(i.x,i.y,i.z,i.w);else if(e!==null){let{width:s,height:a}=e;e.viewport.set(0,0,s,a)}else{let{width:s,height:a}=t.getSize(Tt);t.setViewport(0,0,s,a)}}applyScissor(e=null){let t=this.renderer;if(t===null)return;let i=this.scissor;if(i.enabled)e!==null?(e.scissor.copy(i),e.scissorTest=!0):(t.setScissor(i.x,i.y,i.z,i.w),t.setScissorTest(!0));else if(e!==null){let{width:s,height:a}=e;e.scissor.set(0,0,s,a),e.scissorTest=!1}else if(t.getScissorTest()){let{width:s,height:a}=t.getSize(Tt);t.setScissor(0,0,s,a),t.setScissorTest(!1)}}setRenderTarget(e=null,t,i){var s;this.applyViewport(e),this.applyScissor(e),(s=this.renderer)==null||s.setRenderTarget(e,t,i)}renderFullscreen(){this.renderer!==null&&this.fullscreenMaterial!==null&&this.renderer.render(this.fullscreenScene,this.fullscreenCamera)}handleResolutionEvent(e){this.attached&&e.type==="change"&&(this.updateFullscreenMaterialsResolution(),this.updateOutputBufferSize(),this.onResolutionChange(),this.updateSubpassResolution(),this.updateViewportAndScissor())}handleViewportEvent(e){this.attached&&e.type==="change"&&(this.onViewportChange(),this.updateSubpassViewport())}handleScissorEvent(e){this.attached&&e.type==="change"&&(this.onScissorChange(),this.updateSubpassScissor())}handleInputEvent(e){this.attached&&e.type==="change"&&(this.updateFullscreenMaterialsInput(),this.syncDefaultBuffers(),this.onInputChange())}handleOutputEvent(e){this.attached&&e.type==="change"&&(this.updateOutputBufferSize(),this.updateFullscreenMaterialsOutput(),this.syncDefaultBuffers(),this.onOutputChange())}handleSceneEvent(e){if(this.attached)switch(e.type){case"childadded":this.onSceneChildAdded(e.child);break;case"childremoved":this.onSceneChildRemoved(e.child);break}}dispose(){this.input.dispose(),this.output.dispose(),this.shaderDataTracker.dispose();for(let e of this.materials)e==null||e.dispose();for(let e of this.disposables)e.dispose();for(let e of this.subpasses)e.dispose()}};n(w,"fullscreenGeometry",(()=>{let e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new E.BufferGeometry;return t.setAttribute("position",new E.BufferAttribute(e,3)),t})()),n(w,"idManager",new O),n(w,"sceneEventTargets",new WeakMap);var T=w;var C=g("three"),_r=new Map([[C.FloatType,"highp"],[C.HalfFloatType,"mediump"],[C.UnsignedByteType,"lowp"]]),Tr=new Map([[C.RedFormat,"float"],[C.RGFormat,"vec2"],[C.RGBFormat,"vec3"],[C.RGBAFormat,"vec4"]]);function ue(u){let r=new Map;for(let e=0,t=u.textures.length;e<t;++e){let i=u.textures[e];r.set(i.name,e)}return r}function Ue(u){let r=[];for(let e=0,t=u.textures.length;e<t;++e){let i=u.textures[e],s=_r.get(i.type),a=Tr.get(i.format),o=i.name.replace(/\W*/g,"");e===0&&r.push("#ifndef gl_FragColor"),r.push(`layout(location = ${e}) out ${s} ${a} out_FragData${e};`),o!==""&&r.push(`#define out_${o} out_FragData${e}`),e===0&&(r.push(`#define gl_FragColor out_FragData${e}`),r.push("#endif"))}return r.join(`
`)}function De(u){if(u.includes("pp_normal_codec_pars_fragment")||(u=u.replace(/(void\s+main\(\)\s+{)/,`
#include <pp_normal_codec_pars_fragment>
$1`)),!u.includes("pp_gbuffer_default_output_fragment")){let r=u.includes("clipping_planes_fragment");u=u.replace(r?/(#include\s+<clipping_planes_fragment>)/:/(void\s+main\(\)\s+{)/,`$1
#include <pp_gbuffer_default_output_fragment>
`)}return u}var x=g("three");var X=g("three"),he=class extends X.ShaderMaterial{constructor(){super({name:"BackgroundMaterial",fragmentShader:X.ShaderLib.background.fragmentShader,vertexShader:X.ShaderLib.background.vertexShader,uniforms:X.UniformsUtils.clone(X.ShaderLib.background.uniforms),depthWrite:!1,depthTest:!1,fog:!1})}get map(){return this.uniforms.t2D.value}set map(r){this.uniforms.t2D.value=r}};var N=g("three"),me=class extends N.ShaderMaterial{constructor(){super({name:"SkyBoxMaterial",fragmentShader:N.ShaderLib.backgroundCube.fragmentShader,vertexShader:N.ShaderLib.backgroundCube.vertexShader,uniforms:N.UniformsUtils.clone(N.ShaderLib.backgroundCube.uniforms),side:N.BackSide,depthWrite:!1,depthTest:!1,fog:!1})}get envMap(){return this.uniforms.envMap.value}set envMap(r){this.uniforms.envMap.value=r}};var J=new x.Euler,Cr=new x.Matrix4,Fe=class extends x.Group{constructor(){super();n(this,"skyBox");n(this,"background");let e=new x.Mesh(new x.BoxGeometry(1,1,1),new me);e.name="SkyBox",e.geometry.deleteAttribute("normal"),e.geometry.deleteAttribute("uv"),e.matrixAutoUpdate=!1,e.frustumCulled=!1,e.layers.enableAll(),this.skyBox=e,e.onBeforeRender=function(i,s,a){this.matrixWorld.copyPosition(a.matrixWorld)};let t=new x.Mesh(new x.PlaneGeometry(2,2),new he);t.name="Background",t.geometry.deleteAttribute("normal"),t.matrixAutoUpdate=!1,t.frustumCulled=!1,t.layers.enableAll(),this.background=t,this.add(this.skyBox,this.background)}setClearValues(e){let t=new me,i=new he,s=new Map,a=[],o=[];for(let p of e.gBuffer){let c=typeof p[1]=="number"?"float":`vec${[...p[1]].length}`;s.set(`pp_${p[0]}`,new x.Uniform(p[1])),a.push(`uniform ${c} pp_${p[0]};`),o.push(`	#ifdef out_${p[0]}
		out_${p[0]} = pp_${p[0]};
#endif`)}let f=a.join(`
`),l=o.join(`
`);for(let p of[t,i]){p.fragmentShader=p.fragmentShader.replace(/(void main\(\) {)/,`
${f}
$1
${l}
`);for(let c of s)p.uniforms[c[0]]=c[1];p.onBeforeCompile=(c,v)=>{let d=v.getRenderTarget();if(d===null)return;let b=Ue(d);c.fragmentShader=b+`

`+c.fragmentShader}}this.skyBox.material.dispose(),this.background.material.dispose(),this.skyBox.material=t,this.background.material=i}update(e){let{skyBox:t,background:i}=this;if(t.visible=!1,i.visible=!1,!(e===null||!(e.background instanceof x.Texture)))if(e.background instanceof x.CubeTexture||e.background.mapping===x.CubeUVReflectionMapping){let s=e.background.isRenderTargetTexture?1:-1;J.copy(e.backgroundRotation),J.x*=-1,J.y*=-1,J.z*=-1,J.y*=s,J.z*=s,t.material.envMap=e.background,t.material.uniforms.flipEnvMap.value=s,t.material.uniforms.backgroundBlurriness.value=e.backgroundBlurriness,t.material.uniforms.backgroundIntensity.value=e.backgroundIntensity,t.material.uniforms.backgroundRotation.value.setFromMatrix4(Cr.makeRotationFromEuler(J)),t.visible=!0}else i.material.map=e.background,i.material.uniforms.backgroundIntensity.value=e.backgroundIntensity,i.visible=!0}dispose(){this.skyBox.material.dispose(),this.background.material.dispose()}};var Ae=class{constructor(r=!0,e=!0,t=!0){n(this,"gBuffer");n(this,"depth");n(this,"stencil");this.gBuffer=new Set(["Normal","ORM","Emission"]),this.color=r,this.depth=e,this.stencil=t}get color(){return this.gBuffer.has("Color")}set color(r){r?this.gBuffer.add("Color"):this.gBuffer.delete("Color")}};var Ct=g("three");var Ge=class extends Ct.EventDispatcher{constructor(){super();n(this,"_color");n(this,"_alpha");n(this,"gBuffer");this._color=null,this._alpha=null;let e=new R([["Normal",[0,0]],["ORM",[1,0,0,1]],["Emission",[0,0,0,1]]]);e.addEventListener("change",()=>this.setChanged()),this.gBuffer=e}get color(){return this._color}set color(e){this._color=e,this.setChanged()}get alpha(){return this._alpha}set alpha(e){this._alpha=e,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}};var yr=new ge.Color,y=new Float32Array(4),K=class u extends T{constructor(e=!0,t=!0,i=!0){super("ClearPass");n(this,"clearFlags");n(this,"clearValues");n(this,"gBufferIndices");n(this,"background");n(this,"backgroundScene");this.clearFlags=new Ae(e,t,i),this.clearValues=new Ge,this.gBufferIndices=null,this.background=new Fe,this.background.setClearValues(this.clearValues),this.clearValues.addEventListener("change",()=>this.background.setClearValues(this.clearValues)),this.backgroundScene=new ge.Scene,this.backgroundScene.add(this.background),this.disposables.add(this.background)}clearBuffers(e,t){let i=this.clearFlags,s=this.clearValues.gBuffer;for(let a of t){let o=s.get(a[0]);!i.gBuffer.has(a[0])||o===void 0||(typeof o=="number"?(y[0]=o,y[1]=0,y[2]=0,y[3]=1):(y[0]=o.length>0?o[0]:0,y[1]=o.length>1?o[1]:0,y[2]=o.length>2?o[2]:0,y[3]=o.length>3?o[3]:1),e.clearBufferfv(e.COLOR,a[1],y))}}clear(e=this.clearValues.color){var a;let t=this.renderer,i=t.getContext(),s=(a=this.clearValues.alpha)!=null?a:t.getClearAlpha();e!=null||(e=t.getClearColor(yr)),y[0]=e.r,y[1]=e.g,y[2]=e.b,y[3]=s,i.clearBufferfv(i.COLOR,0,y),this.gBufferIndices!==null&&this.gBufferIndices.size>1&&this.clearBuffers(i,this.gBufferIndices)}clearWithBackground(){let e=this.scene,t=this.camera,i=this.renderer;e.background instanceof ge.Color?this.clear(e.background):(this.background.update(e),i.render(this.backgroundScene,t))}onOutputChange(){var t,i;let e=(i=(t=this.output.defaultBuffer)==null?void 0:t.value)!=null?i:null;this.gBufferIndices=e!==null?ue(e):null}compile(){return G(this,null,function*(){this.renderer===null||this.camera===null||(yield Promise.all([re(u.prototype,this,"compile").call(this),this.renderer.compileAsync(this.backgroundScene,this.camera)]))})}render(){var s,a,o;if(this.renderer===null)return;let e=(a=(s=this.scene)==null?void 0:s.background)!=null?a:null,t=this.clearValues.color!==null,i=this.clearFlags;this.setRenderTarget((o=this.output.defaultBuffer)==null?void 0:o.value),(i.depth||i.stencil)&&this.renderer.clear(!1,i.depth,i.stencil),!t&&this.camera!==null&&e!==null?this.clearWithBackground():this.clear()}};var h=g("three");var yt=g("three");var ct=(o=>(o.COLOR="color",o.DEPTH="depth",o.NORMAL="normal",o.POSITION="position",o.ORM="orm",o.EMISSION="emission",o.LUMINANCE="luminance",o))(ct||{});var Oe=class extends yt.EventDispatcher{constructor(){super();n(this,"textureConfigs");n(this,"gBufferStructFields");n(this,"gBufferStructDeclaration");n(this,"gDataStructDeclaration");n(this,"gDataStructInitialization");n(this,"gDataDependencies");n(this,"gDataBufferSources");let e=new R,t=new R([["Color","color"],["Depth","depth"],["Normal","normal"],["ORM","orm"],["Emission","emission"]]),i=new R([["Color","FRAME_BUFFER_PRECISION sampler2D color;"],["Depth","DEPTH_BUFFER_PRECISION sampler2D depth;"],["Normal","mediump sampler2D normal;"],["ORM","lowp sampler2D orm;"],["Emission","mediump sampler2D emission;"]]),s=new R([["color","vec4 color;"],["depth","float depth;"],["normal","vec3 normal;"],["position","vec3 position;"],["orm","vec3 orm;"],["emission","vec3 emission;"],["luminance","float luminance;"]]),a=new R([["color","gData.color = texture(gBuffer.color, UV);"],["depth","gData.depth = readDepth(gBuffer.depth, UV);"],["normal","gData.normal = readNormal(gBuffer.normal, UV);"],["position","gData.position = getViewPosition(UV, gData.depth);"],["orm","gData.orm = texture(gBuffer.orm, UV).xyz;"],["emission","gData.emission = texture(gBuffer.emission, UV).rgb;"],["luminance","gData.luminance = luminance(gData.color.rgb);"]]),o=new R([["position",new Set(["depth"])],["luminance",new Set(["color"])]]),f=new R([["color",new Set(["Color"])],["depth",new Set(["Depth"])],["normal",new Set(["Normal"])],["position",new Set(["Depth"])],["orm",new Set(["ORM"])],["emission",new Set(["Emission"])],["luminance",new Set(["Color"])]]),l=()=>this.dispatchEvent({type:"change"});e.addEventListener("change",l),t.addEventListener("change",l),i.addEventListener("change",l),s.addEventListener("change",l),a.addEventListener("change",l),o.addEventListener("change",l),f.addEventListener("change",l),this.textureConfigs=e,this.gBufferStructFields=t,this.gBufferStructDeclaration=i,this.gDataStructDeclaration=s,this.gDataStructInitialization=a,this.gDataDependencies=o,this.gDataBufferSources=f}};var fe=class fe extends Set{constructor(e,t=fe.idManager.getNextId()){super();n(this,"_layer");n(this,"enabled");n(this,"exclusive");this._layer=t,(this._layer<1||this._layer>31)&&(console.warn("Layer out of range, resetting to 2"),fe.idManager.reset(2),this._layer=fe.idManager.getNextId()),this.enabled=!0,this.exclusive=!1,e!=null&&this.set(e)}get layer(){return this._layer}set layer(e){let t=this._layer;for(let i of this)i.layers.disable(t),i.layers.enable(e);this._layer=e}clear(){let e=this.layer;for(let t of this)t.layers.disable(e);super.clear()}add(e){return this.exclusive?e.layers.set(this.layer):e.layers.enable(this.layer),super.add(e)}delete(e){return this.has(e)&&e.layers.disable(this.layer),super.delete(e)}set(e){this.clear();for(let t of e)this.add(t);return this}toggle(e){let t;return this.has(e)?(this.delete(e),t=!1):(this.add(e),t=!0),t}setVisible(e){for(let t of this)e?t.layers.enable(0):t.layers.disable(0);return this}};n(fe,"idManager",new O(2));var Ie=fe;var ve=g("three");var wt=`#include <common>
#include <pp_default_output_pars_fragment>
#ifdef COLOR_WRITE
#include <dithering_pars_fragment>
#include <pp_input_buffer_pars_fragment>
#endif
#ifdef DEPTH_WRITE
#include <pp_depth_buffer_pars_fragment>
#endif
#ifdef USE_WEIGHTS
uniform vec4 channelWeights;
#endif
in vec2 vUv;void main(){
#ifdef COLOR_WRITE
vec4 texel=texture2D(inputBuffer,vUv);
#ifdef USE_WEIGHTS
texel*=channelWeights;
#endif
out_Color=texel;
#ifdef COLOR_SPACE_CONVERSION
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
#else
out_Color=vec4(0.0);
#endif
#ifdef DEPTH_WRITE
gl_FragDepth=texture(depthBuffer,vUv).r;
#endif
}`;var Le=class extends _{constructor(){super({name:"CopyMaterial",fragmentShader:wt,vertexShader:Te,defines:{COLOR_SPACE_CONVERSION:!0,COLOR_WRITE:!0},uniforms:{depthBuffer:new ve.Uniform(null),channelWeights:new ve.Uniform(null)}}),this.depthFunc=ve.AlwaysDepth}get inputBuffer(){return super.inputBuffer}set inputBuffer(r){let e=r!==null;this.colorWrite!==e&&(e?this.defines.COLOR_WRITE=!0:delete this.defines.COLOR_WRITE,this.colorWrite=e,this.needsUpdate=!0),super.inputBuffer=r}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(r){let e=r!==null;this.depthWrite!==e&&(e?this.defines.DEPTH_WRITE=!0:delete this.defines.DEPTH_WRITE,this.depthTest=e,this.depthWrite=e,this.needsUpdate=!0),this.uniforms.depthBuffer.value=r}get colorSpaceConversion(){return this.defines.COLOR_SPACE_CONVERSION!==void 0}set colorSpaceConversion(r){this.colorSpaceConversion!==r&&(r?this.defines.COLOR_SPACE_CONVERSION=!0:delete this.defines.COLOR_SPACE_CONVERSION,this.needsUpdate=!0)}get channelWeights(){return this.uniforms.channelWeights.value}set channelWeights(r){r!==null?(this.defines.USE_WEIGHTS=!0,this.uniforms.channelWeights.value=r):delete this.defines.USE_WEIGHTS,this.needsUpdate=!0}};var ze=class ze extends T{constructor(r){super("CopyPass"),this.output.defaultBuffer=r!=null?r:this.createFramebuffer(),this.fullscreenMaterial=new Le}get renderer(){return super.renderer}set renderer(r){super.renderer=r,this.initializeOutputBuffer()}initializeOutputBuffer(){var e,t;let r=(t=(e=this.output.defaultBuffer)==null?void 0:e.value)!=null?t:null;this.renderer!==null&&r!==null&&this.renderer.initRenderTarget(r)}configureDepthBuffer(){var i,s,a;let r=this.input.getBuffer("Depth"),e=(a=(s=(i=this.output.defaultBuffer)==null?void 0:i.value)==null?void 0:s.depthTexture)!=null?a:null,t=r===e;this.fullscreenMaterial.depthBuffer=r===null||t?null:r}onInputChange(){this.configureDepthBuffer()}onOutputChange(){this.configureDepthBuffer(),this.initializeOutputBuffer()}onResolutionChange(){this.initializeOutputBuffer()}blit(){var s,a,o,f;if(!ze.blitEnabled)return!1;let r=(a=(s=this.input.defaultBuffer)==null?void 0:s.value)!=null?a:null,e=(f=(o=this.output.defaultBuffer)==null?void 0:o.value)!=null?f:null;if(this.renderer===null||r===null||e===null)return!1;let t=r.source.data;if(t.width!==e.width||t.height!==e.height)return!1;r.type===e.texture.type&&r.format===e.texture.format&&this.renderer.copyTextureToTexture(r,e.texture);let i=this.input.getBuffer("Depth");return i!==null&&e.depthTexture!==null&&i!==e.depthTexture&&i.type===e.depthTexture.type&&i.format===e.depthTexture.format&&this.renderer.copyTextureToTexture(i,e.depthTexture),!0}render(){var e,t,i;let r=(t=(e=this.input.defaultBuffer)==null?void 0:e.value)!=null?t:null;this.renderer===null||r===null||this.blit()||(this.setRenderTarget((i=this.output.defaultBuffer)==null?void 0:i.value),this.renderFullscreen())}};n(ze,"blitEnabled",!1);var Ne=ze;var Pt=g("three");var ke=class{constructor(){n(this,"registeredMaterials",new WeakSet);n(this,"_enabled");n(this,"_gBuffer");this._enabled=!0,this._gBuffer=null}get enabled(){return this._enabled}set enabled(r){this._enabled=r}get gBuffer(){return this._gBuffer}set gBuffer(r){this._gBuffer=r}applyTo(r){if(this.registeredMaterials.has(r))return;this.registeredMaterials.add(r);let e=r.onBeforeCompile,t=r.customProgramCacheKey;r.onBeforeCompile=(i,s)=>{if(r.onBeforeCompile!==e&&e.call(r,i,s),!(!this.enabled||this.gBuffer===null)&&(r instanceof Pt.ShaderMaterial&&(i.fragmentShader=De(i.fragmentShader)),!i.fragmentShader.includes("out_FragData"))){let a=Ue(this.gBuffer);i.fragmentShader=a+`
`+i.fragmentShader}},r.customProgramCacheKey=()=>{var a,o;let i="";r.customProgramCacheKey!==t&&(i+=t.call(r));let s=(o=(a=this.gBuffer)==null?void 0:a.texture.uuid)!=null?o:"";return i+this.enabled+s}}};var q=class u extends T{constructor(e,t,{alpha:i=!1,stencilBuffer:s=!1,depthBuffer:a=!0,frameBufferType:o=h.HalfFloatType,samples:f=0,gBufferConfig:l=new Oe}={}){super("GeometryPass");n(this,"selection");n(this,"copyPass");n(this,"gBufferShaderPlugin");n(this,"gBufferResource");n(this,"gBufferComponents");n(this,"alpha");n(this,"stencilBuffer");n(this,"depthBuffer");n(this,"frameBufferType");n(this,"gBufferConfig");n(this,"_samples");this.alpha=i,this.stencilBuffer=s,this.depthBuffer=a,this.frameBufferType=o,this._samples=f,this.selection=new Ie,this.selection.enabled=!1,this.gBufferConfig=l,this.copyPass=new Ne,this.copyPass.enabled=!1,this.subpasses=[this.copyPass];let p=new ie;p.addEventListener("change",()=>this.updateGBuffer()),this.gBufferComponents=p,this.gBufferShaderPlugin=new ke,this.gBufferResource=new L,this.output.defaultBuffer=this.gBufferResource,this.scene=e,this.camera=t,this.updateTextureConfigs()}get enabled(){return super.enabled}set enabled(e){super.enabled!==e&&(super.enabled=e,this.gBufferShaderPlugin.enabled=e,this.invalidateMaterials())}get scene(){return super.scene}set scene(e){super.scene=e,e!==null&&this.onSceneChildAdded(e)}get samples(){return this._samples}set samples(e){var i,s;this._samples=e;let t=(s=(i=this.output.defaultBuffer)==null?void 0:i.value)!=null?s:null;t!==null&&t.samples!==e&&(t.samples=e,t.dispose())}get gBuffer(){return this.gBufferResource.value}get frameBufferPrecisionHigh(){return this.frameBufferType===h.HalfFloatType||this.frameBufferType===h.FloatType}get textureConfigs(){return Array.from(this.gBufferConfig.textureConfigs).filter(e=>this.gBufferComponents.has(e[0]))}get renderer(){return super.renderer}set renderer(e){super.renderer=e,this.updateOutputBufferColorSpace()}invalidateMaterial(e){if(!("material"in e))return;let t=Array.isArray(e.material)?e.material:[e.material];for(let i of t)i.needsUpdate=!0}invalidateMaterials(){var e;(e=this.scene)==null||e.traverse(t=>this.invalidateMaterial(t))}updateTextureConfigs(){let e=this.gBufferConfig.textureConfigs,t=this.frameBufferPrecisionHigh&&!this.alpha;e.set("Color",{minFilter:h.LinearFilter,magFilter:h.LinearFilter,type:this.frameBufferType,format:t?h.RGBFormat:h.RGBAFormat,internalFormat:t?"R11F_G11F_B10F":void 0,isColorBuffer:!0}),e.set("Normal",{minFilter:h.NearestFilter,magFilter:h.NearestFilter,type:h.HalfFloatType,format:h.RGFormat}),e.set("ORM",{minFilter:h.NearestFilter,magFilter:h.NearestFilter,type:h.UnsignedByteType,format:h.RGBAFormat}),e.set("Emission",{minFilter:h.LinearFilter,magFilter:h.LinearFilter,type:h.HalfFloatType,format:h.RGBAFormat}),this.updateGBuffer()}updateMaterial(e){if(!("material"in e))return;let t=Array.isArray(e.material)?e.material:[e.material];for(let i of t)this.gBufferShaderPlugin.applyTo(i)}updateOutputBufferColorSpace(){let e=this.gBuffer,t=this.renderer;if(e===null||t===null)return;let i=ue(e),s=this.autoSRGB&&!this.frameBufferPrecisionHigh&&t.outputColorSpace===h.SRGBColorSpace;for(let a of this.textureConfigs)if(a[1].isColorBuffer===!0&&i.has(a[0])){let o=i.get(a[0]),f=e.textures[o];f.colorSpace=s?h.SRGBColorSpace:h.NoColorSpace,f.needsUpdate=!0}}updateGBuffer(){var f,l,p;let e=this.output,t=this.gBufferComponents;if(!e.hasDefaultBuffer)e.defaultBuffer=this.gBufferResource;else if(e.defaultBuffer!==this.gBufferResource)return;if((l=(f=e.defaultBuffer.value)==null?void 0:f.depthTexture)==null||l.dispose(),(p=e.defaultBuffer.value)==null||p.dispose(),t.size===0){e.defaultBuffer=null,e.defines.clear();return}let{width:i,height:s}=this.resolution,a=this.textureConfigs,o=new h.WebGLRenderTarget(i,s,{stencilBuffer:this.stencilBuffer,depthBuffer:this.depthBuffer,samples:this.samples,count:a.length});for(let c=0,v=a.length;c<v;++c){let d=a[c],b=o.textures[c],P=d[1];b.name=d[0],b.minFilter=P.minFilter,b.magFilter=P.magFilter,b.format=P.format,b.type=P.type,P.internalFormat!==void 0&&(b.internalFormat=P.internalFormat)}e.defaultBuffer=o,this.configureDepthTexture(),this.updateOutputBufferColorSpace()}configureDepthTexture(){var s,a,o,f,l;let e=this.output;if(e.defaultBuffer!==this.gBufferResource)return;let t=(a=(s=e.defaultBuffer)==null?void 0:s.value)!=null?a:null;if(t===null)return;if(!this.gBufferComponents.has("Depth")){(o=t.depthTexture)==null||o.dispose(),t.depthTexture=null;return}let i=this.input.getBuffer("Depth");if(i!==null)t.depthTexture!==i&&((f=t.depthTexture)==null||f.dispose(),t.depthTexture=i);else{let p=new h.DepthTexture(1,1);p.name="Depth",p.format=this.stencilBuffer?h.DepthStencilFormat:h.DepthFormat,p.type=this.stencilBuffer?h.UnsignedInt248Type:h.FloatType,(l=t.depthTexture)==null||l.dispose(),t.depthTexture=p}}updateCopyPass(){var a,o,f,l,p;let e=(o=(a=this.input.defaultBuffer)==null?void 0:a.value)!=null?o:null,t=(l=(f=this.output.defaultBuffer)==null?void 0:f.value)!=null?l:null,i=e===(t==null?void 0:t.texture),s=((p=t==null?void 0:t.textures.length)!=null?p:0)>1;this.copyPass.enabled=e!==null&&!i&&!s}onInputChange(){this.configureDepthTexture();let e=this.copyPass;e.input.defaultBuffer=this.input.defaultBuffer,this.updateCopyPass(),this.input.buffers.has("Depth")?e.input.buffers.set("Depth",this.input.buffers.get("Depth")):e.input.buffers.delete("Depth")}onOutputChange(){var e,t;this.output.hasDefaultBuffer?this.configureDepthTexture():(this.gBufferResource.mute(),this.updateGBuffer(),this.gBufferResource.unmute()),this.gBufferShaderPlugin.gBuffer=(t=(e=this.output.defaultBuffer)==null?void 0:e.value)!=null?t:null,this.copyPass.output.defaultBuffer=this.output.defaultBuffer,this.updateCopyPass()}onResolutionChange(){this.copyPass.resolution.copy(this.resolution)}onSceneChildAdded(e){e.traverse(t=>this.updateMaterial(t))}compile(){return G(this,null,function*(){if(this.renderer===null||this.scene===null||this.camera===null)return;let e=[];e.push(re(u.prototype,this,"compile").call(this)),e.push(this.renderer.compileAsync(this.scene,this.camera)),yield Promise.all(e)})}render(){var o;let{renderer:e,scene:t,camera:i}=this;if(e===null||t===null||i===null)return;let s=i.layers.mask,a=t.background;t.background=null,this.selection.enabled&&i.layers.set(this.selection.layer),this.copyPass.enabled&&this.copyPass.render(),this.setRenderTarget((o=this.output.defaultBuffer)==null?void 0:o.value),e.render(t,i),i.layers.mask=s,t.background=a}};function Ut(u,r){for(let e of u.input.buffers.values())r.add(e);for(let e of u.output.buffers.values())r.add(e);for(let e of u.subpasses)Ut(e,r)}var Ve=class{constructor(r){n(this,"pipelines");n(this,"activeResources");this.pipelines=r,this.activeResources=new Set}gatherResources(){let r=new Set;for(let e of this.pipelines)for(let t of e.passes)Ut(t,r);return r}optimize(){let r=this.gatherResources();for(let e of this.activeResources)e instanceof $&&!r.has(e)&&e.dispose();this.activeResources=r}};var He=class u{constructor(){n(this,"pipelines");n(this,"resourceManager");n(this,"outputDefaultBuffers");n(this,"updating");this.pipelines=new Set,this.resourceManager=new Ve(this.pipelines),this.outputDefaultBuffers=new WeakMap,this.updating=!1}updateInput(r){let e=u.findMainGeometryPass(r),t=r.passes.filter(s=>s.enabled);for(let s=0,a=1,o=t.length;s<o;++s,++a){let f=t[s];if(f!==e){if(a<o&&f instanceof K){let l=t[a];f.scene=l.scene,f.camera=l.camera}else!(f instanceof q)&&e!==void 0&&(f.scene=e.scene,f.camera=e.camera);u.assignGBufferTextures(f,e)}}let i;for(let s=0,a=1,o=t.length;a<o;++s,++a){let f=t[s],l=t[a];!(f instanceof K)&&f.output.hasDefaultBuffer&&f.output.defaultBuffer.value!==null&&(i=f.output.defaultBuffer),f.output.defines.forEach((p,c)=>l.input.defines.set(c,p)),f.output.uniforms.forEach((p,c)=>l.input.uniforms.set(c,p)),i===void 0?l.input.buffers.delete(se.BUFFER_DEFAULT):i!==void 0&&(l.input.defaultBuffer=i.texture)}}restoreOutputBuffers(r){let e=this.outputDefaultBuffers;for(let t of r)if(t.output.defaultBuffer!==null&&e.has(t.output.defaultBuffer)){let i=e.get(t.output.defaultBuffer);e.delete(t.output.defaultBuffer),t.output.defaultBuffer=i}}updateOutput(r){let e=r.passes.filter(t=>t.enabled);if(r.autoRenderToScreen&&e.length>0){this.restoreOutputBuffers(e);let t=this.outputDefaultBuffers,i=e[e.length-1];i.output.defaultBuffer!==null&&(t.set(i.output.defaultBuffer,i.output.defaultBuffer.value),i.output.defaultBuffer=null)}for(let t=0,i=1,s=e.length;i<s;++t,++i){let a=e[t];if(a instanceof K){let o=e[i];o.output.defines.forEach((f,l)=>a.output.defines.set(l,f)),o.output.uniforms.forEach((f,l)=>a.output.uniforms.set(l,f)),a.output.defaultBuffer=o.output.defaultBuffer}}}addPipeline(r){this.pipelines.add(r)}removePipeline(r){this.pipelines.delete(r)}updatePipeline(r){u.gatherGBufferComponents(r),this.updateOutput(r),this.updateInput(r)}update(){if(!this.updating){this.updating=!0;for(let r of this.pipelines)this.updatePipeline(r);this.resourceManager.optimize(),this.updating=!1}}static findMainGeometryPass(r){return r.passes.find(e=>e.enabled&&e instanceof q)}static gatherGBufferComponents(r){let e=u.findMainGeometryPass(r);if(e===void 0)return;e.gBufferComponents.clear();for(let i of r.passes.filter(s=>s.enabled))for(let s of i.input.gBuffer)e.gBufferComponents.add(s);let t=r.passes.filter(i=>i.enabled&&i instanceof q);if(!(t.length<=1||!e.gBufferComponents.has("Color")))for(let i=1,s=t.length;i<s;++i){let a=t[i];a.gBufferComponents.add("Color"),a.depthBuffer&&(a.gBufferComponents.add("Depth"),a.input.gBuffer.add("Depth"),e.gBufferComponents.add("Depth"))}}static assignGBufferTextures(r,e){if(e===void 0||e.gBuffer===null)return;r.input.gBufferConfig=e.gBufferConfig;let t=ue(e.gBuffer);for(let i of r.input.gBuffer)if(i==="Depth")r.input.buffers.set(i,new I(e.gBuffer.depthTexture));else if(t.has(i)){let s=t.get(i);r.input.buffers.set(i,new I(e.gBuffer.textures[s]))}}};var ee=g("three");var B=g("three");var Dt=`uniform mat4 projectionMatrix;uniform mat4 projectionMatrixInverse;uniform vec3 cameraParams;
#define CAMERA_NEAR cameraParams.x
#define CAMERA_FAR cameraParams.y
#define CAMERA_ASPECT cameraParams.z
#ifdef PERSPECTIVE_CAMERA
#define getViewZ(depth) perspectiveDepthToViewZ(depth, CAMERA_NEAR, CAMERA_FAR)
#else
#define getViewZ(depth) orthographicDepthToViewZ(depth, CAMERA_NEAR, CAMERA_FAR)
#endif
vec3 getViewPosition(const in vec2 screenPosition,const in float depth,const in float viewZ){vec4 clipPosition=vec4(vec3(screenPosition,depth)*2.0-1.0,1.0);float clipW=projectionMatrix[2][3]*viewZ+projectionMatrix[3][3];clipPosition*=clipW;return(projectionMatrixInverse*clipPosition).xyz;}vec3 getViewPosition(const in vec2 screenPosition,const in float depth){return getViewPosition(screenPosition,depth,getViewZ(depth));}`;var Ft="vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}";var At=`#ifndef gl_FragColor
layout(location=0)out OUTPUT_COLOR_PRECISION vec4 out_FragData0;
#define gl_FragColor out_FragData0
#ifndef out_Color
#define out_Color out_FragData0
#endif
#endif`;var Gt=`#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif`;var Ot=`#ifdef GL_FRAGMENT_PRECISION_HIGH
#define DEPTH_BUFFER_PRECISION highp
#else
#define DEPTH_BUFFER_PRECISION mediump
#endif`;var It=`float readDepth(sampler2D depthBuffer,const in vec2 uv,const in float near,const in float far){float depth=texture(depthBuffer,uv).r;
#ifdef USE_REVERSEDEPTHBUF
return 1.0-depth;
#else
#ifdef USE_LOGDEPTHBUF
float d=pow(2.0,depth*log2(far+1.0))-1.0;float a=far/(far-near);float b=far*near/(near-far);depth=a+b/d;
#endif
return depth;
#endif
}
#if defined(CAMERA_NEAR) && defined(CAMERA_FAR)
#define readDepth(depthBuffer, uv) readDepth(depthBuffer, uv, CAMERA_NEAR, CAMERA_FAR);
#endif`;var Lt=`#ifdef FRAME_BUFFER_PRECISION_HIGH
#define FRAME_BUFFER_PRECISION mediump
#else
#define FRAME_BUFFER_PRECISION lowp
#endif`;var Nt=`#ifdef out_Color
out_Color=vec4(0.0);
#endif
#ifdef out_Emission
out_Emission=vec4(0.0);
#endif
#ifdef out_ORM
out_ORM=vec4(0.0);
#endif
#ifdef out_Normal
out_Normal=vec2(0.0);
#endif`;var zt=`#ifdef FRAME_BUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif`;var kt="uint uhash(uint x){x+=x>>11;x ^=x<<7;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}uint uhash(uvec2 p){uint x=p.x;x+=x>>11;x ^=x<<7;x+=p.y;x ^=x<<6;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}uint uhash(uvec3 p){uint x=p.x;x+=x>>11;x ^=x<<7;x+=p.y;x ^=x<<3;x+=p.z ^(x>>14);x ^=x<<6;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}float urand(uint h){const uint mantissaMask=0x007FFFFFu;const uint one=0x3F800000u;h&=mantissaMask;h|=one;float r2=uintBitsToFloat(h);return r2-1.0;}float urand(float p){return urand(uhash(floatBitsToUint(p)));}float urand(vec2 p){return urand(uhash(floatBitsToUint(p)));}float urand(vec3 p){return urand(uhash(floatBitsToUint(p)));}";var Vt="vec2 pp_encodeNormal(vec3 n){n/=(abs(n.x)+abs(n.y)+abs(n.z));n.xy=(n.z>=0.0)?n.xy:(1.0-abs(n.yx))*vec2(n.x>=0.0?1.0:-1.0,n.y>=0.0?1.0:-1.0);return n.xy;}vec3 pp_decodeNormal(vec2 f){vec3 n=vec3(f.x,f.y,1.0-abs(f.x)-abs(f.y));float t=clamp(-n.z,0.0,1.0);n.xy+=vec2(n.x>=0.0?-t:t,n.y>=0.0?-t:t);return normalize(n);}";var Ht="vec3 readNormal(mediump sampler2D normalBuffer,const in vec2 uv){return pp_decodeNormal(texture(normalBuffer,uv).xy);}";var Wt="uniform vec4 resolution;";var jt=`uniform mat4 viewMatrixInverse;
#define getWorldPosition(viewPosition) (viewMatrixInverse * vec4(viewPosition, 1.0)).xyz
#define getDistance(viewPosition) length(viewPosition)`;var dt=`#ifdef out_Normal
out_Normal.xy=pp_encodeNormal(normal);
#endif`;var ht=`#ifdef out_ORM
#ifdef USE_AOMAP
out_ORM.x=ambientOcclusion;
#else
out_ORM.x=1.0;
#endif
#endif`;var mt=`#ifdef out_ORM
out_ORM.y=roughnessFactor;
#endif`;var $t=`#ifdef out_ORM
out_ORM.y=material.roughness;
#endif`;var gt=`#ifdef out_ORM
out_ORM.z=metalnessFactor;
#endif`;var vt=`#ifdef out_Emission
out_Emission=vec4(totalEmissiveRadiance,1.0);
#endif`;var be=class be{static register(){if(be.registered)return;be.registered=!0,Object.assign(B.ShaderChunk,{pp_camera_pars_fragment:Dt,pp_colorspace_conversion_pars_fragment:Ft,pp_default_output_pars_fragment:At,pp_depth_buffer_pars_fragment:Gt,pp_depth_buffer_precision_pars_fragment:Ot,pp_depth_utils_pars_fragment:It,pp_frame_buffer_precision_pars_fragment:Lt,pp_gbuffer_default_output_fragment:Nt,pp_gbuffer_normal_fragment:dt,pp_gbuffer_occlusion_fragment:ht,pp_gbuffer_roughness_fragment:mt,pp_gbuffer_metalness_fragment:gt,pp_gbuffer_emission_fragment:vt,pp_input_buffer_pars_fragment:zt,pp_normal_codec_pars_fragment:Vt,pp_noise_pars_fragment:kt,pp_normal_utils_pars_fragment:Ht,pp_resolution_pars_fragment:Wt,pp_world_utils_pars_fragment:jt}),B.ShaderChunk.normal_fragment_maps+=`
`+dt,B.ShaderChunk.aomap_fragment+=`
`+ht,B.ShaderChunk.roughnessmap_fragment+=`
`+mt,B.ShaderChunk.lights_physical_fragment+=`
`+$t,B.ShaderChunk.metalnessmap_fragment+=`
`+gt,B.ShaderChunk.emissivemap_fragment+=`
`+vt;let r=[B.ShaderLib.background,B.ShaderLib.backgroundCube,B.ShaderLib.basic,B.ShaderLib.cube,B.ShaderLib.dashed,B.ShaderLib.lambert,B.ShaderLib.matcap,B.ShaderLib.phong,B.ShaderLib.physical,B.ShaderLib.points,B.ShaderLib.sprite,B.ShaderLib.standard,B.ShaderLib.toon];for(let e of r)e.fragmentShader=De(e.fragmentShader)}};n(be,"registered",!1);var We=be;var wr=new ee.Vector2,M=class M{constructor(r=null){n(this,"_timer");n(this,"_passes");n(this,"_renderer");n(this,"_autoRenderToScreen");n(this,"resolution");n(this,"updateStyle");We.register(),M.ioManager.addPipeline(this),this._timer=new ee.Timer,this._passes=[],this._renderer=null,this._autoRenderToScreen=!0,this.resolution=new V,this.resolution.addEventListener("change",()=>this.onResolutionChange()),this.updateStyle=!0,this.renderer=r}get autoRenderToScreen(){return this._autoRenderToScreen}set autoRenderToScreen(r){this.autoRenderToScreen!==r&&(this._autoRenderToScreen=r,M.ioManager.update())}get renderer(){return this._renderer}set renderer(r){this._renderer=r;for(let e of this.passes)e.renderer=r;r!==null&&(r.autoClear=!1,this.setPixelRatio(r.getPixelRatio()),this.passes.length>0&&M.ioManager.update())}get timer(){return this._timer}get passes(){return this._passes}registerPass(r){M.registeredPasses.add(r),r.resolution.pixelRatio=this.resolution.scaledPixelRatio,r.resolution.copyBaseSize(this.resolution),r.renderer=this.renderer,r.timer=this.timer,r.attached=!0,r.addEventListener("toggle",M.listener),r.input.addEventListener("change",M.listener),r.output.addEventListener("change",M.listener)}unregisterPass(r){M.registeredPasses.delete(r),r.renderer=null,r.timer=null,r.attached=!1,r.removeEventListener("toggle",M.listener),r.input.removeEventListener("change",M.listener),r.output.removeEventListener("change",M.listener)}add(...r){for(let e of r){if(M.registeredPasses.has(e))throw new Error(`The pass "${e.name}" has already been added to a pipeline`);this.registerPass(e),this._passes.push(e)}M.ioManager.update()}remove(...r){let e=!1;for(let t of r){let i=this._passes,s=i.indexOf(t);s!==-1&&i.splice(s,1).length>0&&(this.unregisterPass(t),e=!0)}e&&M.ioManager.update()}removeAllPasses(){for(let r of this.passes)this.unregisterPass(r);this._passes=[],M.ioManager.update()}onResolutionChange(){let r=this.renderer;if(r===null){console.debug("Unable to update the render size because the renderer is null");return}let{baseWidth:e,baseHeight:t,pixelRatio:i,scaledPixelRatio:s,scale:a}=this.resolution,o=r.getSize(wr);if(r.getPixelRatio()!==i&&r.setPixelRatio(i),a===1)(o.width!==e||o.height!==t)&&r.setSize(e,t,this.updateStyle);else{let f=e*a,l=t*a;(o.width!==f||o.height!==l)&&(this.updateStyle&&r.setSize(e,t,!0),r.setSize(f,l,!1))}for(let f of this.passes)f.resolution.pixelRatio=s,f.resolution.setBaseSize(e,t)}setPixelRatio(r){let e=this.updateStyle;this.updateStyle=!1,this.resolution.pixelRatio=r,this.updateStyle=e}setSize(r,e,t=!0){this.renderer!==null&&this.setPixelRatio(this.renderer.getPixelRatio());let i=this.updateStyle;this.updateStyle=t,this.resolution.setSize(r,e),this.updateStyle=i}setViewport(r,e=0,t=0,i=0){if(r instanceof ee.Vector4){let s=r;r=s.x,e=s.y,t=s.z,i=s.w}for(let s of this.passes)s.viewport.set(r,e,t,i)}setScissor(r,e=0,t=0,i=0){if(r instanceof ee.Vector4){let s=r;r=s.x,e=s.y,t=s.z,i=s.w}for(let s of this.passes)s.scissor.set(r,e,t,i)}compile(){return G(this,null,function*(){let r=[];for(let e of this.passes)r.push(e.compile());yield Promise.all(r)})}render(r){if(this.renderer===null)return;this._timer.update(r);let e=this.renderer,t=e.info.autoReset;t&&(e.info.reset(),e.info.autoReset=!1);for(let i of this.passes)i.enabled&&i.render();e.info.autoReset=t}dispose(){M.ioManager.removePipeline(this);for(let r of this.passes)r.dispose();this.removeAllPasses(),this._timer.dispose(),T.fullscreenGeometry.dispose()}};n(M,"ioManager",new He),n(M,"registeredPasses",new WeakSet),n(M,"listener",()=>M.ioManager.update());var je=M;var Xe=class Xe{constructor(r,e,t=!1){n(this,"id");n(this,"name");n(this,"shader");n(this,"supportsHDR");this.id=Xe.idManager.getNextId(),this.name=r,this.shader=e,this.supportsHDR=t}};n(Xe,"idManager",new O);var $e=Xe;var qe=g("three");var Ke=class extends qe.EventDispatcher{constructor(e,t=1){super();n(this,"_blendFunction");n(this,"opacityUniform");this._blendFunction=e,this.opacityUniform=new qe.Uniform(t)}get opacity(){return this.opacityUniform.value}set opacity(e){this.opacityUniform.value=e}get blendFunction(){return this._blendFunction}set blendFunction(e){this._blendFunction=e,this.dispatchEvent({type:"change"})}};var Xt="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return src;}";var Qe=class extends $e{constructor(){super("src",Xt,!0)}};var bt=g("three");var le=class extends T{constructor(e){super(e);n(this,"blendMode");n(this,"_fragmentShader");n(this,"_vertexShader");n(this,"_inputColorSpace");n(this,"_outputColorSpace");n(this,"gData");n(this,"optional");this.blendMode=new Ke(new Qe),this.blendMode.addEventListener("change",()=>this.setChanged()),this.input.addEventListener("change",()=>this.detectGDataUsage()),this._fragmentShader=null,this._vertexShader=null,this._inputColorSpace=bt.NoColorSpace,this._outputColorSpace=bt.NoColorSpace,this.gData=new Set,this.optional=!1}get enabled(){return super.enabled}set enabled(e){super.enabled!==e&&(this.optional=!0),super.enabled=e}get fragmentShader(){return this._fragmentShader}set fragmentShader(e){this._fragmentShader=e,this.detectGDataUsage(),this.setChanged()}get vertexShader(){return this._vertexShader}set vertexShader(e){this._vertexShader=e,this.setChanged()}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(e){this._inputColorSpace=e,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e,this.setChanged()}get hasMainImageFunction(){return this.fragmentShader===null?!1:/vec4\s+mainImage\s*\([a-z\s]*vec4\s+\w+,[a-z\s]*vec2\s+\w+,[a-z\s]*GData\s+\w+\)/.test(this.fragmentShader)}get hasMainUvFunction(){return this.fragmentShader===null?!1:/void\s+mainUv\s*\(\s*inout\s+vec2\s+\w+\)/.test(this.fragmentShader)}get hasMainSupportFunction(){return this.vertexShader===null?!1:/void\s+mainSupport\s*\([a-z\s]*vec2\s+\w+\)/.test(this.vertexShader)}detectGDataUsage(){var s,a;if(this.gData.clear(),this.input.gBufferConfig===null||!this.hasMainImageFunction)return;let e=this.fragmentShader,t=this.input.gBufferConfig,i=/GData\s+(\w+)/.exec(e)[1];for(let o of Object.values(ct))if(e.includes(`${i}.${o}`)){for(let f of(s=t.gDataDependencies.get(o))!=null?s:[])this.gData.add(f);this.gData.add(o)}for(let o of this.gData)for(let f of(a=t.gDataBufferSources.get(o))!=null?a:[])this.input.gBuffer.has(f)||(this.input.gBuffer.add(f),console.warn(`${this.name} uses ${o} but does not declare input G-Buffer component ${f}`))}validate(){if(this.fragmentShader===null)throw new Error(`Missing fragment shader (${this.name})`);if(!this.hasMainImageFunction&&!this.hasMainUvFunction)throw new Error(`Could not find a valid mainImage or mainUv function (${this.name})`)}render(){}};var Kt=`#include <pp_default_output_pars_fragment>
#include <pp_input_buffer_pars_fragment>
#define WEIGHT_INNER 0.125
#define WEIGHT_OUTER 0.05556
in vec2 vUv;in vec2 vUv00,vUv01,vUv02,vUv03;in vec2 vUv04,vUv05,vUv06,vUv07;in vec2 vUv08,vUv09,vUv10,vUv11;float clampToBorder(const in vec2 uv){
#ifdef CLAMP_TO_BORDER
return float(uv.s>=0.0&&uv.s<=1.0&&uv.t>=0.0&&uv.t<=1.0);
#else
return 1.0;
#endif
}void main(){vec4 c=vec4(0.0);vec4 w=WEIGHT_INNER*vec4(clampToBorder(vUv00),clampToBorder(vUv01),clampToBorder(vUv02),clampToBorder(vUv03));c+=w.x*texture(inputBuffer,vUv00);c+=w.y*texture(inputBuffer,vUv01);c+=w.z*texture(inputBuffer,vUv02);c+=w.w*texture(inputBuffer,vUv03);w=WEIGHT_OUTER*vec4(clampToBorder(vUv04),clampToBorder(vUv05),clampToBorder(vUv06),clampToBorder(vUv07));c+=w.x*texture(inputBuffer,vUv04);c+=w.y*texture(inputBuffer,vUv05);c+=w.z*texture(inputBuffer,vUv06);c+=w.w*texture(inputBuffer,vUv07);w=WEIGHT_OUTER*vec4(clampToBorder(vUv08),clampToBorder(vUv09),clampToBorder(vUv10),clampToBorder(vUv11));c+=w.x*texture(inputBuffer,vUv08);c+=w.y*texture(inputBuffer,vUv09);c+=w.z*texture(inputBuffer,vUv10);c+=w.w*texture(inputBuffer,vUv11);c+=WEIGHT_OUTER*texture(inputBuffer,vUv);out_Color=c;}`;var qt=`#include <pp_resolution_pars_fragment>
out vec2 vUv;out vec2 vUv00,vUv01,vUv02,vUv03;out vec2 vUv04,vUv05,vUv06,vUv07;out vec2 vUv08,vUv09,vUv10,vUv11;void main(){vUv=position.xy*0.5+0.5;vUv00=vUv+resolution.zw*vec2(-1.0,1.0);vUv01=vUv+resolution.zw*vec2(1.0,1.0);vUv02=vUv+resolution.zw*vec2(-1.0,-1.0);vUv03=vUv+resolution.zw*vec2(1.0,-1.0);vUv04=vUv+resolution.zw*vec2(-2.0,2.0);vUv05=vUv+resolution.zw*vec2(0.0,2.0);vUv06=vUv+resolution.zw*vec2(2.0,2.0);vUv07=vUv+resolution.zw*vec2(-2.0,0.0);vUv08=vUv+resolution.zw*vec2(2.0,0.0);vUv09=vUv+resolution.zw*vec2(-2.0,-2.0);vUv10=vUv+resolution.zw*vec2(0.0,-2.0);vUv11=vUv+resolution.zw*vec2(2.0,-2.0);gl_Position=vec4(position.xy,1.0,1.0);}`;var Ze=class extends _{constructor({clampToBorder:r=!0}={}){super({name:"DownsamplingMaterial",fragmentShader:Kt,vertexShader:qt,defines:{CLAMP_TO_BORDER:!0}}),this.clampToBorder=r}get clampToBorder(){return this.defines.CLAMP_TO_BORDER!==void 0}set clampToBorder(r){this.clampToBorder!==r&&(r?this.defines.CLAMP_TO_BORDER=!0:delete this.defines.CLAMP_TO_BORDER,this.needsUpdate=!0)}};var pe=g("three");var Qt=`#include <pp_default_output_pars_fragment>
#include <pp_input_buffer_pars_fragment>
#ifdef USE_SUPPORT_BUFFER
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D supportBuffer;
#else
uniform lowp sampler2D supportBuffer;
#endif
uniform float radius;
#endif
in vec2 vUv;in vec2 vUv0,vUv1,vUv2,vUv3;in vec2 vUv4,vUv5,vUv6,vUv7;void main(){vec4 c=vec4(0.0);c+=texture(inputBuffer,vUv0)*0.0625;c+=texture(inputBuffer,vUv1)*0.125;c+=texture(inputBuffer,vUv2)*0.0625;c+=texture(inputBuffer,vUv3)*0.125;c+=texture(inputBuffer,vUv)*0.25;c+=texture(inputBuffer,vUv4)*0.125;c+=texture(inputBuffer,vUv5)*0.0625;c+=texture(inputBuffer,vUv6)*0.125;c+=texture(inputBuffer,vUv7)*0.0625;
#ifdef USE_SUPPORT_BUFFER
vec4 baseColor=texture(supportBuffer,vUv);out_Color=mix(baseColor,c,radius);
#else
out_Color=c;
#endif
}`;var Zt=`#include <pp_resolution_pars_fragment>
out vec2 vUv;out vec2 vUv0,vUv1,vUv2,vUv3;out vec2 vUv4,vUv5,vUv6,vUv7;void main(){vUv=position.xy*0.5+0.5;vUv0=vUv+resolution.zw*vec2(-1.0,1.0);vUv1=vUv+resolution.zw*vec2(0.0,1.0);vUv2=vUv+resolution.zw*vec2(1.0,1.0);vUv3=vUv+resolution.zw*vec2(-1.0,0.0);vUv4=vUv+resolution.zw*vec2(1.0,0.0);vUv5=vUv+resolution.zw*vec2(-1.0,-1.0);vUv6=vUv+resolution.zw*vec2(0.0,-1.0);vUv7=vUv+resolution.zw*vec2(1.0,-1.0);gl_Position=vec4(position.xy,1.0,1.0);}`;var Ye=class extends _{constructor({radius:r=.85}={}){super({name:"UpsamplingMaterial",fragmentShader:Qt,vertexShader:Zt,defines:{USE_SUPPORT_BUFFER:!0},uniforms:{supportBuffer:new pe.Uniform(null),texelSize:new pe.Uniform(new pe.Vector2),radius:new pe.Uniform(0)}}),this.radius=r}set supportBuffer(r){this.uniforms.supportBuffer.value=r}get radius(){return this.uniforms.radius.value}set radius(r){this.uniforms.radius.value=r;let e=this.defines.USE_SUPPORT_BUFFER!==void 0,t=r<1;e!==t&&(t?this.defines.USE_SUPPORT_BUFFER=!0:delete this.defines.USE_SUPPORT_BUFFER,this.needsUpdate=!0)}};var H=class H extends T{constructor({levels:e=8,radius:t,fullResolutionUpsampling:i=!1,clampToBorder:s}={}){super("MipmapBlurPass");n(this,"downsamplingMipmaps");n(this,"upsamplingMipmaps");n(this,"downsamplingMaterial");n(this,"upsamplingMaterial");n(this,"_fullResolutionUpsampling");let a=this.createFramebuffer();a.texture.name=H.BUFFER_MAIN,this.output.setBuffer(H.BUFFER_MAIN,a),this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],this.downsamplingMaterial=new Ze({clampToBorder:s}),this.upsamplingMaterial=new Ye({radius:t}),this.materials.add(this.downsamplingMaterial),this.materials.add(this.upsamplingMaterial),this._fullResolutionUpsampling=i,this.levels=e}get texture(){return this.output.buffers.get(H.BUFFER_MAIN).texture}get clampToBorder(){return this.downsamplingMaterial.clampToBorder}set clampToBorder(e){this.downsamplingMaterial.clampToBorder=e}get radius(){return this.upsamplingMaterial.radius}set radius(e){this.upsamplingMaterial.radius=e}get levels(){return this.downsamplingMipmaps.length}set levels(e){if(e<=0)throw new Error("The level count must be greater than 0");this.levels!==e&&this.createMipmaps(e)}get fullResolutionUpsampling(){return this._fullResolutionUpsampling}set fullResolutionUpsampling(e){this._fullResolutionUpsampling!==e&&(this._fullResolutionUpsampling=e,this.createMipmaps(this.levels))}createMipmaps(e){let t=this.output,i=t.buffers.get(H.BUFFER_MAIN),s=i.value;if(this.dispose(),this.disposables.clear(),t.buffers.clear(),this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],e===1&&!this.fullResolutionUpsampling){t.setBuffer(H.BUFFER_MAIN,i),this.downsamplingMipmaps.push(i);return}for(let a=0;a<e;++a){let o=s.clone();o.texture.name="DOWNSAMPLING_MIPMAP"+a;let f=new L(o);t.setBuffer(o.texture.name,f),this.downsamplingMipmaps.push(f)}t.setBuffer(H.BUFFER_MAIN,i),this.upsamplingMipmaps.push(i);for(let a=1,o=this.fullResolutionUpsampling?e:e-1;a<o;++a){let f=s.clone();f.texture.name="UPSAMPLING_MIPMAP"+a;let l=new L(f);t.setBuffer(f.texture.name,l),this.upsamplingMipmaps.push(l)}this.onResolutionChange()}onInputChange(){var o,f;let e=(f=(o=this.input.defaultBuffer)==null?void 0:o.value)!=null?f:null;if(e===null)return;let{format:t,internalFormat:i,type:s,colorSpace:a}=e;for(let l of this.downsamplingMipmaps.concat(this.upsamplingMipmaps)){let p=l.value,c=p.texture;c.format=t,c.internalFormat=i,c.type=s,c.colorSpace=a,p.dispose()}this.input.frameBufferPrecisionHigh?(this.downsamplingMaterial.outputPrecision="mediump",this.upsamplingMaterial.outputPrecision="mediump"):(this.downsamplingMaterial.outputPrecision="lowp",this.upsamplingMaterial.outputPrecision="lowp"),this.onResolutionChange()}onResolutionChange(){var a,o,f,l;let e=(o=(a=this.input.defaultBuffer)==null?void 0:a.value)!=null?o:null;if(e===null)return;let t=e.source.data,{width:i,height:s}=t;for(let p=0,c=this.downsamplingMipmaps.length;p<c;++p)i=Math.round(i/2),s=Math.round(s/2),(f=this.downsamplingMipmaps[p].value)==null||f.setSize(i,s);this.fullResolutionUpsampling?(i=t.width,s=t.height):(i=Math.round(t.width/2),s=Math.round(t.height/2));for(let p=0,c=this.upsamplingMipmaps.length;p<c;++p)(l=this.upsamplingMipmaps[p].value)==null||l.setSize(i,s),i=Math.round(i/2),s=Math.round(s/2)}render(){if(this.renderer===null||this.input.defaultBuffer===null||this.input.defaultBuffer.value===null)return;let e=this.renderer,t=this.downsamplingMaterial,i=this.upsamplingMaterial,s=this.downsamplingMipmaps,a=this.upsamplingMipmaps,o=this.input.defaultBuffer.value,f=o.source.data,{width:l,height:p}=f;this.fullscreenMaterial=t;for(let c=0,v=s.length;c<v;++c){let d=s[c].value;t.setSize(l,p),t.inputBuffer=o,e.setRenderTarget(d),this.renderFullscreen(),o=d.texture,l=d.width,p=d.height}this.fullscreenMaterial=i;for(let c=a.length-1;c>=0;--c){let v=this.fullResolutionUpsampling?c-1:c,d=v>=0?s[v].value.texture:this.input.defaultBuffer.value,b=a[c].value;i.setSize(l,p),i.inputBuffer=o,i.supportBuffer=d,e.setRenderTarget(b),this.renderFullscreen(),o=b.texture,l=b.width,p=b.height}}};n(H,"BUFFER_MAIN","BUFFER_MAIN");var Je=H;var Ee=g("three");var Yt=`#ifdef TEXTURE_PRECISION_HIGH
uniform mediump sampler2D map;
#else
uniform lowp sampler2D map;
#endif
#ifdef UV_TRANSFORM
in vec2 vUv2;
#endif
vec4 mainImage(const in vec4 inputColor,const in vec2 uv,const in GData gData){
#ifdef UV_TRANSFORM
vec4 texel=texture(map,vUv2);
#else
vec4 texel=texture(map,uv);
#endif
vec4 result=TEXEL;return vec4(result.rgb,max(inputColor.a,result.a));}`;var Jt="uniform mat3 uvTransform;out vec2 vUv2;void mainSupport(const in vec2 uv){vUv2=(uvTransform*vec3(uv,1.0)).xy;}";var et=class extends le{constructor({texture:r=null}={}){super("TextureEffect"),this.fragmentShader=Yt,this.input.defines.set("TEXEL","texel");let t=this.input.uniforms;t.set("map",new Ee.Uniform(null)),t.set("uvTransform",new Ee.Uniform(null)),this.texture=r}get texture(){return this.input.uniforms.get("map").value}set texture(r){let e=this.texture,t=this.input.uniforms,i=this.input.defines;e!==r&&(t.get("map").value=r,i.delete("TEXTURE_PRECISION_HIGH"),r!==null&&(r.matrixAutoUpdate?(i.set("UV_TRANSFORM",!0),t.get("uvTransform").value=r.matrix,this.vertexShader=Jt):(i.delete("UV_TRANSFORM"),t.get("uvTransform").value=null,this.vertexShader=null),r.type!==Ee.UnsignedByteType&&i.set("TEXTURE_PRECISION_HIGH",!0)),this.setChanged())}setTextureSwizzleRGBA(r,e=r,t=r,i=r){let s="rgba",a="";(r!==0||e!==1||t!==2||i!==3)&&(a=[".",s[r],s[e],s[t],s[i]].join("")),this.input.defines.set("TEXEL","texel"+a),this.setChanged()}render(){this.texture!==null&&this.texture.matrixAutoUpdate&&this.texture.updateMatrix()}};var tr=g("three");var z=g("three");var tt=class extends z.EventDispatcher{constructor(){super();n(this,"uniform");n(this,"_enabled");this.uniform=new z.Uniform({slope:new z.Vector3(1,1,1),offset:new z.Vector3(0,0,0),power:new z.Vector3(1,1,1),saturation:1}),this._enabled=!0}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.dispatchEvent({type:"toggle"})}get slope(){return this.uniform.value.slope}get offset(){return this.uniform.value.offset}get power(){return this.uniform.value.power}get saturation(){return this.uniform.value.saturation}set saturation(e){this.uniform.value.saturation=e}applyPreset(e){switch(e){case 0:this.slope.set(1,1,1),this.offset.set(0,0,0),this.power.set(1,1,1),this.saturation=1;break;case 1:this.slope.set(1,.9,.5),this.offset.set(0,0,0),this.power.set(.8,.8,.8),this.saturation=.8;break;case 2:this.slope.set(1,1,1),this.offset.set(0,0,0),this.power.set(1.35,1.35,1.35),this.saturation=1.4;break;case 3:this.slope.set(1.05,1.05,1.05),this.offset.set(0,0,0),this.power.set(1.1,1.1,1.1),this.saturation=1.15;break;case 4:this.slope.set(1,.9,.6),this.offset.set(0,0,0),this.power.set(.8,.8,.8),this.saturation=.3;break;case 5:this.slope.set(1,1,1),this.offset.set(0,0,0),this.power.set(1,1,1),this.saturation=0;break}}lerp(e,t,i){this.slope.lerpVectors(e.slope,t.slope,i),this.offset.lerpVectors(e.offset,t.offset,i),this.power.lerpVectors(e.power,t.power,i),this.saturation=z.MathUtils.lerp(e.saturation,t.saturation,i)}};var er=`#ifdef USE_CDL
struct ColorDecisionList{vec3 slope;vec3 offset;vec3 power;float saturation;};uniform ColorDecisionList cdl;vec3 applyCDL(in vec3 color){float l=dot(color,vec3(0.2126,0.7152,0.0722));vec3 v=max(color*cdl.slope+cdl.offset,0.0);vec3 pv=pow(v,cdl.power);if(v.r>0.0){v.r=pv.r;}if(v.g>0.0){v.g=pv.g;}if(v.b>0.0){v.b=pv.b;}return(v-l)*cdl.saturation+l;}
#else
#define applyCDL(color) color
#endif
#include <tonemapping_pars_fragment>
vec4 mainImage(const in vec4 inputColor,const in vec2 uv,const in GData gData){vec3 result;
#if TONE_MAPPING == 0
result=LinearToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 1
result=ReinhardToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 2
result=CineonToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 3
result=ACESFilmicToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 4
result=AgXToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 5
result=NeutralToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 6
result=CustomToneMapping(inputColor.rgb);
#endif
return vec4(result,inputColor.a);}`;var rt=class extends le{constructor({toneMapping:e=4,cdlPreset:t=null}={}){super("ToneMappingEffect");n(this,"cdl");this.fragmentShader=er.replace("#include <tonemapping_pars_fragment>",tr.ShaderChunk.tonemapping_pars_fragment.replace(/(color = AgXOutsetMatrix \* color;)/,`color = applyCDL(color);
$1`)),this.cdl=new tt,this.cdl.addEventListener("toggle",()=>this.onCDLToggle()),this.input.uniforms.set("cdl",this.cdl.uniform),this.input.defines.set("USE_CDL",!0),this.toneMapping=e,this.cdl.applyPreset(t)}get toneMapping(){return this.input.defines.get("TONE_MAPPING")}set toneMapping(e){this.toneMapping!==e&&(this.input.defines.set("TONE_MAPPING",e),this.setChanged())}onCDLToggle(){this.cdl.enabled?this.input.defines.set("USE_CDL",!0):this.input.defines.delete("USE_CDL"),this.setChanged()}};var Et=g("three");var rr=`#include <common>
#include <dithering_pars_fragment>
#include <packing>
#include <pp_camera_pars_fragment>
#include <pp_colorspace_conversion_pars_fragment>
#include <pp_default_output_pars_fragment>
#include <pp_depth_buffer_precision_pars_fragment>
#include <pp_depth_utils_pars_fragment>
#include <pp_frame_buffer_precision_pars_fragment>
#include <pp_noise_pars_fragment>
#include <pp_normal_codec_pars_fragment>
#include <pp_normal_utils_pars_fragment>
#include <pp_resolution_pars_fragment>
#define packFloatToRGBA(v) packDepthToRGBA(v)
#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)
$FRAGMENT_HEAD_GDATA$FRAGMENT_HEAD_GBUFFER uniform GBuffer gBuffer;uniform float time;in vec2 vUv;$FRAGMENT_HEAD_EFFECTS void main(){$FRAGMENT_MAIN_UV$FRAGMENT_MAIN_GDATA vec4 color0=gData.color;vec4 color1=vec4(0.0);$FRAGMENT_MAIN_IMAGE color0.a=clamp(color0.a,0.0,1.0);out_Color=color0;
#ifdef COLOR_SPACE_CONVERSION
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
}`;var ir=`#include <pp_resolution_pars_fragment>
uniform vec3 cameraParams;uniform float time;out vec2 vUv;$VERTEX_HEAD void main(){vUv=position.xy*0.5+0.5;$VERTEX_MAIN_SUPPORT gl_Position=vec4(position.xy,1.0,1.0);}`;var Se=class extends _{constructor(){super({name:"EffectMaterial",defines:{COLOR_SPACE_CONVERSION:!0},uniforms:{gBuffer:new Et.Uniform(null),time:new Et.Uniform(0)}});n(this,"shaderDataTracker");this.shaderDataTracker=new ae,this.fragmentShader=`#include <pp_default_output_pars_fragment>

`+this.fragmentShader}get gBuffer(){return this.uniforms.gBuffer.value}set gBuffer(e){this.uniforms.gBuffer.value=e}get colorSpaceConversion(){return this.defines.COLOR_SPACE_CONVERSION!==void 0}set colorSpaceConversion(e){this.colorSpaceConversion!==e&&(e?this.defines.COLOR_SPACE_CONVERSION=!0:delete this.defines.COLOR_SPACE_CONVERSION,this.needsUpdate=!0)}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}setShaderParts(e){return this.fragmentShader=rr.replace("$FRAGMENT_MAIN_IMAGE",e.get("$FRAGMENT_MAIN_IMAGE")).replace("$FRAGMENT_MAIN_GDATA",e.get("$FRAGMENT_MAIN_GDATA")).replace("$FRAGMENT_MAIN_UV",e.get("$FRAGMENT_MAIN_UV")).replace("$FRAGMENT_HEAD_EFFECTS",e.get("$FRAGMENT_HEAD_EFFECTS")).replace("$FRAGMENT_HEAD_GBUFFER",e.get("$FRAGMENT_HEAD_GBUFFER")).replace("$FRAGMENT_HEAD_GDATA",e.get("$FRAGMENT_HEAD_GDATA")),this.vertexShader=ir.replace("$VERTEX_MAIN_SUPPORT",e.get("$VERTEX_MAIN_SUPPORT")).replace("$VERTEX_HEAD",e.get("$VERTEX_HEAD")),this.needsUpdate=!0,this}setDefines(e){return this.shaderDataTracker.applyDefines(this,e).trackDefines(e),this}setUniforms(e){return this.shaderDataTracker.applyUniforms(this,e).trackUniforms(e),this}dispose(){super.dispose(),this.shaderDataTracker.dispose()}};var ce=g("three");function sr(u){let r;if(u<0)throw new Error(`Invalid index: ${u}`);if(u===0)r=new Float64Array(0);else if(u===1)r=new Float64Array([1]);else{let e=new Float64Array(u),t=new Float64Array(u);r=t;for(let i=1;i<=u;++i){for(let s=0;s<i;++s)t[s]=s===0||s===i-1?1:e[s-1]+e[s];r=t,t=e,e=r}}return r}var it=class{constructor(r,e=2){n(this,"weights");n(this,"offsets");n(this,"linearWeights");n(this,"linearOffsets");this.generate(r,e)}get steps(){return this.offsets===null?0:this.offsets.length}get linearSteps(){return this.linearOffsets===null?0:this.linearOffsets.length}generate(r,e){if(r<3||r>1020)throw new Error("The kernel size must be in the range [3, 1020]");let t=r+e*2,i=e>0?sr(t).slice(e,-e):sr(t),s=Math.floor((i.length-1)/2),a=i.reduce((v,d)=>v+d,0),o=i.slice(s),f=[...Array(s+1).keys()],l=new Float64Array(Math.floor(f.length/2)),p=new Float64Array(l.length);l[0]=o[0]/a;for(let v=1,d=1,b=f.length-1;v<b;v+=2,++d){let P=f[v],ft=f[v+1],te=o[v],Q=o[v+1],de=te+Q,lt=(P*te+ft*Q)/de;l[d]=de/a,p[d]=lt}for(let v=0,d=o.length,b=1/a;v<d;++v)o[v]*=b;let c=(l.reduce((v,d)=>v+d,0)-l[0]*.5)*2;if(c!==0)for(let v=0,d=l.length,b=1/c;v<d;++v)l[v]*=b;this.weights=o,this.offsets=new Float64Array(f),this.linearOffsets=p,this.linearWeights=l}};var nr=`#include <pp_default_output_pars_fragment>
#include <pp_input_buffer_pars_fragment>
uniform vec2 kernel[STEPS];in vec2 vOffset;in vec2 vUv;void main(){vec4 result=texture(inputBuffer,vUv)*kernel[0].y;for(int i=1;i<STEPS;++i){vec2 offset=kernel[i].x*vOffset;vec4 c0=texture(inputBuffer,vUv+offset);vec4 c1=texture(inputBuffer,vUv-offset);result+=(c0+c1)*kernel[i].y;}out_Color=result;}`;var ar=`#include <pp_resolution_pars_fragment>
uniform vec2 direction;uniform float scale;out vec2 vOffset;out vec2 vUv;void main(){vOffset=direction*resolution.zw*scale;vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}`;var st=class extends _{constructor({kernelSize:e=35}={}){super({name:"GaussianBlurMaterial",fragmentShader:nr,vertexShader:ar,defines:{STEPS:0},uniforms:{direction:new ce.Uniform(new ce.Vector2),kernel:new ce.Uniform(null),scale:new ce.Uniform(1)}});n(this,"_kernelSize");this._kernelSize=0,this.kernelSize=e}get kernelSize(){return this._kernelSize}set kernelSize(e){this._kernelSize=e,this.generateKernel(e)}get direction(){return this.uniforms.direction.value}get scale(){return this.uniforms.scale.value}set scale(e){this.uniforms.scale.value=e}generateKernel(e){let t=new it(e),i=t.linearSteps,s=new Float64Array(i*2);for(let a=0,o=0;a<i;++a)s[o++]=t.linearOffsets[a],s[o++]=t.linearWeights[a];this.uniforms.kernel.value=s,this.defines.STEPS=i,this.needsUpdate=!0}};var cr=g("three");var W=g("three");function St(u,r,e){for(let t of r){let i="$1"+u+t.charAt(0).toUpperCase()+t.slice(1),s=new RegExp("([^\\.])(\\b"+t+"\\b)","g");for(let a of e.entries())typeof a[1]=="string"&&e.set(a[0],a[1].replace(s,i))}}function or(u,r,e,t){var i;e.add(u);for(let s of(i=r.get(u))!=null?i:[])e.has(s)||or(s,r,e,t);t.push(u)}function ur(u,r=!1){let e=[],t=new Set;for(let i of u.keys())t.has(i)||or(i,u,t,e);return r?e:e.reverse()}var fr=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,lr=/struct\s+(\w*)/g,pr=/^\s*#define\s+(\w*)/gm,Be=class{constructor(){n(this,"defines");n(this,"uniforms");n(this,"shaderParts");n(this,"blendModes");n(this,"gData");n(this,"convolutionEffects");n(this,"uvTransformationEffects");n(this,"_colorSpace");this.shaderParts=new Map([["$FRAGMENT_HEAD_EFFECTS",""],["$FRAGMENT_HEAD_GBUFFER",""],["$FRAGMENT_HEAD_GDATA",""],["$FRAGMENT_MAIN_UV",""],["$FRAGMENT_MAIN_GDATA",""],["$FRAGMENT_MAIN_IMAGE",""],["$VERTEX_HEAD",""],["$VERTEX_MAIN_SUPPORT",""]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.gData=new Set(["color"]),this.convolutionEffects=new Set,this.uvTransformationEffects=new Set,this._colorSpace=W.LinearSRGBColorSpace}get uvTransformation(){return this.uvTransformationEffects.size>0}get colorSpace(){return this._colorSpace}set colorSpace(r){this._colorSpace=r}gatherVertexShaderTokens(r,e){for(let t of r.matchAll(/(?:out\s+\w+\s+(\w*?);)/g))for(let i of t[1].split(/\s*,\s*/))e.add(i);for(let t of r.matchAll(fr))e.add(t[1]);for(let t of r.matchAll(lr))e.add(t[1]);for(let t of r.matchAll(pr))e.add(t[1])}gatherFragmentShaderTokens(r,e){for(let t of r.matchAll(fr))e.add(t[1]);for(let t of r.matchAll(lr))e.add(t[1]);for(let t of r.matchAll(pr))e.add(t[1])}updateWorkingColorSpace(r){r.outputColorSpace!==W.NoColorSpace?this.colorSpace=r.outputColorSpace:r.inputColorSpace!==W.NoColorSpace&&(this.colorSpace=r.inputColorSpace)}integrateEffect(r,e){e.validate(),e.isConvolutionPass(!1)&&this.convolutionEffects.add(e);let t=e.fragmentShader,i=e.vertexShader,s=this.shaderParts,a=s.get("$FRAGMENT_HEAD_EFFECTS"),o=s.get("$FRAGMENT_MAIN_UV"),f=s.get("$FRAGMENT_MAIN_IMAGE"),l=s.get("$VERTEX_HEAD"),p=s.get("$VERTEX_MAIN_SUPPORT"),c=new Set;if(i!==null&&e.hasMainSupportFunction){this.gatherVertexShaderTokens(i,c);let d=/mainSupport\s*\([\w\s]*?uv\s*?\)/.test(i);p+=`	${r}MainSupport(`,p+=d?`vUv);
`:`);
`}e.hasMainUvFunction&&(o+=`	${r}MainUv(UV);
`,this.uvTransformationEffects.add(e));for(let d of e.gData)this.gData.add(d);if(e.hasMainImageFunction){this.gatherFragmentShaderTokens(t,c),e.inputColorSpace!==W.NoColorSpace&&e.inputColorSpace!==this.colorSpace&&(f+=e.inputColorSpace===W.SRGBColorSpace?`color0 = sRGBTransferOETF(color0);
	`:`color0 = sRGBTransferEOTF(color0);
	`),f+=`color1 = ${r}MainImage(color0, UV, gData);
	`;let d=e.blendMode;this.blendModes.set(d.blendFunction.id,d);let b=r+"BlendOpacity";this.uniforms.set(b,d.opacityUniform),f+=`color0 = blend${d.blendFunction.id}(color0, color1, ${b});

	`,a+=`uniform float ${b};

`,this.updateWorkingColorSpace(e)}for(let d of e.input.defines.keys())c.add(d.replace(/\([\w\s,]*\)/g,""));for(let d of e.input.uniforms.keys())c.add(d);c.delete("while"),c.delete("for"),c.delete("if"),e.input.uniforms.forEach((d,b)=>this.uniforms.set(r+b.charAt(0).toUpperCase()+b.slice(1),d)),e.input.defines.forEach((d,b)=>this.defines.set(r+b.charAt(0).toUpperCase()+b.slice(1),d));let v=new Map([["fragment",t],["vertex",i]]);St(r,c,this.defines),St(r,c,v),t=v.get("fragment"),i=v.get("vertex"),a+=t+`
`,i!==null&&(l+=i+`
`),s.set("$FRAGMENT_HEAD_EFFECTS",a),s.set("$FRAGMENT_MAIN_UV",o),s.set("$FRAGMENT_MAIN_IMAGE",f),s.set("$VERTEX_HEAD",l),s.set("$VERTEX_MAIN_SUPPORT",p),this.validate()}add(r){r.convolutionEffects.forEach(f=>this.convolutionEffects.add(f)),r.uvTransformationEffects.forEach(f=>this.uvTransformationEffects.add(f)),r.uniforms.forEach((f,l)=>this.uniforms.set(l,f)),r.defines.forEach((f,l)=>this.defines.set(l,f)),r.blendModes.forEach((f,l)=>this.blendModes.set(l,f)),r.gData.forEach(f=>this.gData.add(f));let e=this.shaderParts,t=e.get("$FRAGMENT_HEAD_EFFECTS"),i=e.get("$FRAGMENT_MAIN_UV"),s=e.get("$FRAGMENT_MAIN_IMAGE"),a=e.get("$VERTEX_HEAD"),o=e.get("$VERTEX_MAIN_SUPPORT");t+=r.shaderParts.get("$FRAGMENT_HEAD_EFFECTS"),i+=r.shaderParts.get("$FRAGMENT_MAIN_UV"),s+=r.shaderParts.get("$FRAGMENT_MAIN_IMAGE"),a+=r.shaderParts.get("$VERTEX_HEAD"),o+=r.shaderParts.get("$VERTEX_MAIN_SUPPORT"),e.set("$FRAGMENT_HEAD_EFFECTS",t),e.set("$FRAGMENT_MAIN_UV",i),e.set("$FRAGMENT_MAIN_IMAGE",s),e.set("$VERTEX_HEAD",a),e.set("$VERTEX_MAIN_SUPPORT",o),this.colorSpace!==r.colorSpace&&r.colorSpace!==W.NoColorSpace&&(this.colorSpace=r.colorSpace),this.validate()}validate(){if(this.convolutionEffects.size>1){let r=[...this.convolutionEffects].map(e=>e.name).join(", ");throw new Error(`Convolution effects cannot be merged (${r})`)}else if(this.convolutionEffects.size>0&&this.uvTransformation){let r=[...this.convolutionEffects,...this.uvTransformationEffects].map(e=>e.name).join(", ");throw new Error(`Effects that transform UVs are incompatible with convolution effects (${r})`)}}createGDataStructDeclaration(r){return["struct GData {",...Array.from(r.gDataStructDeclaration).filter(e=>this.gData.has(e[0])).map(e=>`	${e[1]}`),`};
`].join(`
`)}createGDataStructInitialization(r){let e=r.gDataDependencies,t=r.gDataStructInitialization,i=new Map(Array.from(this.gData).filter(s=>t.has(s)).map(s=>{var a;return[s,(a=e.get(s))!=null?a:[]]}));return["	GData gData;",...ur(i,!0).map(s=>`	${t.get(s)}`)].join(`
`)}createBlendFunctions(){let r=/\bblend\b/g,e=[];for(let t of this.blendModes.values()){let i=t.blendFunction.shader,s=`blend${t.blendFunction.id}`;e.push(i.replace(r,s))}return e.join(`
`)}};var A=class A{constructor(r){n(this,"shaderData");n(this,"defaultMaterial");n(this,"materialCache");n(this,"effectShaderDataCache");n(this,"activeMaterial");n(this,"_gBufferConfig");n(this,"_gBuffer");n(this,"_dithering");this.shaderData=r,this.defaultMaterial=new Se,this.materialCache=new Map,this.effectShaderDataCache=new Map,this.activeMaterial=null,this._gBufferConfig=null,this._gBuffer=null,this._dithering=!1}get materials(){return this.materialCache.values()}get gBufferConfig(){return this._gBufferConfig}set gBufferConfig(r){this._gBufferConfig!==r&&(this.dispose(),this._gBufferConfig=r)}get gBuffer(){return this._gBuffer}set gBuffer(r){this._gBuffer!==r&&(this.invalidateMaterialCache(),this._gBuffer=r)}get dithering(){return this._dithering}set dithering(r){if(this._dithering!==r){this._dithering=r;for(let e of this.materialCache.values())if(r&&e.outputPrecision!=="lowp"){console.info("Dithering only works on 8-bit colors");break}else e.dithering=r,e.needsUpdate=!0}}getEffectShaderData(r){let e=new Be,t=this.effectShaderDataCache;for(let i of r){if(!t.has(i)){let s=new Be;s.integrateEffect(`e${i.id}`,i),t.set(i,s)}i.blendMode.blendFunction.shader!==null&&e.add(t.get(i))}return e}createGBufferStructDeclaration(r){if(this.gBuffer===null)throw new Error("Missing G-Buffer information");return["struct GBuffer {",...Array.from(r.gBufferStructDeclaration).filter(e=>this.gBuffer.has(e[0])).map(e=>`	${e[1]}`),`};
`].join(`
`)}createMaterial(r){let t=A.getMaterialId(r)===A.DEFAULT_MATERIAL_ID?this.defaultMaterial:new Se,i=this.getEffectShaderData(r),s=this.gBufferConfig;s!==null&&(i.shaderParts.set("$FRAGMENT_HEAD_GBUFFER",this.createGBufferStructDeclaration(s)),i.shaderParts.set("$FRAGMENT_HEAD_GDATA",i.createGDataStructDeclaration(s)),i.shaderParts.set("$FRAGMENT_MAIN_GDATA",i.createGDataStructInitialization(s)));let a=i.shaderParts.get("$FRAGMENT_HEAD_EFFECTS");if(i.shaderParts.set("$FRAGMENT_HEAD_EFFECTS",a+i.createBlendFunctions()),i.colorSpace===cr.SRGBColorSpace){let o=i.shaderParts.get("$FRAGMENT_MAIN_IMAGE");i.shaderParts.set("$FRAGMENT_MAIN_IMAGE",o+`color0 = sRGBTransferEOTF(color0);
	`)}if(i.uvTransformation){let o=i.shaderParts.get("$FRAGMENT_MAIN_UV");i.shaderParts.set("$FRAGMENT_MAIN_UV",`vec2 transformedUv = vUv;
`+o),i.defines.set("UV","transformedUv")}else i.defines.set("UV","vUv");i.shaderParts.forEach((o,f,l)=>l.set(f,o.trim().replace(/^#/,`
#`)));for(let o of this.shaderData.defines)i.defines.set(o[0],o[1]);for(let o of this.shaderData.uniforms)i.uniforms.set(o[0],o[1]);if(t!==this.defaultMaterial){for(let o of Object.entries(this.defaultMaterial.uniforms))t.uniforms[o[0]]=o[1];for(let o of Object.entries(this.defaultMaterial.defines))t.defines[o[0]]=o[1]}return t.setShaderParts(i.shaderParts).setDefines(i.defines).setUniforms(i.uniforms)}createMaterials(r){let e=r.filter(i=>i.optional),t=e.length>A.MAX_OPTIONAL_EFFECTS;if(e.length===0||t){let i=r.filter(a=>a.enabled),s=A.getMaterialId(i);this.materialCache.set(s,this.createMaterial(i));return}for(let i of this.getEffectCombinations(r)){let s=A.getMaterialId(i);this.materialCache.has(s)||this.materialCache.set(s,this.createMaterial(i))}}synchronizeMaterials(){if(this.activeMaterial===null)return;let r=this.activeMaterial,e=this.defaultMaterial;for(let t of Object.entries(e.defines))t[1]!==r.defines[t[0]]&&(e.defines[t[0]]=r.defines[t[0]],e.needsUpdate=!0);if(e.needsUpdate){for(let t of this.materialCache.values())if(t!==e){for(let i of Object.entries(e.defines))t.defines[i[0]]=i[1];t.needsUpdate=!0}}}getMaterial(r){if(this.gBufferConfig===null)return this.defaultMaterial;this.synchronizeMaterials();let e=r.filter(i=>i.enabled),t=A.getMaterialId(e);return this.materialCache.has(t)||this.createMaterials(r),this.activeMaterial=this.materialCache.get(t),this.activeMaterial}*getEffectCombinations(r){let e=r.filter(s=>s.optional),t=e.length,i=1<<t;for(let s=0;s<i;++s){let a=[];for(let o=0;o<t;++o)s&1<<o&&a.push(e[o]);yield r.filter(o=>!o.optional||a.includes(o))}}invalidateMaterialCache(){for(let r of this.materialCache.values())r.dispose();this.materialCache.clear()}invalidateShaderData(r){this.effectShaderDataCache.delete(r)}dispose(){this.invalidateMaterialCache(),this.effectShaderDataCache.clear()}static getMaterialId(r){return r.length===0?A.DEFAULT_MATERIAL_ID:r.map(e=>e.id).join("-")}};n(A,"MAX_OPTIONAL_EFFECTS",6),n(A,"DEFAULT_MATERIAL_ID","default");var nt=A;var at=class u extends T{constructor(...e){super("EffectPass");n(this,"effectMaterialManager");n(this,"effectListener");n(this,"gBufferConfigListener");n(this,"previousGBufferConfig");n(this,"disposed");n(this,"timeScale");this.output.defaultBuffer=this.createFramebuffer(),this.effectMaterialManager=new nt(this.input),this.effectMaterialManager.gBuffer=this.input.gBuffer,this.effectListener=t=>this.handleEffectEvent(t),this.gBufferConfigListener=t=>this.handleGBufferConfigEvent(t),this.previousGBufferConfig=null,this.effects=e,this.disposed=!1,this.timeScale=1}get subpasses(){return super.subpasses}set subpasses(e){for(let t of super.subpasses)t.removeEventListener("change",this.effectListener),t.removeEventListener("toggle",this.effectListener);super.subpasses=e,this.input.gBuffer.clear(),this.input.gBuffer.add("Color");for(let t of super.subpasses)this.copyGBufferComponents(t),t.addEventListener("change",this.effectListener),t.addEventListener("toggle",this.effectListener);this.updateMaterial(!0),this.disposed=!1}get effects(){return this.subpasses}set effects(e){let t=new Set(e);if(t.size<e.length){let i=e.filter(s=>!t.has(s)).map(s=>s.name);throw new Error(`Encountered duplicate effects: ${i.join(", ")}`)}this.subpasses=e}get dithering(){return this.effectMaterialManager.dithering}set dithering(e){this.effectMaterialManager.dithering=e}copyGBufferComponents(e){for(let t of e.input.gBuffer)this.input.gBuffer.add(t)}updateMaterial(e){e&&(this.effectMaterialManager.invalidateMaterialCache(),this.materials.clear()),this.fullscreenMaterial=this.effectMaterialManager.getMaterial(this.effects);for(let t of this.effectMaterialManager.materials)this.materials.add(t)}updateGBufferStruct(){var s,a;let e=this.input,t=e.gBufferConfig;if(t===null)return;let i=[];for(let o of e.gBuffer){let l=o==="Color"?(s=e.defaultBuffer)==null?void 0:s.value:(a=e.buffers.get(o))==null?void 0:a.value;i.push([t.gBufferStructFields.get(o),l!=null?l:null])}this.fullscreenMaterial.gBuffer=Object.fromEntries(i)}handleEffectEvent(e){switch(e.type){case"change":this.copyGBufferComponents(e.target),this.effectMaterialManager.invalidateShaderData(e.target),this.updateMaterial(!0);break;case"toggle":this.updateMaterial(!1);break}}handleGBufferConfigEvent(e){e.type==="change"&&this.updateMaterial(!0)}onGBufferConfigChange(){let e=this.input.gBufferConfig;this.previousGBufferConfig!==null&&this.previousGBufferConfig.removeEventListener("change",this.gBufferConfigListener),this.input.gBufferConfig!==null&&this.input.gBufferConfig.addEventListener("change",this.gBufferConfigListener),this.effectMaterialManager.gBufferConfig=e,this.previousGBufferConfig=e;for(let t of this.effects)t.input.gBufferConfig=e;this.updateMaterial(!0)}onInputChange(){this.updateGBufferStruct();for(let e of this.effects){e.removeEventListener("change",this.effectListener),e.input.buffers.clear();for(let t of this.input.buffers)e.input.buffers.set(t[0],t[1]);e.addEventListener("change",this.effectListener)}this.previousGBufferConfig!==this.input.gBufferConfig?this.onGBufferConfigChange():this.updateMaterial(!0)}checkRequirements(){for(let e of this.effects)e.checkRequirements()}compile(){return G(this,null,function*(){return this.updateMaterial(!1),re(u.prototype,this,"compile").call(this)})}dispose(){for(let e of this.effects)e.removeEventListener("change",this.effectListener),e.removeEventListener("toggle",this.effectListener);this.input.gBufferConfig!==null&&this.input.gBufferConfig.removeEventListener("change",this.gBufferConfigListener),this.effectMaterialManager.dispose(),super.dispose(),this.disposed=!0}render(){var e;if(!(this.renderer===null||this.timer===null)){this.disposed&&(this.effects=[...this.effects]);for(let t of this.effects)t.enabled&&t.render();this.fullscreenMaterial.time+=this.timer.getDelta()*this.timeScale,this.setRenderTarget((e=this.output.defaultBuffer)==null?void 0:e.value),this.renderFullscreen()}}};var j=class j extends T{constructor({kernelSize:e=35,iterations:t=1}={}){super("GaussianBlurPass");n(this,"iterations");this.output.setBuffer(j.BUFFER_A,this.createFramebuffer()),this.output.setBuffer(j.BUFFER_B,this.createFramebuffer()),this.fullscreenMaterial=new st({kernelSize:e}),this.iterations=t}get blurMaterial(){return this.fullscreenMaterial}get kernelSize(){return this.blurMaterial.kernelSize}set kernelSize(e){this.blurMaterial.kernelSize=e}get renderTargetA(){return this.output.getBuffer(j.BUFFER_A)}get renderTargetB(){return this.output.getBuffer(j.BUFFER_B)}get texture(){return this.output.buffers.get(j.BUFFER_B).texture}onInputChange(){var o,f;let e=(f=(o=this.input.defaultBuffer)==null?void 0:o.value)!=null?f:null;if(e===null)return;let{format:t,internalFormat:i,type:s,colorSpace:a}=e;for(let l of[this.renderTargetA,this.renderTargetB]){let p=l.texture;p.format=t,p.internalFormat=i,p.type=s,p.colorSpace=a,l.dispose()}this.input.frameBufferPrecisionHigh?this.blurMaterial.outputPrecision="mediump":this.blurMaterial.outputPrecision="lowp",this.onResolutionChange()}onResolutionChange(){var s,a;let e=(a=(s=this.input.defaultBuffer)==null?void 0:s.value)!=null?a:null;if(e===null)return;let t=this.resolution;this.renderTargetA.setSize(t.width,t.height),this.renderTargetB.setSize(t.width,t.height);let i=e.source.data;this.blurMaterial.setSize(i.width,i.height)}render(){if(this.renderer===null||this.input.defaultBuffer===null||this.input.defaultBuffer.value===null)return;let e=this.renderTargetA,t=this.renderTargetB,i=this.blurMaterial,s=this.input.defaultBuffer.value;for(let a=0,o=Math.max(this.iterations,1);a<o;++a)i.direction.set(1,0),i.inputBuffer=s,this.setRenderTarget(e),this.renderFullscreen(),i.direction.set(0,1),i.inputBuffer=e.texture,this.setRenderTarget(t),this.renderFullscreen(),a===0&&o>1&&(s=t.texture)}};n(j,"BUFFER_A","BUFFER_A"),n(j,"BUFFER_B","BUFFER_B");var ot=j;var Sr=g("tweakpane"),ut=g("spatial-controls");var m=g("three");function dr(){let u=[[.12324091787538365,.09064047524231066,.05263591868309067],[.07505564151881193,.07505564221782213,.07505564728562912],[-12738801795225628e-34,-13862720782180785e-34,72901209466271645e-35],[-.022844675139794938,.013457944286841193,-2555398129446308e-35],[-6378735628644095e-34,3723254872321192e-34,-4827259490682807e-35],[-71448287739362375e-35,-1307481902513501e-33,-9613106193675661e-34],[-.037415948039784014,-.041434962772114364,-.044504851419885576],[30317816726499583e-36,-4584564755673668e-35,4745534065260507e-36],[-.09868906531272167,-.09172794146160522,-.0864107588144471]],r=new m.LightProbe;r.sh.coefficients=u.map(i=>new m.Vector3(i[0],i[1],i[2]));let e=new m.PointLight(14264409,1,10);e.position.set(0,.84,0),e.castShadow=!0,e.shadow.mapSize.width=1024,e.shadow.mapSize.height=1024,e.shadow.camera.near=.1;let t=new m.Group;return t.add(r,e),t}function hr(){let u=new m.PlaneGeometry,r=new m.MeshStandardMaterial({color:16777215}),e=new m.InstancedMesh(u,r,7);e.receiveShadow=!0;let t=new m.Vector3,i=new m.Quaternion,s=new m.Euler,a=new m.Vector3,o=new m.Matrix4,f=new m.Color;e.setMatrixAt(0,o.compose(t.set(0,-1,0),i.setFromEuler(s.set(Math.PI*.5,0,0)),a.set(2,2,1))),e.setMatrixAt(1,o.compose(t.set(0,-1,0),i.setFromEuler(s.set(Math.PI*-.5,0,0)),a.set(2,2,1))),e.setMatrixAt(2,o.compose(t.set(0,1,0),i.setFromEuler(s.set(Math.PI*.5,0,0)),a.set(2,2,1))),e.setMatrixAt(3,o.compose(t.set(0,0,-1),i.identity(),a.set(2,2,1))),e.setMatrixAt(4,o.compose(t.set(0,0,1),i.setFromEuler(s.set(0,Math.PI,0)),a.set(2,2,1))),e.setMatrixAt(5,o.compose(t.set(-1,0,0),i.setFromEuler(s.set(0,Math.PI*.5,0)),a.set(2,2,1))),e.setMatrixAt(6,o.compose(t.set(1,0,0),i.setFromEuler(s.set(0,Math.PI*-.5,0)),a.set(2,2,1))),e.setColorAt(5,f.setHex(16711680)),e.setColorAt(6,f.setHex(65280));let l=new m.Mesh(u,new m.MeshStandardMaterial({color:16777215,emissive:16777215}));l.position.y=1-.004,l.rotation.x=Math.PI*.5,l.scale.set(.4,.4,1);let p=new m.Group;return p.add(e,l),p}function mr(){let u=new m.Mesh(new m.BoxGeometry(1,1,1),new m.MeshStandardMaterial({color:16777215,roughness:.5,metalness:0})),r=new m.Mesh(new m.BoxGeometry(1,1,1),new m.MeshStandardMaterial({color:16777215,roughness:1,metalness:0})),e=new m.Mesh(new m.SphereGeometry(1,32,32),new m.MeshStandardMaterial({color:16777215,roughness:.25,metalness:.25})),t=1e-4;u.position.set(-.35,-.4+t,-.3),u.rotation.y=Math.PI*.1,u.scale.set(.6,1.2,.6),u.castShadow=!0,r.position.set(.35,-.7+t,.3),r.rotation.y=Math.PI*-.1,r.scale.set(.6,.6,.6),r.castShadow=!0,e.position.set(-.5,-.7+t,.6),e.scale.set(.3,.3,.3),e.castShadow=!0;let i=new m.Group;return i.add(u,r,e),i}var Ur=Math.PI/180,Dr=180/Math.PI;function gr(u,r=16/9){return Math.atan(Math.tan(u*Ur*.5)/r)*Dr*2}function vr(u,r=".png"){let e=`${document.baseURI}img/textures/skies/${u}/`;return[e+"px"+r,e+"nx"+r,e+"py"+r,e+"ny"+r,e+"pz"+r,e+"nz"+r]}var br=g("@tweakpane/plugin-essentials");function Er(u){u.registerPlugin(br.EssentialsPlugin);let r=u.addBlade({view:"fpsgraph",rows:2});return r.on("tick",()=>{if(r.fps===null)return;let e=Math.round(r.fps)*1.5;e>r.max&&(r.max=e)}),r}var Bt=["localhost","127.0.0.1","","[::1]"].includes(window.location.hostname);function Ar(){let u=new Map,r=new F.LoadingManager,e=new F.CubeTextureLoader(r);return new Promise((t,i)=>{r.onLoad=()=>t(u),r.onError=s=>i(new Error(`Failed to load ${s}`)),e.load(vr("sunset"),s=>{s.colorSpace=F.SRGBColorSpace,u.set("sky",s)})})}window.addEventListener("load",()=>{Ar().then(u=>{let r=new F.WebGLRenderer({powerPreference:"high-performance",antialias:!1,stencil:!1,depth:!1});r.setPixelRatio(window.devicePixelRatio),r.debug.checkShaderErrors=Bt,r.shadowMap.autoUpdate=!1,r.shadowMap.needsUpdate=!0,r.shadowMap.enabled=!0;let e=new F.PerspectiveCamera,t=new ut.SpatialControls(e.position,e.quaternion,r.domElement),i=t.settings;i.general.mode=ut.ControlMode.THIRD_PERSON,i.rotation.sensitivity=2.2,i.rotation.damping=.05,i.zoom.damping=.1,i.translation.enabled=!1,t.position.set(0,0,5);let s=new F.Scene;s.background=u.get("sky"),s.environment=u.get("sky"),s.environmentIntensity=.33,s.add(dr()),s.add(hr()),s.add(mr());let a=new Je({fullResolutionUpsampling:!0,clampToBorder:!1,radius:1,levels:1}),o=new ot({kernelSize:15,iterations:1});o.enabled=!1,o.resolution.scale=.5;let f=new et({texture:a.texture.value}),l=new at(f,new rt),p=new je(r);p.add(new K,new q(s,e,{samples:4}),a,o,l);let c=document.getElementById("viewport"),v=new Sr.Pane({container:c.querySelector(".tp")}),d=Er(v),b=v.addFolder({title:"Settings"});b.addBinding(l,"dithering");let P=b.addTab({pages:[{title:"Mipmap"},{title:"Gaussian"}]});P.on("select",U=>{a.enabled=U.index===0,o.enabled=U.index===1,f.texture=o.enabled?o.texture.value:a.texture.value});let ft={"7x7":7,"15x15":15,"25x25":25,"35x35":35,"63x63":63,"127x127":127,"255x255":255},te=P.pages[0];te.addBinding(a,"radius",{min:0,max:1,step:.01}),te.addBinding(a,"levels",{min:1,max:10,step:1}),te.addBinding(a,"fullResolutionUpsampling",{label:"fullResUpscale"});let Q=P.pages[1];Q.addBinding(o.resolution,"scale",{label:"resolution",min:.5,max:1,step:.05}),Q.addBinding(o.fullscreenMaterial,"kernelSize",{options:ft}),Q.addBinding(o.fullscreenMaterial,"scale",{min:0,max:2,step:.01}),Q.addBinding(o,"iterations",{min:1,max:8,step:1});function de(){let U=c.clientWidth,Me=c.clientHeight;e.aspect=U/Me,e.fov=gr(90,Math.max(e.aspect,16/9)),e.updateProjectionMatrix(),p.setSize(U,Me)}window.addEventListener("resize",de),de();function lt(U){d.begin(),t.update(U),p.render(U),d.end()}p.compile().then(()=>{let U=new IntersectionObserver(Me=>r.setAnimationLoop(Me[0].isIntersecting?lt:null),{threshold:.75});c.prepend(r.domElement),U.observe(c)}).catch(U=>console.error(U))})});})();
