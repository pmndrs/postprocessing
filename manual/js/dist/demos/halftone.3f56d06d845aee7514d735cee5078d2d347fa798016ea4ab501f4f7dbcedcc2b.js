"use strict";(()=>{var bs=Object.defineProperty;var Es=Object.getPrototypeOf;var xs=Reflect.get;var Ss=(a,r,e)=>r in a?bs(a,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[r]=e;var h=(a=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(a,{get:(r,e)=>(typeof require!="undefined"?require:r)[e]}):a)(function(a){if(typeof require!="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+a+'" is not supported')});var n=(a,r,e)=>Ss(a,typeof r!="symbol"?r+"":r,e);var J=(a,r,e)=>xs(Es(a),e,r);var G=(a,r,e)=>new Promise((t,s)=>{var i=u=>{try{f(e.next(u))}catch(c){s(c)}},o=u=>{try{f(e.throw(u))}catch(c){s(c)}},f=u=>u.done?t(u.value):Promise.resolve(u.value).then(i,o);f((e=e.apply(a,r)).next())});var D=h("three");var kt=h("three");var L=class{constructor(r=0){n(this,"nextId");this.nextId=r}getNextId(){return this.nextId++}reset(r=0){return this.nextId=r,this}};var Ee=class Ee extends kt.EventDispatcher{constructor(e){super();n(this,"id");n(this,"_value");n(this,"_overrideValue");n(this,"muted");n(this,"locked");this.id=Ee.idManager.getNextId(),this._value=e,this._overrideValue=null,this.locked=!1,this.muted=!1}get value(){var e;return(e=this._overrideValue)!=null?e:this._value}set value(e){this._value=e,this.setChanged()}get overrideValue(){return this._overrideValue}set overrideValue(e){this._overrideValue=e,this.setChanged()}mute(){this.muted=!0}unmute(){this.muted=!1}setChanged(){if(!this.muted){if(this.locked)throw new Error("Unable to change resource value inside change event handler");this.locked=!0,this.dispatchEvent({type:"change"}),this.locked=!1}}};n(Ee,"idManager",new L);var be=Ee;var V=class V extends be{constructor(r){super(r),V.increaseReferenceCount(r)}get value(){return super.value}set value(r){let e=super.value;super.value=r,r!==e&&(V.decreaseReferenceCount(e),V.increaseReferenceCount(r),e!==null&&!V.references.has(e)&&e.dispose())}dispose(){var r;(r=this.value)==null||r.dispose()}static decreaseReferenceCount(r){var s;if(r===null)return;let e=V.references,t=(s=e.get(r))!=null?s:0;t>0&&(t===1?e.delete(r):e.set(r,t-1))}static increaseReferenceCount(r){var s;if(r===null)return;let e=V.references,t=(s=e.get(r))!=null?s:0;e.set(r,t+1)}};n(V,"references",new Map);var W=V;var xe=h("three");var Ht=h("three");var B=class extends Ht.EventDispatcher{constructor(e){super();n(this,"data");this.data=new Map(e)}get size(){return this.data.size}get[Symbol.toStringTag](){return this.data[Symbol.toStringTag]}clear(){this.dispatchEvent({type:"clear"});let e=this.data.clear();return this.dispatchEvent({type:"change"}),e}delete(e){return this.data.has(e)?(this.dispatchEvent({type:"delete",key:e,value:this.data.get(e)}),this.data.delete(e),this.dispatchEvent({type:"change"}),!0):!1}get(e){return this.data.get(e)}has(e){return this.data.has(e)}set(e,t){return this.data.has(e)&&this.dispatchEvent({type:"delete",key:e,value:this.data.get(e)}),this.data.set(e,t),this.dispatchEvent({type:"add",key:e,value:t}),this.dispatchEvent({type:"change"}),this}entries(){return this.data.entries()}keys(){return this.data.keys()}values(){return this.data.values()}forEach(e,t){return this.data.forEach(e,t)}[Symbol.iterator](){return this.data[Symbol.iterator]()}};var zt=h("three");var ee=class extends zt.EventDispatcher{constructor(e){super();n(this,"data");this.data=new Set(e)}get size(){return this.data.size}get[Symbol.toStringTag](){return this.data[Symbol.toStringTag]}[Symbol.iterator](){return this.data[Symbol.iterator]()}clear(){this.data.size!==0&&(this.dispatchEvent({type:"clear"}),this.data.clear(),this.dispatchEvent({type:"change"}))}delete(e){return this.data.has(e)?(this.dispatchEvent({type:"delete",value:e}),this.data.delete(e),this.dispatchEvent({type:"change"}),!0):!1}has(e){return this.data.has(e)}add(e){return this.data.has(e)?this:(this.data.add(e),this.dispatchEvent({type:"add",value:e}),this.dispatchEvent({type:"change"}),this)}entries(){return this.data.entries()}keys(){return this.data.keys()}values(){return this.data.values()}forEach(e,t){return this.data.forEach(e,t)}};var O=class extends W{constructor(e=null){super(e);n(this,"uniformListeners");this.uniformListeners=new WeakMap}bindUniform(e){if(!this.uniformListeners.has(e)){let t=()=>{e.value=this.value};this.uniformListeners.set(e,t),this.addEventListener("change",t)}e.value=this.value}unbindUniform(e){this.uniformListeners.has(e)&&this.removeEventListener("change",this.uniformListeners.get(e))}};var K=class K extends xe.EventDispatcher{constructor(){super();n(this,"defines");n(this,"uniforms");n(this,"gBuffer");n(this,"textures");n(this,"_gBufferConfig");n(this,"propagateChangeEvent");let e=new ee(["Color"]),t=new B,s=new B,i=new B,o=()=>this.setChanged();e.addEventListener("change",o),t.addEventListener("change",o),s.addEventListener("change",o),i.addEventListener("change",o),i.addEventListener("add",f=>f.value.addEventListener("change",o)),i.addEventListener("delete",f=>f.value.removeEventListener("change",o)),i.addEventListener("clear",f=>{for(let u of f.target.values())u.removeEventListener("change",o)}),this.propagateChangeEvent=o,this.defines=t,this.uniforms=s,this.textures=i,this.gBuffer=e,this._gBufferConfig=null}get gBufferConfig(){return this._gBufferConfig}set gBufferConfig(e){this._gBufferConfig!==null&&this._gBufferConfig.removeEventListener("change",this.propagateChangeEvent),e!==null&&e.addEventListener("change",this.propagateChangeEvent),this._gBufferConfig=e,this.setChanged()}get buffers(){return this.textures}get hasDefaultBuffer(){return this.textures.has(K.BUFFER_DEFAULT)}get defaultBuffer(){var e;return(e=this.textures.get(K.BUFFER_DEFAULT))!=null?e:null}set defaultBuffer(e){this.setBuffer(K.BUFFER_DEFAULT,e)}get frameBufferPrecisionHigh(){var e,t;return((t=(e=this.defaultBuffer)==null?void 0:e.value)==null?void 0:t.type)!==xe.UnsignedByteType}setChanged(){this.dispatchEvent({type:"change"})}setBuffer(e,t){if(t instanceof O)this.textures.set(e,t);else{let s=this.textures.get(e);s!=null?s.value=t:this.textures.set(e,new O(t))}}getBuffer(e){var t,s;return(s=(t=this.textures.get(e))==null?void 0:t.value)!=null?s:null}removeDefaultBuffer(){return this.textures.delete(K.BUFFER_DEFAULT)}dispose(){var e;for(let t of this.textures.values())(e=t.value)==null||e.dispose()}};n(K,"BUFFER_DEFAULT","BUFFER_DEFAULT");var te=K;var pe=h("three");var v=h("three");var A=h("three");var Se="out vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}";var C=class extends A.ShaderMaterial{constructor(r){super(Object.assign({name:"FullscreenMaterial",glslVersion:A.GLSL3,blending:A.NoBlending,depthWrite:!1,depthTest:!1,vertexShader:Se},r)),Object.assign(this.uniforms,{projectionMatrix:new A.Uniform(null),projectionMatrixInverse:new A.Uniform(null),viewMatrix:new A.Uniform(null),viewMatrixInverse:new A.Uniform(null),cameraParams:new A.Uniform(new A.Vector3),resolution:new A.Uniform(new A.Vector4),inputBuffer:new A.Uniform(null)}),this.outputPrecision="lowp",this.onBeforeCompile=(e,t)=>{t.getRenderTarget()===null&&this.outputPrecision!=="lowp"&&(this.outputPrecision="lowp",this.needsUpdate=!1)}}get outputPrecision(){return this.defines.OUTPUT_COLOR_PRECISION}set outputPrecision(r){this.defines.OUTPUT_COLOR_PRECISION!==r&&(this.defines.OUTPUT_COLOR_PRECISION=r,this.needsUpdate=!0)}get frameBufferPrecisionHigh(){return this.defines.FRAME_BUFFER_PRECISION_HIGH!==void 0}set frameBufferPrecisionHigh(r){this.frameBufferPrecisionHigh!==r&&(r?this.defines.FRAME_BUFFER_PRECISION_HIGH=!0:delete this.defines.FRAME_BUFFER_PRECISION_HIGH,this.needsUpdate=!0)}get inputBuffer(){return this.uniforms.inputBuffer.value}set inputBuffer(r){this.frameBufferPrecisionHigh=r!==null&&r.type!==A.UnsignedByteType,this.uniforms.inputBuffer.value=r}get near(){return this.uniforms.cameraParams.value.x}get far(){return this.uniforms.cameraParams.value.y}copyCameraSettings(r){this.uniforms.projectionMatrix.value=r.projectionMatrix,this.uniforms.projectionMatrixInverse.value=r.projectionMatrixInverse,this.uniforms.viewMatrix.value=r.matrixWorldInverse,this.uniforms.viewMatrixInverse.value=r.matrixWorld;let e=this.uniforms.cameraParams.value;e.set(r.near,r.far,e.z);let t=this.defines.PERSPECTIVE_CAMERA!==void 0;r instanceof A.PerspectiveCamera?t||(this.defines.PERSPECTIVE_CAMERA=!0,this.needsUpdate=!0):t&&(delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(r,e){this.uniforms.resolution.value.set(r,e,1/r,1/e);let s=this.uniforms.cameraParams.value;s.z=r/e}};var re=h("three");var P=-1,k=class extends re.EventDispatcher{constructor(e=P,t=P,s=1){super();n(this,"baseSize");n(this,"preferredSize");n(this,"effectiveSize");n(this,"_pixelRatio");n(this,"_scale");n(this,"locked");this.baseSize=new re.Vector2(1,1),this.preferredSize=new re.Vector2(e,t),this.effectiveSize=new re.Vector2,this._pixelRatio=1,this._scale=s,this.locked=!1,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){let e=this.baseSize,t=this.preferredSize,s=this.effectiveSize;s.copy(e),t.width!==P?s.width=t.width:t.height!==P&&(s.width=Math.round(t.height*(e.width/Math.max(e.height,1)))),t.height!==P?s.height=t.height:t.width!==P&&(s.height=Math.round(t.width/Math.max(e.width/Math.max(e.height,1),1))),s.multiplyScalar(this.scaledPixelRatio).floor()}get width(){return this.effectiveSize.width}get height(){return this.effectiveSize.height}get aspectRatio(){return this.baseSize.width/this.baseSize.height}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio!==e&&(this._pixelRatio=e,this.setChanged())}get scale(){return this._scale}set scale(e){this._scale!==e&&(this._scale=e,this.preferredSize.setScalar(P),this.setChanged())}get scaledPixelRatio(){return this._pixelRatio*this._scale}get baseWidth(){return this.baseSize.width}set baseWidth(e){this.baseSize.width!==e&&(this.baseSize.width=e,this.setChanged())}get baseHeight(){return this.baseSize.height}set baseHeight(e){this.baseSize.height!==e&&(this.baseSize.height=e,this.setChanged())}setBaseSize(e,t){(this.baseSize.width!==e||this.baseSize.height!==t)&&(this.baseSize.set(e,t),this.setChanged())}setSize(e,t){this.setBaseSize(e,t)}copyBaseSize(e){this.baseSize.equals(e.baseSize)||(this.baseSize.copy(e.baseSize),this.setChanged())}get preferredWidth(){return this.preferredSize.width}set preferredWidth(e){this.preferredSize.width!==e&&(this.preferredSize.width=e,this.setChanged())}get preferredHeight(){return this.preferredSize.height}set preferredHeight(e){this.preferredSize.height!==e&&(this.preferredSize.height=e,this.setChanged())}setPreferredSize(e,t){(this.preferredSize.width!==e||this.preferredSize.height!==t)&&(this.preferredSize.set(e,t),this.setChanged())}copyPreferredSize(e){this.preferredSize.equals(e.preferredSize)||(this.preferredSize.copy(e.preferredSize),this.setChanged())}resetPreferredSize(){(this.preferredSize.width!==P||this.preferredSize.height!==P)&&(this.preferredSize.set(P,P),this.setChanged())}copy(e){this.equals(e)||(this.preferredSize.copy(e.preferredSize),this.baseSize.copy(e.baseSize),this._pixelRatio=e.pixelRatio,this._scale=e.scale,this.setChanged())}equals(e){return this.scale===e.scale&&this.pixelRatio===e.pixelRatio&&this.baseSize.equals(e.baseSize)&&this.preferredSize.equals(e.preferredSize)}setChanged(){if(this.locked)throw new Error("Unable to change resolution inside change event handler");this.locked=!0,this.dispatchEvent({type:"change"}),this.locked=!1}get x(){return this.width}get y(){return this.height}};n(k,"AUTO_SIZE",P);var Wt=h("three");var Be=class extends Wt.EventDispatcher{constructor(e){super();n(this,"listener");this.listener=t=>this.handleSceneEvent(t),this.handleSceneEvent({type:"childadded",target:e,child:e})}handleSceneEvent(e){var t,s;switch(e.type){case"childadded":{(t=e.child)==null||t.traverse(i=>{i.addEventListener("childadded",this.listener),i.addEventListener("childremoved",this.listener)});break}case"childremoved":{(s=e.child)==null||s.traverse(i=>{i.removeEventListener("childadded",this.listener),i.removeEventListener("childremoved",this.listener)});break}}this.dispatchEvent(e)}};var se=class{constructor(){n(this,"defines");n(this,"uniforms");this.defines=new Map,this.uniforms=new Map}applyDefines(r,e){for(let t of this.defines.keys())delete r.defines[t];for(let t of e.entries())r.defines[t[0]]=t[1];return r.needsUpdate=!0,this}trackDefines(r){this.defines.clear();for(let e of r.entries())this.defines.set(e[0],e[1]);return this}applyUniforms(r,e){for(let t of this.uniforms.keys())delete r.uniforms[t];for(let t of e.entries())r.uniforms[t[0]]=t[1];return r.uniformsNeedUpdate=!0,this}trackUniforms(r){this.uniforms.clear();for(let e of r.entries())this.uniforms.set(e[0],e[1]);return this}dispose(){this.defines.clear(),this.uniforms.clear()}};var yt=h("three");var ie=class a extends k{constructor(){super();n(this,"offset");n(this,"effectiveOffset");n(this,"_enabled");this.offset=new yt.Vector2,this.effectiveOffset=new yt.Vector2,this._enabled=!1,this.addEventListener("change",()=>this.updateEffectiveOffset())}updateEffectiveOffset(){this.effectiveOffset.copy(this.offset).multiplyScalar(this.scaledPixelRatio).floor()}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.setChanged())}get offsetX(){return this.effectiveOffset.x}get offsetY(){return this.effectiveOffset.y}setOffset(e,t){(this.offset.x!==e||this.offset.y!==t)&&(this.offset.set(e,t),this.updateEffectiveOffset(),this.setChanged())}set(e,t,s,i){s===void 0||i===void 0?super.setPreferredSize(e,t):(this.offset.set(e,t),this.updateEffectiveOffset(),super.setPreferredSize(s,i))}copy(e){e instanceof a?this.equals(e)||(this.enabled=e.enabled,this.offset.copy(e.offset),this.effectiveOffset.copy(e.effectiveOffset),super.copy(e)):super.copy(e)}equals(e){return this.enabled===e.enabled&&this.offset.equals(e.offset)&&super.equals(e)}get x(){return this.effectiveOffset.x}get y(){return this.effectiveOffset.y}get z(){return this.width}get w(){return this.height}};var Me=class extends ie{};var _e=h("three");var q=class extends W{constructor(e=null){var t;super(e);n(this,"texture");this.texture=new O((t=this.value)==null?void 0:t.texture)}get value(){return super.value}set value(e){super.value=e,this.texture.value=e!==null?e.texture:null}mute(){super.mute(),this.texture.mute()}unmute(){super.unmute(),this.texture.unmute()}};var Q=class Q extends _e.EventDispatcher{constructor(){super();n(this,"defines");n(this,"uniforms");n(this,"renderTargets");let e=new B,t=new B,s=new B,i=()=>this.setChanged();e.addEventListener("change",i),t.addEventListener("change",i),s.addEventListener("change",i),s.addEventListener("add",o=>o.value.addEventListener("change",i)),s.addEventListener("delete",o=>o.value.removeEventListener("change",i)),s.addEventListener("clear",o=>{for(let f of o.target.values())f.removeEventListener("change",i)}),this.defines=e,this.uniforms=t,this.renderTargets=s}get buffers(){return this.renderTargets}get hasDefaultBuffer(){return this.renderTargets.has(Q.BUFFER_DEFAULT)}get defaultBuffer(){var e;return(e=this.renderTargets.get(Q.BUFFER_DEFAULT))!=null?e:null}set defaultBuffer(e){this.setBuffer(Q.BUFFER_DEFAULT,e)}get frameBufferPrecisionHigh(){var t;let e=(t=this.defaultBuffer)==null?void 0:t.value;return e==null?!1:e.texture.type!==_e.UnsignedByteType}setChanged(){this.dispatchEvent({type:"change"})}setBuffer(e,t){if(t instanceof q)this.renderTargets.set(e,t);else{let s=this.renderTargets.get(e);s!=null?s.value=t:this.renderTargets.set(e,new q(t))}}getBuffer(e){var t,s;return(s=(t=this.renderTargets.get(e))==null?void 0:t.value)!=null?s:null}removeDefaultBuffer(){return this.renderTargets.delete(Q.BUFFER_DEFAULT)}dispose(){var e,t,s;for(let i of this.renderTargets.values())(t=(e=i.value)==null?void 0:e.depthTexture)==null||t.dispose(),(s=i.value)==null||s.dispose()}};n(Q,"BUFFER_DEFAULT","BUFFER_DEFAULT");var Re=Q;var jt=new v.Vector2,y=class y extends v.EventDispatcher{constructor(e){super();n(this,"id");n(this,"sceneListener");n(this,"shaderDataTracker");n(this,"fullscreenScene");n(this,"fullscreenCamera");n(this,"screen");n(this,"_name");n(this,"_enabled");n(this,"_attached");n(this,"_autoSyncDefaultBuffers");n(this,"_autoSRGB");n(this,"_timer");n(this,"_renderer");n(this,"_scene");n(this,"_camera");n(this,"_subpasses");n(this,"disposables");n(this,"materials");n(this,"resolution");n(this,"viewport");n(this,"scissor");n(this,"input");n(this,"output");this.sceneListener=t=>this.handleSceneEvent(t),this.shaderDataTracker=new se,this.fullscreenScene=null,this.fullscreenCamera=null,this.screen=null,this._name=e,this._enabled=!0,this._attached=!1,this._autoSyncDefaultBuffers=!0,this._autoSRGB=!0,this._renderer=null,this._timer=null,this._scene=null,this._camera=null,this._subpasses=[],this.id=y.idManager.getNextId(),this.disposables=new Set,this.materials=new Set,this.resolution=new k,this.viewport=new ie,this.scissor=new Me,this.resolution.addEventListener("change",t=>this.handleResolutionEvent(t)),this.viewport.addEventListener("change",t=>this.handleViewportEvent(t)),this.scissor.addEventListener("change",t=>this.handleScissorEvent(t)),this.input=new te,this.output=new Re,this.input.addEventListener("change",t=>this.handleInputEvent(t)),this.output.addEventListener("change",t=>this.handleOutputEvent(t))}get name(){return this._name}set name(e){this._name=e}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.dispatchEvent({type:"toggle"}))}get attached(){return this._attached}set attached(e){this._attached!==e&&(this._attached=e,this.input.setChanged(),this.output.setChanged(),this.resolution.setChanged())}get autoSyncDefaultBuffers(){return this._autoSyncDefaultBuffers}set autoSyncDefaultBuffers(e){this._autoSyncDefaultBuffers!==e&&(this._autoSyncDefaultBuffers=e,this.syncDefaultBuffers())}get autoSRGB(){return this._autoSRGB}set autoSRGB(e){this._autoSRGB!==e&&(this._autoSRGB=e,this.syncDefaultBuffers())}get subpasses(){return this._subpasses}set subpasses(e){for(let t of this.subpasses)t.attached=!1;for(let t of e)if(t.attached)throw new Error(`${t.name} is already attached to another pass`);this._subpasses=e,Object.freeze(this._subpasses),this.initializeSubpasses()}get timer(){return this._timer}set timer(e){this._timer=e;for(let t of this.subpasses)t.timer=e}get renderer(){return this._renderer}set renderer(e){this._renderer=e;try{(e==null?void 0:e.capabilities)!==void 0&&this.checkRequirements()}catch(t){console.warn(t),console.info("Disabling pass:",this),this.enabled=!1}for(let t of this.subpasses)t.renderer=e}get scene(){return this._scene}set scene(e){if(this._scene!==e){if(this._scene!==null&&y.sceneEventTargets.has(this._scene)){let t=y.sceneEventTargets.get(this._scene);t.removeEventListener("childadded",this.sceneListener),t.removeEventListener("childremoved",this.sceneListener)}if(this._scene=e,e!==null){y.sceneEventTargets.has(e)||y.sceneEventTargets.set(e,new Be(e));let t=y.sceneEventTargets.get(e);t.addEventListener("childadded",this.sceneListener),t.addEventListener("childremoved",this.sceneListener)}for(let t of this.subpasses)t.scene=e}}get camera(){return this._camera}set camera(e){if(this._camera!==e){this._camera=e,e!==null&&this.fullscreenMaterial instanceof C&&this.fullscreenMaterial.copyCameraSettings(e);for(let t of this.subpasses)t.camera=e}}get fullscreenMaterial(){var e;return(e=this.screen)==null?void 0:e.material}set fullscreenMaterial(e){e!==null&&(this.screen!==null?this.screen.material=e:(this.screen=new v.Mesh(y.fullscreenGeometry,e),this.screen.frustumCulled=!1,this.fullscreenScene=new v.Scene,this.fullscreenCamera=new v.OrthographicCamera(-1,1,1,-1,0,1),this.fullscreenScene.add(this.screen)),this.materials.has(e)||(this.materials.add(e),this.updateFullscreenMaterialInput(e)))}initializeSubpasses(){for(let e of this.subpasses)e.timer=this.timer,e.renderer=this.renderer,e.scene=this.scene,e.camera=this.camera,e.resolution.copy(this.resolution),e.viewport.copy(this.viewport),e.scissor.copy(this.scissor),e.attached=!0}updateSubpassResolution(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.resolution;for(let i of this.subpasses)i.resolution.pixelRatio=s,i.resolution.setBaseSize(e,t)}updateSubpassViewport(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.viewport;for(let i of this.subpasses)i.viewport.pixelRatio=s,i.viewport.setBaseSize(e,t)}updateSubpassScissor(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.scissor;for(let i of this.subpasses)i.scissor.pixelRatio=s,i.scissor.setBaseSize(e,t)}updateOutputBufferSize(){var e,t;(t=(e=this.output.defaultBuffer)==null?void 0:e.value)==null||t.setSize(this.resolution.width,this.resolution.height)}updateViewportAndScissor(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.resolution;this.viewport.pixelRatio=s,this.viewport.setBaseSize(e,t),this.scissor.pixelRatio=s,this.scissor.setBaseSize(e,t)}updateFullscreenMaterialResolution(e){e instanceof C&&e.setSize(this.resolution.width,this.resolution.height)}updateFullscreenMaterialsResolution(){for(let e of this.materials)this.updateFullscreenMaterialResolution(e)}updateFullscreenMaterialInput(e){var t,s;e instanceof v.ShaderMaterial&&(e instanceof C&&(e.inputBuffer=(s=(t=this.input.defaultBuffer)==null?void 0:t.value)!=null?s:null),this.shaderDataTracker.applyDefines(e,this.input.defines).applyUniforms(e,this.input.uniforms))}updateFullscreenMaterialsInput(){for(let e of this.materials)this.updateFullscreenMaterialInput(e);this.shaderDataTracker.trackDefines(this.input.defines).trackUniforms(this.input.uniforms)}updateFullscreenMaterialsOutput(){for(let e of this.materials)e instanceof C&&(e.outputPrecision=this.output.frameBufferPrecisionHigh?"mediump":"lowp")}syncDefaultBuffers(){var f,u,c,d;let e=this.renderer,t=(u=(f=this.input.defaultBuffer)==null?void 0:f.value)!=null?u:null,s=(d=(c=this.output.defaultBuffer)==null?void 0:c.value)!=null?d:null;if(!this.autoSyncDefaultBuffers||e===null||t===null||s===null)return;let i=s.texture;i.needsUpdate=i.format!==t.format||i.internalFormat!==t.internalFormat||i.type!==t.type,i.needsUpdate&&(i.format=t.format,i.internalFormat=t.internalFormat,i.type=t.type),this.autoSRGB&&!this.output.frameBufferPrecisionHigh&&e.outputColorSpace===v.SRGBColorSpace&&i.colorSpace!==v.SRGBColorSpace&&(i.colorSpace=v.SRGBColorSpace,i.needsUpdate=!0),i.needsUpdate&&this.output.defaultBuffer.texture.setChanged()}isConvolutionPass(e){let t=this.fullscreenMaterial;if(t instanceof C&&/texture\s*\(\s*gBuffer.color/.test(t.fragmentShader))return!0;if(e){for(let s of this.subpasses)if(s.isConvolutionPass(e))return!0}return!1}checkRequirements(){}onInputChange(){}onOutputChange(){}onResolutionChange(){}onViewportChange(){}onScissorChange(){}onSceneChildAdded(e){}onSceneChildRemoved(e){}compile(){return G(this,null,function*(){if(this.renderer===null)return;let e=new v.Group;for(let s of this.materials)e.add(new v.Mesh(y.fullscreenGeometry,s));let t=[this.renderer.compileAsync(e,this.fullscreenCamera,this.fullscreenScene)];for(let s of this.subpasses)t.push(s.compile());yield Promise.all(t)})}createFramebuffer(){let{width:e,height:t}=this.resolution;return new v.WebGLRenderTarget(e,t,{depthBuffer:!1})}setChanged(){this.dispatchEvent({type:"change"})}applyViewport(e=null){let t=this.renderer;if(t===null)return;let s=this.viewport;if(s.enabled)e!==null?e.viewport.copy(s):t.setViewport(s.x,s.y,s.z,s.w);else if(e!==null){let{width:i,height:o}=e;e.viewport.set(0,0,i,o)}else{let{width:i,height:o}=t.getSize(jt);t.setViewport(0,0,i,o)}}applyScissor(e=null){let t=this.renderer;if(t===null)return;let s=this.scissor;if(s.enabled)e!==null?(e.scissor.copy(s),e.scissorTest=!0):(t.setScissor(s.x,s.y,s.z,s.w),t.setScissorTest(!0));else if(e!==null){let{width:i,height:o}=e;e.scissor.set(0,0,i,o),e.scissorTest=!1}else if(t.getScissorTest()){let{width:i,height:o}=t.getSize(jt);t.setScissor(0,0,i,o),t.setScissorTest(!1)}}setRenderTarget(e=null,t,s){var i;this.applyViewport(e),this.applyScissor(e),(i=this.renderer)==null||i.setRenderTarget(e,t,s)}renderFullscreen(){this.renderer!==null&&this.fullscreenMaterial!==null&&this.renderer.render(this.fullscreenScene,this.fullscreenCamera)}handleResolutionEvent(e){this.attached&&e.type==="change"&&(this.updateFullscreenMaterialsResolution(),this.updateOutputBufferSize(),this.onResolutionChange(),this.updateSubpassResolution(),this.updateViewportAndScissor())}handleViewportEvent(e){this.attached&&e.type==="change"&&(this.onViewportChange(),this.updateSubpassViewport())}handleScissorEvent(e){this.attached&&e.type==="change"&&(this.onScissorChange(),this.updateSubpassScissor())}handleInputEvent(e){this.attached&&e.type==="change"&&(this.updateFullscreenMaterialsInput(),this.syncDefaultBuffers(),this.onInputChange())}handleOutputEvent(e){this.attached&&e.type==="change"&&(this.updateOutputBufferSize(),this.updateFullscreenMaterialsOutput(),this.syncDefaultBuffers(),this.onOutputChange())}handleSceneEvent(e){if(this.attached)switch(e.type){case"childadded":this.onSceneChildAdded(e.child);break;case"childremoved":this.onSceneChildRemoved(e.child);break}}dispose(){this.input.dispose(),this.output.dispose(),this.shaderDataTracker.dispose();for(let e of this.materials)e==null||e.dispose();for(let e of this.disposables)e.dispose();for(let e of this.subpasses)e.dispose()}};n(y,"fullscreenGeometry",(()=>{let e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new v.BufferGeometry;return t.setAttribute("position",new v.BufferAttribute(e,3)),t})()),n(y,"idManager",new L),n(y,"sceneEventTargets",new WeakMap);var R=y;var _=h("three"),Bs=new Map([[_.FloatType,"highp"],[_.HalfFloatType,"mediump"],[_.UnsignedByteType,"lowp"]]),Ms=new Map([[_.RedFormat,"float"],[_.RGFormat,"vec2"],[_.RGBFormat,"vec3"],[_.RGBAFormat,"vec4"]]);function ne(a){let r=new Map;for(let e=0,t=a.textures.length;e<t;++e){let s=a.textures[e];r.set(s.name,e)}return r}function Te(a){let r=[];for(let e=0,t=a.textures.length;e<t;++e){let s=a.textures[e],i=Bs.get(s.type),o=Ms.get(s.format),f=s.name.replace(/\W*/g,"");e===0&&r.push("#ifndef gl_FragColor"),r.push(`layout(location = ${e}) out ${i} ${o} out_FragData${e};`),f!==""&&r.push(`#define out_${f} out_FragData${e}`),e===0&&(r.push(`#define gl_FragColor out_FragData${e}`),r.push("#endif"))}return r.join(`
`)}function ye(a){if(a.includes("pp_normal_codec_pars_fragment")||(a=a.replace(/(void\s+main\(\)\s+{)/,`
#include <pp_normal_codec_pars_fragment>
$1`)),!a.includes("pp_gbuffer_default_output_fragment")){let r=a.includes("clipping_planes_fragment");a=a.replace(r?/(#include\s+<clipping_planes_fragment>)/:/(void\s+main\(\)\s+{)/,`$1
#include <pp_gbuffer_default_output_fragment>
`)}return a}var S=h("three");var j=h("three"),ce=class extends j.ShaderMaterial{constructor(){super({name:"BackgroundMaterial",fragmentShader:j.ShaderLib.background.fragmentShader,vertexShader:j.ShaderLib.background.vertexShader,uniforms:j.UniformsUtils.clone(j.ShaderLib.background.uniforms),depthWrite:!1,depthTest:!1,fog:!1})}get map(){return this.uniforms.t2D.value}set map(r){this.uniforms.t2D.value=r}};var I=h("three"),de=class extends I.ShaderMaterial{constructor(){super({name:"SkyBoxMaterial",fragmentShader:I.ShaderLib.backgroundCube.fragmentShader,vertexShader:I.ShaderLib.backgroundCube.vertexShader,uniforms:I.UniformsUtils.clone(I.ShaderLib.backgroundCube.uniforms),side:I.BackSide,depthWrite:!1,depthTest:!1,fog:!1})}get envMap(){return this.uniforms.envMap.value}set envMap(r){this.uniforms.envMap.value=r}};var Z=new S.Euler,Rs=new S.Matrix4,Ce=class extends S.Group{constructor(){super();n(this,"skyBox");n(this,"background");let e=new S.Mesh(new S.BoxGeometry(1,1,1),new de);e.name="SkyBox",e.geometry.deleteAttribute("normal"),e.geometry.deleteAttribute("uv"),e.matrixAutoUpdate=!1,e.frustumCulled=!1,e.layers.enableAll(),this.skyBox=e,e.onBeforeRender=function(s,i,o){this.matrixWorld.copyPosition(o.matrixWorld)};let t=new S.Mesh(new S.PlaneGeometry(2,2),new ce);t.name="Background",t.geometry.deleteAttribute("normal"),t.matrixAutoUpdate=!1,t.frustumCulled=!1,t.layers.enableAll(),this.background=t,this.add(this.skyBox,this.background)}setClearValues(e){let t=new de,s=new ce,i=new Map,o=[],f=[];for(let d of e.gBuffer){let g=typeof d[1]=="number"?"float":`vec${[...d[1]].length}`;i.set(`pp_${d[0]}`,new S.Uniform(d[1])),o.push(`uniform ${g} pp_${d[0]};`),f.push(`	#ifdef out_${d[0]}
		out_${d[0]} = pp_${d[0]};
#endif`)}let u=o.join(`
`),c=f.join(`
`);for(let d of[t,s]){d.fragmentShader=d.fragmentShader.replace(/(void main\(\) {)/,`
${u}
$1
${c}
`);for(let g of i)d.uniforms[g[0]]=g[1];d.onBeforeCompile=(g,w)=>{let m=w.getRenderTarget();if(m===null)return;let x=Te(m);g.fragmentShader=x+`

`+g.fragmentShader}}this.skyBox.material.dispose(),this.background.material.dispose(),this.skyBox.material=t,this.background.material=s}update(e){let{skyBox:t,background:s}=this;if(t.visible=!1,s.visible=!1,!(e===null||!(e.background instanceof S.Texture)))if(e.background instanceof S.CubeTexture||e.background.mapping===S.CubeUVReflectionMapping){let i=e.background.isRenderTargetTexture?1:-1;Z.copy(e.backgroundRotation),Z.x*=-1,Z.y*=-1,Z.z*=-1,Z.y*=i,Z.z*=i,t.material.envMap=e.background,t.material.uniforms.flipEnvMap.value=i,t.material.uniforms.backgroundBlurriness.value=e.backgroundBlurriness,t.material.uniforms.backgroundIntensity.value=e.backgroundIntensity,t.material.uniforms.backgroundRotation.value.setFromMatrix4(Rs.makeRotationFromEuler(Z)),t.visible=!0}else s.material.map=e.background,s.material.uniforms.backgroundIntensity.value=e.backgroundIntensity,s.visible=!0}dispose(){this.skyBox.material.dispose(),this.background.material.dispose()}};var Pe=class{constructor(r=!0,e=!0,t=!0){n(this,"gBuffer");n(this,"depth");n(this,"stencil");this.gBuffer=new Set(["Normal","ORM","Emission"]),this.color=r,this.depth=e,this.stencil=t}get color(){return this.gBuffer.has("Color")}set color(r){r?this.gBuffer.add("Color"):this.gBuffer.delete("Color")}};var $t=h("three");var De=class extends $t.EventDispatcher{constructor(){super();n(this,"_color");n(this,"_alpha");n(this,"gBuffer");this._color=null,this._alpha=null;let e=new B([["Normal",[0,0]],["ORM",[1,0,0,1]],["Emission",[0,0,0,1]]]);e.addEventListener("change",()=>this.setChanged()),this.gBuffer=e}get color(){return this._color}set color(e){this._color=e,this.setChanged()}get alpha(){return this._alpha}set alpha(e){this._alpha=e,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}};var _s=new pe.Color,T=new Float32Array(4),$=class a extends R{constructor(e=!0,t=!0,s=!0){super("ClearPass");n(this,"clearFlags");n(this,"clearValues");n(this,"gBufferIndices");n(this,"background");n(this,"backgroundScene");this.clearFlags=new Pe(e,t,s),this.clearValues=new De,this.gBufferIndices=null,this.background=new Ce,this.background.setClearValues(this.clearValues),this.clearValues.addEventListener("change",()=>this.background.setClearValues(this.clearValues)),this.backgroundScene=new pe.Scene,this.backgroundScene.add(this.background),this.disposables.add(this.background)}clearBuffers(e,t){let s=this.clearFlags,i=this.clearValues.gBuffer;for(let o of t){let f=i.get(o[0]);!s.gBuffer.has(o[0])||f===void 0||(typeof f=="number"?(T[0]=f,T[1]=0,T[2]=0,T[3]=1):(T[0]=f.length>0?f[0]:0,T[1]=f.length>1?f[1]:0,T[2]=f.length>2?f[2]:0,T[3]=f.length>3?f[3]:1),e.clearBufferfv(e.COLOR,o[1],T))}}clear(e=this.clearValues.color){var o;let t=this.renderer,s=t.getContext(),i=(o=this.clearValues.alpha)!=null?o:t.getClearAlpha();e!=null||(e=t.getClearColor(_s)),T[0]=e.r,T[1]=e.g,T[2]=e.b,T[3]=i,s.clearBufferfv(s.COLOR,0,T),this.gBufferIndices!==null&&this.gBufferIndices.size>1&&this.clearBuffers(s,this.gBufferIndices)}clearWithBackground(){let e=this.scene,t=this.camera,s=this.renderer;e.background instanceof pe.Color?this.clear(e.background):(this.background.update(e),s.render(this.backgroundScene,t))}onOutputChange(){var t,s;let e=(s=(t=this.output.defaultBuffer)==null?void 0:t.value)!=null?s:null;this.gBufferIndices=e!==null?ne(e):null}compile(){return G(this,null,function*(){this.renderer===null||this.camera===null||(yield Promise.all([J(a.prototype,this,"compile").call(this),this.renderer.compileAsync(this.backgroundScene,this.camera)]))})}render(){var i,o,f;if(this.renderer===null)return;let e=(o=(i=this.scene)==null?void 0:i.background)!=null?o:null,t=this.clearValues.color!==null,s=this.clearFlags;this.setRenderTarget((f=this.output.defaultBuffer)==null?void 0:f.value),(s.depth||s.stencil)&&this.renderer.clear(!1,s.depth,s.stencil),!t&&this.camera!==null&&e!==null?this.clearWithBackground():this.clear()}};var p=h("three");var Xt=h("three");var Ct=(f=>(f.COLOR="color",f.DEPTH="depth",f.NORMAL="normal",f.POSITION="position",f.ORM="orm",f.EMISSION="emission",f.LUMINANCE="luminance",f))(Ct||{});var Fe=class extends Xt.EventDispatcher{constructor(){super();n(this,"textureConfigs");n(this,"gBufferStructFields");n(this,"gBufferStructDeclaration");n(this,"gDataStructDeclaration");n(this,"gDataStructInitialization");n(this,"gDataDependencies");n(this,"gDataBufferSources");let e=new B,t=new B([["Color","color"],["Depth","depth"],["Normal","normal"],["ORM","orm"],["Emission","emission"]]),s=new B([["Color","FRAME_BUFFER_PRECISION sampler2D color;"],["Depth","DEPTH_BUFFER_PRECISION sampler2D depth;"],["Normal","mediump sampler2D normal;"],["ORM","lowp sampler2D orm;"],["Emission","mediump sampler2D emission;"]]),i=new B([["color","vec4 color;"],["depth","float depth;"],["normal","vec3 normal;"],["position","vec3 position;"],["orm","vec3 orm;"],["emission","vec3 emission;"],["luminance","float luminance;"]]),o=new B([["color","gData.color = texture(gBuffer.color, UV);"],["depth","gData.depth = readDepth(gBuffer.depth, UV);"],["normal","gData.normal = readNormal(gBuffer.normal, UV);"],["position","gData.position = getViewPosition(UV, gData.depth);"],["orm","gData.orm = texture(gBuffer.orm, UV).xyz;"],["emission","gData.emission = texture(gBuffer.emission, UV).rgb;"],["luminance","gData.luminance = luminance(gData.color.rgb);"]]),f=new B([["position",new Set(["depth"])],["luminance",new Set(["color"])]]),u=new B([["color",new Set(["Color"])],["depth",new Set(["Depth"])],["normal",new Set(["Normal"])],["position",new Set(["Depth"])],["orm",new Set(["ORM"])],["emission",new Set(["Emission"])],["luminance",new Set(["Color"])]]),c=()=>this.dispatchEvent({type:"change"});e.addEventListener("change",c),t.addEventListener("change",c),s.addEventListener("change",c),i.addEventListener("change",c),o.addEventListener("change",c),f.addEventListener("change",c),u.addEventListener("change",c),this.textureConfigs=e,this.gBufferStructFields=t,this.gBufferStructDeclaration=s,this.gDataStructDeclaration=i,this.gDataStructInitialization=o,this.gDataDependencies=f,this.gDataBufferSources=u}};var ae=class ae extends Set{constructor(e,t=ae.idManager.getNextId()){super();n(this,"_layer");n(this,"enabled");n(this,"exclusive");this._layer=t,(this._layer<1||this._layer>31)&&(console.warn("Layer out of range, resetting to 2"),ae.idManager.reset(2),this._layer=ae.idManager.getNextId()),this.enabled=!0,this.exclusive=!1,e!=null&&this.set(e)}get layer(){return this._layer}set layer(e){let t=this._layer;for(let s of this)s.layers.disable(t),s.layers.enable(e);this._layer=e}clear(){let e=this.layer;for(let t of this)t.layers.disable(e);super.clear()}add(e){return this.exclusive?e.layers.set(this.layer):e.layers.enable(this.layer),super.add(e)}delete(e){return this.has(e)&&e.layers.disable(this.layer),super.delete(e)}set(e){this.clear();for(let t of e)this.add(t);return this}toggle(e){let t;return this.has(e)?(this.delete(e),t=!1):(this.add(e),t=!0),t}setVisible(e){for(let t of this)e?t.layers.enable(0):t.layers.disable(0);return this}};n(ae,"idManager",new L(2));var we=ae;var he=h("three");var Kt=`#include <common>
#include <pp_default_output_pars_fragment>
#ifdef COLOR_WRITE
#include <dithering_pars_fragment>
#include <pp_input_buffer_pars_fragment>
#endif
#ifdef DEPTH_WRITE
#include <pp_depth_buffer_pars_fragment>
#endif
#ifdef USE_WEIGHTS
uniform vec4 channelWeights;
#endif
in vec2 vUv;void main(){
#ifdef COLOR_WRITE
vec4 texel=texture2D(inputBuffer,vUv);
#ifdef USE_WEIGHTS
texel*=channelWeights;
#endif
out_Color=texel;
#ifdef COLOR_SPACE_CONVERSION
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
#else
out_Color=vec4(0.0);
#endif
#ifdef DEPTH_WRITE
gl_FragDepth=texture(depthBuffer,vUv).r;
#endif
}`;var Ge=class extends C{constructor(){super({name:"CopyMaterial",fragmentShader:Kt,vertexShader:Se,defines:{COLOR_SPACE_CONVERSION:!0,COLOR_WRITE:!0},uniforms:{depthBuffer:new he.Uniform(null),channelWeights:new he.Uniform(null)}}),this.depthFunc=he.AlwaysDepth}get inputBuffer(){return super.inputBuffer}set inputBuffer(r){let e=r!==null;this.colorWrite!==e&&(e?this.defines.COLOR_WRITE=!0:delete this.defines.COLOR_WRITE,this.colorWrite=e,this.needsUpdate=!0),super.inputBuffer=r}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(r){let e=r!==null;this.depthWrite!==e&&(e?this.defines.DEPTH_WRITE=!0:delete this.defines.DEPTH_WRITE,this.depthTest=e,this.depthWrite=e,this.needsUpdate=!0),this.uniforms.depthBuffer.value=r}get colorSpaceConversion(){return this.defines.COLOR_SPACE_CONVERSION!==void 0}set colorSpaceConversion(r){this.colorSpaceConversion!==r&&(r?this.defines.COLOR_SPACE_CONVERSION=!0:delete this.defines.COLOR_SPACE_CONVERSION,this.needsUpdate=!0)}get channelWeights(){return this.uniforms.channelWeights.value}set channelWeights(r){r!==null?(this.defines.USE_WEIGHTS=!0,this.uniforms.channelWeights.value=r):delete this.defines.USE_WEIGHTS,this.needsUpdate=!0}};var Oe=class Oe extends R{constructor(r){super("CopyPass"),this.output.defaultBuffer=r!=null?r:this.createFramebuffer(),this.fullscreenMaterial=new Ge}get renderer(){return super.renderer}set renderer(r){super.renderer=r,this.initializeOutputBuffer()}initializeOutputBuffer(){var e,t;let r=(t=(e=this.output.defaultBuffer)==null?void 0:e.value)!=null?t:null;this.renderer!==null&&r!==null&&this.renderer.initRenderTarget(r)}configureDepthBuffer(){var s,i,o;let r=this.input.getBuffer("Depth"),e=(o=(i=(s=this.output.defaultBuffer)==null?void 0:s.value)==null?void 0:i.depthTexture)!=null?o:null,t=r===e;this.fullscreenMaterial.depthBuffer=r===null||t?null:r}onInputChange(){this.configureDepthBuffer()}onOutputChange(){this.configureDepthBuffer(),this.initializeOutputBuffer()}onResolutionChange(){this.initializeOutputBuffer()}blit(){var i,o,f,u;if(!Oe.blitEnabled)return!1;let r=(o=(i=this.input.defaultBuffer)==null?void 0:i.value)!=null?o:null,e=(u=(f=this.output.defaultBuffer)==null?void 0:f.value)!=null?u:null;if(this.renderer===null||r===null||e===null)return!1;let t=r.source.data;if(t.width!==e.width||t.height!==e.height)return!1;r.type===e.texture.type&&r.format===e.texture.format&&this.renderer.copyTextureToTexture(r,e.texture);let s=this.input.getBuffer("Depth");return s!==null&&e.depthTexture!==null&&s!==e.depthTexture&&s.type===e.depthTexture.type&&s.format===e.depthTexture.format&&this.renderer.copyTextureToTexture(s,e.depthTexture),!0}render(){var e,t,s;let r=(t=(e=this.input.defaultBuffer)==null?void 0:e.value)!=null?t:null;this.renderer===null||r===null||this.blit()||(this.setRenderTarget((s=this.output.defaultBuffer)==null?void 0:s.value),this.renderFullscreen())}};n(Oe,"blitEnabled",!1);var Le=Oe;var qt=h("three");var Ie=class{constructor(){n(this,"registeredMaterials",new WeakSet);n(this,"_enabled");n(this,"_gBuffer");this._enabled=!0,this._gBuffer=null}get enabled(){return this._enabled}set enabled(r){this._enabled=r}get gBuffer(){return this._gBuffer}set gBuffer(r){this._gBuffer=r}applyTo(r){if(this.registeredMaterials.has(r))return;this.registeredMaterials.add(r);let e=r.onBeforeCompile,t=r.customProgramCacheKey;r.onBeforeCompile=(s,i)=>{if(r.onBeforeCompile!==e&&e.call(r,s,i),!(!this.enabled||this.gBuffer===null)&&(r instanceof qt.ShaderMaterial&&(s.fragmentShader=ye(s.fragmentShader)),!s.fragmentShader.includes("out_FragData"))){let o=Te(this.gBuffer);s.fragmentShader=o+`
`+s.fragmentShader}},r.customProgramCacheKey=()=>{var o,f;let s="";r.customProgramCacheKey!==t&&(s+=t.call(r));let i=(f=(o=this.gBuffer)==null?void 0:o.texture.uuid)!=null?f:"";return s+this.enabled+i}}};var X=class a extends R{constructor(e,t,{alpha:s=!1,stencilBuffer:i=!1,depthBuffer:o=!0,frameBufferType:f=p.HalfFloatType,samples:u=0,gBufferConfig:c=new Fe}={}){super("GeometryPass");n(this,"selection");n(this,"copyPass");n(this,"gBufferShaderPlugin");n(this,"gBufferResource");n(this,"gBufferComponents");n(this,"alpha");n(this,"stencilBuffer");n(this,"depthBuffer");n(this,"frameBufferType");n(this,"gBufferConfig");n(this,"_samples");this.alpha=s,this.stencilBuffer=i,this.depthBuffer=o,this.frameBufferType=f,this._samples=u,this.selection=new we,this.selection.enabled=!1,this.gBufferConfig=c,this.copyPass=new Le,this.copyPass.enabled=!1,this.subpasses=[this.copyPass];let d=new ee;d.addEventListener("change",()=>this.updateGBuffer()),this.gBufferComponents=d,this.gBufferShaderPlugin=new Ie,this.gBufferResource=new q,this.output.defaultBuffer=this.gBufferResource,this.scene=e,this.camera=t,this.updateTextureConfigs()}get enabled(){return super.enabled}set enabled(e){super.enabled!==e&&(super.enabled=e,this.gBufferShaderPlugin.enabled=e,this.invalidateMaterials())}get scene(){return super.scene}set scene(e){super.scene=e,e!==null&&this.onSceneChildAdded(e)}get samples(){return this._samples}set samples(e){var s,i;this._samples=e;let t=(i=(s=this.output.defaultBuffer)==null?void 0:s.value)!=null?i:null;t!==null&&t.samples!==e&&(t.samples=e,t.dispose())}get gBuffer(){return this.gBufferResource.value}get frameBufferPrecisionHigh(){return this.frameBufferType===p.HalfFloatType||this.frameBufferType===p.FloatType}get textureConfigs(){return Array.from(this.gBufferConfig.textureConfigs).filter(e=>this.gBufferComponents.has(e[0]))}get renderer(){return super.renderer}set renderer(e){super.renderer=e,this.updateOutputBufferColorSpace()}invalidateMaterial(e){if(!("material"in e))return;let t=Array.isArray(e.material)?e.material:[e.material];for(let s of t)s.needsUpdate=!0}invalidateMaterials(){var e;(e=this.scene)==null||e.traverse(t=>this.invalidateMaterial(t))}updateTextureConfigs(){let e=this.gBufferConfig.textureConfigs,t=this.frameBufferPrecisionHigh&&!this.alpha;e.set("Color",{minFilter:p.LinearFilter,magFilter:p.LinearFilter,type:this.frameBufferType,format:t?p.RGBFormat:p.RGBAFormat,internalFormat:t?"R11F_G11F_B10F":void 0,isColorBuffer:!0}),e.set("Normal",{minFilter:p.NearestFilter,magFilter:p.NearestFilter,type:p.HalfFloatType,format:p.RGFormat}),e.set("ORM",{minFilter:p.NearestFilter,magFilter:p.NearestFilter,type:p.UnsignedByteType,format:p.RGBAFormat}),e.set("Emission",{minFilter:p.LinearFilter,magFilter:p.LinearFilter,type:p.HalfFloatType,format:p.RGBAFormat}),this.updateGBuffer()}updateMaterial(e){if(!("material"in e))return;let t=Array.isArray(e.material)?e.material:[e.material];for(let s of t)this.gBufferShaderPlugin.applyTo(s)}updateOutputBufferColorSpace(){let e=this.gBuffer,t=this.renderer;if(e===null||t===null)return;let s=ne(e),i=this.autoSRGB&&!this.frameBufferPrecisionHigh&&t.outputColorSpace===p.SRGBColorSpace;for(let o of this.textureConfigs)if(o[1].isColorBuffer===!0&&s.has(o[0])){let f=s.get(o[0]),u=e.textures[f];u.colorSpace=i?p.SRGBColorSpace:p.NoColorSpace,u.needsUpdate=!0}}updateGBuffer(){var u,c,d;let e=this.output,t=this.gBufferComponents;if(!e.hasDefaultBuffer)e.defaultBuffer=this.gBufferResource;else if(e.defaultBuffer!==this.gBufferResource)return;if((c=(u=e.defaultBuffer.value)==null?void 0:u.depthTexture)==null||c.dispose(),(d=e.defaultBuffer.value)==null||d.dispose(),t.size===0){e.defaultBuffer=null,e.defines.clear();return}let{width:s,height:i}=this.resolution,o=this.textureConfigs,f=new p.WebGLRenderTarget(s,i,{stencilBuffer:this.stencilBuffer,depthBuffer:this.depthBuffer,samples:this.samples,count:o.length});for(let g=0,w=o.length;g<w;++g){let m=o[g],x=f.textures[g],z=m[1];x.name=m[0],x.minFilter=z.minFilter,x.magFilter=z.magFilter,x.format=z.format,x.type=z.type,z.internalFormat!==void 0&&(x.internalFormat=z.internalFormat)}e.defaultBuffer=f,this.configureDepthTexture(),this.updateOutputBufferColorSpace()}configureDepthTexture(){var i,o,f,u,c;let e=this.output;if(e.defaultBuffer!==this.gBufferResource)return;let t=(o=(i=e.defaultBuffer)==null?void 0:i.value)!=null?o:null;if(t===null)return;if(!this.gBufferComponents.has("Depth")){(f=t.depthTexture)==null||f.dispose(),t.depthTexture=null;return}let s=this.input.getBuffer("Depth");if(s!==null)t.depthTexture!==s&&((u=t.depthTexture)==null||u.dispose(),t.depthTexture=s);else{let d=new p.DepthTexture(1,1);d.name="Depth",d.format=this.stencilBuffer?p.DepthStencilFormat:p.DepthFormat,d.type=this.stencilBuffer?p.UnsignedInt248Type:p.FloatType,(c=t.depthTexture)==null||c.dispose(),t.depthTexture=d}}updateCopyPass(){var o,f,u,c,d;let e=(f=(o=this.input.defaultBuffer)==null?void 0:o.value)!=null?f:null,t=(c=(u=this.output.defaultBuffer)==null?void 0:u.value)!=null?c:null,s=e===(t==null?void 0:t.texture),i=((d=t==null?void 0:t.textures.length)!=null?d:0)>1;this.copyPass.enabled=e!==null&&!s&&!i}onInputChange(){this.configureDepthTexture();let e=this.copyPass;e.input.defaultBuffer=this.input.defaultBuffer,this.updateCopyPass(),this.input.buffers.has("Depth")?e.input.buffers.set("Depth",this.input.buffers.get("Depth")):e.input.buffers.delete("Depth")}onOutputChange(){var e,t;this.output.hasDefaultBuffer?this.configureDepthTexture():(this.gBufferResource.mute(),this.updateGBuffer(),this.gBufferResource.unmute()),this.gBufferShaderPlugin.gBuffer=(t=(e=this.output.defaultBuffer)==null?void 0:e.value)!=null?t:null,this.copyPass.output.defaultBuffer=this.output.defaultBuffer,this.updateCopyPass()}onResolutionChange(){this.copyPass.resolution.copy(this.resolution)}onSceneChildAdded(e){e.traverse(t=>this.updateMaterial(t))}compile(){return G(this,null,function*(){if(this.renderer===null||this.scene===null||this.camera===null)return;let e=[];e.push(J(a.prototype,this,"compile").call(this)),e.push(this.renderer.compileAsync(this.scene,this.camera)),yield Promise.all(e)})}render(){var f;let{renderer:e,scene:t,camera:s}=this;if(e===null||t===null||s===null)return;let i=s.layers.mask,o=t.background;t.background=null,this.selection.enabled&&s.layers.set(this.selection.layer),this.copyPass.enabled&&this.copyPass.render(),this.setRenderTarget((f=this.output.defaultBuffer)==null?void 0:f.value),e.render(t,s),s.layers.mask=i,t.background=o}};function Qt(a,r){for(let e of a.input.buffers.values())r.add(e);for(let e of a.output.buffers.values())r.add(e);for(let e of a.subpasses)Qt(e,r)}var Ue=class{constructor(r){n(this,"pipelines");n(this,"activeResources");this.pipelines=r,this.activeResources=new Set}gatherResources(){let r=new Set;for(let e of this.pipelines)for(let t of e.passes)Qt(t,r);return r}optimize(){let r=this.gatherResources();for(let e of this.activeResources)e instanceof W&&!r.has(e)&&e.dispose();this.activeResources=r}};var Ne=class a{constructor(){n(this,"pipelines");n(this,"resourceManager");n(this,"outputDefaultBuffers");n(this,"updating");this.pipelines=new Set,this.resourceManager=new Ue(this.pipelines),this.outputDefaultBuffers=new WeakMap,this.updating=!1}updateInput(r){let e=a.findMainGeometryPass(r),t=r.passes.filter(i=>i.enabled);for(let i=0,o=1,f=t.length;i<f;++i,++o){let u=t[i];if(u!==e){if(o<f&&u instanceof $){let c=t[o];u.scene=c.scene,u.camera=c.camera}else!(u instanceof X)&&e!==void 0&&(u.scene=e.scene,u.camera=e.camera);a.assignGBufferTextures(u,e)}}let s;for(let i=0,o=1,f=t.length;o<f;++i,++o){let u=t[i],c=t[o];!(u instanceof $)&&u.output.hasDefaultBuffer&&u.output.defaultBuffer.value!==null&&(s=u.output.defaultBuffer),u.output.defines.forEach((d,g)=>c.input.defines.set(g,d)),u.output.uniforms.forEach((d,g)=>c.input.uniforms.set(g,d)),s===void 0?c.input.buffers.delete(te.BUFFER_DEFAULT):s!==void 0&&(c.input.defaultBuffer=s.texture)}}restoreOutputBuffers(r){let e=this.outputDefaultBuffers;for(let t of r)if(t.output.defaultBuffer!==null&&e.has(t.output.defaultBuffer)){let s=e.get(t.output.defaultBuffer);e.delete(t.output.defaultBuffer),t.output.defaultBuffer=s}}updateOutput(r){let e=r.passes.filter(t=>t.enabled);if(r.autoRenderToScreen&&e.length>0){this.restoreOutputBuffers(e);let t=this.outputDefaultBuffers,s=e[e.length-1];s.output.defaultBuffer!==null&&(t.set(s.output.defaultBuffer,s.output.defaultBuffer.value),s.output.defaultBuffer=null)}for(let t=0,s=1,i=e.length;s<i;++t,++s){let o=e[t];if(o instanceof $){let f=e[s];f.output.defines.forEach((u,c)=>o.output.defines.set(c,u)),f.output.uniforms.forEach((u,c)=>o.output.uniforms.set(c,u)),o.output.defaultBuffer=f.output.defaultBuffer}}}addPipeline(r){this.pipelines.add(r)}removePipeline(r){this.pipelines.delete(r)}updatePipeline(r){a.gatherGBufferComponents(r),this.updateOutput(r),this.updateInput(r)}update(){if(!this.updating){this.updating=!0;for(let r of this.pipelines)this.updatePipeline(r);this.resourceManager.optimize(),this.updating=!1}}static findMainGeometryPass(r){return r.passes.find(e=>e.enabled&&e instanceof X)}static gatherGBufferComponents(r){let e=a.findMainGeometryPass(r);if(e===void 0)return;e.gBufferComponents.clear();for(let s of r.passes.filter(i=>i.enabled))for(let i of s.input.gBuffer)e.gBufferComponents.add(i);let t=r.passes.filter(s=>s.enabled&&s instanceof X);if(!(t.length<=1||!e.gBufferComponents.has("Color")))for(let s=1,i=t.length;s<i;++s){let o=t[s];o.gBufferComponents.add("Color"),o.depthBuffer&&(o.gBufferComponents.add("Depth"),o.input.gBuffer.add("Depth"),e.gBufferComponents.add("Depth"))}}static assignGBufferTextures(r,e){if(e===void 0||e.gBuffer===null)return;r.input.gBufferConfig=e.gBufferConfig;let t=ne(e.gBuffer);for(let s of r.input.gBuffer)if(s==="Depth")r.input.buffers.set(s,new O(e.gBuffer.depthTexture));else if(t.has(s)){let i=t.get(s);r.input.buffers.set(s,new O(e.gBuffer.textures[i]))}}};var Y=h("three");var b=h("three");var Zt=`uniform mat4 projectionMatrix;uniform mat4 projectionMatrixInverse;uniform vec3 cameraParams;
#define CAMERA_NEAR cameraParams.x
#define CAMERA_FAR cameraParams.y
#define CAMERA_ASPECT cameraParams.z
#ifdef PERSPECTIVE_CAMERA
#define getViewZ(depth) perspectiveDepthToViewZ(depth, CAMERA_NEAR, CAMERA_FAR)
#else
#define getViewZ(depth) orthographicDepthToViewZ(depth, CAMERA_NEAR, CAMERA_FAR)
#endif
vec3 getViewPosition(const in vec2 screenPosition,const in float depth,const in float viewZ){vec4 clipPosition=vec4(vec3(screenPosition,depth)*2.0-1.0,1.0);float clipW=projectionMatrix[2][3]*viewZ+projectionMatrix[3][3];clipPosition*=clipW;return(projectionMatrixInverse*clipPosition).xyz;}vec3 getViewPosition(const in vec2 screenPosition,const in float depth){return getViewPosition(screenPosition,depth,getViewZ(depth));}`;var Yt="vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}";var Jt=`#ifndef gl_FragColor
layout(location=0)out OUTPUT_COLOR_PRECISION vec4 out_FragData0;
#define gl_FragColor out_FragData0
#ifndef out_Color
#define out_Color out_FragData0
#endif
#endif`;var er=`#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif`;var tr=`#ifdef GL_FRAGMENT_PRECISION_HIGH
#define DEPTH_BUFFER_PRECISION highp
#else
#define DEPTH_BUFFER_PRECISION mediump
#endif`;var rr=`float readDepth(sampler2D depthBuffer,const in vec2 uv,const in float near,const in float far){float depth=texture(depthBuffer,uv).r;
#ifdef USE_REVERSEDEPTHBUF
return 1.0-depth;
#else
#ifdef USE_LOGDEPTHBUF
float d=pow(2.0,depth*log2(far+1.0))-1.0;float a=far/(far-near);float b=far*near/(near-far);depth=a+b/d;
#endif
return depth;
#endif
}
#if defined(CAMERA_NEAR) && defined(CAMERA_FAR)
#define readDepth(depthBuffer, uv) readDepth(depthBuffer, uv, CAMERA_NEAR, CAMERA_FAR);
#endif`;var sr=`#ifdef FRAME_BUFFER_PRECISION_HIGH
#define FRAME_BUFFER_PRECISION mediump
#else
#define FRAME_BUFFER_PRECISION lowp
#endif`;var ir=`#ifdef out_Color
out_Color=vec4(0.0);
#endif
#ifdef out_Emission
out_Emission=vec4(0.0);
#endif
#ifdef out_ORM
out_ORM=vec4(0.0);
#endif
#ifdef out_Normal
out_Normal=vec2(0.0);
#endif`;var nr=`#ifdef FRAME_BUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif`;var ar="uint uhash(uint x){x+=x>>11;x ^=x<<7;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}uint uhash(uvec2 p){uint x=p.x;x+=x>>11;x ^=x<<7;x+=p.y;x ^=x<<6;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}uint uhash(uvec3 p){uint x=p.x;x+=x>>11;x ^=x<<7;x+=p.y;x ^=x<<3;x+=p.z ^(x>>14);x ^=x<<6;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}float urand(uint h){const uint mantissaMask=0x007FFFFFu;const uint one=0x3F800000u;h&=mantissaMask;h|=one;float r2=uintBitsToFloat(h);return r2-1.0;}float urand(float p){return urand(uhash(floatBitsToUint(p)));}float urand(vec2 p){return urand(uhash(floatBitsToUint(p)));}float urand(vec3 p){return urand(uhash(floatBitsToUint(p)));}";var or="vec2 pp_encodeNormal(vec3 n){n/=(abs(n.x)+abs(n.y)+abs(n.z));n.xy=(n.z>=0.0)?n.xy:(1.0-abs(n.yx))*vec2(n.x>=0.0?1.0:-1.0,n.y>=0.0?1.0:-1.0);return n.xy;}vec3 pp_decodeNormal(vec2 f){vec3 n=vec3(f.x,f.y,1.0-abs(f.x)-abs(f.y));float t=clamp(-n.z,0.0,1.0);n.xy+=vec2(n.x>=0.0?-t:t,n.y>=0.0?-t:t);return normalize(n);}";var fr="vec3 readNormal(mediump sampler2D normalBuffer,const in vec2 uv){return pp_decodeNormal(texture(normalBuffer,uv).xy);}";var ur="uniform vec4 resolution;";var lr=`uniform mat4 viewMatrixInverse;
#define getWorldPosition(viewPosition) (viewMatrixInverse * vec4(viewPosition, 1.0)).xyz
#define getDistance(viewPosition) length(viewPosition)`;var Pt=`#ifdef out_Normal
out_Normal.xy=pp_encodeNormal(normal);
#endif`;var Dt=`#ifdef out_ORM
#ifdef USE_AOMAP
out_ORM.x=ambientOcclusion;
#else
out_ORM.x=1.0;
#endif
#endif`;var Ft=`#ifdef out_ORM
out_ORM.y=roughnessFactor;
#endif`;var cr=`#ifdef out_ORM
out_ORM.y=material.roughness;
#endif`;var wt=`#ifdef out_ORM
out_ORM.z=metalnessFactor;
#endif`;var Gt=`#ifdef out_Emission
out_Emission=vec4(totalEmissiveRadiance,1.0);
#endif`;var me=class me{static register(){if(me.registered)return;me.registered=!0,Object.assign(b.ShaderChunk,{pp_camera_pars_fragment:Zt,pp_colorspace_conversion_pars_fragment:Yt,pp_default_output_pars_fragment:Jt,pp_depth_buffer_pars_fragment:er,pp_depth_buffer_precision_pars_fragment:tr,pp_depth_utils_pars_fragment:rr,pp_frame_buffer_precision_pars_fragment:sr,pp_gbuffer_default_output_fragment:ir,pp_gbuffer_normal_fragment:Pt,pp_gbuffer_occlusion_fragment:Dt,pp_gbuffer_roughness_fragment:Ft,pp_gbuffer_metalness_fragment:wt,pp_gbuffer_emission_fragment:Gt,pp_input_buffer_pars_fragment:nr,pp_normal_codec_pars_fragment:or,pp_noise_pars_fragment:ar,pp_normal_utils_pars_fragment:fr,pp_resolution_pars_fragment:ur,pp_world_utils_pars_fragment:lr}),b.ShaderChunk.normal_fragment_maps+=`
`+Pt,b.ShaderChunk.aomap_fragment+=`
`+Dt,b.ShaderChunk.roughnessmap_fragment+=`
`+Ft,b.ShaderChunk.lights_physical_fragment+=`
`+cr,b.ShaderChunk.metalnessmap_fragment+=`
`+wt,b.ShaderChunk.emissivemap_fragment+=`
`+Gt;let r=[b.ShaderLib.background,b.ShaderLib.backgroundCube,b.ShaderLib.basic,b.ShaderLib.cube,b.ShaderLib.dashed,b.ShaderLib.lambert,b.ShaderLib.matcap,b.ShaderLib.phong,b.ShaderLib.physical,b.ShaderLib.points,b.ShaderLib.sprite,b.ShaderLib.standard,b.ShaderLib.toon];for(let e of r)e.fragmentShader=ye(e.fragmentShader)}};n(me,"registered",!1);var Ve=me;var Ts=new Y.Vector2,E=class E{constructor(r=null){n(this,"_timer");n(this,"_passes");n(this,"_renderer");n(this,"_autoRenderToScreen");n(this,"resolution");n(this,"updateStyle");Ve.register(),E.ioManager.addPipeline(this),this._timer=new Y.Timer,this._passes=[],this._renderer=null,this._autoRenderToScreen=!0,this.resolution=new k,this.resolution.addEventListener("change",()=>this.onResolutionChange()),this.updateStyle=!0,this.renderer=r}get autoRenderToScreen(){return this._autoRenderToScreen}set autoRenderToScreen(r){this.autoRenderToScreen!==r&&(this._autoRenderToScreen=r,E.ioManager.update())}get renderer(){return this._renderer}set renderer(r){this._renderer=r;for(let e of this.passes)e.renderer=r;r!==null&&(r.autoClear=!1,this.setPixelRatio(r.getPixelRatio()),this.passes.length>0&&E.ioManager.update())}get timer(){return this._timer}get passes(){return this._passes}registerPass(r){E.registeredPasses.add(r),r.resolution.pixelRatio=this.resolution.scaledPixelRatio,r.resolution.copyBaseSize(this.resolution),r.renderer=this.renderer,r.timer=this.timer,r.attached=!0,r.addEventListener("toggle",E.listener),r.input.addEventListener("change",E.listener),r.output.addEventListener("change",E.listener)}unregisterPass(r){E.registeredPasses.delete(r),r.renderer=null,r.timer=null,r.attached=!1,r.removeEventListener("toggle",E.listener),r.input.removeEventListener("change",E.listener),r.output.removeEventListener("change",E.listener)}add(...r){for(let e of r){if(E.registeredPasses.has(e))throw new Error(`The pass "${e.name}" has already been added to a pipeline`);this.registerPass(e),this._passes.push(e)}E.ioManager.update()}remove(...r){let e=!1;for(let t of r){let s=this._passes,i=s.indexOf(t);i!==-1&&s.splice(i,1).length>0&&(this.unregisterPass(t),e=!0)}e&&E.ioManager.update()}removeAllPasses(){for(let r of this.passes)this.unregisterPass(r);this._passes=[],E.ioManager.update()}onResolutionChange(){let r=this.renderer;if(r===null){console.debug("Unable to update the render size because the renderer is null");return}let{baseWidth:e,baseHeight:t,pixelRatio:s,scaledPixelRatio:i,scale:o}=this.resolution,f=r.getSize(Ts);if(r.getPixelRatio()!==s&&r.setPixelRatio(s),o===1)(f.width!==e||f.height!==t)&&r.setSize(e,t,this.updateStyle);else{let u=e*o,c=t*o;(f.width!==u||f.height!==c)&&(this.updateStyle&&r.setSize(e,t,!0),r.setSize(u,c,!1))}for(let u of this.passes)u.resolution.pixelRatio=i,u.resolution.setBaseSize(e,t)}setPixelRatio(r){let e=this.updateStyle;this.updateStyle=!1,this.resolution.pixelRatio=r,this.updateStyle=e}setSize(r,e,t=!0){this.renderer!==null&&this.setPixelRatio(this.renderer.getPixelRatio());let s=this.updateStyle;this.updateStyle=t,this.resolution.setSize(r,e),this.updateStyle=s}setViewport(r,e=0,t=0,s=0){if(r instanceof Y.Vector4){let i=r;r=i.x,e=i.y,t=i.z,s=i.w}for(let i of this.passes)i.viewport.set(r,e,t,s)}setScissor(r,e=0,t=0,s=0){if(r instanceof Y.Vector4){let i=r;r=i.x,e=i.y,t=i.z,s=i.w}for(let i of this.passes)i.scissor.set(r,e,t,s)}compile(){return G(this,null,function*(){let r=[];for(let e of this.passes)r.push(e.compile());yield Promise.all(r)})}render(r){if(this.renderer===null)return;this._timer.update(r);let e=this.renderer,t=e.info.autoReset;t&&(e.info.reset(),e.info.autoReset=!1);for(let s of this.passes)s.enabled&&s.render();e.info.autoReset=t}dispose(){E.ioManager.removePipeline(this);for(let r of this.passes)r.dispose();this.removeAllPasses(),this._timer.dispose(),R.fullscreenGeometry.dispose()}};n(E,"ioManager",new Ne),n(E,"registeredPasses",new WeakSet),n(E,"listener",()=>E.ioManager.update());var ke=E;var Lt=(t=>(t[t.DOT=1]="DOT",t[t.HATCH=2]="HATCH",t[t.SQUARE=3]="SQUARE",t))(Lt||{});var He=class He{constructor(r,e,t=!1){n(this,"id");n(this,"name");n(this,"shader");n(this,"supportsHDR");this.id=He.idManager.getNextId(),this.name=r,this.shader=e,this.supportsHDR=t}};n(He,"idManager",new L);var l=He;var We=h("three");var ze=class extends We.EventDispatcher{constructor(e,t=1){super();n(this,"_blendFunction");n(this,"opacityUniform");this._blendFunction=e,this.opacityUniform=new We.Uniform(t)}get opacity(){return this.opacityUniform.value}set opacity(e){this.opacityUniform.value=e}get blendFunction(){return this._blendFunction}set blendFunction(e){this._blendFunction=e,this.dispatchEvent({type:"change"})}};var dr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var je=class extends l{constructor(){super("add",dr,!0)}};var pr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,src.a*opacity);}";var $e=class extends l{constructor(){super("alpha",pr,!0)}};var hr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=(dst.rgb+src.rgb)*0.5;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Xe=class extends l{constructor(){super("average",hr,!0)}};var mr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.xy,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Ke=class extends l{constructor(){super("color",mr)}};var gr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=mix(step(0.0,b)*(1.0-min(vec3(1.0),(1.0-a)/max(b,1e-9))),vec3(1.0),step(1.0,a));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var qe=class extends l{constructor(){super("color-burn",gr)}};var vr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=step(0.0,a)*mix(min(vec3(1.0),a/max(1.0-b,1e-9)),vec3(1.0),step(1.0,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var oe=class extends l{constructor(){super("color-dodge",vr)}};var Ar="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Qe=class extends l{constructor(){super("darken",Ar,!0)}};var br="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=abs(dst.rgb-src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Ze=class extends l{constructor(){super("difference",br,!0)}};var Er="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb/max(src.rgb,1e-9);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Ye=class extends l{constructor(){super("divide",Er,!0)}};var Je=class extends l{constructor(){super("dst",null,!0)}};var xr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-2.0*dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var et=class extends l{constructor(){super("exclusion",xr)}};var Sr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb,1.0);vec3 b=min(src.rgb,1.0);vec3 c=mix(2.0*a*b,1.0-2.0*(1.0-a)*(1.0-b),step(0.5,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var tt=class extends l{constructor(){super("hard-light",Sr)}};var Br="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=step(1.0,dst.rgb+src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var rt=class extends l{constructor(){super("hard-mix",Br)}};var Mr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.x,a.yz));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var st=class extends l{constructor(){super("hue",Mr)}};var Rr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var it=class extends l{constructor(){super("invert",Rr)}};var _r="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=src.rgb*max(1.0-dst.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var nt=class extends l{constructor(){super("invert-rgb",_r)}};var Tr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var at=class extends l{constructor(){super("lighten",Tr,!0)}};var yr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ot=class extends l{constructor(){super("linear-burn",yr)}};var Cr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb+src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ft=class extends l{constructor(){super("linear-dodge",Cr)}};var Pr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(2.0*src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ut=class extends l{constructor(){super("linear-light",Pr)}};var Dr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.xy,b.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var lt=class extends l{constructor(){super("luminosity",Dr)}};var Fr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,opacity);}";var ct=class extends l{constructor(){super("mix",Fr,!0)}};var wr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var dt=class extends l{constructor(){super("multiply",wr,!0)}};var Gr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-abs(1.0-dst.rgb-src.rgb),0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var pt=class extends l{constructor(){super("negation",Gr)}};var Lr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=2.0*src.rgb*dst.rgb;vec3 b=1.0-2.0*(1.0-src.rgb)*(1.0-dst.rgb);vec3 c=mix(a,b,step(0.5,dst.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ht=class extends l{constructor(){super("overlay",Lr)}};var Or="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 c=mix(mix(src2,dst.rgb,step(0.5*dst.rgb,src.rgb)),max(src2-1.0,vec3(0.0)),step(dst.rgb,src2-1.0));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var mt=class extends l{constructor(){super("pin-light",Or)}};var Ir="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb*dst.rgb/max(1.0-src.rgb,1e-9),1.0);vec3 c=mix(a,src.rgb,step(1.0,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var gt=class extends l{constructor(){super("reflect",Ir)}};var Ur="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.x,b.y,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var vt=class extends l{constructor(){super("saturation",Ur)}};var Nr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return src;}";var fe=class extends l{constructor(){super("src",Nr,!0)}};var Vr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-min(dst.rgb*src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var At=class extends l{constructor(){super("screen",Vr)}};var kr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 d=dst.rgb+(src2-1.0);vec3 w=step(0.5,src.rgb);vec3 a=dst.rgb-(1.0-src2)*dst.rgb*(1.0-dst.rgb);vec3 b=mix(d*(sqrt(dst.rgb)-dst.rgb),d*dst.rgb*((16.0*dst.rgb-12.0)*dst.rgb+3.0),w*(1.0-step(0.25,dst.rgb)));vec3 c=mix(a,b,w);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var bt=class extends l{constructor(){super("soft-light",kr)}};var Hr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Et=class extends l{constructor(){super("subtract",Hr)}};var zr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=mix(max(1.0-min((1.0-dst.rgb)/(2.0*src.rgb),1.0),0.0),min(dst.rgb/(2.0*(1.0-src.rgb)),1.0),step(0.5,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var xt=class extends l{constructor(){super("vivid-light",zr)}};var Ot=h("three");var ue=class extends R{constructor(e){super(e);n(this,"blendMode");n(this,"_fragmentShader");n(this,"_vertexShader");n(this,"_inputColorSpace");n(this,"_outputColorSpace");n(this,"gData");n(this,"optional");this.blendMode=new ze(new fe),this.blendMode.addEventListener("change",()=>this.setChanged()),this.input.addEventListener("change",()=>this.detectGDataUsage()),this._fragmentShader=null,this._vertexShader=null,this._inputColorSpace=Ot.NoColorSpace,this._outputColorSpace=Ot.NoColorSpace,this.gData=new Set,this.optional=!1}get enabled(){return super.enabled}set enabled(e){super.enabled!==e&&(this.optional=!0),super.enabled=e}get fragmentShader(){return this._fragmentShader}set fragmentShader(e){this._fragmentShader=e,this.detectGDataUsage(),this.setChanged()}get vertexShader(){return this._vertexShader}set vertexShader(e){this._vertexShader=e,this.setChanged()}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(e){this._inputColorSpace=e,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e,this.setChanged()}get hasMainImageFunction(){return this.fragmentShader===null?!1:/vec4\s+mainImage\s*\([a-z\s]*vec4\s+\w+,[a-z\s]*vec2\s+\w+,[a-z\s]*GData\s+\w+\)/.test(this.fragmentShader)}get hasMainUvFunction(){return this.fragmentShader===null?!1:/void\s+mainUv\s*\(\s*inout\s+vec2\s+\w+\)/.test(this.fragmentShader)}get hasMainSupportFunction(){return this.vertexShader===null?!1:/void\s+mainSupport\s*\([a-z\s]*vec2\s+\w+\)/.test(this.vertexShader)}detectGDataUsage(){var i,o;if(this.gData.clear(),this.input.gBufferConfig===null||!this.hasMainImageFunction)return;let e=this.fragmentShader,t=this.input.gBufferConfig,s=/GData\s+(\w+)/.exec(e)[1];for(let f of Object.values(Ct))if(e.includes(`${s}.${f}`)){for(let u of(i=t.gDataDependencies.get(f))!=null?i:[])this.gData.add(u);this.gData.add(f)}for(let f of this.gData)for(let u of(o=t.gDataBufferSources.get(f))!=null?o:[])this.input.gBuffer.has(u)||(this.input.gBuffer.add(u),console.warn(`${this.name} uses ${f} but does not declare input G-Buffer component ${u}`))}validate(){if(this.fragmentShader===null)throw new Error(`Missing fragment shader (${this.name})`);if(!this.hasMainImageFunction&&!this.hasMainUvFunction)throw new Error(`Could not find a valid mainImage or mainUv function (${this.name})`)}render(){}};var le=h("three");var Wr=`#define SHAPE_DOT 1
#define SHAPE_HATCH 2
#define SHAPE_SQUARE 3
uniform vec2 rotation;uniform float invRadius;uniform float bias;float hatchHalftone(vec2 uv){return 1.0-2.0*abs(uv.y-0.5);}float squareHalftone(vec2 uv){float s=2.0*max(abs(uv.x-0.5),abs(uv.y-0.5));return 1.0-pow2(s);}float dotHalftone(vec2 uv){const float invDiag=1.414213562373095;return 1.0-distance(uv,vec2(0.5))*invDiag;}float getSample(vec2 p,float threshold){
#if SHAPE == SHAPE_DOT
float halftone=dotHalftone(p);
#elif SHAPE == SHAPE_HATCH
float halftone=hatchHalftone(p);
#elif SHAPE == SHAPE_SQUARE
float halftone=squareHalftone(p);
#endif
halftone=1.0-halftone;return(halftone<threshold)?1.0:0.0;}vec4 mainImage(const in vec4 inputColor,const in vec2 uv,const in GData gData){vec2 p=uv*resolution.xy;mat2 r=mat2(rotation.y,rotation.x,-rotation.x,rotation.y);float threshold=gData.luminance-bias;float pattern=0.0;for(int x=0;x<SAMPLES;x++){for(int y=0;y<SAMPLES;y++){vec2 coord=p+vec2(x,y)*INV_SAMPLES;coord=coord*r*invRadius;vec2 gridUv=fract(coord);pattern+=getSample(gridUv,threshold);}}pattern*=INV_SAMPLES_SQ;
#ifdef INVERTED
vec3 result=vec3(1.0-pattern);
#else
vec3 result=vec3(pattern);
#endif
#ifdef PREMULTIPLY
result*=inputColor.rgb;
#endif
return vec4(result,inputColor.a);}`;var St=class extends ue{constructor({shape:e=1,radius:t=6,rotation:s=.7513,samples:i=6,bias:o=0,premultiply:f=!1,inverted:u=!1}={}){super("HalftoneEffect");n(this,"_radius");n(this,"_rotation");this.fragmentShader=Wr,this.blendMode.blendFunction=new oe;let c=this.input.uniforms;c.set("invRadius",new le.Uniform(1)),c.set("rotation",new le.Uniform(new le.Vector2)),c.set("bias",new le.Uniform(o)),this._radius=t,this._rotation=s,this.shape=e,this.rotation=s,this.samples=i,this.premultiply=f,this.inverted=u}get shape(){return this.input.defines.get("SHAPE")}set shape(e){this.input.defines.set("SHAPE",e),this.setChanged()}get samples(){return this.input.defines.get("SAMPLES")}set samples(e){e=Math.max(e,1),this.input.defines.set("SAMPLES",e),this.input.defines.set("INV_SAMPLES",(1/e).toFixed(9)),this.input.defines.set("INV_SAMPLES_SQ",(1/(e*e)).toFixed(9)),this.setChanged()}get radius(){return this._radius}set radius(e){this._radius=e,this.onResolutionChange()}get rotation(){return this._rotation}set rotation(e){this.input.uniforms.get("rotation").value.set(Math.sin(e),Math.cos(e)),this._rotation=e}get bias(){return this.input.uniforms.get("bias").value}set bias(e){this.input.uniforms.get("bias").value=e}get premultiply(){return this.input.defines.has("PREMULTIPLY")}set premultiply(e){this.premultiply!==e&&(e?this.input.defines.set("PREMULTIPLY",!0):this.input.defines.delete("PREMULTIPLY"),this.setChanged())}get inverted(){return this.input.defines.has("INVERTED")}set inverted(e){this.inverted!==e&&(e?this.input.defines.set("INVERTED",!0):this.input.defines.delete("INVERTED"),this.setChanged())}onResolutionChange(){let e=this.radius*this.resolution.scaledPixelRatio;this.input.uniforms.get("invRadius").value=1/Math.max(e,1e-9)}};var $r=h("three");var U=h("three");var Bt=class extends U.EventDispatcher{constructor(){super();n(this,"uniform");n(this,"_enabled");this.uniform=new U.Uniform({slope:new U.Vector3(1,1,1),offset:new U.Vector3(0,0,0),power:new U.Vector3(1,1,1),saturation:1}),this._enabled=!0}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.dispatchEvent({type:"toggle"})}get slope(){return this.uniform.value.slope}get offset(){return this.uniform.value.offset}get power(){return this.uniform.value.power}get saturation(){return this.uniform.value.saturation}set saturation(e){this.uniform.value.saturation=e}applyPreset(e){switch(e){case 0:this.slope.set(1,1,1),this.offset.set(0,0,0),this.power.set(1,1,1),this.saturation=1;break;case 1:this.slope.set(1,.9,.5),this.offset.set(0,0,0),this.power.set(.8,.8,.8),this.saturation=.8;break;case 2:this.slope.set(1,1,1),this.offset.set(0,0,0),this.power.set(1.35,1.35,1.35),this.saturation=1.4;break;case 3:this.slope.set(1.05,1.05,1.05),this.offset.set(0,0,0),this.power.set(1.1,1.1,1.1),this.saturation=1.15;break;case 4:this.slope.set(1,.9,.6),this.offset.set(0,0,0),this.power.set(.8,.8,.8),this.saturation=.3;break;case 5:this.slope.set(1,1,1),this.offset.set(0,0,0),this.power.set(1,1,1),this.saturation=0;break}}lerp(e,t,s){this.slope.lerpVectors(e.slope,t.slope,s),this.offset.lerpVectors(e.offset,t.offset,s),this.power.lerpVectors(e.power,t.power,s),this.saturation=U.MathUtils.lerp(e.saturation,t.saturation,s)}};var jr=`#ifdef USE_CDL
struct ColorDecisionList{vec3 slope;vec3 offset;vec3 power;float saturation;};uniform ColorDecisionList cdl;vec3 applyCDL(in vec3 color){float l=dot(color,vec3(0.2126,0.7152,0.0722));vec3 v=max(color*cdl.slope+cdl.offset,0.0);vec3 pv=pow(v,cdl.power);if(v.r>0.0){v.r=pv.r;}if(v.g>0.0){v.g=pv.g;}if(v.b>0.0){v.b=pv.b;}return(v-l)*cdl.saturation+l;}
#else
#define applyCDL(color) color
#endif
#include <tonemapping_pars_fragment>
vec4 mainImage(const in vec4 inputColor,const in vec2 uv,const in GData gData){vec3 result;
#if TONE_MAPPING == 0
result=LinearToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 1
result=ReinhardToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 2
result=CineonToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 3
result=ACESFilmicToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 4
result=AgXToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 5
result=NeutralToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 6
result=CustomToneMapping(inputColor.rgb);
#endif
return vec4(result,inputColor.a);}`;var Mt=class extends ue{constructor({toneMapping:e=4,cdlPreset:t=null}={}){super("ToneMappingEffect");n(this,"cdl");this.fragmentShader=jr.replace("#include <tonemapping_pars_fragment>",$r.ShaderChunk.tonemapping_pars_fragment.replace(/(color = AgXOutsetMatrix \* color;)/,`color = applyCDL(color);
$1`)),this.cdl=new Bt,this.cdl.addEventListener("toggle",()=>this.onCDLToggle()),this.input.uniforms.set("cdl",this.cdl.uniform),this.input.defines.set("USE_CDL",!0),this.toneMapping=e,this.cdl.applyPreset(t)}get toneMapping(){return this.input.defines.get("TONE_MAPPING")}set toneMapping(e){this.toneMapping!==e&&(this.input.defines.set("TONE_MAPPING",e),this.setChanged())}onCDLToggle(){this.cdl.enabled?this.input.defines.set("USE_CDL",!0):this.input.defines.delete("USE_CDL"),this.setChanged()}};var It=h("three");var Xr=`#include <common>
#include <dithering_pars_fragment>
#include <packing>
#include <pp_camera_pars_fragment>
#include <pp_colorspace_conversion_pars_fragment>
#include <pp_default_output_pars_fragment>
#include <pp_depth_buffer_precision_pars_fragment>
#include <pp_depth_utils_pars_fragment>
#include <pp_frame_buffer_precision_pars_fragment>
#include <pp_noise_pars_fragment>
#include <pp_normal_codec_pars_fragment>
#include <pp_normal_utils_pars_fragment>
#include <pp_resolution_pars_fragment>
#define packFloatToRGBA(v) packDepthToRGBA(v)
#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)
$FRAGMENT_HEAD_GDATA$FRAGMENT_HEAD_GBUFFER uniform GBuffer gBuffer;uniform float time;in vec2 vUv;$FRAGMENT_HEAD_EFFECTS void main(){$FRAGMENT_MAIN_UV$FRAGMENT_MAIN_GDATA vec4 color0=gData.color;vec4 color1=vec4(0.0);$FRAGMENT_MAIN_IMAGE color0.a=clamp(color0.a,0.0,1.0);out_Color=color0;
#ifdef COLOR_SPACE_CONVERSION
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
}`;var Kr=`#include <pp_resolution_pars_fragment>
uniform vec3 cameraParams;uniform float time;out vec2 vUv;$VERTEX_HEAD void main(){vUv=position.xy*0.5+0.5;$VERTEX_MAIN_SUPPORT gl_Position=vec4(position.xy,1.0,1.0);}`;var ge=class extends C{constructor(){super({name:"EffectMaterial",defines:{COLOR_SPACE_CONVERSION:!0},uniforms:{gBuffer:new It.Uniform(null),time:new It.Uniform(0)}});n(this,"shaderDataTracker");this.shaderDataTracker=new se,this.fragmentShader=`#include <pp_default_output_pars_fragment>

`+this.fragmentShader}get gBuffer(){return this.uniforms.gBuffer.value}set gBuffer(e){this.uniforms.gBuffer.value=e}get colorSpaceConversion(){return this.defines.COLOR_SPACE_CONVERSION!==void 0}set colorSpaceConversion(e){this.colorSpaceConversion!==e&&(e?this.defines.COLOR_SPACE_CONVERSION=!0:delete this.defines.COLOR_SPACE_CONVERSION,this.needsUpdate=!0)}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}setShaderParts(e){return this.fragmentShader=Xr.replace("$FRAGMENT_MAIN_IMAGE",e.get("$FRAGMENT_MAIN_IMAGE")).replace("$FRAGMENT_MAIN_GDATA",e.get("$FRAGMENT_MAIN_GDATA")).replace("$FRAGMENT_MAIN_UV",e.get("$FRAGMENT_MAIN_UV")).replace("$FRAGMENT_HEAD_EFFECTS",e.get("$FRAGMENT_HEAD_EFFECTS")).replace("$FRAGMENT_HEAD_GBUFFER",e.get("$FRAGMENT_HEAD_GBUFFER")).replace("$FRAGMENT_HEAD_GDATA",e.get("$FRAGMENT_HEAD_GDATA")),this.vertexShader=Kr.replace("$VERTEX_MAIN_SUPPORT",e.get("$VERTEX_MAIN_SUPPORT")).replace("$VERTEX_HEAD",e.get("$VERTEX_HEAD")),this.needsUpdate=!0,this}setDefines(e){return this.shaderDataTracker.applyDefines(this,e).trackDefines(e),this}setUniforms(e){return this.shaderDataTracker.applyUniforms(this,e).trackUniforms(e),this}dispose(){super.dispose(),this.shaderDataTracker.dispose()}};var es=h("three");var H=h("three");function Ut(a,r,e){for(let t of r){let s="$1"+a+t.charAt(0).toUpperCase()+t.slice(1),i=new RegExp("([^\\.])(\\b"+t+"\\b)","g");for(let o of e.entries())typeof o[1]=="string"&&e.set(o[0],o[1].replace(i,s))}}function qr(a,r,e,t){var s;e.add(a);for(let i of(s=r.get(a))!=null?s:[])e.has(i)||qr(i,r,e,t);t.push(a)}function Qr(a,r=!1){let e=[],t=new Set;for(let s of a.keys())t.has(s)||qr(s,a,t,e);return r?e:e.reverse()}var Zr=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,Yr=/struct\s+(\w*)/g,Jr=/^\s*#define\s+(\w*)/gm,ve=class{constructor(){n(this,"defines");n(this,"uniforms");n(this,"shaderParts");n(this,"blendModes");n(this,"gData");n(this,"convolutionEffects");n(this,"uvTransformationEffects");n(this,"_colorSpace");this.shaderParts=new Map([["$FRAGMENT_HEAD_EFFECTS",""],["$FRAGMENT_HEAD_GBUFFER",""],["$FRAGMENT_HEAD_GDATA",""],["$FRAGMENT_MAIN_UV",""],["$FRAGMENT_MAIN_GDATA",""],["$FRAGMENT_MAIN_IMAGE",""],["$VERTEX_HEAD",""],["$VERTEX_MAIN_SUPPORT",""]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.gData=new Set(["color"]),this.convolutionEffects=new Set,this.uvTransformationEffects=new Set,this._colorSpace=H.LinearSRGBColorSpace}get uvTransformation(){return this.uvTransformationEffects.size>0}get colorSpace(){return this._colorSpace}set colorSpace(r){this._colorSpace=r}gatherVertexShaderTokens(r,e){for(let t of r.matchAll(/(?:out\s+\w+\s+(\w*?);)/g))for(let s of t[1].split(/\s*,\s*/))e.add(s);for(let t of r.matchAll(Zr))e.add(t[1]);for(let t of r.matchAll(Yr))e.add(t[1]);for(let t of r.matchAll(Jr))e.add(t[1])}gatherFragmentShaderTokens(r,e){for(let t of r.matchAll(Zr))e.add(t[1]);for(let t of r.matchAll(Yr))e.add(t[1]);for(let t of r.matchAll(Jr))e.add(t[1])}updateWorkingColorSpace(r){r.outputColorSpace!==H.NoColorSpace?this.colorSpace=r.outputColorSpace:r.inputColorSpace!==H.NoColorSpace&&(this.colorSpace=r.inputColorSpace)}integrateEffect(r,e){e.validate(),e.isConvolutionPass(!1)&&this.convolutionEffects.add(e);let t=e.fragmentShader,s=e.vertexShader,i=this.shaderParts,o=i.get("$FRAGMENT_HEAD_EFFECTS"),f=i.get("$FRAGMENT_MAIN_UV"),u=i.get("$FRAGMENT_MAIN_IMAGE"),c=i.get("$VERTEX_HEAD"),d=i.get("$VERTEX_MAIN_SUPPORT"),g=new Set;if(s!==null&&e.hasMainSupportFunction){this.gatherVertexShaderTokens(s,g);let m=/mainSupport\s*\([\w\s]*?uv\s*?\)/.test(s);d+=`	${r}MainSupport(`,d+=m?`vUv);
`:`);
`}e.hasMainUvFunction&&(f+=`	${r}MainUv(UV);
`,this.uvTransformationEffects.add(e));for(let m of e.gData)this.gData.add(m);if(e.hasMainImageFunction){this.gatherFragmentShaderTokens(t,g),e.inputColorSpace!==H.NoColorSpace&&e.inputColorSpace!==this.colorSpace&&(u+=e.inputColorSpace===H.SRGBColorSpace?`color0 = sRGBTransferOETF(color0);
	`:`color0 = sRGBTransferEOTF(color0);
	`),u+=`color1 = ${r}MainImage(color0, UV, gData);
	`;let m=e.blendMode;this.blendModes.set(m.blendFunction.id,m);let x=r+"BlendOpacity";this.uniforms.set(x,m.opacityUniform),u+=`color0 = blend${m.blendFunction.id}(color0, color1, ${x});

	`,o+=`uniform float ${x};

`,this.updateWorkingColorSpace(e)}for(let m of e.input.defines.keys())g.add(m.replace(/\([\w\s,]*\)/g,""));for(let m of e.input.uniforms.keys())g.add(m);g.delete("while"),g.delete("for"),g.delete("if"),e.input.uniforms.forEach((m,x)=>this.uniforms.set(r+x.charAt(0).toUpperCase()+x.slice(1),m)),e.input.defines.forEach((m,x)=>this.defines.set(r+x.charAt(0).toUpperCase()+x.slice(1),m));let w=new Map([["fragment",t],["vertex",s]]);Ut(r,g,this.defines),Ut(r,g,w),t=w.get("fragment"),s=w.get("vertex"),o+=t+`
`,s!==null&&(c+=s+`
`),i.set("$FRAGMENT_HEAD_EFFECTS",o),i.set("$FRAGMENT_MAIN_UV",f),i.set("$FRAGMENT_MAIN_IMAGE",u),i.set("$VERTEX_HEAD",c),i.set("$VERTEX_MAIN_SUPPORT",d),this.validate()}add(r){r.convolutionEffects.forEach(u=>this.convolutionEffects.add(u)),r.uvTransformationEffects.forEach(u=>this.uvTransformationEffects.add(u)),r.uniforms.forEach((u,c)=>this.uniforms.set(c,u)),r.defines.forEach((u,c)=>this.defines.set(c,u)),r.blendModes.forEach((u,c)=>this.blendModes.set(c,u)),r.gData.forEach(u=>this.gData.add(u));let e=this.shaderParts,t=e.get("$FRAGMENT_HEAD_EFFECTS"),s=e.get("$FRAGMENT_MAIN_UV"),i=e.get("$FRAGMENT_MAIN_IMAGE"),o=e.get("$VERTEX_HEAD"),f=e.get("$VERTEX_MAIN_SUPPORT");t+=r.shaderParts.get("$FRAGMENT_HEAD_EFFECTS"),s+=r.shaderParts.get("$FRAGMENT_MAIN_UV"),i+=r.shaderParts.get("$FRAGMENT_MAIN_IMAGE"),o+=r.shaderParts.get("$VERTEX_HEAD"),f+=r.shaderParts.get("$VERTEX_MAIN_SUPPORT"),e.set("$FRAGMENT_HEAD_EFFECTS",t),e.set("$FRAGMENT_MAIN_UV",s),e.set("$FRAGMENT_MAIN_IMAGE",i),e.set("$VERTEX_HEAD",o),e.set("$VERTEX_MAIN_SUPPORT",f),this.colorSpace!==r.colorSpace&&r.colorSpace!==H.NoColorSpace&&(this.colorSpace=r.colorSpace),this.validate()}validate(){if(this.convolutionEffects.size>1){let r=[...this.convolutionEffects].map(e=>e.name).join(", ");throw new Error(`Convolution effects cannot be merged (${r})`)}else if(this.convolutionEffects.size>0&&this.uvTransformation){let r=[...this.convolutionEffects,...this.uvTransformationEffects].map(e=>e.name).join(", ");throw new Error(`Effects that transform UVs are incompatible with convolution effects (${r})`)}}createGDataStructDeclaration(r){return["struct GData {",...Array.from(r.gDataStructDeclaration).filter(e=>this.gData.has(e[0])).map(e=>`	${e[1]}`),`};
`].join(`
`)}createGDataStructInitialization(r){let e=r.gDataDependencies,t=r.gDataStructInitialization,s=new Map(Array.from(this.gData).filter(i=>t.has(i)).map(i=>{var o;return[i,(o=e.get(i))!=null?o:[]]}));return["	GData gData;",...Qr(s,!0).map(i=>`	${t.get(i)}`)].join(`
`)}createBlendFunctions(){let r=/\bblend\b/g,e=[];for(let t of this.blendModes.values()){let s=t.blendFunction.shader,i=`blend${t.blendFunction.id}`;e.push(s.replace(r,i))}return e.join(`
`)}};var F=class F{constructor(r){n(this,"shaderData");n(this,"defaultMaterial");n(this,"materialCache");n(this,"effectShaderDataCache");n(this,"activeMaterial");n(this,"_gBufferConfig");n(this,"_gBuffer");n(this,"_dithering");this.shaderData=r,this.defaultMaterial=new ge,this.materialCache=new Map,this.effectShaderDataCache=new Map,this.activeMaterial=null,this._gBufferConfig=null,this._gBuffer=null,this._dithering=!1}get materials(){return this.materialCache.values()}get gBufferConfig(){return this._gBufferConfig}set gBufferConfig(r){this._gBufferConfig!==r&&(this.dispose(),this._gBufferConfig=r)}get gBuffer(){return this._gBuffer}set gBuffer(r){this._gBuffer!==r&&(this.invalidateMaterialCache(),this._gBuffer=r)}get dithering(){return this._dithering}set dithering(r){if(this._dithering!==r){this._dithering=r;for(let e of this.materialCache.values())if(r&&e.outputPrecision!=="lowp"){console.info("Dithering only works on 8-bit colors");break}else e.dithering=r,e.needsUpdate=!0}}getEffectShaderData(r){let e=new ve,t=this.effectShaderDataCache;for(let s of r){if(!t.has(s)){let i=new ve;i.integrateEffect(`e${s.id}`,s),t.set(s,i)}s.blendMode.blendFunction.shader!==null&&e.add(t.get(s))}return e}createGBufferStructDeclaration(r){if(this.gBuffer===null)throw new Error("Missing G-Buffer information");return["struct GBuffer {",...Array.from(r.gBufferStructDeclaration).filter(e=>this.gBuffer.has(e[0])).map(e=>`	${e[1]}`),`};
`].join(`
`)}createMaterial(r){let t=F.getMaterialId(r)===F.DEFAULT_MATERIAL_ID?this.defaultMaterial:new ge,s=this.getEffectShaderData(r),i=this.gBufferConfig;i!==null&&(s.shaderParts.set("$FRAGMENT_HEAD_GBUFFER",this.createGBufferStructDeclaration(i)),s.shaderParts.set("$FRAGMENT_HEAD_GDATA",s.createGDataStructDeclaration(i)),s.shaderParts.set("$FRAGMENT_MAIN_GDATA",s.createGDataStructInitialization(i)));let o=s.shaderParts.get("$FRAGMENT_HEAD_EFFECTS");if(s.shaderParts.set("$FRAGMENT_HEAD_EFFECTS",o+s.createBlendFunctions()),s.colorSpace===es.SRGBColorSpace){let f=s.shaderParts.get("$FRAGMENT_MAIN_IMAGE");s.shaderParts.set("$FRAGMENT_MAIN_IMAGE",f+`color0 = sRGBTransferEOTF(color0);
	`)}if(s.uvTransformation){let f=s.shaderParts.get("$FRAGMENT_MAIN_UV");s.shaderParts.set("$FRAGMENT_MAIN_UV",`vec2 transformedUv = vUv;
`+f),s.defines.set("UV","transformedUv")}else s.defines.set("UV","vUv");s.shaderParts.forEach((f,u,c)=>c.set(u,f.trim().replace(/^#/,`
#`)));for(let f of this.shaderData.defines)s.defines.set(f[0],f[1]);for(let f of this.shaderData.uniforms)s.uniforms.set(f[0],f[1]);if(t!==this.defaultMaterial){for(let f of Object.entries(this.defaultMaterial.uniforms))t.uniforms[f[0]]=f[1];for(let f of Object.entries(this.defaultMaterial.defines))t.defines[f[0]]=f[1]}return t.setShaderParts(s.shaderParts).setDefines(s.defines).setUniforms(s.uniforms)}createMaterials(r){let e=r.filter(s=>s.optional),t=e.length>F.MAX_OPTIONAL_EFFECTS;if(e.length===0||t){let s=r.filter(o=>o.enabled),i=F.getMaterialId(s);this.materialCache.set(i,this.createMaterial(s));return}for(let s of this.getEffectCombinations(r)){let i=F.getMaterialId(s);this.materialCache.has(i)||this.materialCache.set(i,this.createMaterial(s))}}synchronizeMaterials(){if(this.activeMaterial===null)return;let r=this.activeMaterial,e=this.defaultMaterial;for(let t of Object.entries(e.defines))t[1]!==r.defines[t[0]]&&(e.defines[t[0]]=r.defines[t[0]],e.needsUpdate=!0);if(e.needsUpdate){for(let t of this.materialCache.values())if(t!==e){for(let s of Object.entries(e.defines))t.defines[s[0]]=s[1];t.needsUpdate=!0}}}getMaterial(r){if(this.gBufferConfig===null)return this.defaultMaterial;this.synchronizeMaterials();let e=r.filter(s=>s.enabled),t=F.getMaterialId(e);return this.materialCache.has(t)||this.createMaterials(r),this.activeMaterial=this.materialCache.get(t),this.activeMaterial}*getEffectCombinations(r){let e=r.filter(i=>i.optional),t=e.length,s=1<<t;for(let i=0;i<s;++i){let o=[];for(let f=0;f<t;++f)i&1<<f&&o.push(e[f]);yield r.filter(f=>!f.optional||o.includes(f))}}invalidateMaterialCache(){for(let r of this.materialCache.values())r.dispose();this.materialCache.clear()}invalidateShaderData(r){this.effectShaderDataCache.delete(r)}dispose(){this.invalidateMaterialCache(),this.effectShaderDataCache.clear()}static getMaterialId(r){return r.length===0?F.DEFAULT_MATERIAL_ID:r.map(e=>e.id).join("-")}};n(F,"MAX_OPTIONAL_EFFECTS",6),n(F,"DEFAULT_MATERIAL_ID","default");var Rt=F;var _t=class a extends R{constructor(...e){super("EffectPass");n(this,"effectMaterialManager");n(this,"effectListener");n(this,"gBufferConfigListener");n(this,"previousGBufferConfig");n(this,"disposed");n(this,"timeScale");this.output.defaultBuffer=this.createFramebuffer(),this.effectMaterialManager=new Rt(this.input),this.effectMaterialManager.gBuffer=this.input.gBuffer,this.effectListener=t=>this.handleEffectEvent(t),this.gBufferConfigListener=t=>this.handleGBufferConfigEvent(t),this.previousGBufferConfig=null,this.effects=e,this.disposed=!1,this.timeScale=1}get subpasses(){return super.subpasses}set subpasses(e){for(let t of super.subpasses)t.removeEventListener("change",this.effectListener),t.removeEventListener("toggle",this.effectListener);super.subpasses=e,this.input.gBuffer.clear(),this.input.gBuffer.add("Color");for(let t of super.subpasses)this.copyGBufferComponents(t),t.addEventListener("change",this.effectListener),t.addEventListener("toggle",this.effectListener);this.updateMaterial(!0),this.disposed=!1}get effects(){return this.subpasses}set effects(e){let t=new Set(e);if(t.size<e.length){let s=e.filter(i=>!t.has(i)).map(i=>i.name);throw new Error(`Encountered duplicate effects: ${s.join(", ")}`)}this.subpasses=e}get dithering(){return this.effectMaterialManager.dithering}set dithering(e){this.effectMaterialManager.dithering=e}copyGBufferComponents(e){for(let t of e.input.gBuffer)this.input.gBuffer.add(t)}updateMaterial(e){e&&(this.effectMaterialManager.invalidateMaterialCache(),this.materials.clear()),this.fullscreenMaterial=this.effectMaterialManager.getMaterial(this.effects);for(let t of this.effectMaterialManager.materials)this.materials.add(t)}updateGBufferStruct(){var i,o;let e=this.input,t=e.gBufferConfig;if(t===null)return;let s=[];for(let f of e.gBuffer){let c=f==="Color"?(i=e.defaultBuffer)==null?void 0:i.value:(o=e.buffers.get(f))==null?void 0:o.value;s.push([t.gBufferStructFields.get(f),c!=null?c:null])}this.fullscreenMaterial.gBuffer=Object.fromEntries(s)}handleEffectEvent(e){switch(e.type){case"change":this.copyGBufferComponents(e.target),this.effectMaterialManager.invalidateShaderData(e.target),this.updateMaterial(!0);break;case"toggle":this.updateMaterial(!1);break}}handleGBufferConfigEvent(e){e.type==="change"&&this.updateMaterial(!0)}onGBufferConfigChange(){let e=this.input.gBufferConfig;this.previousGBufferConfig!==null&&this.previousGBufferConfig.removeEventListener("change",this.gBufferConfigListener),this.input.gBufferConfig!==null&&this.input.gBufferConfig.addEventListener("change",this.gBufferConfigListener),this.effectMaterialManager.gBufferConfig=e,this.previousGBufferConfig=e;for(let t of this.effects)t.input.gBufferConfig=e;this.updateMaterial(!0)}onInputChange(){this.updateGBufferStruct();for(let e of this.effects){e.removeEventListener("change",this.effectListener),e.input.buffers.clear();for(let t of this.input.buffers)e.input.buffers.set(t[0],t[1]);e.addEventListener("change",this.effectListener)}this.previousGBufferConfig!==this.input.gBufferConfig?this.onGBufferConfigChange():this.updateMaterial(!0)}checkRequirements(){for(let e of this.effects)e.checkRequirements()}compile(){return G(this,null,function*(){return this.updateMaterial(!1),J(a.prototype,this,"compile").call(this)})}dispose(){for(let e of this.effects)e.removeEventListener("change",this.effectListener),e.removeEventListener("toggle",this.effectListener);this.input.gBufferConfig!==null&&this.input.gBufferConfig.removeEventListener("change",this.gBufferConfigListener),this.effectMaterialManager.dispose(),super.dispose(),this.disposed=!0}render(){var e;if(!(this.renderer===null||this.timer===null)){this.disposed&&(this.effects=[...this.effects]);for(let t of this.effects)t.enabled&&t.render();this.fullscreenMaterial.time+=this.timer.getDelta()*this.timeScale,this.setRenderTarget((e=this.output.defaultBuffer)==null?void 0:e.value),this.renderFullscreen()}}};var gs=h("three/examples/jsm/loaders/GLTFLoader.js"),vs=h("tweakpane"),As=h("spatial-controls");var M=h("three");var ts=`#ifdef USE_FOG
uniform vec3 fogColor;varying vec3 vWorldPosition;
#ifdef FOG_EXP2
uniform float fogDensity;
#else
uniform float fogNear;uniform float fogFar;
#endif
#endif`;var rs=`#ifdef USE_FOG
float range=length(vWorldPosition-cameraPosition);
#ifdef FOG_EXP2
float fogFactor=1.0-exp(-fogDensity*fogDensity*range*range);
#else
float fogFactor=smoothstep(fogNear,fogFar,range);
#endif
gl_FragColor.a=saturate(1.0-fogFactor);
#endif`;var ss=`#ifdef USE_FOG
varying vec3 vWorldPosition;
#endif`;var is=`#ifdef USE_FOG
vWorldPosition=worldPosition.xyz;
#endif`;function ns(a){a.fragmentShader=a.fragmentShader.replace("#include <fog_pars_fragment>",ts),a.fragmentShader=a.fragmentShader.replace("#include <fog_fragment>",rs),a.vertexShader=a.vertexShader.replace("#include <fog_pars_vertex>",ss),a.vertexShader=a.vertexShader.replace("#include <fog_vertex>",is)}var as="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABAAAAAQAAQMAAABF07nAAAAABlBMVEVjY2PGxsamg2z0AAACH0lEQVR42u3QMREAAAgDsfo3DSI6MJBXkPtMWdoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADOAQ4CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALwHLMf/DvLci4ZuAAAAAElFTkSuQmCC";function os(){return new M.Fog(0,15,60)}function fs(){let r=new Image,e=new M.Texture(r);e.wrapS=M.RepeatWrapping,e.wrapT=M.RepeatWrapping,e.colorSpace=M.SRGBColorSpace,e.repeat.setScalar(5e3/2),e.anisotropy=4,r.addEventListener("load",()=>e.needsUpdate=!0),r.src=as;let t=new M.Group,s=new M.MeshStandardMaterial({transparent:!0,roughness:.1,metalness:1,map:e}),i=new M.Mesh(new M.PlaneGeometry(1,1,6,6),s);return i.name="Checkeboard",i.material.onBeforeCompile=ns,i.material.side=M.DoubleSide,i.rotation.x=-Math.PI*.5,i.scale.set(5e3,5e3,1),t.add(i),t}var ys=Math.PI/180,Cs=180/Math.PI;function us(a,r=16/9){return Math.atan(Math.tan(a*ys*.5)/r)*Cs*2}function ls(a,r=".png"){let e=`${document.baseURI}img/textures/skies/${a}/`;return[e+"px"+r,e+"nx"+r,e+"py"+r,e+"ny"+r,e+"pz"+r,e+"nz"+r]}var Tt=h("three");function cs(a,r){a.traverse(e=>{if(!(e instanceof Tt.Mesh)||e.material===void 0||e.material===null)return;let s=Object.values(e.material).filter(i=>i instanceof Tt.Texture&&!i.isRenderTargetTexture);for(let i of s)i.anisotropy=r})}var ds=h("@tweakpane/plugin-essentials");var Ps=[new je,new $e,new Xe,new Ke,new qe,new oe,new Qe,new Ze,new Ye,new Je,new et,new tt,new rt,new st,new it,new nt,new at,new ot,new ft,new ut,new lt,new ct,new dt,new pt,new ht,new mt,new gt,new vt,new fe,new At,new bt,new Et,new xt],Nt=Object.fromEntries(Ps.map(a=>[a.name,a]));function ps(a){a.registerPlugin(ds.EssentialsPlugin);let r=a.addBlade({view:"fpsgraph",rows:2});return r.on("tick",()=>{if(r.fps===null)return;let e=Math.round(r.fps)*1.5;e>r.max&&(r.max=e)}),r}function hs(a,r){let e={blendFunction:r.blendFunction.name};a.addBinding(r,"opacity",{min:0,max:1,step:.001}),a.addBinding(e,"blendFunction",{options:Ds(Object.keys(Nt))}).on("change",t=>r.blendFunction=Nt[t.value])}function Ds(a){return a.reduce((r,e)=>(r[e]=e,r),{})}function ms(a){return Object.fromEntries(Object.entries(a).filter(r=>isNaN(Number(r[0]))))}var Vt=["localhost","127.0.0.1","","[::1]"].includes(window.location.hostname);function ws(){let a=new Map,r=new D.LoadingManager,e=new gs.GLTFLoader(r),t=new D.CubeTextureLoader(r);return new Promise((s,i)=>{r.onLoad=()=>s(a),r.onError=o=>i(new Error(`Failed to load ${o}`)),t.load(ls("space-01",".jpg"),o=>{o.colorSpace=D.SRGBColorSpace,a.set("sky",o)}),e.load(`${document.baseURI}models/enchanted-crystal/enchanted-crystal.glb`,o=>a.set("model",o))})}window.addEventListener("load",()=>{ws().then(a=>{let r=new D.WebGLRenderer({powerPreference:"high-performance",antialias:!1,stencil:!1,depth:!1});r.setPixelRatio(window.devicePixelRatio),r.debug.checkShaderErrors=Vt;let e=new D.PerspectiveCamera,t=new As.SpatialControls(e.position,e.quaternion,r.domElement),s=t.settings;s.rotation.sensitivity=2.2,s.rotation.damping=.05,s.translation.damping=.1,t.position.set(0,1,-1),t.lookAt(0,1,1);let i=new D.Scene,o=a.get("sky");i.background=o,i.environment=o,i.fog=os(),i.add(fs());let f=a.get("model");cs(f.scene,Math.min(8,r.capabilities.getMaxAnisotropy())),f.scene.translateY(1),f.scene.scale.setScalar(2),i.add(f.scene);let u=new St({shape:2,bias:.03}),c=new ke(r);c.add(new $,new X(i,e,{samples:4}),new _t(u,new Mt));let d=document.getElementById("viewport"),g=new vs.Pane({container:d.querySelector(".tp")}),w=ps(g),m=g.addFolder({title:"Settings"});m.addBinding(u,"shape",{options:ms(Lt)}),m.addBinding(u,"radius",{min:1,max:25,step:.001}),m.addBinding(u,"samples",{min:1,max:16,step:1}),m.addBinding(u,"rotation",{min:0,max:Math.PI,step:1e-4}),m.addBinding(u,"bias",{min:0,max:1,step:1e-6}),m.addBinding(u,"premultiply"),m.addBinding(u,"inverted"),hs(m,u.blendMode);function x(){let N=d.clientWidth,Ae=d.clientHeight;e.aspect=N/Ae,e.fov=us(90,Math.max(e.aspect,16/9)),e.updateProjectionMatrix(),c.setSize(N,Ae)}window.addEventListener("resize",x),x();function z(N){w.begin(),t.update(N),f.scene.position.y=1+Math.sin(c.timer.getElapsed())*.01,c.render(N),w.end()}c.compile().then(()=>{let N=new IntersectionObserver(Ae=>r.setAnimationLoop(Ae[0].isIntersecting?z:null),{threshold:.75});d.prepend(r.domElement),N.observe(d)}).catch(N=>console.error(N))})});})();
