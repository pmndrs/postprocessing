"use strict";(()=>{var Ps=Object.defineProperty;var Fs=Object.getPrototypeOf;var Us=Reflect.get;var Ds=(o,r,e)=>r in o?Ps(o,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[r]=e;var m=(o=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(o,{get:(r,e)=>(typeof require!="undefined"?require:r)[e]}):o)(function(o){if(typeof require!="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+o+'" is not supported')});var n=(o,r,e)=>Ds(o,typeof r!="symbol"?r+"":r,e);var ee=(o,r,e)=>Us(Fs(o),e,r);var G=(o,r,e)=>new Promise((t,s)=>{var i=l=>{try{u(e.next(l))}catch(f){s(f)}},a=l=>{try{u(e.throw(l))}catch(f){s(f)}},u=l=>l.done?t(l.value):Promise.resolve(l.value).then(i,a);u((e=e.apply(o,r)).next())});var F=m("three");var qt=m("three");var O=class{constructor(r=0){n(this,"nextId");this.nextId=r}getNextId(){return this.nextId++}reset(r=0){return this.nextId=r,this}};var Se=class Se extends qt.EventDispatcher{constructor(e){super();n(this,"id");n(this,"_value");n(this,"_overrideValue");n(this,"muted");n(this,"locked");this.id=Se.idManager.getNextId(),this._value=e,this._overrideValue=null,this.locked=!1,this.muted=!1}get value(){var e;return(e=this._overrideValue)!=null?e:this._value}set value(e){this._value=e,this.setChanged()}get overrideValue(){return this._overrideValue}set overrideValue(e){this._overrideValue=e,this.setChanged()}mute(){this.muted=!0}unmute(){this.muted=!1}setChanged(){if(!this.muted){if(this.locked)throw new Error("Unable to change resource value inside change event handler");this.locked=!0,this.dispatchEvent({type:"change"}),this.locked=!1}}};n(Se,"idManager",new O);var Be=Se;var k=class k extends Be{constructor(r){super(r),k.increaseReferenceCount(r)}get value(){return super.value}set value(r){let e=super.value;super.value=r,r!==e&&(k.decreaseReferenceCount(e),k.increaseReferenceCount(r),e!==null&&!k.references.has(e)&&e.dispose())}dispose(){var r;(r=this.value)==null||r.dispose()}static decreaseReferenceCount(r){var s;if(r===null)return;let e=k.references,t=(s=e.get(r))!=null?s:0;t>0&&(t===1?e.delete(r):e.set(r,t-1))}static increaseReferenceCount(r){var s;if(r===null)return;let e=k.references,t=(s=e.get(r))!=null?s:0;e.set(r,t+1)}};n(k,"references",new Map);var $=k;var Me=m("three");var Qt=m("three");var S=class extends Qt.EventDispatcher{constructor(e){super();n(this,"data");this.data=new Map(e)}get size(){return this.data.size}get[Symbol.toStringTag](){return this.data[Symbol.toStringTag]}clear(){this.dispatchEvent({type:"clear"});let e=this.data.clear();return this.dispatchEvent({type:"change"}),e}delete(e){return this.data.has(e)?(this.dispatchEvent({type:"delete",key:e,value:this.data.get(e)}),this.data.delete(e),this.dispatchEvent({type:"change"}),!0):!1}get(e){return this.data.get(e)}has(e){return this.data.has(e)}set(e,t){return this.data.has(e)&&this.dispatchEvent({type:"delete",key:e,value:this.data.get(e)}),this.data.set(e,t),this.dispatchEvent({type:"add",key:e,value:t}),this.dispatchEvent({type:"change"}),this}entries(){return this.data.entries()}keys(){return this.data.keys()}values(){return this.data.values()}forEach(e,t){return this.data.forEach(e,t)}[Symbol.iterator](){return this.data[Symbol.iterator]()}};var Zt=m("three");var te=class extends Zt.EventDispatcher{constructor(e){super();n(this,"data");this.data=new Set(e)}get size(){return this.data.size}get[Symbol.toStringTag](){return this.data[Symbol.toStringTag]}[Symbol.iterator](){return this.data[Symbol.iterator]()}clear(){this.data.size!==0&&(this.dispatchEvent({type:"clear"}),this.data.clear(),this.dispatchEvent({type:"change"}))}delete(e){return this.data.has(e)?(this.dispatchEvent({type:"delete",value:e}),this.data.delete(e),this.dispatchEvent({type:"change"}),!0):!1}has(e){return this.data.has(e)}add(e){return this.data.has(e)?this:(this.data.add(e),this.dispatchEvent({type:"add",value:e}),this.dispatchEvent({type:"change"}),this)}entries(){return this.data.entries()}keys(){return this.data.keys()}values(){return this.data.values()}forEach(e,t){return this.data.forEach(e,t)}};var I=class extends ${constructor(e=null){super(e);n(this,"uniformListeners");this.uniformListeners=new WeakMap}bindUniform(e){if(!this.uniformListeners.has(e)){let t=()=>{e.value=this.value};this.uniformListeners.set(e,t),this.addEventListener("change",t)}e.value=this.value}unbindUniform(e){this.uniformListeners.has(e)&&this.removeEventListener("change",this.uniformListeners.get(e))}};var Q=class Q extends Me.EventDispatcher{constructor(){super();n(this,"defines");n(this,"uniforms");n(this,"gBuffer");n(this,"textures");n(this,"_gBufferConfig");n(this,"propagateChangeEvent");let e=new te(["Color"]),t=new S,s=new S,i=new S,a=()=>this.setChanged();e.addEventListener("change",a),t.addEventListener("change",a),s.addEventListener("change",a),i.addEventListener("change",a),i.addEventListener("add",u=>u.value.addEventListener("change",a)),i.addEventListener("delete",u=>u.value.removeEventListener("change",a)),i.addEventListener("clear",u=>{for(let l of u.target.values())l.removeEventListener("change",a)}),this.propagateChangeEvent=a,this.defines=t,this.uniforms=s,this.textures=i,this.gBuffer=e,this._gBufferConfig=null}get gBufferConfig(){return this._gBufferConfig}set gBufferConfig(e){this._gBufferConfig!==null&&this._gBufferConfig.removeEventListener("change",this.propagateChangeEvent),e!==null&&e.addEventListener("change",this.propagateChangeEvent),this._gBufferConfig=e,this.setChanged()}get buffers(){return this.textures}get hasDefaultBuffer(){return this.textures.has(Q.BUFFER_DEFAULT)}get defaultBuffer(){var e;return(e=this.textures.get(Q.BUFFER_DEFAULT))!=null?e:null}set defaultBuffer(e){this.setBuffer(Q.BUFFER_DEFAULT,e)}get frameBufferPrecisionHigh(){var e,t;return((t=(e=this.defaultBuffer)==null?void 0:e.value)==null?void 0:t.type)!==Me.UnsignedByteType}setChanged(){this.dispatchEvent({type:"change"})}setBuffer(e,t){if(t instanceof I)this.textures.set(e,t);else{let s=this.textures.get(e);s!=null?s.value=t:this.textures.set(e,new I(t))}}getBuffer(e){var t,s;return(s=(t=this.textures.get(e))==null?void 0:t.value)!=null?s:null}removeDefaultBuffer(){return this.textures.delete(Q.BUFFER_DEFAULT)}dispose(){var e;for(let t of this.textures.values())(e=t.value)==null||e.dispose()}};n(Q,"BUFFER_DEFAULT","BUFFER_DEFAULT");var re=Q;var ge=m("three");var A=m("three");var b=m("three");var se="out vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}";var _=class extends b.ShaderMaterial{constructor(r){super(Object.assign({name:"FullscreenMaterial",glslVersion:b.GLSL3,blending:b.NoBlending,depthWrite:!1,depthTest:!1,vertexShader:se},r)),Object.assign(this.uniforms,{projectionMatrix:new b.Uniform(null),projectionMatrixInverse:new b.Uniform(null),viewMatrix:new b.Uniform(null),viewMatrixInverse:new b.Uniform(null),cameraParams:new b.Uniform(new b.Vector3),resolution:new b.Uniform(new b.Vector4),inputBuffer:new b.Uniform(null)}),this.outputPrecision="lowp",this.onBeforeCompile=(e,t)=>{t.getRenderTarget()===null&&this.outputPrecision!=="lowp"&&(this.outputPrecision="lowp",this.needsUpdate=!1)}}get outputPrecision(){return this.defines.OUTPUT_COLOR_PRECISION}set outputPrecision(r){this.defines.OUTPUT_COLOR_PRECISION!==r&&(this.defines.OUTPUT_COLOR_PRECISION=r,this.needsUpdate=!0)}get frameBufferPrecisionHigh(){return this.defines.FRAME_BUFFER_PRECISION_HIGH!==void 0}set frameBufferPrecisionHigh(r){this.frameBufferPrecisionHigh!==r&&(r?this.defines.FRAME_BUFFER_PRECISION_HIGH=!0:delete this.defines.FRAME_BUFFER_PRECISION_HIGH,this.needsUpdate=!0)}get inputBuffer(){return this.uniforms.inputBuffer.value}set inputBuffer(r){this.frameBufferPrecisionHigh=r!==null&&r.type!==b.UnsignedByteType,this.uniforms.inputBuffer.value=r}get near(){return this.uniforms.cameraParams.value.x}get far(){return this.uniforms.cameraParams.value.y}copyCameraSettings(r){this.uniforms.projectionMatrix.value=r.projectionMatrix,this.uniforms.projectionMatrixInverse.value=r.projectionMatrixInverse,this.uniforms.viewMatrix.value=r.matrixWorldInverse,this.uniforms.viewMatrixInverse.value=r.matrixWorld;let e=this.uniforms.cameraParams.value;e.set(r.near,r.far,e.z);let t=this.defines.PERSPECTIVE_CAMERA!==void 0;r instanceof b.PerspectiveCamera?t||(this.defines.PERSPECTIVE_CAMERA=!0,this.needsUpdate=!0):t&&(delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(r,e){this.uniforms.resolution.value.set(r,e,1/r,1/e);let s=this.uniforms.cameraParams.value;s.z=r/e}};var ie=m("three");var P=-1,H=class extends ie.EventDispatcher{constructor(e=P,t=P,s=1){super();n(this,"baseSize");n(this,"preferredSize");n(this,"effectiveSize");n(this,"_pixelRatio");n(this,"_scale");n(this,"locked");this.baseSize=new ie.Vector2(1,1),this.preferredSize=new ie.Vector2(e,t),this.effectiveSize=new ie.Vector2,this._pixelRatio=1,this._scale=s,this.locked=!1,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){let e=this.baseSize,t=this.preferredSize,s=this.effectiveSize;s.copy(e),t.width!==P?s.width=t.width:t.height!==P&&(s.width=Math.round(t.height*(e.width/Math.max(e.height,1)))),t.height!==P?s.height=t.height:t.width!==P&&(s.height=Math.round(t.width/Math.max(e.width/Math.max(e.height,1),1))),s.multiplyScalar(this.scaledPixelRatio).floor()}get width(){return this.effectiveSize.width}get height(){return this.effectiveSize.height}get aspectRatio(){return this.baseSize.width/this.baseSize.height}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio!==e&&(this._pixelRatio=e,this.setChanged())}get scale(){return this._scale}set scale(e){this._scale!==e&&(this._scale=e,this.preferredSize.setScalar(P),this.setChanged())}get scaledPixelRatio(){return this._pixelRatio*this._scale}get baseWidth(){return this.baseSize.width}set baseWidth(e){this.baseSize.width!==e&&(this.baseSize.width=e,this.setChanged())}get baseHeight(){return this.baseSize.height}set baseHeight(e){this.baseSize.height!==e&&(this.baseSize.height=e,this.setChanged())}setBaseSize(e,t){(this.baseSize.width!==e||this.baseSize.height!==t)&&(this.baseSize.set(e,t),this.setChanged())}setSize(e,t){this.setBaseSize(e,t)}copyBaseSize(e){this.baseSize.equals(e.baseSize)||(this.baseSize.copy(e.baseSize),this.setChanged())}get preferredWidth(){return this.preferredSize.width}set preferredWidth(e){this.preferredSize.width!==e&&(this.preferredSize.width=e,this.setChanged())}get preferredHeight(){return this.preferredSize.height}set preferredHeight(e){this.preferredSize.height!==e&&(this.preferredSize.height=e,this.setChanged())}setPreferredSize(e,t){(this.preferredSize.width!==e||this.preferredSize.height!==t)&&(this.preferredSize.set(e,t),this.setChanged())}copyPreferredSize(e){this.preferredSize.equals(e.preferredSize)||(this.preferredSize.copy(e.preferredSize),this.setChanged())}resetPreferredSize(){(this.preferredSize.width!==P||this.preferredSize.height!==P)&&(this.preferredSize.set(P,P),this.setChanged())}copy(e){this.equals(e)||(this.preferredSize.copy(e.preferredSize),this.baseSize.copy(e.baseSize),this._pixelRatio=e.pixelRatio,this._scale=e.scale,this.setChanged())}equals(e){return this.scale===e.scale&&this.pixelRatio===e.pixelRatio&&this.baseSize.equals(e.baseSize)&&this.preferredSize.equals(e.preferredSize)}setChanged(){if(this.locked)throw new Error("Unable to change resolution inside change event handler");this.locked=!0,this.dispatchEvent({type:"change"}),this.locked=!1}get x(){return this.width}get y(){return this.height}};n(H,"AUTO_SIZE",P);var Yt=m("three");var Re=class extends Yt.EventDispatcher{constructor(e){super();n(this,"listener");this.listener=t=>this.handleSceneEvent(t),this.handleSceneEvent({type:"childadded",target:e,child:e})}handleSceneEvent(e){var t,s;switch(e.type){case"childadded":{(t=e.child)==null||t.traverse(i=>{i.addEventListener("childadded",this.listener),i.addEventListener("childremoved",this.listener)});break}case"childremoved":{(s=e.child)==null||s.traverse(i=>{i.removeEventListener("childadded",this.listener),i.removeEventListener("childremoved",this.listener)});break}}this.dispatchEvent(e)}};var ne=class{constructor(){n(this,"defines");n(this,"uniforms");this.defines=new Map,this.uniforms=new Map}applyDefines(r,e){for(let t of this.defines.keys())delete r.defines[t];for(let t of e.entries())r.defines[t[0]]=t[1];return r.needsUpdate=!0,this}trackDefines(r){this.defines.clear();for(let e of r.entries())this.defines.set(e[0],e[1]);return this}applyUniforms(r,e){for(let t of this.uniforms.keys())delete r.uniforms[t];for(let t of e.entries())r.uniforms[t[0]]=t[1];return r.uniformsNeedUpdate=!0,this}trackUniforms(r){this.uniforms.clear();for(let e of r.entries())this.uniforms.set(e[0],e[1]);return this}dispose(){this.defines.clear(),this.uniforms.clear()}};var Dt=m("three");var ae=class o extends H{constructor(){super();n(this,"offset");n(this,"effectiveOffset");n(this,"_enabled");this.offset=new Dt.Vector2,this.effectiveOffset=new Dt.Vector2,this._enabled=!1,this.addEventListener("change",()=>this.updateEffectiveOffset())}updateEffectiveOffset(){this.effectiveOffset.copy(this.offset).multiplyScalar(this.scaledPixelRatio).floor()}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.setChanged())}get offsetX(){return this.effectiveOffset.x}get offsetY(){return this.effectiveOffset.y}setOffset(e,t){(this.offset.x!==e||this.offset.y!==t)&&(this.offset.set(e,t),this.updateEffectiveOffset(),this.setChanged())}set(e,t,s,i){s===void 0||i===void 0?super.setPreferredSize(e,t):(this.offset.set(e,t),this.updateEffectiveOffset(),super.setPreferredSize(s,i))}copy(e){e instanceof o?this.equals(e)||(this.enabled=e.enabled,this.offset.copy(e.offset),this.effectiveOffset.copy(e.effectiveOffset),super.copy(e)):super.copy(e)}equals(e){return this.enabled===e.enabled&&this.offset.equals(e.offset)&&super.equals(e)}get x(){return this.effectiveOffset.x}get y(){return this.effectiveOffset.y}get z(){return this.width}get w(){return this.height}};var _e=class extends ae{};var ye=m("three");var L=class extends ${constructor(e=null){var t;super(e);n(this,"texture");this.texture=new I((t=this.value)==null?void 0:t.texture)}get value(){return super.value}set value(e){super.value=e,this.texture.value=e!==null?e.texture:null}mute(){super.mute(),this.texture.mute()}unmute(){super.unmute(),this.texture.unmute()}};var Z=class Z extends ye.EventDispatcher{constructor(){super();n(this,"defines");n(this,"uniforms");n(this,"renderTargets");let e=new S,t=new S,s=new S,i=()=>this.setChanged();e.addEventListener("change",i),t.addEventListener("change",i),s.addEventListener("change",i),s.addEventListener("add",a=>a.value.addEventListener("change",i)),s.addEventListener("delete",a=>a.value.removeEventListener("change",i)),s.addEventListener("clear",a=>{for(let u of a.target.values())u.removeEventListener("change",i)}),this.defines=e,this.uniforms=t,this.renderTargets=s}get buffers(){return this.renderTargets}get hasDefaultBuffer(){return this.renderTargets.has(Z.BUFFER_DEFAULT)}get defaultBuffer(){var e;return(e=this.renderTargets.get(Z.BUFFER_DEFAULT))!=null?e:null}set defaultBuffer(e){this.setBuffer(Z.BUFFER_DEFAULT,e)}get frameBufferPrecisionHigh(){var t;let e=(t=this.defaultBuffer)==null?void 0:t.value;return e==null?!1:e.texture.type!==ye.UnsignedByteType}setChanged(){this.dispatchEvent({type:"change"})}setBuffer(e,t){if(t instanceof L)this.renderTargets.set(e,t);else{let s=this.renderTargets.get(e);s!=null?s.value=t:this.renderTargets.set(e,new L(t))}}getBuffer(e){var t,s;return(s=(t=this.renderTargets.get(e))==null?void 0:t.value)!=null?s:null}removeDefaultBuffer(){return this.renderTargets.delete(Z.BUFFER_DEFAULT)}dispose(){var e,t,s;for(let i of this.renderTargets.values())(t=(e=i.value)==null?void 0:e.depthTexture)==null||t.dispose(),(s=i.value)==null||s.dispose()}};n(Z,"BUFFER_DEFAULT","BUFFER_DEFAULT");var Te=Z;var Jt=new A.Vector2,w=class w extends A.EventDispatcher{constructor(e){super();n(this,"id");n(this,"sceneListener");n(this,"shaderDataTracker");n(this,"fullscreenScene");n(this,"fullscreenCamera");n(this,"screen");n(this,"_name");n(this,"_enabled");n(this,"_attached");n(this,"_autoSyncDefaultBuffers");n(this,"_autoSRGB");n(this,"_timer");n(this,"_renderer");n(this,"_scene");n(this,"_camera");n(this,"_subpasses");n(this,"disposables");n(this,"materials");n(this,"resolution");n(this,"viewport");n(this,"scissor");n(this,"input");n(this,"output");this.sceneListener=t=>this.handleSceneEvent(t),this.shaderDataTracker=new ne,this.fullscreenScene=null,this.fullscreenCamera=null,this.screen=null,this._name=e,this._enabled=!0,this._attached=!1,this._autoSyncDefaultBuffers=!0,this._autoSRGB=!0,this._renderer=null,this._timer=null,this._scene=null,this._camera=null,this._subpasses=[],this.id=w.idManager.getNextId(),this.disposables=new Set,this.materials=new Set,this.resolution=new H,this.viewport=new ae,this.scissor=new _e,this.resolution.addEventListener("change",t=>this.handleResolutionEvent(t)),this.viewport.addEventListener("change",t=>this.handleViewportEvent(t)),this.scissor.addEventListener("change",t=>this.handleScissorEvent(t)),this.input=new re,this.output=new Te,this.input.addEventListener("change",t=>this.handleInputEvent(t)),this.output.addEventListener("change",t=>this.handleOutputEvent(t))}get name(){return this._name}set name(e){this._name=e}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.dispatchEvent({type:"toggle"}))}get attached(){return this._attached}set attached(e){this._attached!==e&&(this._attached=e,this.input.setChanged(),this.output.setChanged(),this.resolution.setChanged())}get autoSyncDefaultBuffers(){return this._autoSyncDefaultBuffers}set autoSyncDefaultBuffers(e){this._autoSyncDefaultBuffers!==e&&(this._autoSyncDefaultBuffers=e,this.syncDefaultBuffers())}get autoSRGB(){return this._autoSRGB}set autoSRGB(e){this._autoSRGB!==e&&(this._autoSRGB=e,this.syncDefaultBuffers())}get subpasses(){return this._subpasses}set subpasses(e){for(let t of this.subpasses)t.attached=!1;for(let t of e)if(t.attached)throw new Error(`${t.name} is already attached to another pass`);this._subpasses=e,Object.freeze(this._subpasses),this.initializeSubpasses()}get timer(){return this._timer}set timer(e){this._timer=e;for(let t of this.subpasses)t.timer=e}get renderer(){return this._renderer}set renderer(e){this._renderer=e;try{(e==null?void 0:e.capabilities)!==void 0&&this.checkRequirements()}catch(t){console.warn(t),console.info("Disabling pass:",this),this.enabled=!1}for(let t of this.subpasses)t.renderer=e}get scene(){return this._scene}set scene(e){if(this._scene!==e){if(this._scene!==null&&w.sceneEventTargets.has(this._scene)){let t=w.sceneEventTargets.get(this._scene);t.removeEventListener("childadded",this.sceneListener),t.removeEventListener("childremoved",this.sceneListener)}if(this._scene=e,e!==null){w.sceneEventTargets.has(e)||w.sceneEventTargets.set(e,new Re(e));let t=w.sceneEventTargets.get(e);t.addEventListener("childadded",this.sceneListener),t.addEventListener("childremoved",this.sceneListener)}for(let t of this.subpasses)t.scene=e}}get camera(){return this._camera}set camera(e){if(this._camera!==e){this._camera=e,e!==null&&this.fullscreenMaterial instanceof _&&this.fullscreenMaterial.copyCameraSettings(e);for(let t of this.subpasses)t.camera=e}}get fullscreenMaterial(){var e;return(e=this.screen)==null?void 0:e.material}set fullscreenMaterial(e){e!==null&&(this.screen!==null?this.screen.material=e:(this.screen=new A.Mesh(w.fullscreenGeometry,e),this.screen.frustumCulled=!1,this.fullscreenScene=new A.Scene,this.fullscreenCamera=new A.OrthographicCamera(-1,1,1,-1,0,1),this.fullscreenScene.add(this.screen)),this.materials.has(e)||(this.materials.add(e),this.updateFullscreenMaterialInput(e)))}initializeSubpasses(){for(let e of this.subpasses)e.timer=this.timer,e.renderer=this.renderer,e.scene=this.scene,e.camera=this.camera,e.resolution.copy(this.resolution),e.viewport.copy(this.viewport),e.scissor.copy(this.scissor),e.attached=!0}updateSubpassResolution(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.resolution;for(let i of this.subpasses)i.resolution.pixelRatio=s,i.resolution.setBaseSize(e,t)}updateSubpassViewport(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.viewport;for(let i of this.subpasses)i.viewport.pixelRatio=s,i.viewport.setBaseSize(e,t)}updateSubpassScissor(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.scissor;for(let i of this.subpasses)i.scissor.pixelRatio=s,i.scissor.setBaseSize(e,t)}updateOutputBufferSize(){var e,t;(t=(e=this.output.defaultBuffer)==null?void 0:e.value)==null||t.setSize(this.resolution.width,this.resolution.height)}updateViewportAndScissor(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.resolution;this.viewport.pixelRatio=s,this.viewport.setBaseSize(e,t),this.scissor.pixelRatio=s,this.scissor.setBaseSize(e,t)}updateFullscreenMaterialResolution(e){e instanceof _&&e.setSize(this.resolution.width,this.resolution.height)}updateFullscreenMaterialsResolution(){for(let e of this.materials)this.updateFullscreenMaterialResolution(e)}updateFullscreenMaterialInput(e){var t,s;e instanceof A.ShaderMaterial&&(e instanceof _&&(e.inputBuffer=(s=(t=this.input.defaultBuffer)==null?void 0:t.value)!=null?s:null),this.shaderDataTracker.applyDefines(e,this.input.defines).applyUniforms(e,this.input.uniforms))}updateFullscreenMaterialsInput(){for(let e of this.materials)this.updateFullscreenMaterialInput(e);this.shaderDataTracker.trackDefines(this.input.defines).trackUniforms(this.input.uniforms)}updateFullscreenMaterialsOutput(){for(let e of this.materials)e instanceof _&&(e.outputPrecision=this.output.frameBufferPrecisionHigh?"mediump":"lowp")}syncDefaultBuffers(){var u,l,f,p;let e=this.renderer,t=(l=(u=this.input.defaultBuffer)==null?void 0:u.value)!=null?l:null,s=(p=(f=this.output.defaultBuffer)==null?void 0:f.value)!=null?p:null;if(!this.autoSyncDefaultBuffers||e===null||t===null||s===null)return;let i=s.texture;i.needsUpdate=i.format!==t.format||i.internalFormat!==t.internalFormat||i.type!==t.type,i.needsUpdate&&(i.format=t.format,i.internalFormat=t.internalFormat,i.type=t.type),this.autoSRGB&&!this.output.frameBufferPrecisionHigh&&e.outputColorSpace===A.SRGBColorSpace&&i.colorSpace!==A.SRGBColorSpace&&(i.colorSpace=A.SRGBColorSpace,i.needsUpdate=!0),i.needsUpdate&&this.output.defaultBuffer.texture.setChanged()}isConvolutionPass(e){let t=this.fullscreenMaterial;if(t instanceof _&&/texture\s*\(\s*gBuffer.color/.test(t.fragmentShader))return!0;if(e){for(let s of this.subpasses)if(s.isConvolutionPass(e))return!0}return!1}checkRequirements(){}onInputChange(){}onOutputChange(){}onResolutionChange(){}onViewportChange(){}onScissorChange(){}onSceneChildAdded(e){}onSceneChildRemoved(e){}compile(){return G(this,null,function*(){if(this.renderer===null)return;let e=new A.Group;for(let s of this.materials)e.add(new A.Mesh(w.fullscreenGeometry,s));let t=[this.renderer.compileAsync(e,this.fullscreenCamera,this.fullscreenScene)];for(let s of this.subpasses)t.push(s.compile());yield Promise.all(t)})}createFramebuffer(){let{width:e,height:t}=this.resolution;return new A.WebGLRenderTarget(e,t,{depthBuffer:!1})}setChanged(){this.dispatchEvent({type:"change"})}applyViewport(e=null){let t=this.renderer;if(t===null)return;let s=this.viewport;if(s.enabled)e!==null?e.viewport.copy(s):t.setViewport(s.x,s.y,s.z,s.w);else if(e!==null){let{width:i,height:a}=e;e.viewport.set(0,0,i,a)}else{let{width:i,height:a}=t.getSize(Jt);t.setViewport(0,0,i,a)}}applyScissor(e=null){let t=this.renderer;if(t===null)return;let s=this.scissor;if(s.enabled)e!==null?(e.scissor.copy(s),e.scissorTest=!0):(t.setScissor(s.x,s.y,s.z,s.w),t.setScissorTest(!0));else if(e!==null){let{width:i,height:a}=e;e.scissor.set(0,0,i,a),e.scissorTest=!1}else if(t.getScissorTest()){let{width:i,height:a}=t.getSize(Jt);t.setScissor(0,0,i,a),t.setScissorTest(!1)}}setRenderTarget(e=null,t,s){var i;this.applyViewport(e),this.applyScissor(e),(i=this.renderer)==null||i.setRenderTarget(e,t,s)}renderFullscreen(){this.renderer!==null&&this.fullscreenMaterial!==null&&this.renderer.render(this.fullscreenScene,this.fullscreenCamera)}handleResolutionEvent(e){this.attached&&e.type==="change"&&(this.updateFullscreenMaterialsResolution(),this.updateOutputBufferSize(),this.onResolutionChange(),this.updateSubpassResolution(),this.updateViewportAndScissor())}handleViewportEvent(e){this.attached&&e.type==="change"&&(this.onViewportChange(),this.updateSubpassViewport())}handleScissorEvent(e){this.attached&&e.type==="change"&&(this.onScissorChange(),this.updateSubpassScissor())}handleInputEvent(e){this.attached&&e.type==="change"&&(this.updateFullscreenMaterialsInput(),this.syncDefaultBuffers(),this.onInputChange())}handleOutputEvent(e){this.attached&&e.type==="change"&&(this.updateOutputBufferSize(),this.updateFullscreenMaterialsOutput(),this.syncDefaultBuffers(),this.onOutputChange())}handleSceneEvent(e){if(this.attached)switch(e.type){case"childadded":this.onSceneChildAdded(e.child);break;case"childremoved":this.onSceneChildRemoved(e.child);break}}dispose(){this.input.dispose(),this.output.dispose(),this.shaderDataTracker.dispose();for(let e of this.materials)e==null||e.dispose();for(let e of this.disposables)e.dispose();for(let e of this.subpasses)e.dispose()}};n(w,"fullscreenGeometry",(()=>{let e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new A.BufferGeometry;return t.setAttribute("position",new A.BufferAttribute(e,3)),t})()),n(w,"idManager",new O),n(w,"sceneEventTargets",new WeakMap);var T=w;var y=m("three"),Gs=new Map([[y.FloatType,"highp"],[y.HalfFloatType,"mediump"],[y.UnsignedByteType,"lowp"]]),Os=new Map([[y.RedFormat,"float"],[y.RGFormat,"vec2"],[y.RGBFormat,"vec3"],[y.RGBAFormat,"vec4"]]);function oe(o){let r=new Map;for(let e=0,t=o.textures.length;e<t;++e){let s=o.textures[e];r.set(s.name,e)}return r}function Ce(o){let r=[];for(let e=0,t=o.textures.length;e<t;++e){let s=o.textures[e],i=Gs.get(s.type),a=Os.get(s.format),u=s.name.replace(/\W*/g,"");e===0&&r.push("#ifndef gl_FragColor"),r.push(`layout(location = ${e}) out ${i} ${a} out_FragData${e};`),u!==""&&r.push(`#define out_${u} out_FragData${e}`),e===0&&(r.push(`#define gl_FragColor out_FragData${e}`),r.push("#endif"))}return r.join(`
`)}function we(o){if(o.includes("pp_normal_codec_pars_fragment")||(o=o.replace(/(void\s+main\(\)\s+{)/,`
#include <pp_normal_codec_pars_fragment>
$1`)),!o.includes("pp_gbuffer_default_output_fragment")){let r=o.includes("clipping_planes_fragment");o=o.replace(r?/(#include\s+<clipping_planes_fragment>)/:/(void\s+main\(\)\s+{)/,`$1
#include <pp_gbuffer_default_output_fragment>
`)}return o}var B=m("three");var X=m("three"),he=class extends X.ShaderMaterial{constructor(){super({name:"BackgroundMaterial",fragmentShader:X.ShaderLib.background.fragmentShader,vertexShader:X.ShaderLib.background.vertexShader,uniforms:X.UniformsUtils.clone(X.ShaderLib.background.uniforms),depthWrite:!1,depthTest:!1,fog:!1})}get map(){return this.uniforms.t2D.value}set map(r){this.uniforms.t2D.value=r}};var N=m("three"),me=class extends N.ShaderMaterial{constructor(){super({name:"SkyBoxMaterial",fragmentShader:N.ShaderLib.backgroundCube.fragmentShader,vertexShader:N.ShaderLib.backgroundCube.vertexShader,uniforms:N.UniformsUtils.clone(N.ShaderLib.backgroundCube.uniforms),side:N.BackSide,depthWrite:!1,depthTest:!1,fog:!1})}get envMap(){return this.uniforms.envMap.value}set envMap(r){this.uniforms.envMap.value=r}};var Y=new B.Euler,Is=new B.Matrix4,Pe=class extends B.Group{constructor(){super();n(this,"skyBox");n(this,"background");let e=new B.Mesh(new B.BoxGeometry(1,1,1),new me);e.name="SkyBox",e.geometry.deleteAttribute("normal"),e.geometry.deleteAttribute("uv"),e.matrixAutoUpdate=!1,e.frustumCulled=!1,e.layers.enableAll(),this.skyBox=e,e.onBeforeRender=function(s,i,a){this.matrixWorld.copyPosition(a.matrixWorld)};let t=new B.Mesh(new B.PlaneGeometry(2,2),new he);t.name="Background",t.geometry.deleteAttribute("normal"),t.matrixAutoUpdate=!1,t.frustumCulled=!1,t.layers.enableAll(),this.background=t,this.add(this.skyBox,this.background)}setClearValues(e){let t=new me,s=new he,i=new Map,a=[],u=[];for(let p of e.gBuffer){let d=typeof p[1]=="number"?"float":`vec${[...p[1]].length}`;i.set(`pp_${p[0]}`,new B.Uniform(p[1])),a.push(`uniform ${d} pp_${p[0]};`),u.push(`	#ifdef out_${p[0]}
		out_${p[0]} = pp_${p[0]};
#endif`)}let l=a.join(`
`),f=u.join(`
`);for(let p of[t,s]){p.fragmentShader=p.fragmentShader.replace(/(void main\(\) {)/,`
${l}
$1
${f}
`);for(let d of i)p.uniforms[d[0]]=d[1];p.onBeforeCompile=(d,R)=>{let g=R.getRenderTarget();if(g===null)return;let v=Ce(g);d.fragmentShader=v+`

`+d.fragmentShader}}this.skyBox.material.dispose(),this.background.material.dispose(),this.skyBox.material=t,this.background.material=s}update(e){let{skyBox:t,background:s}=this;if(t.visible=!1,s.visible=!1,!(e===null||!(e.background instanceof B.Texture)))if(e.background instanceof B.CubeTexture||e.background.mapping===B.CubeUVReflectionMapping){let i=e.background.isRenderTargetTexture?1:-1;Y.copy(e.backgroundRotation),Y.x*=-1,Y.y*=-1,Y.z*=-1,Y.y*=i,Y.z*=i,t.material.envMap=e.background,t.material.uniforms.flipEnvMap.value=i,t.material.uniforms.backgroundBlurriness.value=e.backgroundBlurriness,t.material.uniforms.backgroundIntensity.value=e.backgroundIntensity,t.material.uniforms.backgroundRotation.value.setFromMatrix4(Is.makeRotationFromEuler(Y)),t.visible=!0}else s.material.map=e.background,s.material.uniforms.backgroundIntensity.value=e.backgroundIntensity,s.visible=!0}dispose(){this.skyBox.material.dispose(),this.background.material.dispose()}};var Fe=class{constructor(r=!0,e=!0,t=!0){n(this,"gBuffer");n(this,"depth");n(this,"stencil");this.gBuffer=new Set(["Normal","ORM","Emission"]),this.color=r,this.depth=e,this.stencil=t}get color(){return this.gBuffer.has("Color")}set color(r){r?this.gBuffer.add("Color"):this.gBuffer.delete("Color")}};var er=m("three");var Ue=class extends er.EventDispatcher{constructor(){super();n(this,"_color");n(this,"_alpha");n(this,"gBuffer");this._color=null,this._alpha=null;let e=new S([["Normal",[0,0]],["ORM",[1,0,0,1]],["Emission",[0,0,0,1]]]);e.addEventListener("change",()=>this.setChanged()),this.gBuffer=e}get color(){return this._color}set color(e){this._color=e,this.setChanged()}get alpha(){return this._alpha}set alpha(e){this._alpha=e,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}};var Ls=new ge.Color,C=new Float32Array(4),K=class o extends T{constructor(e=!0,t=!0,s=!0){super("ClearPass");n(this,"clearFlags");n(this,"clearValues");n(this,"gBufferIndices");n(this,"background");n(this,"backgroundScene");this.clearFlags=new Fe(e,t,s),this.clearValues=new Ue,this.gBufferIndices=null,this.background=new Pe,this.background.setClearValues(this.clearValues),this.clearValues.addEventListener("change",()=>this.background.setClearValues(this.clearValues)),this.backgroundScene=new ge.Scene,this.backgroundScene.add(this.background),this.disposables.add(this.background)}clearBuffers(e,t){let s=this.clearFlags,i=this.clearValues.gBuffer;for(let a of t){let u=i.get(a[0]);!s.gBuffer.has(a[0])||u===void 0||(typeof u=="number"?(C[0]=u,C[1]=0,C[2]=0,C[3]=1):(C[0]=u.length>0?u[0]:0,C[1]=u.length>1?u[1]:0,C[2]=u.length>2?u[2]:0,C[3]=u.length>3?u[3]:1),e.clearBufferfv(e.COLOR,a[1],C))}}clear(e=this.clearValues.color){var a;let t=this.renderer,s=t.getContext(),i=(a=this.clearValues.alpha)!=null?a:t.getClearAlpha();e!=null||(e=t.getClearColor(Ls)),C[0]=e.r,C[1]=e.g,C[2]=e.b,C[3]=i,s.clearBufferfv(s.COLOR,0,C),this.gBufferIndices!==null&&this.gBufferIndices.size>1&&this.clearBuffers(s,this.gBufferIndices)}clearWithBackground(){let e=this.scene,t=this.camera,s=this.renderer;e.background instanceof ge.Color?this.clear(e.background):(this.background.update(e),s.render(this.backgroundScene,t))}onOutputChange(){var t,s;let e=(s=(t=this.output.defaultBuffer)==null?void 0:t.value)!=null?s:null;this.gBufferIndices=e!==null?oe(e):null}compile(){return G(this,null,function*(){this.renderer===null||this.camera===null||(yield Promise.all([ee(o.prototype,this,"compile").call(this),this.renderer.compileAsync(this.backgroundScene,this.camera)]))})}render(){var i,a,u;if(this.renderer===null)return;let e=(a=(i=this.scene)==null?void 0:i.background)!=null?a:null,t=this.clearValues.color!==null,s=this.clearFlags;this.setRenderTarget((u=this.output.defaultBuffer)==null?void 0:u.value),(s.depth||s.stencil)&&this.renderer.clear(!1,s.depth,s.stencil),!t&&this.camera!==null&&e!==null?this.clearWithBackground():this.clear()}};var h=m("three");var tr=m("three");var Gt=(u=>(u.COLOR="color",u.DEPTH="depth",u.NORMAL="normal",u.POSITION="position",u.ORM="orm",u.EMISSION="emission",u.LUMINANCE="luminance",u))(Gt||{});var De=class extends tr.EventDispatcher{constructor(){super();n(this,"textureConfigs");n(this,"gBufferStructFields");n(this,"gBufferStructDeclaration");n(this,"gDataStructDeclaration");n(this,"gDataStructInitialization");n(this,"gDataDependencies");n(this,"gDataBufferSources");let e=new S,t=new S([["Color","color"],["Depth","depth"],["Normal","normal"],["ORM","orm"],["Emission","emission"]]),s=new S([["Color","FRAME_BUFFER_PRECISION sampler2D color;"],["Depth","DEPTH_BUFFER_PRECISION sampler2D depth;"],["Normal","mediump sampler2D normal;"],["ORM","lowp sampler2D orm;"],["Emission","mediump sampler2D emission;"]]),i=new S([["color","vec4 color;"],["depth","float depth;"],["normal","vec3 normal;"],["position","vec3 position;"],["orm","vec3 orm;"],["emission","vec3 emission;"],["luminance","float luminance;"]]),a=new S([["color","gData.color = texture(gBuffer.color, UV);"],["depth","gData.depth = readDepth(gBuffer.depth, UV);"],["normal","gData.normal = readNormal(gBuffer.normal, UV);"],["position","gData.position = getViewPosition(UV, gData.depth);"],["orm","gData.orm = texture(gBuffer.orm, UV).xyz;"],["emission","gData.emission = texture(gBuffer.emission, UV).rgb;"],["luminance","gData.luminance = luminance(gData.color.rgb);"]]),u=new S([["position",new Set(["depth"])],["luminance",new Set(["color"])]]),l=new S([["color",new Set(["Color"])],["depth",new Set(["Depth"])],["normal",new Set(["Normal"])],["position",new Set(["Depth"])],["orm",new Set(["ORM"])],["emission",new Set(["Emission"])],["luminance",new Set(["Color"])]]),f=()=>this.dispatchEvent({type:"change"});e.addEventListener("change",f),t.addEventListener("change",f),s.addEventListener("change",f),i.addEventListener("change",f),a.addEventListener("change",f),u.addEventListener("change",f),l.addEventListener("change",f),this.textureConfigs=e,this.gBufferStructFields=t,this.gBufferStructDeclaration=s,this.gDataStructDeclaration=i,this.gDataStructInitialization=a,this.gDataDependencies=u,this.gDataBufferSources=l}};var ue=class ue extends Set{constructor(e,t=ue.idManager.getNextId()){super();n(this,"_layer");n(this,"enabled");n(this,"exclusive");this._layer=t,(this._layer<1||this._layer>31)&&(console.warn("Layer out of range, resetting to 2"),ue.idManager.reset(2),this._layer=ue.idManager.getNextId()),this.enabled=!0,this.exclusive=!1,e!=null&&this.set(e)}get layer(){return this._layer}set layer(e){let t=this._layer;for(let s of this)s.layers.disable(t),s.layers.enable(e);this._layer=e}clear(){let e=this.layer;for(let t of this)t.layers.disable(e);super.clear()}add(e){return this.exclusive?e.layers.set(this.layer):e.layers.enable(this.layer),super.add(e)}delete(e){return this.has(e)&&e.layers.disable(this.layer),super.delete(e)}set(e){this.clear();for(let t of e)this.add(t);return this}toggle(e){let t;return this.has(e)?(this.delete(e),t=!1):(this.add(e),t=!0),t}setVisible(e){for(let t of this)e?t.layers.enable(0):t.layers.disable(0);return this}};n(ue,"idManager",new O(2));var Ge=ue;var ve=m("three");var rr=`#include <common>
#include <pp_default_output_pars_fragment>
#ifdef COLOR_WRITE
#include <dithering_pars_fragment>
#include <pp_input_buffer_pars_fragment>
#endif
#ifdef DEPTH_WRITE
#include <pp_depth_buffer_pars_fragment>
#endif
#ifdef USE_WEIGHTS
uniform vec4 channelWeights;
#endif
in vec2 vUv;void main(){
#ifdef COLOR_WRITE
vec4 texel=texture2D(inputBuffer,vUv);
#ifdef USE_WEIGHTS
texel*=channelWeights;
#endif
out_Color=texel;
#ifdef COLOR_SPACE_CONVERSION
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
#else
out_Color=vec4(0.0);
#endif
#ifdef DEPTH_WRITE
gl_FragDepth=texture(depthBuffer,vUv).r;
#endif
}`;var Oe=class extends _{constructor(){super({name:"CopyMaterial",fragmentShader:rr,vertexShader:se,defines:{COLOR_SPACE_CONVERSION:!0,COLOR_WRITE:!0},uniforms:{depthBuffer:new ve.Uniform(null),channelWeights:new ve.Uniform(null)}}),this.depthFunc=ve.AlwaysDepth}get inputBuffer(){return super.inputBuffer}set inputBuffer(r){let e=r!==null;this.colorWrite!==e&&(e?this.defines.COLOR_WRITE=!0:delete this.defines.COLOR_WRITE,this.colorWrite=e,this.needsUpdate=!0),super.inputBuffer=r}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(r){let e=r!==null;this.depthWrite!==e&&(e?this.defines.DEPTH_WRITE=!0:delete this.defines.DEPTH_WRITE,this.depthTest=e,this.depthWrite=e,this.needsUpdate=!0),this.uniforms.depthBuffer.value=r}get colorSpaceConversion(){return this.defines.COLOR_SPACE_CONVERSION!==void 0}set colorSpaceConversion(r){this.colorSpaceConversion!==r&&(r?this.defines.COLOR_SPACE_CONVERSION=!0:delete this.defines.COLOR_SPACE_CONVERSION,this.needsUpdate=!0)}get channelWeights(){return this.uniforms.channelWeights.value}set channelWeights(r){r!==null?(this.defines.USE_WEIGHTS=!0,this.uniforms.channelWeights.value=r):delete this.defines.USE_WEIGHTS,this.needsUpdate=!0}};var Le=class Le extends T{constructor(r){super("CopyPass"),this.output.defaultBuffer=r!=null?r:this.createFramebuffer(),this.fullscreenMaterial=new Oe}get renderer(){return super.renderer}set renderer(r){super.renderer=r,this.initializeOutputBuffer()}initializeOutputBuffer(){var e,t;let r=(t=(e=this.output.defaultBuffer)==null?void 0:e.value)!=null?t:null;this.renderer!==null&&r!==null&&this.renderer.initRenderTarget(r)}configureDepthBuffer(){var s,i,a;let r=this.input.getBuffer("Depth"),e=(a=(i=(s=this.output.defaultBuffer)==null?void 0:s.value)==null?void 0:i.depthTexture)!=null?a:null,t=r===e;this.fullscreenMaterial.depthBuffer=r===null||t?null:r}onInputChange(){this.configureDepthBuffer()}onOutputChange(){this.configureDepthBuffer(),this.initializeOutputBuffer()}onResolutionChange(){this.initializeOutputBuffer()}blit(){var i,a,u,l;if(!Le.blitEnabled)return!1;let r=(a=(i=this.input.defaultBuffer)==null?void 0:i.value)!=null?a:null,e=(l=(u=this.output.defaultBuffer)==null?void 0:u.value)!=null?l:null;if(this.renderer===null||r===null||e===null)return!1;let t=r.source.data;if(t.width!==e.width||t.height!==e.height)return!1;r.type===e.texture.type&&r.format===e.texture.format&&this.renderer.copyTextureToTexture(r,e.texture);let s=this.input.getBuffer("Depth");return s!==null&&e.depthTexture!==null&&s!==e.depthTexture&&s.type===e.depthTexture.type&&s.format===e.depthTexture.format&&this.renderer.copyTextureToTexture(s,e.depthTexture),!0}render(){var e,t,s;let r=(t=(e=this.input.defaultBuffer)==null?void 0:e.value)!=null?t:null;this.renderer===null||r===null||this.blit()||(this.setRenderTarget((s=this.output.defaultBuffer)==null?void 0:s.value),this.renderFullscreen())}};n(Le,"blitEnabled",!1);var Ie=Le;var sr=m("three");var Ne=class{constructor(){n(this,"registeredMaterials",new WeakSet);n(this,"_enabled");n(this,"_gBuffer");this._enabled=!0,this._gBuffer=null}get enabled(){return this._enabled}set enabled(r){this._enabled=r}get gBuffer(){return this._gBuffer}set gBuffer(r){this._gBuffer=r}applyTo(r){if(this.registeredMaterials.has(r))return;this.registeredMaterials.add(r);let e=r.onBeforeCompile,t=r.customProgramCacheKey;r.onBeforeCompile=(s,i)=>{if(r.onBeforeCompile!==e&&e.call(r,s,i),!(!this.enabled||this.gBuffer===null)&&(r instanceof sr.ShaderMaterial&&(s.fragmentShader=we(s.fragmentShader)),!s.fragmentShader.includes("out_FragData"))){let a=Ce(this.gBuffer);s.fragmentShader=a+`
`+s.fragmentShader}},r.customProgramCacheKey=()=>{var a,u;let s="";r.customProgramCacheKey!==t&&(s+=t.call(r));let i=(u=(a=this.gBuffer)==null?void 0:a.texture.uuid)!=null?u:"";return s+this.enabled+i}}};var q=class o extends T{constructor(e,t,{alpha:s=!1,stencilBuffer:i=!1,depthBuffer:a=!0,frameBufferType:u=h.HalfFloatType,samples:l=0,gBufferConfig:f=new De}={}){super("GeometryPass");n(this,"selection");n(this,"copyPass");n(this,"gBufferShaderPlugin");n(this,"gBufferResource");n(this,"gBufferComponents");n(this,"alpha");n(this,"stencilBuffer");n(this,"depthBuffer");n(this,"frameBufferType");n(this,"gBufferConfig");n(this,"_samples");this.alpha=s,this.stencilBuffer=i,this.depthBuffer=a,this.frameBufferType=u,this._samples=l,this.selection=new Ge,this.selection.enabled=!1,this.gBufferConfig=f,this.copyPass=new Ie,this.copyPass.enabled=!1,this.subpasses=[this.copyPass];let p=new te;p.addEventListener("change",()=>this.updateGBuffer()),this.gBufferComponents=p,this.gBufferShaderPlugin=new Ne,this.gBufferResource=new L,this.output.defaultBuffer=this.gBufferResource,this.scene=e,this.camera=t,this.updateTextureConfigs()}get enabled(){return super.enabled}set enabled(e){super.enabled!==e&&(super.enabled=e,this.gBufferShaderPlugin.enabled=e,this.invalidateMaterials())}get scene(){return super.scene}set scene(e){super.scene=e,e!==null&&this.onSceneChildAdded(e)}get samples(){return this._samples}set samples(e){var s,i;this._samples=e;let t=(i=(s=this.output.defaultBuffer)==null?void 0:s.value)!=null?i:null;t!==null&&t.samples!==e&&(t.samples=e,t.dispose())}get gBuffer(){return this.gBufferResource.value}get frameBufferPrecisionHigh(){return this.frameBufferType===h.HalfFloatType||this.frameBufferType===h.FloatType}get textureConfigs(){return Array.from(this.gBufferConfig.textureConfigs).filter(e=>this.gBufferComponents.has(e[0]))}get renderer(){return super.renderer}set renderer(e){super.renderer=e,this.updateOutputBufferColorSpace()}invalidateMaterial(e){if(!("material"in e))return;let t=Array.isArray(e.material)?e.material:[e.material];for(let s of t)s.needsUpdate=!0}invalidateMaterials(){var e;(e=this.scene)==null||e.traverse(t=>this.invalidateMaterial(t))}updateTextureConfigs(){let e=this.gBufferConfig.textureConfigs,t=this.frameBufferPrecisionHigh&&!this.alpha;e.set("Color",{minFilter:h.LinearFilter,magFilter:h.LinearFilter,type:this.frameBufferType,format:t?h.RGBFormat:h.RGBAFormat,internalFormat:t?"R11F_G11F_B10F":void 0,isColorBuffer:!0}),e.set("Normal",{minFilter:h.NearestFilter,magFilter:h.NearestFilter,type:h.HalfFloatType,format:h.RGFormat}),e.set("ORM",{minFilter:h.NearestFilter,magFilter:h.NearestFilter,type:h.UnsignedByteType,format:h.RGBAFormat}),e.set("Emission",{minFilter:h.LinearFilter,magFilter:h.LinearFilter,type:h.HalfFloatType,format:h.RGBAFormat}),this.updateGBuffer()}updateMaterial(e){if(!("material"in e))return;let t=Array.isArray(e.material)?e.material:[e.material];for(let s of t)this.gBufferShaderPlugin.applyTo(s)}updateOutputBufferColorSpace(){let e=this.gBuffer,t=this.renderer;if(e===null||t===null)return;let s=oe(e),i=this.autoSRGB&&!this.frameBufferPrecisionHigh&&t.outputColorSpace===h.SRGBColorSpace;for(let a of this.textureConfigs)if(a[1].isColorBuffer===!0&&s.has(a[0])){let u=s.get(a[0]),l=e.textures[u];l.colorSpace=i?h.SRGBColorSpace:h.NoColorSpace,l.needsUpdate=!0}}updateGBuffer(){var l,f,p;let e=this.output,t=this.gBufferComponents;if(!e.hasDefaultBuffer)e.defaultBuffer=this.gBufferResource;else if(e.defaultBuffer!==this.gBufferResource)return;if((f=(l=e.defaultBuffer.value)==null?void 0:l.depthTexture)==null||f.dispose(),(p=e.defaultBuffer.value)==null||p.dispose(),t.size===0){e.defaultBuffer=null,e.defines.clear();return}let{width:s,height:i}=this.resolution,a=this.textureConfigs,u=new h.WebGLRenderTarget(s,i,{stencilBuffer:this.stencilBuffer,depthBuffer:this.depthBuffer,samples:this.samples,count:a.length});for(let d=0,R=a.length;d<R;++d){let g=a[d],v=u.textures[d],D=g[1];v.name=g[0],v.minFilter=D.minFilter,v.magFilter=D.magFilter,v.format=D.format,v.type=D.type,D.internalFormat!==void 0&&(v.internalFormat=D.internalFormat)}e.defaultBuffer=u,this.configureDepthTexture(),this.updateOutputBufferColorSpace()}configureDepthTexture(){var i,a,u,l,f;let e=this.output;if(e.defaultBuffer!==this.gBufferResource)return;let t=(a=(i=e.defaultBuffer)==null?void 0:i.value)!=null?a:null;if(t===null)return;if(!this.gBufferComponents.has("Depth")){(u=t.depthTexture)==null||u.dispose(),t.depthTexture=null;return}let s=this.input.getBuffer("Depth");if(s!==null)t.depthTexture!==s&&((l=t.depthTexture)==null||l.dispose(),t.depthTexture=s);else{let p=new h.DepthTexture(1,1);p.name="Depth",p.format=this.stencilBuffer?h.DepthStencilFormat:h.DepthFormat,p.type=this.stencilBuffer?h.UnsignedInt248Type:h.FloatType,(f=t.depthTexture)==null||f.dispose(),t.depthTexture=p}}updateCopyPass(){var a,u,l,f,p;let e=(u=(a=this.input.defaultBuffer)==null?void 0:a.value)!=null?u:null,t=(f=(l=this.output.defaultBuffer)==null?void 0:l.value)!=null?f:null,s=e===(t==null?void 0:t.texture),i=((p=t==null?void 0:t.textures.length)!=null?p:0)>1;this.copyPass.enabled=e!==null&&!s&&!i}onInputChange(){this.configureDepthTexture();let e=this.copyPass;e.input.defaultBuffer=this.input.defaultBuffer,this.updateCopyPass(),this.input.buffers.has("Depth")?e.input.buffers.set("Depth",this.input.buffers.get("Depth")):e.input.buffers.delete("Depth")}onOutputChange(){var e,t;this.output.hasDefaultBuffer?this.configureDepthTexture():(this.gBufferResource.mute(),this.updateGBuffer(),this.gBufferResource.unmute()),this.gBufferShaderPlugin.gBuffer=(t=(e=this.output.defaultBuffer)==null?void 0:e.value)!=null?t:null,this.copyPass.output.defaultBuffer=this.output.defaultBuffer,this.updateCopyPass()}onResolutionChange(){this.copyPass.resolution.copy(this.resolution)}onSceneChildAdded(e){e.traverse(t=>this.updateMaterial(t))}compile(){return G(this,null,function*(){if(this.renderer===null||this.scene===null||this.camera===null)return;let e=[];e.push(ee(o.prototype,this,"compile").call(this)),e.push(this.renderer.compileAsync(this.scene,this.camera)),yield Promise.all(e)})}render(){var u;let{renderer:e,scene:t,camera:s}=this;if(e===null||t===null||s===null)return;let i=s.layers.mask,a=t.background;t.background=null,this.selection.enabled&&s.layers.set(this.selection.layer),this.copyPass.enabled&&this.copyPass.render(),this.setRenderTarget((u=this.output.defaultBuffer)==null?void 0:u.value),e.render(t,s),s.layers.mask=i,t.background=a}};function ir(o,r){for(let e of o.input.buffers.values())r.add(e);for(let e of o.output.buffers.values())r.add(e);for(let e of o.subpasses)ir(e,r)}var ze=class{constructor(r){n(this,"pipelines");n(this,"activeResources");this.pipelines=r,this.activeResources=new Set}gatherResources(){let r=new Set;for(let e of this.pipelines)for(let t of e.passes)ir(t,r);return r}optimize(){let r=this.gatherResources();for(let e of this.activeResources)e instanceof $&&!r.has(e)&&e.dispose();this.activeResources=r}};var Ve=class o{constructor(){n(this,"pipelines");n(this,"resourceManager");n(this,"outputDefaultBuffers");n(this,"updating");this.pipelines=new Set,this.resourceManager=new ze(this.pipelines),this.outputDefaultBuffers=new WeakMap,this.updating=!1}updateInput(r){let e=o.findMainGeometryPass(r),t=r.passes.filter(i=>i.enabled);for(let i=0,a=1,u=t.length;i<u;++i,++a){let l=t[i];if(l!==e){if(a<u&&l instanceof K){let f=t[a];l.scene=f.scene,l.camera=f.camera}else!(l instanceof q)&&e!==void 0&&(l.scene=e.scene,l.camera=e.camera);o.assignGBufferTextures(l,e)}}let s;for(let i=0,a=1,u=t.length;a<u;++i,++a){let l=t[i],f=t[a];!(l instanceof K)&&l.output.hasDefaultBuffer&&l.output.defaultBuffer.value!==null&&(s=l.output.defaultBuffer),l.output.defines.forEach((p,d)=>f.input.defines.set(d,p)),l.output.uniforms.forEach((p,d)=>f.input.uniforms.set(d,p)),s===void 0?f.input.buffers.delete(re.BUFFER_DEFAULT):s!==void 0&&(f.input.defaultBuffer=s.texture)}}restoreOutputBuffers(r){let e=this.outputDefaultBuffers;for(let t of r)if(t.output.defaultBuffer!==null&&e.has(t.output.defaultBuffer)){let s=e.get(t.output.defaultBuffer);e.delete(t.output.defaultBuffer),t.output.defaultBuffer=s}}updateOutput(r){let e=r.passes.filter(t=>t.enabled);if(r.autoRenderToScreen&&e.length>0){this.restoreOutputBuffers(e);let t=this.outputDefaultBuffers,s=e[e.length-1];s.output.defaultBuffer!==null&&(t.set(s.output.defaultBuffer,s.output.defaultBuffer.value),s.output.defaultBuffer=null)}for(let t=0,s=1,i=e.length;s<i;++t,++s){let a=e[t];if(a instanceof K){let u=e[s];u.output.defines.forEach((l,f)=>a.output.defines.set(f,l)),u.output.uniforms.forEach((l,f)=>a.output.uniforms.set(f,l)),a.output.defaultBuffer=u.output.defaultBuffer}}}addPipeline(r){this.pipelines.add(r)}removePipeline(r){this.pipelines.delete(r)}updatePipeline(r){o.gatherGBufferComponents(r),this.updateOutput(r),this.updateInput(r)}update(){if(!this.updating){this.updating=!0;for(let r of this.pipelines)this.updatePipeline(r);this.resourceManager.optimize(),this.updating=!1}}static findMainGeometryPass(r){return r.passes.find(e=>e.enabled&&e instanceof q)}static gatherGBufferComponents(r){let e=o.findMainGeometryPass(r);if(e===void 0)return;e.gBufferComponents.clear();for(let s of r.passes.filter(i=>i.enabled))for(let i of s.input.gBuffer)e.gBufferComponents.add(i);let t=r.passes.filter(s=>s.enabled&&s instanceof q);if(!(t.length<=1||!e.gBufferComponents.has("Color")))for(let s=1,i=t.length;s<i;++s){let a=t[s];a.gBufferComponents.add("Color"),a.depthBuffer&&(a.gBufferComponents.add("Depth"),a.input.gBuffer.add("Depth"),e.gBufferComponents.add("Depth"))}}static assignGBufferTextures(r,e){if(e===void 0||e.gBuffer===null)return;r.input.gBufferConfig=e.gBufferConfig;let t=oe(e.gBuffer);for(let s of r.input.gBuffer)if(s==="Depth")r.input.buffers.set(s,new I(e.gBuffer.depthTexture));else if(t.has(s)){let i=t.get(s);r.input.buffers.set(s,new I(e.gBuffer.textures[i]))}}};var J=m("three");var x=m("three");var nr=`uniform mat4 projectionMatrix;uniform mat4 projectionMatrixInverse;uniform vec3 cameraParams;
#define CAMERA_NEAR cameraParams.x
#define CAMERA_FAR cameraParams.y
#define CAMERA_ASPECT cameraParams.z
#ifdef PERSPECTIVE_CAMERA
#define getViewZ(depth) perspectiveDepthToViewZ(depth, CAMERA_NEAR, CAMERA_FAR)
#else
#define getViewZ(depth) orthographicDepthToViewZ(depth, CAMERA_NEAR, CAMERA_FAR)
#endif
vec3 getViewPosition(const in vec2 screenPosition,const in float depth,const in float viewZ){vec4 clipPosition=vec4(vec3(screenPosition,depth)*2.0-1.0,1.0);float clipW=projectionMatrix[2][3]*viewZ+projectionMatrix[3][3];clipPosition*=clipW;return(projectionMatrixInverse*clipPosition).xyz;}vec3 getViewPosition(const in vec2 screenPosition,const in float depth){return getViewPosition(screenPosition,depth,getViewZ(depth));}`;var ar="vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}";var or=`#ifndef gl_FragColor
layout(location=0)out OUTPUT_COLOR_PRECISION vec4 out_FragData0;
#define gl_FragColor out_FragData0
#ifndef out_Color
#define out_Color out_FragData0
#endif
#endif`;var ur=`#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif`;var lr=`#ifdef GL_FRAGMENT_PRECISION_HIGH
#define DEPTH_BUFFER_PRECISION highp
#else
#define DEPTH_BUFFER_PRECISION mediump
#endif`;var fr=`float readDepth(sampler2D depthBuffer,const in vec2 uv,const in float near,const in float far){float depth=texture(depthBuffer,uv).r;
#ifdef USE_REVERSEDEPTHBUF
return 1.0-depth;
#else
#ifdef USE_LOGDEPTHBUF
float d=pow(2.0,depth*log2(far+1.0))-1.0;float a=far/(far-near);float b=far*near/(near-far);depth=a+b/d;
#endif
return depth;
#endif
}
#if defined(CAMERA_NEAR) && defined(CAMERA_FAR)
#define readDepth(depthBuffer, uv) readDepth(depthBuffer, uv, CAMERA_NEAR, CAMERA_FAR);
#endif`;var cr=`#ifdef FRAME_BUFFER_PRECISION_HIGH
#define FRAME_BUFFER_PRECISION mediump
#else
#define FRAME_BUFFER_PRECISION lowp
#endif`;var pr=`#ifdef out_Color
out_Color=vec4(0.0);
#endif
#ifdef out_Emission
out_Emission=vec4(0.0);
#endif
#ifdef out_ORM
out_ORM=vec4(0.0);
#endif
#ifdef out_Normal
out_Normal=vec2(0.0);
#endif`;var dr=`#ifdef FRAME_BUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif`;var hr="uint uhash(uint x){x+=x>>11;x ^=x<<7;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}uint uhash(uvec2 p){uint x=p.x;x+=x>>11;x ^=x<<7;x+=p.y;x ^=x<<6;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}uint uhash(uvec3 p){uint x=p.x;x+=x>>11;x ^=x<<7;x+=p.y;x ^=x<<3;x+=p.z ^(x>>14);x ^=x<<6;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}float urand(uint h){const uint mantissaMask=0x007FFFFFu;const uint one=0x3F800000u;h&=mantissaMask;h|=one;float r2=uintBitsToFloat(h);return r2-1.0;}float urand(float p){return urand(uhash(floatBitsToUint(p)));}float urand(vec2 p){return urand(uhash(floatBitsToUint(p)));}float urand(vec3 p){return urand(uhash(floatBitsToUint(p)));}";var mr="vec2 pp_encodeNormal(vec3 n){n/=(abs(n.x)+abs(n.y)+abs(n.z));n.xy=(n.z>=0.0)?n.xy:(1.0-abs(n.yx))*vec2(n.x>=0.0?1.0:-1.0,n.y>=0.0?1.0:-1.0);return n.xy;}vec3 pp_decodeNormal(vec2 f){vec3 n=vec3(f.x,f.y,1.0-abs(f.x)-abs(f.y));float t=clamp(-n.z,0.0,1.0);n.xy+=vec2(n.x>=0.0?-t:t,n.y>=0.0?-t:t);return normalize(n);}";var gr="vec3 readNormal(mediump sampler2D normalBuffer,const in vec2 uv){return pp_decodeNormal(texture(normalBuffer,uv).xy);}";var vr="uniform vec4 resolution;";var Ar=`uniform mat4 viewMatrixInverse;
#define getWorldPosition(viewPosition) (viewMatrixInverse * vec4(viewPosition, 1.0)).xyz
#define getDistance(viewPosition) length(viewPosition)`;var Ot=`#ifdef out_Normal
out_Normal.xy=pp_encodeNormal(normal);
#endif`;var It=`#ifdef out_ORM
#ifdef USE_AOMAP
out_ORM.x=ambientOcclusion;
#else
out_ORM.x=1.0;
#endif
#endif`;var Lt=`#ifdef out_ORM
out_ORM.y=roughnessFactor;
#endif`;var br=`#ifdef out_ORM
out_ORM.y=material.roughness;
#endif`;var Nt=`#ifdef out_ORM
out_ORM.z=metalnessFactor;
#endif`;var zt=`#ifdef out_Emission
out_Emission=vec4(totalEmissiveRadiance,1.0);
#endif`;var Ae=class Ae{static register(){if(Ae.registered)return;Ae.registered=!0,Object.assign(x.ShaderChunk,{pp_camera_pars_fragment:nr,pp_colorspace_conversion_pars_fragment:ar,pp_default_output_pars_fragment:or,pp_depth_buffer_pars_fragment:ur,pp_depth_buffer_precision_pars_fragment:lr,pp_depth_utils_pars_fragment:fr,pp_frame_buffer_precision_pars_fragment:cr,pp_gbuffer_default_output_fragment:pr,pp_gbuffer_normal_fragment:Ot,pp_gbuffer_occlusion_fragment:It,pp_gbuffer_roughness_fragment:Lt,pp_gbuffer_metalness_fragment:Nt,pp_gbuffer_emission_fragment:zt,pp_input_buffer_pars_fragment:dr,pp_normal_codec_pars_fragment:mr,pp_noise_pars_fragment:hr,pp_normal_utils_pars_fragment:gr,pp_resolution_pars_fragment:vr,pp_world_utils_pars_fragment:Ar}),x.ShaderChunk.normal_fragment_maps+=`
`+Ot,x.ShaderChunk.aomap_fragment+=`
`+It,x.ShaderChunk.roughnessmap_fragment+=`
`+Lt,x.ShaderChunk.lights_physical_fragment+=`
`+br,x.ShaderChunk.metalnessmap_fragment+=`
`+Nt,x.ShaderChunk.emissivemap_fragment+=`
`+zt;let r=[x.ShaderLib.background,x.ShaderLib.backgroundCube,x.ShaderLib.basic,x.ShaderLib.cube,x.ShaderLib.dashed,x.ShaderLib.lambert,x.ShaderLib.matcap,x.ShaderLib.phong,x.ShaderLib.physical,x.ShaderLib.points,x.ShaderLib.sprite,x.ShaderLib.standard,x.ShaderLib.toon];for(let e of r)e.fragmentShader=we(e.fragmentShader)}};n(Ae,"registered",!1);var ke=Ae;var Ns=new J.Vector2,E=class E{constructor(r=null){n(this,"_timer");n(this,"_passes");n(this,"_renderer");n(this,"_autoRenderToScreen");n(this,"resolution");n(this,"updateStyle");ke.register(),E.ioManager.addPipeline(this),this._timer=new J.Timer,this._passes=[],this._renderer=null,this._autoRenderToScreen=!0,this.resolution=new H,this.resolution.addEventListener("change",()=>this.onResolutionChange()),this.updateStyle=!0,this.renderer=r}get autoRenderToScreen(){return this._autoRenderToScreen}set autoRenderToScreen(r){this.autoRenderToScreen!==r&&(this._autoRenderToScreen=r,E.ioManager.update())}get renderer(){return this._renderer}set renderer(r){this._renderer=r;for(let e of this.passes)e.renderer=r;r!==null&&(r.autoClear=!1,this.setPixelRatio(r.getPixelRatio()),this.passes.length>0&&E.ioManager.update())}get timer(){return this._timer}get passes(){return this._passes}registerPass(r){E.registeredPasses.add(r),r.resolution.pixelRatio=this.resolution.scaledPixelRatio,r.resolution.copyBaseSize(this.resolution),r.renderer=this.renderer,r.timer=this.timer,r.attached=!0,r.addEventListener("toggle",E.listener),r.input.addEventListener("change",E.listener),r.output.addEventListener("change",E.listener)}unregisterPass(r){E.registeredPasses.delete(r),r.renderer=null,r.timer=null,r.attached=!1,r.removeEventListener("toggle",E.listener),r.input.removeEventListener("change",E.listener),r.output.removeEventListener("change",E.listener)}add(...r){for(let e of r){if(E.registeredPasses.has(e))throw new Error(`The pass "${e.name}" has already been added to a pipeline`);this.registerPass(e),this._passes.push(e)}E.ioManager.update()}remove(...r){let e=!1;for(let t of r){let s=this._passes,i=s.indexOf(t);i!==-1&&s.splice(i,1).length>0&&(this.unregisterPass(t),e=!0)}e&&E.ioManager.update()}removeAllPasses(){for(let r of this.passes)this.unregisterPass(r);this._passes=[],E.ioManager.update()}onResolutionChange(){let r=this.renderer;if(r===null){console.debug("Unable to update the render size because the renderer is null");return}let{baseWidth:e,baseHeight:t,pixelRatio:s,scaledPixelRatio:i,scale:a}=this.resolution,u=r.getSize(Ns);if(r.getPixelRatio()!==s&&r.setPixelRatio(s),a===1)(u.width!==e||u.height!==t)&&r.setSize(e,t,this.updateStyle);else{let l=e*a,f=t*a;(u.width!==l||u.height!==f)&&(this.updateStyle&&r.setSize(e,t,!0),r.setSize(l,f,!1))}for(let l of this.passes)l.resolution.pixelRatio=i,l.resolution.setBaseSize(e,t)}setPixelRatio(r){let e=this.updateStyle;this.updateStyle=!1,this.resolution.pixelRatio=r,this.updateStyle=e}setSize(r,e,t=!0){this.renderer!==null&&this.setPixelRatio(this.renderer.getPixelRatio());let s=this.updateStyle;this.updateStyle=t,this.resolution.setSize(r,e),this.updateStyle=s}setViewport(r,e=0,t=0,s=0){if(r instanceof J.Vector4){let i=r;r=i.x,e=i.y,t=i.z,s=i.w}for(let i of this.passes)i.viewport.set(r,e,t,s)}setScissor(r,e=0,t=0,s=0){if(r instanceof J.Vector4){let i=r;r=i.x,e=i.y,t=i.z,s=i.w}for(let i of this.passes)i.scissor.set(r,e,t,s)}compile(){return G(this,null,function*(){let r=[];for(let e of this.passes)r.push(e.compile());yield Promise.all(r)})}render(r){if(this.renderer===null)return;this._timer.update(r);let e=this.renderer,t=e.info.autoReset;t&&(e.info.reset(),e.info.autoReset=!1);for(let s of this.passes)s.enabled&&s.render();e.info.autoReset=t}dispose(){E.ioManager.removePipeline(this);for(let r of this.passes)r.dispose();this.removeAllPasses(),this._timer.dispose(),T.fullscreenGeometry.dispose()}};n(E,"ioManager",new Ve),n(E,"registeredPasses",new WeakSet),n(E,"listener",()=>E.ioManager.update());var He=E;var We=class We{constructor(r,e,t=!1){n(this,"id");n(this,"name");n(this,"shader");n(this,"supportsHDR");this.id=We.idManager.getNextId(),this.name=r,this.shader=e,this.supportsHDR=t}};n(We,"idManager",new O);var c=We;var $e=m("three");var je=class extends $e.EventDispatcher{constructor(e,t=1){super();n(this,"_blendFunction");n(this,"opacityUniform");this._blendFunction=e,this.opacityUniform=new $e.Uniform(t)}get opacity(){return this.opacityUniform.value}set opacity(e){this.opacityUniform.value=e}get blendFunction(){return this._blendFunction}set blendFunction(e){this._blendFunction=e,this.dispatchEvent({type:"change"})}};var xr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var le=class extends c{constructor(){super("add",xr,!0)}};var Er="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,src.a*opacity);}";var Xe=class extends c{constructor(){super("alpha",Er,!0)}};var Br="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=(dst.rgb+src.rgb)*0.5;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Ke=class extends c{constructor(){super("average",Br,!0)}};var Sr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.xy,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var qe=class extends c{constructor(){super("color",Sr)}};var Mr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=mix(step(0.0,b)*(1.0-min(vec3(1.0),(1.0-a)/max(b,1e-9))),vec3(1.0),step(1.0,a));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Qe=class extends c{constructor(){super("color-burn",Mr)}};var Rr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=step(0.0,a)*mix(min(vec3(1.0),a/max(1.0-b,1e-9)),vec3(1.0),step(1.0,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Ze=class extends c{constructor(){super("color-dodge",Rr)}};var _r="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Ye=class extends c{constructor(){super("darken",_r,!0)}};var Tr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=abs(dst.rgb-src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Je=class extends c{constructor(){super("difference",Tr,!0)}};var yr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb/max(src.rgb,1e-9);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var et=class extends c{constructor(){super("divide",yr,!0)}};var tt=class extends c{constructor(){super("dst",null,!0)}};var Cr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-2.0*dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var rt=class extends c{constructor(){super("exclusion",Cr)}};var wr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb,1.0);vec3 b=min(src.rgb,1.0);vec3 c=mix(2.0*a*b,1.0-2.0*(1.0-a)*(1.0-b),step(0.5,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var st=class extends c{constructor(){super("hard-light",wr)}};var Pr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=step(1.0,dst.rgb+src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var it=class extends c{constructor(){super("hard-mix",Pr)}};var Fr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.x,a.yz));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var nt=class extends c{constructor(){super("hue",Fr)}};var Ur="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var at=class extends c{constructor(){super("invert",Ur)}};var Dr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=src.rgb*max(1.0-dst.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ot=class extends c{constructor(){super("invert-rgb",Dr)}};var Gr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ut=class extends c{constructor(){super("lighten",Gr,!0)}};var Or="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var lt=class extends c{constructor(){super("linear-burn",Or)}};var Ir="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb+src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ft=class extends c{constructor(){super("linear-dodge",Ir)}};var Lr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(2.0*src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ct=class extends c{constructor(){super("linear-light",Lr)}};var Nr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.xy,b.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var pt=class extends c{constructor(){super("luminosity",Nr)}};var zr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,opacity);}";var dt=class extends c{constructor(){super("mix",zr,!0)}};var Vr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ht=class extends c{constructor(){super("multiply",Vr,!0)}};var kr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-abs(1.0-dst.rgb-src.rgb),0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var mt=class extends c{constructor(){super("negation",kr)}};var Hr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=2.0*src.rgb*dst.rgb;vec3 b=1.0-2.0*(1.0-src.rgb)*(1.0-dst.rgb);vec3 c=mix(a,b,step(0.5,dst.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var gt=class extends c{constructor(){super("overlay",Hr)}};var Wr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 c=mix(mix(src2,dst.rgb,step(0.5*dst.rgb,src.rgb)),max(src2-1.0,vec3(0.0)),step(dst.rgb,src2-1.0));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var vt=class extends c{constructor(){super("pin-light",Wr)}};var jr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb*dst.rgb/max(1.0-src.rgb,1e-9),1.0);vec3 c=mix(a,src.rgb,step(1.0,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var At=class extends c{constructor(){super("reflect",jr)}};var $r="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.x,b.y,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var bt=class extends c{constructor(){super("saturation",$r)}};var Xr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return src;}";var fe=class extends c{constructor(){super("src",Xr,!0)}};var Kr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-min(dst.rgb*src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var xt=class extends c{constructor(){super("screen",Kr)}};var qr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 d=dst.rgb+(src2-1.0);vec3 w=step(0.5,src.rgb);vec3 a=dst.rgb-(1.0-src2)*dst.rgb*(1.0-dst.rgb);vec3 b=mix(d*(sqrt(dst.rgb)-dst.rgb),d*dst.rgb*((16.0*dst.rgb-12.0)*dst.rgb+3.0),w*(1.0-step(0.25,dst.rgb)));vec3 c=mix(a,b,w);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Et=class extends c{constructor(){super("soft-light",qr)}};var Qr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Bt=class extends c{constructor(){super("subtract",Qr)}};var Zr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=mix(max(1.0-min((1.0-dst.rgb)/(2.0*src.rgb),1.0),0.0),min(dst.rgb/(2.0*(1.0-src.rgb)),1.0),step(0.5,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var St=class extends c{constructor(){super("vivid-light",Zr)}};var Vt=m("three");var ce=class extends T{constructor(e){super(e);n(this,"blendMode");n(this,"_fragmentShader");n(this,"_vertexShader");n(this,"_inputColorSpace");n(this,"_outputColorSpace");n(this,"gData");n(this,"optional");this.blendMode=new je(new fe),this.blendMode.addEventListener("change",()=>this.setChanged()),this.input.addEventListener("change",()=>this.detectGDataUsage()),this._fragmentShader=null,this._vertexShader=null,this._inputColorSpace=Vt.NoColorSpace,this._outputColorSpace=Vt.NoColorSpace,this.gData=new Set,this.optional=!1}get enabled(){return super.enabled}set enabled(e){super.enabled!==e&&(this.optional=!0),super.enabled=e}get fragmentShader(){return this._fragmentShader}set fragmentShader(e){this._fragmentShader=e,this.detectGDataUsage(),this.setChanged()}get vertexShader(){return this._vertexShader}set vertexShader(e){this._vertexShader=e,this.setChanged()}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(e){this._inputColorSpace=e,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e,this.setChanged()}get hasMainImageFunction(){return this.fragmentShader===null?!1:/vec4\s+mainImage\s*\([a-z\s]*vec4\s+\w+,[a-z\s]*vec2\s+\w+,[a-z\s]*GData\s+\w+\)/.test(this.fragmentShader)}get hasMainUvFunction(){return this.fragmentShader===null?!1:/void\s+mainUv\s*\(\s*inout\s+vec2\s+\w+\)/.test(this.fragmentShader)}get hasMainSupportFunction(){return this.vertexShader===null?!1:/void\s+mainSupport\s*\([a-z\s]*vec2\s+\w+\)/.test(this.vertexShader)}detectGDataUsage(){var i,a;if(this.gData.clear(),this.input.gBufferConfig===null||!this.hasMainImageFunction)return;let e=this.fragmentShader,t=this.input.gBufferConfig,s=/GData\s+(\w+)/.exec(e)[1];for(let u of Object.values(Gt))if(e.includes(`${s}.${u}`)){for(let l of(i=t.gDataDependencies.get(u))!=null?i:[])this.gData.add(l);this.gData.add(u)}for(let u of this.gData)for(let l of(a=t.gDataBufferSources.get(u))!=null?a:[])this.input.gBuffer.has(l)||(this.input.gBuffer.add(l),console.warn(`${this.name} uses ${u} but does not declare input G-Buffer component ${l}`))}validate(){if(this.fragmentShader===null)throw new Error(`Missing fragment shader (${this.name})`);if(!this.hasMainImageFunction&&!this.hasMainUvFunction)throw new Error(`Could not find a valid mainImage or mainUv function (${this.name})`)}render(){}};var Ht=m("three");var kt=m("three");var Yr=`#include <common>
#include <pp_default_output_pars_fragment>
#include <pp_input_buffer_pars_fragment>
uniform float threshold;uniform float smoothing;in vec2 vUv;void main(){vec4 texel=texture(inputBuffer,vUv);float l=luminance(texel.rgb);float mask=smoothstep(threshold,threshold+smoothing,l);out_Color=texel*mask;}`;var Mt=class extends _{constructor(){super({name:"LuminanceHighPassMaterial",fragmentShader:Yr,vertexShader:se,uniforms:{threshold:new kt.Uniform(0),smoothing:new kt.Uniform(0)}})}get threshold(){return this.uniforms.threshold.value}set threshold(r){this.uniforms.threshold.value=r}get smoothing(){return this.uniforms.smoothing.value}set smoothing(r){this.uniforms.smoothing.value=r}};var pe=class pe extends T{constructor(){super("LuminancePass"),this.output.setBuffer(pe.BUFFER_LUMINANCE,this.createFramebuffer()),this.fullscreenMaterial=new Mt}get renderTarget(){return this.output.getBuffer(pe.BUFFER_LUMINANCE)}get texture(){return this.output.buffers.get(pe.BUFFER_LUMINANCE).texture}onInputChange(){var t,s;let r=(s=(t=this.input.defaultBuffer)==null?void 0:t.value)!=null?s:null;if(r===null)return;let e=this.renderTarget.texture;e.format=r.format,e.internalFormat=r.internalFormat,e.type=r.type,e.colorSpace=r.colorSpace,e.needsUpdate=!0,this.input.frameBufferPrecisionHigh?this.fullscreenMaterial.outputPrecision="mediump":this.fullscreenMaterial.outputPrecision="lowp"}onResolutionChange(){let r=this.resolution;this.renderTarget.setSize(r.width,r.height)}render(){this.setRenderTarget(this.renderTarget),this.renderFullscreen()}};n(pe,"BUFFER_LUMINANCE","BUFFER_LUMINANCE");var Rt=pe;var Jr=`#include <pp_default_output_pars_fragment>
#include <pp_input_buffer_pars_fragment>
#define WEIGHT_INNER 0.125
#define WEIGHT_OUTER 0.05556
in vec2 vUv;in vec2 vUv00,vUv01,vUv02,vUv03;in vec2 vUv04,vUv05,vUv06,vUv07;in vec2 vUv08,vUv09,vUv10,vUv11;float clampToBorder(const in vec2 uv){
#ifdef CLAMP_TO_BORDER
return float(uv.s>=0.0&&uv.s<=1.0&&uv.t>=0.0&&uv.t<=1.0);
#else
return 1.0;
#endif
}void main(){vec4 c=vec4(0.0);vec4 w=WEIGHT_INNER*vec4(clampToBorder(vUv00),clampToBorder(vUv01),clampToBorder(vUv02),clampToBorder(vUv03));c+=w.x*texture(inputBuffer,vUv00);c+=w.y*texture(inputBuffer,vUv01);c+=w.z*texture(inputBuffer,vUv02);c+=w.w*texture(inputBuffer,vUv03);w=WEIGHT_OUTER*vec4(clampToBorder(vUv04),clampToBorder(vUv05),clampToBorder(vUv06),clampToBorder(vUv07));c+=w.x*texture(inputBuffer,vUv04);c+=w.y*texture(inputBuffer,vUv05);c+=w.z*texture(inputBuffer,vUv06);c+=w.w*texture(inputBuffer,vUv07);w=WEIGHT_OUTER*vec4(clampToBorder(vUv08),clampToBorder(vUv09),clampToBorder(vUv10),clampToBorder(vUv11));c+=w.x*texture(inputBuffer,vUv08);c+=w.y*texture(inputBuffer,vUv09);c+=w.z*texture(inputBuffer,vUv10);c+=w.w*texture(inputBuffer,vUv11);c+=WEIGHT_OUTER*texture(inputBuffer,vUv);out_Color=c;}`;var es=`#include <pp_resolution_pars_fragment>
out vec2 vUv;out vec2 vUv00,vUv01,vUv02,vUv03;out vec2 vUv04,vUv05,vUv06,vUv07;out vec2 vUv08,vUv09,vUv10,vUv11;void main(){vUv=position.xy*0.5+0.5;vUv00=vUv+resolution.zw*vec2(-1.0,1.0);vUv01=vUv+resolution.zw*vec2(1.0,1.0);vUv02=vUv+resolution.zw*vec2(-1.0,-1.0);vUv03=vUv+resolution.zw*vec2(1.0,-1.0);vUv04=vUv+resolution.zw*vec2(-2.0,2.0);vUv05=vUv+resolution.zw*vec2(0.0,2.0);vUv06=vUv+resolution.zw*vec2(2.0,2.0);vUv07=vUv+resolution.zw*vec2(-2.0,0.0);vUv08=vUv+resolution.zw*vec2(2.0,0.0);vUv09=vUv+resolution.zw*vec2(-2.0,-2.0);vUv10=vUv+resolution.zw*vec2(0.0,-2.0);vUv11=vUv+resolution.zw*vec2(2.0,-2.0);gl_Position=vec4(position.xy,1.0,1.0);}`;var _t=class extends _{constructor({clampToBorder:r=!0}={}){super({name:"DownsamplingMaterial",fragmentShader:Jr,vertexShader:es,defines:{CLAMP_TO_BORDER:!0}}),this.clampToBorder=r}get clampToBorder(){return this.defines.CLAMP_TO_BORDER!==void 0}set clampToBorder(r){this.clampToBorder!==r&&(r?this.defines.CLAMP_TO_BORDER=!0:delete this.defines.CLAMP_TO_BORDER,this.needsUpdate=!0)}};var de=m("three");var ts=`#include <pp_default_output_pars_fragment>
#include <pp_input_buffer_pars_fragment>
#ifdef USE_SUPPORT_BUFFER
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D supportBuffer;
#else
uniform lowp sampler2D supportBuffer;
#endif
uniform float radius;
#endif
in vec2 vUv;in vec2 vUv0,vUv1,vUv2,vUv3;in vec2 vUv4,vUv5,vUv6,vUv7;void main(){vec4 c=vec4(0.0);c+=texture(inputBuffer,vUv0)*0.0625;c+=texture(inputBuffer,vUv1)*0.125;c+=texture(inputBuffer,vUv2)*0.0625;c+=texture(inputBuffer,vUv3)*0.125;c+=texture(inputBuffer,vUv)*0.25;c+=texture(inputBuffer,vUv4)*0.125;c+=texture(inputBuffer,vUv5)*0.0625;c+=texture(inputBuffer,vUv6)*0.125;c+=texture(inputBuffer,vUv7)*0.0625;
#ifdef USE_SUPPORT_BUFFER
vec4 baseColor=texture(supportBuffer,vUv);out_Color=mix(baseColor,c,radius);
#else
out_Color=c;
#endif
}`;var rs=`#include <pp_resolution_pars_fragment>
out vec2 vUv;out vec2 vUv0,vUv1,vUv2,vUv3;out vec2 vUv4,vUv5,vUv6,vUv7;void main(){vUv=position.xy*0.5+0.5;vUv0=vUv+resolution.zw*vec2(-1.0,1.0);vUv1=vUv+resolution.zw*vec2(0.0,1.0);vUv2=vUv+resolution.zw*vec2(1.0,1.0);vUv3=vUv+resolution.zw*vec2(-1.0,0.0);vUv4=vUv+resolution.zw*vec2(1.0,0.0);vUv5=vUv+resolution.zw*vec2(-1.0,-1.0);vUv6=vUv+resolution.zw*vec2(0.0,-1.0);vUv7=vUv+resolution.zw*vec2(1.0,-1.0);gl_Position=vec4(position.xy,1.0,1.0);}`;var Tt=class extends _{constructor({radius:r=.85}={}){super({name:"UpsamplingMaterial",fragmentShader:ts,vertexShader:rs,defines:{USE_SUPPORT_BUFFER:!0},uniforms:{supportBuffer:new de.Uniform(null),texelSize:new de.Uniform(new de.Vector2),radius:new de.Uniform(0)}}),this.radius=r}set supportBuffer(r){this.uniforms.supportBuffer.value=r}get radius(){return this.uniforms.radius.value}set radius(r){this.uniforms.radius.value=r;let e=this.defines.USE_SUPPORT_BUFFER!==void 0,t=r<1;e!==t&&(t?this.defines.USE_SUPPORT_BUFFER=!0:delete this.defines.USE_SUPPORT_BUFFER,this.needsUpdate=!0)}};var W=class W extends T{constructor({levels:e=8,radius:t,fullResolutionUpsampling:s=!1,clampToBorder:i}={}){super("MipmapBlurPass");n(this,"downsamplingMipmaps");n(this,"upsamplingMipmaps");n(this,"downsamplingMaterial");n(this,"upsamplingMaterial");n(this,"_fullResolutionUpsampling");let a=this.createFramebuffer();a.texture.name=W.BUFFER_MAIN,this.output.setBuffer(W.BUFFER_MAIN,a),this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],this.downsamplingMaterial=new _t({clampToBorder:i}),this.upsamplingMaterial=new Tt({radius:t}),this.materials.add(this.downsamplingMaterial),this.materials.add(this.upsamplingMaterial),this._fullResolutionUpsampling=s,this.levels=e}get texture(){return this.output.buffers.get(W.BUFFER_MAIN).texture}get clampToBorder(){return this.downsamplingMaterial.clampToBorder}set clampToBorder(e){this.downsamplingMaterial.clampToBorder=e}get radius(){return this.upsamplingMaterial.radius}set radius(e){this.upsamplingMaterial.radius=e}get levels(){return this.downsamplingMipmaps.length}set levels(e){if(e<=0)throw new Error("The level count must be greater than 0");this.levels!==e&&this.createMipmaps(e)}get fullResolutionUpsampling(){return this._fullResolutionUpsampling}set fullResolutionUpsampling(e){this._fullResolutionUpsampling!==e&&(this._fullResolutionUpsampling=e,this.createMipmaps(this.levels))}createMipmaps(e){let t=this.output,s=t.buffers.get(W.BUFFER_MAIN),i=s.value;if(this.dispose(),this.disposables.clear(),t.buffers.clear(),this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],e===1&&!this.fullResolutionUpsampling){t.setBuffer(W.BUFFER_MAIN,s),this.downsamplingMipmaps.push(s);return}for(let a=0;a<e;++a){let u=i.clone();u.texture.name="DOWNSAMPLING_MIPMAP"+a;let l=new L(u);t.setBuffer(u.texture.name,l),this.downsamplingMipmaps.push(l)}t.setBuffer(W.BUFFER_MAIN,s),this.upsamplingMipmaps.push(s);for(let a=1,u=this.fullResolutionUpsampling?e:e-1;a<u;++a){let l=i.clone();l.texture.name="UPSAMPLING_MIPMAP"+a;let f=new L(l);t.setBuffer(l.texture.name,f),this.upsamplingMipmaps.push(f)}this.onResolutionChange()}onInputChange(){var u,l;let e=(l=(u=this.input.defaultBuffer)==null?void 0:u.value)!=null?l:null;if(e===null)return;let{format:t,internalFormat:s,type:i,colorSpace:a}=e;for(let f of this.downsamplingMipmaps.concat(this.upsamplingMipmaps)){let p=f.value,d=p.texture;d.format=t,d.internalFormat=s,d.type=i,d.colorSpace=a,p.dispose()}this.input.frameBufferPrecisionHigh?(this.downsamplingMaterial.outputPrecision="mediump",this.upsamplingMaterial.outputPrecision="mediump"):(this.downsamplingMaterial.outputPrecision="lowp",this.upsamplingMaterial.outputPrecision="lowp"),this.onResolutionChange()}onResolutionChange(){var a,u,l,f;let e=(u=(a=this.input.defaultBuffer)==null?void 0:a.value)!=null?u:null;if(e===null)return;let t=e.source.data,{width:s,height:i}=t;for(let p=0,d=this.downsamplingMipmaps.length;p<d;++p)s=Math.round(s/2),i=Math.round(i/2),(l=this.downsamplingMipmaps[p].value)==null||l.setSize(s,i);this.fullResolutionUpsampling?(s=t.width,i=t.height):(s=Math.round(t.width/2),i=Math.round(t.height/2));for(let p=0,d=this.upsamplingMipmaps.length;p<d;++p)(f=this.upsamplingMipmaps[p].value)==null||f.setSize(s,i),s=Math.round(s/2),i=Math.round(i/2)}render(){if(this.renderer===null||this.input.defaultBuffer===null||this.input.defaultBuffer.value===null)return;let e=this.renderer,t=this.downsamplingMaterial,s=this.upsamplingMaterial,i=this.downsamplingMipmaps,a=this.upsamplingMipmaps,u=this.input.defaultBuffer.value,l=u.source.data,{width:f,height:p}=l;this.fullscreenMaterial=t;for(let d=0,R=i.length;d<R;++d){let g=i[d].value;t.setSize(f,p),t.inputBuffer=u,e.setRenderTarget(g),this.renderFullscreen(),u=g.texture,f=g.width,p=g.height}this.fullscreenMaterial=s;for(let d=a.length-1;d>=0;--d){let R=this.fullResolutionUpsampling?d-1:d,g=R>=0?i[R].value.texture:this.input.defaultBuffer.value,v=a[d].value;s.setSize(f,p),s.inputBuffer=u,s.supportBuffer=g,e.setRenderTarget(v),this.renderFullscreen(),u=v.texture,f=v.width,p=v.height}}};n(W,"BUFFER_MAIN","BUFFER_MAIN");var yt=W;var ss=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D map;
#else
uniform lowp sampler2D map;
#endif
uniform float intensity;vec4 mainImage(const in vec4 inputColor,const in vec2 uv,const in GData gData){return texture(map,uv)*intensity;}`;var Ct=class extends ce{constructor({luminanceThreshold:e=1,luminanceSmoothing:t=.03,intensity:s=1,radius:i=.85,levels:a=8,fullResolutionUpsampling:u,clampToBorder:l}={}){super("BloomEffect");n(this,"luminancePass");n(this,"mipmapBlurPass");this.fragmentShader=ss,this.blendMode.blendFunction=new le;let f=new Rt;f.addEventListener("toggle",()=>this.onInputChange()),this.luminancePass=f;let p=this.luminanceMaterial;p.threshold=e,p.smoothing=t;let d=new yt({levels:a,radius:i,fullResolutionUpsampling:u,clampToBorder:l});this.mipmapBlurPass=d;let R=this.input.uniforms;R.set("intensity",new Ht.Uniform(s)),R.set("map",new Ht.Uniform(null)),d.texture.bindUniform(R.get("map")),this.subpasses=[f,d]}get luminanceMaterial(){return this.luminancePass.fullscreenMaterial}get luminanceThreshold(){return this.luminanceMaterial.threshold}set luminanceThreshold(e){this.luminanceMaterial.threshold=e}get luminanceSmoothing(){return this.luminanceMaterial.smoothing}set luminanceSmoothing(e){this.luminanceMaterial.smoothing=e}get intensity(){return this.input.uniforms.get("intensity").value}set intensity(e){this.input.uniforms.get("intensity").value=e}onInputChange(){if(this.input.defaultBuffer===null){this.luminancePass.input.removeDefaultBuffer(),this.mipmapBlurPass.input.removeDefaultBuffer();return}this.luminancePass.enabled?(this.luminancePass.input.defaultBuffer=this.input.defaultBuffer,this.mipmapBlurPass.input.defaultBuffer=this.luminancePass.texture):this.mipmapBlurPass.input.defaultBuffer=this.input.defaultBuffer}render(){this.luminancePass.enabled&&this.luminancePass.render(),this.mipmapBlurPass.render()}};var ns=m("three");var z=m("three");var wt=class extends z.EventDispatcher{constructor(){super();n(this,"uniform");n(this,"_enabled");this.uniform=new z.Uniform({slope:new z.Vector3(1,1,1),offset:new z.Vector3(0,0,0),power:new z.Vector3(1,1,1),saturation:1}),this._enabled=!0}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.dispatchEvent({type:"toggle"})}get slope(){return this.uniform.value.slope}get offset(){return this.uniform.value.offset}get power(){return this.uniform.value.power}get saturation(){return this.uniform.value.saturation}set saturation(e){this.uniform.value.saturation=e}applyPreset(e){switch(e){case 0:this.slope.set(1,1,1),this.offset.set(0,0,0),this.power.set(1,1,1),this.saturation=1;break;case 1:this.slope.set(1,.9,.5),this.offset.set(0,0,0),this.power.set(.8,.8,.8),this.saturation=.8;break;case 2:this.slope.set(1,1,1),this.offset.set(0,0,0),this.power.set(1.35,1.35,1.35),this.saturation=1.4;break;case 3:this.slope.set(1.05,1.05,1.05),this.offset.set(0,0,0),this.power.set(1.1,1.1,1.1),this.saturation=1.15;break;case 4:this.slope.set(1,.9,.6),this.offset.set(0,0,0),this.power.set(.8,.8,.8),this.saturation=.3;break;case 5:this.slope.set(1,1,1),this.offset.set(0,0,0),this.power.set(1,1,1),this.saturation=0;break}}lerp(e,t,s){this.slope.lerpVectors(e.slope,t.slope,s),this.offset.lerpVectors(e.offset,t.offset,s),this.power.lerpVectors(e.power,t.power,s),this.saturation=z.MathUtils.lerp(e.saturation,t.saturation,s)}};var is=`#ifdef USE_CDL
struct ColorDecisionList{vec3 slope;vec3 offset;vec3 power;float saturation;};uniform ColorDecisionList cdl;vec3 applyCDL(in vec3 color){float l=dot(color,vec3(0.2126,0.7152,0.0722));vec3 v=max(color*cdl.slope+cdl.offset,0.0);vec3 pv=pow(v,cdl.power);if(v.r>0.0){v.r=pv.r;}if(v.g>0.0){v.g=pv.g;}if(v.b>0.0){v.b=pv.b;}return(v-l)*cdl.saturation+l;}
#else
#define applyCDL(color) color
#endif
#include <tonemapping_pars_fragment>
vec4 mainImage(const in vec4 inputColor,const in vec2 uv,const in GData gData){vec3 result;
#if TONE_MAPPING == 0
result=LinearToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 1
result=ReinhardToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 2
result=CineonToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 3
result=ACESFilmicToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 4
result=AgXToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 5
result=NeutralToneMapping(inputColor.rgb);
#elif TONE_MAPPING == 6
result=CustomToneMapping(inputColor.rgb);
#endif
return vec4(result,inputColor.a);}`;var Pt=class extends ce{constructor({toneMapping:e=4,cdlPreset:t=null}={}){super("ToneMappingEffect");n(this,"cdl");this.fragmentShader=is.replace("#include <tonemapping_pars_fragment>",ns.ShaderChunk.tonemapping_pars_fragment.replace(/(color = AgXOutsetMatrix \* color;)/,`color = applyCDL(color);
$1`)),this.cdl=new wt,this.cdl.addEventListener("toggle",()=>this.onCDLToggle()),this.input.uniforms.set("cdl",this.cdl.uniform),this.input.defines.set("USE_CDL",!0),this.toneMapping=e,this.cdl.applyPreset(t)}get toneMapping(){return this.input.defines.get("TONE_MAPPING")}set toneMapping(e){this.toneMapping!==e&&(this.input.defines.set("TONE_MAPPING",e),this.setChanged())}onCDLToggle(){this.cdl.enabled?this.input.defines.set("USE_CDL",!0):this.input.defines.delete("USE_CDL"),this.setChanged()}};var Wt=m("three");var as=`#include <common>
#include <dithering_pars_fragment>
#include <packing>
#include <pp_camera_pars_fragment>
#include <pp_colorspace_conversion_pars_fragment>
#include <pp_default_output_pars_fragment>
#include <pp_depth_buffer_precision_pars_fragment>
#include <pp_depth_utils_pars_fragment>
#include <pp_frame_buffer_precision_pars_fragment>
#include <pp_noise_pars_fragment>
#include <pp_normal_codec_pars_fragment>
#include <pp_normal_utils_pars_fragment>
#include <pp_resolution_pars_fragment>
#define packFloatToRGBA(v) packDepthToRGBA(v)
#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)
$FRAGMENT_HEAD_GDATA$FRAGMENT_HEAD_GBUFFER uniform GBuffer gBuffer;uniform float time;in vec2 vUv;$FRAGMENT_HEAD_EFFECTS void main(){$FRAGMENT_MAIN_UV$FRAGMENT_MAIN_GDATA vec4 color0=gData.color;vec4 color1=vec4(0.0);$FRAGMENT_MAIN_IMAGE color0.a=clamp(color0.a,0.0,1.0);out_Color=color0;
#ifdef COLOR_SPACE_CONVERSION
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
}`;var os=`#include <pp_resolution_pars_fragment>
uniform vec3 cameraParams;uniform float time;out vec2 vUv;$VERTEX_HEAD void main(){vUv=position.xy*0.5+0.5;$VERTEX_MAIN_SUPPORT gl_Position=vec4(position.xy,1.0,1.0);}`;var be=class extends _{constructor(){super({name:"EffectMaterial",defines:{COLOR_SPACE_CONVERSION:!0},uniforms:{gBuffer:new Wt.Uniform(null),time:new Wt.Uniform(0)}});n(this,"shaderDataTracker");this.shaderDataTracker=new ne,this.fragmentShader=`#include <pp_default_output_pars_fragment>

`+this.fragmentShader}get gBuffer(){return this.uniforms.gBuffer.value}set gBuffer(e){this.uniforms.gBuffer.value=e}get colorSpaceConversion(){return this.defines.COLOR_SPACE_CONVERSION!==void 0}set colorSpaceConversion(e){this.colorSpaceConversion!==e&&(e?this.defines.COLOR_SPACE_CONVERSION=!0:delete this.defines.COLOR_SPACE_CONVERSION,this.needsUpdate=!0)}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}setShaderParts(e){return this.fragmentShader=as.replace("$FRAGMENT_MAIN_IMAGE",e.get("$FRAGMENT_MAIN_IMAGE")).replace("$FRAGMENT_MAIN_GDATA",e.get("$FRAGMENT_MAIN_GDATA")).replace("$FRAGMENT_MAIN_UV",e.get("$FRAGMENT_MAIN_UV")).replace("$FRAGMENT_HEAD_EFFECTS",e.get("$FRAGMENT_HEAD_EFFECTS")).replace("$FRAGMENT_HEAD_GBUFFER",e.get("$FRAGMENT_HEAD_GBUFFER")).replace("$FRAGMENT_HEAD_GDATA",e.get("$FRAGMENT_HEAD_GDATA")),this.vertexShader=os.replace("$VERTEX_MAIN_SUPPORT",e.get("$VERTEX_MAIN_SUPPORT")).replace("$VERTEX_HEAD",e.get("$VERTEX_HEAD")),this.needsUpdate=!0,this}setDefines(e){return this.shaderDataTracker.applyDefines(this,e).trackDefines(e),this}setUniforms(e){return this.shaderDataTracker.applyUniforms(this,e).trackUniforms(e),this}dispose(){super.dispose(),this.shaderDataTracker.dispose()}};var ds=m("three");var j=m("three");function jt(o,r,e){for(let t of r){let s="$1"+o+t.charAt(0).toUpperCase()+t.slice(1),i=new RegExp("([^\\.])(\\b"+t+"\\b)","g");for(let a of e.entries())typeof a[1]=="string"&&e.set(a[0],a[1].replace(i,s))}}function us(o,r,e,t){var s;e.add(o);for(let i of(s=r.get(o))!=null?s:[])e.has(i)||us(i,r,e,t);t.push(o)}function ls(o,r=!1){let e=[],t=new Set;for(let s of o.keys())t.has(s)||us(s,o,t,e);return r?e:e.reverse()}var fs=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,cs=/struct\s+(\w*)/g,ps=/^\s*#define\s+(\w*)/gm,xe=class{constructor(){n(this,"defines");n(this,"uniforms");n(this,"shaderParts");n(this,"blendModes");n(this,"gData");n(this,"convolutionEffects");n(this,"uvTransformationEffects");n(this,"_colorSpace");this.shaderParts=new Map([["$FRAGMENT_HEAD_EFFECTS",""],["$FRAGMENT_HEAD_GBUFFER",""],["$FRAGMENT_HEAD_GDATA",""],["$FRAGMENT_MAIN_UV",""],["$FRAGMENT_MAIN_GDATA",""],["$FRAGMENT_MAIN_IMAGE",""],["$VERTEX_HEAD",""],["$VERTEX_MAIN_SUPPORT",""]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.gData=new Set(["color"]),this.convolutionEffects=new Set,this.uvTransformationEffects=new Set,this._colorSpace=j.LinearSRGBColorSpace}get uvTransformation(){return this.uvTransformationEffects.size>0}get colorSpace(){return this._colorSpace}set colorSpace(r){this._colorSpace=r}gatherVertexShaderTokens(r,e){for(let t of r.matchAll(/(?:out\s+\w+\s+(\w*?);)/g))for(let s of t[1].split(/\s*,\s*/))e.add(s);for(let t of r.matchAll(fs))e.add(t[1]);for(let t of r.matchAll(cs))e.add(t[1]);for(let t of r.matchAll(ps))e.add(t[1])}gatherFragmentShaderTokens(r,e){for(let t of r.matchAll(fs))e.add(t[1]);for(let t of r.matchAll(cs))e.add(t[1]);for(let t of r.matchAll(ps))e.add(t[1])}updateWorkingColorSpace(r){r.outputColorSpace!==j.NoColorSpace?this.colorSpace=r.outputColorSpace:r.inputColorSpace!==j.NoColorSpace&&(this.colorSpace=r.inputColorSpace)}integrateEffect(r,e){e.validate(),e.isConvolutionPass(!1)&&this.convolutionEffects.add(e);let t=e.fragmentShader,s=e.vertexShader,i=this.shaderParts,a=i.get("$FRAGMENT_HEAD_EFFECTS"),u=i.get("$FRAGMENT_MAIN_UV"),l=i.get("$FRAGMENT_MAIN_IMAGE"),f=i.get("$VERTEX_HEAD"),p=i.get("$VERTEX_MAIN_SUPPORT"),d=new Set;if(s!==null&&e.hasMainSupportFunction){this.gatherVertexShaderTokens(s,d);let g=/mainSupport\s*\([\w\s]*?uv\s*?\)/.test(s);p+=`	${r}MainSupport(`,p+=g?`vUv);
`:`);
`}e.hasMainUvFunction&&(u+=`	${r}MainUv(UV);
`,this.uvTransformationEffects.add(e));for(let g of e.gData)this.gData.add(g);if(e.hasMainImageFunction){this.gatherFragmentShaderTokens(t,d),e.inputColorSpace!==j.NoColorSpace&&e.inputColorSpace!==this.colorSpace&&(l+=e.inputColorSpace===j.SRGBColorSpace?`color0 = sRGBTransferOETF(color0);
	`:`color0 = sRGBTransferEOTF(color0);
	`),l+=`color1 = ${r}MainImage(color0, UV, gData);
	`;let g=e.blendMode;this.blendModes.set(g.blendFunction.id,g);let v=r+"BlendOpacity";this.uniforms.set(v,g.opacityUniform),l+=`color0 = blend${g.blendFunction.id}(color0, color1, ${v});

	`,a+=`uniform float ${v};

`,this.updateWorkingColorSpace(e)}for(let g of e.input.defines.keys())d.add(g.replace(/\([\w\s,]*\)/g,""));for(let g of e.input.uniforms.keys())d.add(g);d.delete("while"),d.delete("for"),d.delete("if"),e.input.uniforms.forEach((g,v)=>this.uniforms.set(r+v.charAt(0).toUpperCase()+v.slice(1),g)),e.input.defines.forEach((g,v)=>this.defines.set(r+v.charAt(0).toUpperCase()+v.slice(1),g));let R=new Map([["fragment",t],["vertex",s]]);jt(r,d,this.defines),jt(r,d,R),t=R.get("fragment"),s=R.get("vertex"),a+=t+`
`,s!==null&&(f+=s+`
`),i.set("$FRAGMENT_HEAD_EFFECTS",a),i.set("$FRAGMENT_MAIN_UV",u),i.set("$FRAGMENT_MAIN_IMAGE",l),i.set("$VERTEX_HEAD",f),i.set("$VERTEX_MAIN_SUPPORT",p),this.validate()}add(r){r.convolutionEffects.forEach(l=>this.convolutionEffects.add(l)),r.uvTransformationEffects.forEach(l=>this.uvTransformationEffects.add(l)),r.uniforms.forEach((l,f)=>this.uniforms.set(f,l)),r.defines.forEach((l,f)=>this.defines.set(f,l)),r.blendModes.forEach((l,f)=>this.blendModes.set(f,l)),r.gData.forEach(l=>this.gData.add(l));let e=this.shaderParts,t=e.get("$FRAGMENT_HEAD_EFFECTS"),s=e.get("$FRAGMENT_MAIN_UV"),i=e.get("$FRAGMENT_MAIN_IMAGE"),a=e.get("$VERTEX_HEAD"),u=e.get("$VERTEX_MAIN_SUPPORT");t+=r.shaderParts.get("$FRAGMENT_HEAD_EFFECTS"),s+=r.shaderParts.get("$FRAGMENT_MAIN_UV"),i+=r.shaderParts.get("$FRAGMENT_MAIN_IMAGE"),a+=r.shaderParts.get("$VERTEX_HEAD"),u+=r.shaderParts.get("$VERTEX_MAIN_SUPPORT"),e.set("$FRAGMENT_HEAD_EFFECTS",t),e.set("$FRAGMENT_MAIN_UV",s),e.set("$FRAGMENT_MAIN_IMAGE",i),e.set("$VERTEX_HEAD",a),e.set("$VERTEX_MAIN_SUPPORT",u),this.colorSpace!==r.colorSpace&&r.colorSpace!==j.NoColorSpace&&(this.colorSpace=r.colorSpace),this.validate()}validate(){if(this.convolutionEffects.size>1){let r=[...this.convolutionEffects].map(e=>e.name).join(", ");throw new Error(`Convolution effects cannot be merged (${r})`)}else if(this.convolutionEffects.size>0&&this.uvTransformation){let r=[...this.convolutionEffects,...this.uvTransformationEffects].map(e=>e.name).join(", ");throw new Error(`Effects that transform UVs are incompatible with convolution effects (${r})`)}}createGDataStructDeclaration(r){return["struct GData {",...Array.from(r.gDataStructDeclaration).filter(e=>this.gData.has(e[0])).map(e=>`	${e[1]}`),`};
`].join(`
`)}createGDataStructInitialization(r){let e=r.gDataDependencies,t=r.gDataStructInitialization,s=new Map(Array.from(this.gData).filter(i=>t.has(i)).map(i=>{var a;return[i,(a=e.get(i))!=null?a:[]]}));return["	GData gData;",...ls(s,!0).map(i=>`	${t.get(i)}`)].join(`
`)}createBlendFunctions(){let r=/\bblend\b/g,e=[];for(let t of this.blendModes.values()){let s=t.blendFunction.shader,i=`blend${t.blendFunction.id}`;e.push(s.replace(r,i))}return e.join(`
`)}};var U=class U{constructor(r){n(this,"shaderData");n(this,"defaultMaterial");n(this,"materialCache");n(this,"effectShaderDataCache");n(this,"activeMaterial");n(this,"_gBufferConfig");n(this,"_gBuffer");n(this,"_dithering");this.shaderData=r,this.defaultMaterial=new be,this.materialCache=new Map,this.effectShaderDataCache=new Map,this.activeMaterial=null,this._gBufferConfig=null,this._gBuffer=null,this._dithering=!1}get materials(){return this.materialCache.values()}get gBufferConfig(){return this._gBufferConfig}set gBufferConfig(r){this._gBufferConfig!==r&&(this.dispose(),this._gBufferConfig=r)}get gBuffer(){return this._gBuffer}set gBuffer(r){this._gBuffer!==r&&(this.invalidateMaterialCache(),this._gBuffer=r)}get dithering(){return this._dithering}set dithering(r){if(this._dithering!==r){this._dithering=r;for(let e of this.materialCache.values())if(r&&e.outputPrecision!=="lowp"){console.info("Dithering only works on 8-bit colors");break}else e.dithering=r,e.needsUpdate=!0}}getEffectShaderData(r){let e=new xe,t=this.effectShaderDataCache;for(let s of r){if(!t.has(s)){let i=new xe;i.integrateEffect(`e${s.id}`,s),t.set(s,i)}s.blendMode.blendFunction.shader!==null&&e.add(t.get(s))}return e}createGBufferStructDeclaration(r){if(this.gBuffer===null)throw new Error("Missing G-Buffer information");return["struct GBuffer {",...Array.from(r.gBufferStructDeclaration).filter(e=>this.gBuffer.has(e[0])).map(e=>`	${e[1]}`),`};
`].join(`
`)}createMaterial(r){let t=U.getMaterialId(r)===U.DEFAULT_MATERIAL_ID?this.defaultMaterial:new be,s=this.getEffectShaderData(r),i=this.gBufferConfig;i!==null&&(s.shaderParts.set("$FRAGMENT_HEAD_GBUFFER",this.createGBufferStructDeclaration(i)),s.shaderParts.set("$FRAGMENT_HEAD_GDATA",s.createGDataStructDeclaration(i)),s.shaderParts.set("$FRAGMENT_MAIN_GDATA",s.createGDataStructInitialization(i)));let a=s.shaderParts.get("$FRAGMENT_HEAD_EFFECTS");if(s.shaderParts.set("$FRAGMENT_HEAD_EFFECTS",a+s.createBlendFunctions()),s.colorSpace===ds.SRGBColorSpace){let u=s.shaderParts.get("$FRAGMENT_MAIN_IMAGE");s.shaderParts.set("$FRAGMENT_MAIN_IMAGE",u+`color0 = sRGBTransferEOTF(color0);
	`)}if(s.uvTransformation){let u=s.shaderParts.get("$FRAGMENT_MAIN_UV");s.shaderParts.set("$FRAGMENT_MAIN_UV",`vec2 transformedUv = vUv;
`+u),s.defines.set("UV","transformedUv")}else s.defines.set("UV","vUv");s.shaderParts.forEach((u,l,f)=>f.set(l,u.trim().replace(/^#/,`
#`)));for(let u of this.shaderData.defines)s.defines.set(u[0],u[1]);for(let u of this.shaderData.uniforms)s.uniforms.set(u[0],u[1]);if(t!==this.defaultMaterial){for(let u of Object.entries(this.defaultMaterial.uniforms))t.uniforms[u[0]]=u[1];for(let u of Object.entries(this.defaultMaterial.defines))t.defines[u[0]]=u[1]}return t.setShaderParts(s.shaderParts).setDefines(s.defines).setUniforms(s.uniforms)}createMaterials(r){let e=r.filter(s=>s.optional),t=e.length>U.MAX_OPTIONAL_EFFECTS;if(e.length===0||t){let s=r.filter(a=>a.enabled),i=U.getMaterialId(s);this.materialCache.set(i,this.createMaterial(s));return}for(let s of this.getEffectCombinations(r)){let i=U.getMaterialId(s);this.materialCache.has(i)||this.materialCache.set(i,this.createMaterial(s))}}synchronizeMaterials(){if(this.activeMaterial===null)return;let r=this.activeMaterial,e=this.defaultMaterial;for(let t of Object.entries(e.defines))t[1]!==r.defines[t[0]]&&(e.defines[t[0]]=r.defines[t[0]],e.needsUpdate=!0);if(e.needsUpdate){for(let t of this.materialCache.values())if(t!==e){for(let s of Object.entries(e.defines))t.defines[s[0]]=s[1];t.needsUpdate=!0}}}getMaterial(r){if(this.gBufferConfig===null)return this.defaultMaterial;this.synchronizeMaterials();let e=r.filter(s=>s.enabled),t=U.getMaterialId(e);return this.materialCache.has(t)||this.createMaterials(r),this.activeMaterial=this.materialCache.get(t),this.activeMaterial}*getEffectCombinations(r){let e=r.filter(i=>i.optional),t=e.length,s=1<<t;for(let i=0;i<s;++i){let a=[];for(let u=0;u<t;++u)i&1<<u&&a.push(e[u]);yield r.filter(u=>!u.optional||a.includes(u))}}invalidateMaterialCache(){for(let r of this.materialCache.values())r.dispose();this.materialCache.clear()}invalidateShaderData(r){this.effectShaderDataCache.delete(r)}dispose(){this.invalidateMaterialCache(),this.effectShaderDataCache.clear()}static getMaterialId(r){return r.length===0?U.DEFAULT_MATERIAL_ID:r.map(e=>e.id).join("-")}};n(U,"MAX_OPTIONAL_EFFECTS",6),n(U,"DEFAULT_MATERIAL_ID","default");var Ft=U;var Ut=class o extends T{constructor(...e){super("EffectPass");n(this,"effectMaterialManager");n(this,"effectListener");n(this,"gBufferConfigListener");n(this,"previousGBufferConfig");n(this,"disposed");n(this,"timeScale");this.output.defaultBuffer=this.createFramebuffer(),this.effectMaterialManager=new Ft(this.input),this.effectMaterialManager.gBuffer=this.input.gBuffer,this.effectListener=t=>this.handleEffectEvent(t),this.gBufferConfigListener=t=>this.handleGBufferConfigEvent(t),this.previousGBufferConfig=null,this.effects=e,this.disposed=!1,this.timeScale=1}get subpasses(){return super.subpasses}set subpasses(e){for(let t of super.subpasses)t.removeEventListener("change",this.effectListener),t.removeEventListener("toggle",this.effectListener);super.subpasses=e,this.input.gBuffer.clear(),this.input.gBuffer.add("Color");for(let t of super.subpasses)this.copyGBufferComponents(t),t.addEventListener("change",this.effectListener),t.addEventListener("toggle",this.effectListener);this.updateMaterial(!0),this.disposed=!1}get effects(){return this.subpasses}set effects(e){let t=new Set(e);if(t.size<e.length){let s=e.filter(i=>!t.has(i)).map(i=>i.name);throw new Error(`Encountered duplicate effects: ${s.join(", ")}`)}this.subpasses=e}get dithering(){return this.effectMaterialManager.dithering}set dithering(e){this.effectMaterialManager.dithering=e}copyGBufferComponents(e){for(let t of e.input.gBuffer)this.input.gBuffer.add(t)}updateMaterial(e){e&&(this.effectMaterialManager.invalidateMaterialCache(),this.materials.clear()),this.fullscreenMaterial=this.effectMaterialManager.getMaterial(this.effects);for(let t of this.effectMaterialManager.materials)this.materials.add(t)}updateGBufferStruct(){var i,a;let e=this.input,t=e.gBufferConfig;if(t===null)return;let s=[];for(let u of e.gBuffer){let f=u==="Color"?(i=e.defaultBuffer)==null?void 0:i.value:(a=e.buffers.get(u))==null?void 0:a.value;s.push([t.gBufferStructFields.get(u),f!=null?f:null])}this.fullscreenMaterial.gBuffer=Object.fromEntries(s)}handleEffectEvent(e){switch(e.type){case"change":this.copyGBufferComponents(e.target),this.effectMaterialManager.invalidateShaderData(e.target),this.updateMaterial(!0);break;case"toggle":this.updateMaterial(!1);break}}handleGBufferConfigEvent(e){e.type==="change"&&this.updateMaterial(!0)}onGBufferConfigChange(){let e=this.input.gBufferConfig;this.previousGBufferConfig!==null&&this.previousGBufferConfig.removeEventListener("change",this.gBufferConfigListener),this.input.gBufferConfig!==null&&this.input.gBufferConfig.addEventListener("change",this.gBufferConfigListener),this.effectMaterialManager.gBufferConfig=e,this.previousGBufferConfig=e;for(let t of this.effects)t.input.gBufferConfig=e;this.updateMaterial(!0)}onInputChange(){this.updateGBufferStruct();for(let e of this.effects){e.removeEventListener("change",this.effectListener),e.input.buffers.clear();for(let t of this.input.buffers)e.input.buffers.set(t[0],t[1]);e.addEventListener("change",this.effectListener)}this.previousGBufferConfig!==this.input.gBufferConfig?this.onGBufferConfigChange():this.updateMaterial(!0)}checkRequirements(){for(let e of this.effects)e.checkRequirements()}compile(){return G(this,null,function*(){return this.updateMaterial(!1),ee(o.prototype,this,"compile").call(this)})}dispose(){for(let e of this.effects)e.removeEventListener("change",this.effectListener),e.removeEventListener("toggle",this.effectListener);this.input.gBufferConfig!==null&&this.input.gBufferConfig.removeEventListener("change",this.gBufferConfigListener),this.effectMaterialManager.dispose(),super.dispose(),this.disposed=!0}render(){var e;if(!(this.renderer===null||this.timer===null)){this.disposed&&(this.effects=[...this.effects]);for(let t of this.effects)t.enabled&&t.render();this.fullscreenMaterial.time+=this.timer.getDelta()*this.timeScale,this.setRenderTarget((e=this.output.defaultBuffer)==null?void 0:e.value),this.renderFullscreen()}}};var Ts=m("three/examples/jsm/loaders/GLTFLoader.js"),ys=m("tweakpane"),Cs=m("spatial-controls");var M=m("three");var hs=`#ifdef USE_FOG
uniform vec3 fogColor;varying vec3 vWorldPosition;
#ifdef FOG_EXP2
uniform float fogDensity;
#else
uniform float fogNear;uniform float fogFar;
#endif
#endif`;var ms=`#ifdef USE_FOG
float range=length(vWorldPosition-cameraPosition);
#ifdef FOG_EXP2
float fogFactor=1.0-exp(-fogDensity*fogDensity*range*range);
#else
float fogFactor=smoothstep(fogNear,fogFar,range);
#endif
gl_FragColor.a=saturate(1.0-fogFactor);
#endif`;var gs=`#ifdef USE_FOG
varying vec3 vWorldPosition;
#endif`;var vs=`#ifdef USE_FOG
vWorldPosition=worldPosition.xyz;
#endif`;function As(o){o.fragmentShader=o.fragmentShader.replace("#include <fog_pars_fragment>",hs),o.fragmentShader=o.fragmentShader.replace("#include <fog_fragment>",ms),o.vertexShader=o.vertexShader.replace("#include <fog_pars_vertex>",gs),o.vertexShader=o.vertexShader.replace("#include <fog_vertex>",vs)}var bs="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABAAAAAQAAQMAAABF07nAAAAABlBMVEVjY2PGxsamg2z0AAACH0lEQVR42u3QMREAAAgDsfo3DSI6MJBXkPtMWdoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADOAQ4CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALwHLMf/DvLci4ZuAAAAAElFTkSuQmCC";function xs(){return new M.Fog(0,15,60)}function Es(){let r=new Image,e=new M.Texture(r);e.wrapS=M.RepeatWrapping,e.wrapT=M.RepeatWrapping,e.colorSpace=M.SRGBColorSpace,e.repeat.setScalar(5e3/2),e.anisotropy=4,r.addEventListener("load",()=>e.needsUpdate=!0),r.src=bs;let t=new M.Group,s=new M.MeshStandardMaterial({transparent:!0,roughness:.1,metalness:1,map:e}),i=new M.Mesh(new M.PlaneGeometry(1,1,6,6),s);return i.name="Checkeboard",i.material.onBeforeCompile=As,i.material.side=M.DoubleSide,i.rotation.x=-Math.PI*.5,i.scale.set(5e3,5e3,1),t.add(i),t}var zs=Math.PI/180,Vs=180/Math.PI;function Bs(o,r=16/9){return Math.atan(Math.tan(o*zs*.5)/r)*Vs*2}function Ss(o,r=".png"){let e=`${document.baseURI}img/textures/skies/${o}/`;return[e+"px"+r,e+"nx"+r,e+"py"+r,e+"ny"+r,e+"pz"+r,e+"nz"+r]}var Ms=m("@tweakpane/plugin-essentials");var ks=[new le,new Xe,new Ke,new qe,new Qe,new Ze,new Ye,new Je,new et,new tt,new rt,new st,new it,new nt,new at,new ot,new ut,new lt,new ft,new ct,new pt,new dt,new ht,new mt,new gt,new vt,new At,new bt,new fe,new xt,new Et,new Bt,new St],$t=Object.fromEntries(ks.map(o=>[o.name,o]));function Rs(o){o.registerPlugin(Ms.EssentialsPlugin);let r=o.addBlade({view:"fpsgraph",rows:2});return r.on("tick",()=>{if(r.fps===null)return;let e=Math.round(r.fps)*1.5;e>r.max&&(r.max=e)}),r}function _s(o,r){let e={blendFunction:r.blendFunction.name};o.addBinding(r,"opacity",{min:0,max:1,step:.001}),o.addBinding(e,"blendFunction",{options:Hs(Object.keys($t))}).on("change",t=>r.blendFunction=$t[t.value])}function Hs(o){return o.reduce((r,e)=>(r[e]=e,r),{})}var Xt=["localhost","127.0.0.1","","[::1]"].includes(window.location.hostname);function js(){let o=new Map,r=new F.LoadingManager,e=new Ts.GLTFLoader(r),t=new F.CubeTextureLoader(r);return new Promise((s,i)=>{r.onLoad=()=>s(o),r.onError=a=>i(new Error(`Failed to load ${a}`)),t.load(Ss("space-01",".jpg"),a=>{a.colorSpace=F.SRGBColorSpace,o.set("sky",a)}),e.load(`${document.baseURI}models/emissive-strength-test/emissive-strength-test.gltf`,a=>o.set("model",a))})}window.addEventListener("load",()=>{js().then(o=>{let r=new F.WebGLRenderer({powerPreference:"high-performance",antialias:!1,stencil:!1,depth:!1});r.setPixelRatio(window.devicePixelRatio),r.debug.checkShaderErrors=Xt;let e=new F.PerspectiveCamera,t=new Cs.SpatialControls(e.position,e.quaternion,r.domElement),s=t.settings;s.rotation.sensitivity=2.2,s.rotation.damping=.025,s.translation.damping=.1,t.position.set(0,3,18),t.lookAt(0,3,0);let i=new F.Scene,a=o.get("sky");i.background=a,i.environment=a,i.fog=xs(),i.add(Es());let u=o.get("model");u.scene.position.y=3,i.add(u.scene);let l=new Ct({luminanceThreshold:1,luminanceSmoothing:.03,intensity:1,radius:.85,levels:8}),f=new Ut(l,new Pt),p=new He(r);p.add(new K,new q(i,e,{samples:4}),f);let d=document.getElementById("viewport"),R=new ys.Pane({container:d.querySelector(".tp")}),g=Rs(R),v=R.addFolder({title:"Settings"});v.addBinding(l,"intensity",{min:0,max:10,step:.01}),v.addBinding(l.mipmapBlurPass,"radius",{min:0,max:1,step:.001}),v.addBinding(l.mipmapBlurPass,"levels",{min:1,max:10,step:1}),v.addBinding(l.resolution,"scale",{label:"resolution",min:.5,max:1,step:.05}),v.addBinding(f,"dithering");let D=v.addFolder({title:"Luminance Filter"});D.addBinding(l.luminancePass,"enabled"),D.addBinding(l.luminanceMaterial,"threshold",{min:0,max:1,step:.01}),D.addBinding(l.luminanceMaterial,"smoothing",{min:0,max:1,step:.01}),_s(v,l.blendMode);function Kt(){let V=d.clientWidth,Ee=d.clientHeight;e.aspect=V/Ee,e.fov=Bs(90,Math.max(e.aspect,16/9)),e.updateProjectionMatrix(),p.setSize(V,Ee)}window.addEventListener("resize",Kt),Kt();function ws(V){g.begin(),t.update(V),p.render(V),g.end()}p.compile().then(()=>{let V=new IntersectionObserver(Ee=>r.setAnimationLoop(Ee[0].isIntersecting?ws:null),{threshold:.75});d.prepend(r.domElement),V.observe(d)}).catch(V=>console.error(V))})});})();
