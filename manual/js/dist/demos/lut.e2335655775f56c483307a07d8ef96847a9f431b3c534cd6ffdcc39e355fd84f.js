"use strict";(()=>{var bs=Object.defineProperty;var xs=Object.getPrototypeOf;var Es=Reflect.get;var me=Math.pow,Ss=(u,r,e)=>r in u?bs(u,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[r]=e;var v=(u=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(u,{get:(r,e)=>(typeof require!="undefined"?require:r)[e]}):u)(function(u){if(typeof require!="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+u+'" is not supported')});var i=(u,r,e)=>Ss(u,typeof r!="symbol"?r+"":r,e);var ne=(u,r,e)=>Es(xs(u),e,r);var I=(u,r,e)=>new Promise((t,s)=>{var n=l=>{try{o(e.next(l))}catch(c){s(c)}},a=l=>{try{o(e.throw(l))}catch(c){s(c)}},o=l=>l.done?t(l.value):Promise.resolve(l.value).then(n,a);o((e=e.apply(u,r)).next())});var S=v("three");var qt=v("three");var k=class{constructor(r=0){i(this,"nextId");this.nextId=r}getNextId(){return this.nextId++}reset(r=0){return this.nextId=r,this}};var Me=class Me extends qt.EventDispatcher{constructor(e){super();i(this,"id");i(this,"_value");i(this,"_overrideValue");i(this,"muted");i(this,"locked");this.id=Me.idManager.getNextId(),this._value=e,this._overrideValue=null,this.locked=!1,this.muted=!1}get value(){var e;return(e=this._overrideValue)!=null?e:this._value}set value(e){this._value=e,this.setChanged()}get overrideValue(){return this._overrideValue}set overrideValue(e){this._overrideValue=e,this.setChanged()}mute(){this.muted=!0}unmute(){this.muted=!1}setChanged(){if(!this.muted){if(this.locked)throw new Error("Unable to change resource value inside change event handler");this.locked=!0,this.dispatchEvent({type:"change"}),this.locked=!1}}};i(Me,"idManager",new k);var Te=Me;var W=class W extends Te{constructor(r){super(r),W.increaseReferenceCount(r)}get value(){return super.value}set value(r){let e=super.value;super.value=r,r!==e&&(W.decreaseReferenceCount(e),W.increaseReferenceCount(r),e!==null&&!W.references.has(e)&&e.dispose())}dispose(){var r;(r=this.value)==null||r.dispose()}static decreaseReferenceCount(r){var s;if(r===null)return;let e=W.references,t=(s=e.get(r))!=null?s:0;t>0&&(t===1?e.delete(r):e.set(r,t-1))}static increaseReferenceCount(r){var s;if(r===null)return;let e=W.references,t=(s=e.get(r))!=null?s:0;e.set(r,t+1)}};i(W,"references",new Map);var q=W;var Re=v("three");var Kt=v("three");var _=class extends Kt.EventDispatcher{constructor(e){super();i(this,"data");this.data=new Map(e)}get size(){return this.data.size}get[Symbol.toStringTag](){return this.data[Symbol.toStringTag]}clear(){this.dispatchEvent({type:"clear"});let e=this.data.clear();return this.dispatchEvent({type:"change"}),e}delete(e){return this.data.has(e)?(this.dispatchEvent({type:"delete",key:e,value:this.data.get(e)}),this.data.delete(e),this.dispatchEvent({type:"change"}),!0):!1}get(e){return this.data.get(e)}has(e){return this.data.has(e)}set(e,t){return this.data.has(e)&&this.dispatchEvent({type:"delete",key:e,value:this.data.get(e)}),this.data.set(e,t),this.dispatchEvent({type:"add",key:e,value:t}),this.dispatchEvent({type:"change"}),this}entries(){return this.data.entries()}keys(){return this.data.keys()}values(){return this.data.values()}forEach(e,t){return this.data.forEach(e,t)}[Symbol.iterator](){return this.data[Symbol.iterator]()}};var Zt=v("three");var ie=class extends Zt.EventDispatcher{constructor(e){super();i(this,"data");this.data=new Set(e)}get size(){return this.data.size}get[Symbol.toStringTag](){return this.data[Symbol.toStringTag]}[Symbol.iterator](){return this.data[Symbol.iterator]()}clear(){this.data.size!==0&&(this.dispatchEvent({type:"clear"}),this.data.clear(),this.dispatchEvent({type:"change"}))}delete(e){return this.data.has(e)?(this.dispatchEvent({type:"delete",value:e}),this.data.delete(e),this.dispatchEvent({type:"change"}),!0):!1}has(e){return this.data.has(e)}add(e){return this.data.has(e)?this:(this.data.add(e),this.dispatchEvent({type:"add",value:e}),this.dispatchEvent({type:"change"}),this)}entries(){return this.data.entries()}keys(){return this.data.keys()}values(){return this.data.values()}forEach(e,t){return this.data.forEach(e,t)}};var V=class extends q{constructor(e=null){super(e);i(this,"uniformListeners");this.uniformListeners=new WeakMap}bindUniform(e){if(!this.uniformListeners.has(e)){let t=()=>{e.value=this.value};this.uniformListeners.set(e,t),this.addEventListener("change",t)}e.value=this.value}unbindUniform(e){this.uniformListeners.has(e)&&this.removeEventListener("change",this.uniformListeners.get(e))}};var Y=class Y extends Re.EventDispatcher{constructor(){super();i(this,"defines");i(this,"uniforms");i(this,"gBuffer");i(this,"textures");i(this,"_gBufferConfig");i(this,"propagateChangeEvent");let e=new ie(["Color"]),t=new _,s=new _,n=new _,a=()=>this.setChanged();e.addEventListener("change",a),t.addEventListener("change",a),s.addEventListener("change",a),n.addEventListener("change",a),n.addEventListener("add",o=>o.value.addEventListener("change",a)),n.addEventListener("delete",o=>o.value.removeEventListener("change",a)),n.addEventListener("clear",o=>{for(let l of o.target.values())l.removeEventListener("change",a)}),this.propagateChangeEvent=a,this.defines=t,this.uniforms=s,this.textures=n,this.gBuffer=e,this._gBufferConfig=null}get gBufferConfig(){return this._gBufferConfig}set gBufferConfig(e){this._gBufferConfig!==null&&this._gBufferConfig.removeEventListener("change",this.propagateChangeEvent),e!==null&&e.addEventListener("change",this.propagateChangeEvent),this._gBufferConfig=e,this.setChanged()}get buffers(){return this.textures}get hasDefaultBuffer(){return this.textures.has(Y.BUFFER_DEFAULT)}get defaultBuffer(){var e;return(e=this.textures.get(Y.BUFFER_DEFAULT))!=null?e:null}set defaultBuffer(e){this.setBuffer(Y.BUFFER_DEFAULT,e)}get frameBufferPrecisionHigh(){var e,t;return((t=(e=this.defaultBuffer)==null?void 0:e.value)==null?void 0:t.type)!==Re.UnsignedByteType}setChanged(){this.dispatchEvent({type:"change"})}setBuffer(e,t){if(t instanceof V)this.textures.set(e,t);else{let s=this.textures.get(e);s!=null?s.value=t:this.textures.set(e,new V(t))}}getBuffer(e){var t,s;return(s=(t=this.textures.get(e))==null?void 0:t.value)!=null?s:null}removeDefaultBuffer(){return this.textures.delete(Y.BUFFER_DEFAULT)}dispose(){var e;for(let t of this.textures.values())(e=t.value)==null||e.dispose()}};i(Y,"BUFFER_DEFAULT","BUFFER_DEFAULT");var ae=Y;var be=v("three");var E=v("three");var B=v("three");var _e="out vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}";var G=class extends B.ShaderMaterial{constructor(r){super(Object.assign({name:"FullscreenMaterial",glslVersion:B.GLSL3,blending:B.NoBlending,depthWrite:!1,depthTest:!1,vertexShader:_e},r)),Object.assign(this.uniforms,{projectionMatrix:new B.Uniform(null),projectionMatrixInverse:new B.Uniform(null),viewMatrix:new B.Uniform(null),viewMatrixInverse:new B.Uniform(null),cameraParams:new B.Uniform(new B.Vector3),resolution:new B.Uniform(new B.Vector4),inputBuffer:new B.Uniform(null)}),this.outputPrecision="lowp",this.onBeforeCompile=(e,t)=>{t.getRenderTarget()===null&&this.outputPrecision!=="lowp"&&(this.outputPrecision="lowp",this.needsUpdate=!1)}}get outputPrecision(){return this.defines.OUTPUT_COLOR_PRECISION}set outputPrecision(r){this.defines.OUTPUT_COLOR_PRECISION!==r&&(this.defines.OUTPUT_COLOR_PRECISION=r,this.needsUpdate=!0)}get frameBufferPrecisionHigh(){return this.defines.FRAME_BUFFER_PRECISION_HIGH!==void 0}set frameBufferPrecisionHigh(r){this.frameBufferPrecisionHigh!==r&&(r?this.defines.FRAME_BUFFER_PRECISION_HIGH=!0:delete this.defines.FRAME_BUFFER_PRECISION_HIGH,this.needsUpdate=!0)}get inputBuffer(){return this.uniforms.inputBuffer.value}set inputBuffer(r){this.frameBufferPrecisionHigh=r!==null&&r.type!==B.UnsignedByteType,this.uniforms.inputBuffer.value=r}get near(){return this.uniforms.cameraParams.value.x}get far(){return this.uniforms.cameraParams.value.y}copyCameraSettings(r){this.uniforms.projectionMatrix.value=r.projectionMatrix,this.uniforms.projectionMatrixInverse.value=r.projectionMatrixInverse,this.uniforms.viewMatrix.value=r.matrixWorldInverse,this.uniforms.viewMatrixInverse.value=r.matrixWorld;let e=this.uniforms.cameraParams.value;e.set(r.near,r.far,e.z);let t=this.defines.PERSPECTIVE_CAMERA!==void 0;r instanceof B.PerspectiveCamera?t||(this.defines.PERSPECTIVE_CAMERA=!0,this.needsUpdate=!0):t&&(delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(r,e){this.uniforms.resolution.value.set(r,e,1/r,1/e);let s=this.uniforms.cameraParams.value;s.z=r/e}};var oe=v("three");var O=-1,j=class extends oe.EventDispatcher{constructor(e=O,t=O,s=1){super();i(this,"baseSize");i(this,"preferredSize");i(this,"effectiveSize");i(this,"_pixelRatio");i(this,"_scale");i(this,"locked");this.baseSize=new oe.Vector2(1,1),this.preferredSize=new oe.Vector2(e,t),this.effectiveSize=new oe.Vector2,this._pixelRatio=1,this._scale=s,this.locked=!1,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){let e=this.baseSize,t=this.preferredSize,s=this.effectiveSize;s.copy(e),t.width!==O?s.width=t.width:t.height!==O&&(s.width=Math.round(t.height*(e.width/Math.max(e.height,1)))),t.height!==O?s.height=t.height:t.width!==O&&(s.height=Math.round(t.width/Math.max(e.width/Math.max(e.height,1),1))),s.multiplyScalar(this.scaledPixelRatio).floor()}get width(){return this.effectiveSize.width}get height(){return this.effectiveSize.height}get aspectRatio(){return this.baseSize.width/this.baseSize.height}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio!==e&&(this._pixelRatio=e,this.setChanged())}get scale(){return this._scale}set scale(e){this._scale!==e&&(this._scale=e,this.preferredSize.setScalar(O),this.setChanged())}get scaledPixelRatio(){return this._pixelRatio*this._scale}get baseWidth(){return this.baseSize.width}set baseWidth(e){this.baseSize.width!==e&&(this.baseSize.width=e,this.setChanged())}get baseHeight(){return this.baseSize.height}set baseHeight(e){this.baseSize.height!==e&&(this.baseSize.height=e,this.setChanged())}setBaseSize(e,t){(this.baseSize.width!==e||this.baseSize.height!==t)&&(this.baseSize.set(e,t),this.setChanged())}setSize(e,t){this.setBaseSize(e,t)}copyBaseSize(e){this.baseSize.equals(e.baseSize)||(this.baseSize.copy(e.baseSize),this.setChanged())}get preferredWidth(){return this.preferredSize.width}set preferredWidth(e){this.preferredSize.width!==e&&(this.preferredSize.width=e,this.setChanged())}get preferredHeight(){return this.preferredSize.height}set preferredHeight(e){this.preferredSize.height!==e&&(this.preferredSize.height=e,this.setChanged())}setPreferredSize(e,t){(this.preferredSize.width!==e||this.preferredSize.height!==t)&&(this.preferredSize.set(e,t),this.setChanged())}copyPreferredSize(e){this.preferredSize.equals(e.preferredSize)||(this.preferredSize.copy(e.preferredSize),this.setChanged())}resetPreferredSize(){(this.preferredSize.width!==O||this.preferredSize.height!==O)&&(this.preferredSize.set(O,O),this.setChanged())}copy(e){this.equals(e)||(this.preferredSize.copy(e.preferredSize),this.baseSize.copy(e.baseSize),this._pixelRatio=e.pixelRatio,this._scale=e.scale,this.setChanged())}equals(e){return this.scale===e.scale&&this.pixelRatio===e.pixelRatio&&this.baseSize.equals(e.baseSize)&&this.preferredSize.equals(e.preferredSize)}setChanged(){if(this.locked)throw new Error("Unable to change resolution inside change event handler");this.locked=!0,this.dispatchEvent({type:"change"}),this.locked=!1}get x(){return this.width}get y(){return this.height}};i(j,"AUTO_SIZE",O);var Qt=v("three");var Ce=class extends Qt.EventDispatcher{constructor(e){super();i(this,"listener");this.listener=t=>this.handleSceneEvent(t),this.handleSceneEvent({type:"childadded",target:e,child:e})}handleSceneEvent(e){var t,s;switch(e.type){case"childadded":{(t=e.child)==null||t.traverse(n=>{n.addEventListener("childadded",this.listener),n.addEventListener("childremoved",this.listener)});break}case"childremoved":{(s=e.child)==null||s.traverse(n=>{n.removeEventListener("childadded",this.listener),n.removeEventListener("childremoved",this.listener)});break}}this.dispatchEvent(e)}};var ue=class{constructor(){i(this,"defines");i(this,"uniforms");this.defines=new Map,this.uniforms=new Map}applyDefines(r,e){for(let t of this.defines.keys())delete r.defines[t];for(let t of e.entries())r.defines[t[0]]=t[1];return r.needsUpdate=!0,this}trackDefines(r){this.defines.clear();for(let e of r.entries())this.defines.set(e[0],e[1]);return this}applyUniforms(r,e){for(let t of this.uniforms.keys())delete r.uniforms[t];for(let t of e.entries())r.uniforms[t[0]]=t[1];return r.uniformsNeedUpdate=!0,this}trackUniforms(r){this.uniforms.clear();for(let e of r.entries())this.uniforms.set(e[0],e[1]);return this}dispose(){this.defines.clear(),this.uniforms.clear()}};var Lt=v("three");var le=class u extends j{constructor(){super();i(this,"offset");i(this,"effectiveOffset");i(this,"_enabled");this.offset=new Lt.Vector2,this.effectiveOffset=new Lt.Vector2,this._enabled=!1,this.addEventListener("change",()=>this.updateEffectiveOffset())}updateEffectiveOffset(){this.effectiveOffset.copy(this.offset).multiplyScalar(this.scaledPixelRatio).floor()}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.setChanged())}get offsetX(){return this.effectiveOffset.x}get offsetY(){return this.effectiveOffset.y}setOffset(e,t){(this.offset.x!==e||this.offset.y!==t)&&(this.offset.set(e,t),this.updateEffectiveOffset(),this.setChanged())}set(e,t,s,n){s===void 0||n===void 0?super.setPreferredSize(e,t):(this.offset.set(e,t),this.updateEffectiveOffset(),super.setPreferredSize(s,n))}copy(e){e instanceof u?this.equals(e)||(this.enabled=e.enabled,this.offset.copy(e.offset),this.effectiveOffset.copy(e.effectiveOffset),super.copy(e)):super.copy(e)}equals(e){return this.enabled===e.enabled&&this.offset.equals(e.offset)&&super.equals(e)}get x(){return this.effectiveOffset.x}get y(){return this.effectiveOffset.y}get z(){return this.width}get w(){return this.height}};var we=class extends le{};var Fe=v("three");var J=class extends q{constructor(e=null){var t;super(e);i(this,"texture");this.texture=new V((t=this.value)==null?void 0:t.texture)}get value(){return super.value}set value(e){super.value=e,this.texture.value=e!==null?e.texture:null}mute(){super.mute(),this.texture.mute()}unmute(){super.unmute(),this.texture.unmute()}};var ee=class ee extends Fe.EventDispatcher{constructor(){super();i(this,"defines");i(this,"uniforms");i(this,"renderTargets");let e=new _,t=new _,s=new _,n=()=>this.setChanged();e.addEventListener("change",n),t.addEventListener("change",n),s.addEventListener("change",n),s.addEventListener("add",a=>a.value.addEventListener("change",n)),s.addEventListener("delete",a=>a.value.removeEventListener("change",n)),s.addEventListener("clear",a=>{for(let o of a.target.values())o.removeEventListener("change",n)}),this.defines=e,this.uniforms=t,this.renderTargets=s}get buffers(){return this.renderTargets}get hasDefaultBuffer(){return this.renderTargets.has(ee.BUFFER_DEFAULT)}get defaultBuffer(){var e;return(e=this.renderTargets.get(ee.BUFFER_DEFAULT))!=null?e:null}set defaultBuffer(e){this.setBuffer(ee.BUFFER_DEFAULT,e)}get frameBufferPrecisionHigh(){var t;let e=(t=this.defaultBuffer)==null?void 0:t.value;return e==null?!1:e.texture.type!==Fe.UnsignedByteType}setChanged(){this.dispatchEvent({type:"change"})}setBuffer(e,t){if(t instanceof J)this.renderTargets.set(e,t);else{let s=this.renderTargets.get(e);s!=null?s.value=t:this.renderTargets.set(e,new J(t))}}getBuffer(e){var t,s;return(s=(t=this.renderTargets.get(e))==null?void 0:t.value)!=null?s:null}removeDefaultBuffer(){return this.renderTargets.delete(ee.BUFFER_DEFAULT)}dispose(){var e,t,s;for(let n of this.renderTargets.values())(t=(e=n.value)==null?void 0:e.depthTexture)==null||t.dispose(),(s=n.value)==null||s.dispose()}};i(ee,"BUFFER_DEFAULT","BUFFER_DEFAULT");var De=ee;var Yt=new E.Vector2,P=class P extends E.EventDispatcher{constructor(e){super();i(this,"id");i(this,"sceneListener");i(this,"shaderDataTracker");i(this,"fullscreenScene");i(this,"fullscreenCamera");i(this,"screen");i(this,"_name");i(this,"_enabled");i(this,"_attached");i(this,"_autoSyncDefaultBuffers");i(this,"_autoSRGB");i(this,"_timer");i(this,"_renderer");i(this,"_scene");i(this,"_camera");i(this,"_subpasses");i(this,"disposables");i(this,"materials");i(this,"resolution");i(this,"viewport");i(this,"scissor");i(this,"input");i(this,"output");this.sceneListener=t=>this.handleSceneEvent(t),this.shaderDataTracker=new ue,this.fullscreenScene=null,this.fullscreenCamera=null,this.screen=null,this._name=e,this._enabled=!0,this._attached=!1,this._autoSyncDefaultBuffers=!0,this._autoSRGB=!0,this._renderer=null,this._timer=null,this._scene=null,this._camera=null,this._subpasses=[],this.id=P.idManager.getNextId(),this.disposables=new Set,this.materials=new Set,this.resolution=new j,this.viewport=new le,this.scissor=new we,this.resolution.addEventListener("change",t=>this.handleResolutionEvent(t)),this.viewport.addEventListener("change",t=>this.handleViewportEvent(t)),this.scissor.addEventListener("change",t=>this.handleScissorEvent(t)),this.input=new ae,this.output=new De,this.input.addEventListener("change",t=>this.handleInputEvent(t)),this.output.addEventListener("change",t=>this.handleOutputEvent(t))}get name(){return this._name}set name(e){this._name=e}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.dispatchEvent({type:"toggle"}))}get attached(){return this._attached}set attached(e){this._attached!==e&&(this._attached=e,this.input.setChanged(),this.output.setChanged(),this.resolution.setChanged())}get autoSyncDefaultBuffers(){return this._autoSyncDefaultBuffers}set autoSyncDefaultBuffers(e){this._autoSyncDefaultBuffers!==e&&(this._autoSyncDefaultBuffers=e,this.syncDefaultBuffers())}get autoSRGB(){return this._autoSRGB}set autoSRGB(e){this._autoSRGB!==e&&(this._autoSRGB=e,this.syncDefaultBuffers())}get subpasses(){return this._subpasses}set subpasses(e){for(let t of this.subpasses)t.attached=!1;for(let t of e)if(t.attached)throw new Error(`${t.name} is already attached to another pass`);this._subpasses=e,Object.freeze(this._subpasses),this.initializeSubpasses()}get timer(){return this._timer}set timer(e){this._timer=e;for(let t of this.subpasses)t.timer=e}get renderer(){return this._renderer}set renderer(e){this._renderer=e;try{(e==null?void 0:e.capabilities)!==void 0&&this.checkRequirements()}catch(t){console.warn(t),console.info("Disabling pass:",this),this.enabled=!1}for(let t of this.subpasses)t.renderer=e}get scene(){return this._scene}set scene(e){if(this._scene!==e){if(this._scene!==null&&P.sceneEventTargets.has(this._scene)){let t=P.sceneEventTargets.get(this._scene);t.removeEventListener("childadded",this.sceneListener),t.removeEventListener("childremoved",this.sceneListener)}if(this._scene=e,e!==null){P.sceneEventTargets.has(e)||P.sceneEventTargets.set(e,new Ce(e));let t=P.sceneEventTargets.get(e);t.addEventListener("childadded",this.sceneListener),t.addEventListener("childremoved",this.sceneListener)}for(let t of this.subpasses)t.scene=e}}get camera(){return this._camera}set camera(e){if(this._camera!==e){this._camera=e,e!==null&&this.fullscreenMaterial instanceof G&&this.fullscreenMaterial.copyCameraSettings(e);for(let t of this.subpasses)t.camera=e}}get fullscreenMaterial(){var e;return(e=this.screen)==null?void 0:e.material}set fullscreenMaterial(e){e!==null&&(this.screen!==null?this.screen.material=e:(this.screen=new E.Mesh(P.fullscreenGeometry,e),this.screen.frustumCulled=!1,this.fullscreenScene=new E.Scene,this.fullscreenCamera=new E.OrthographicCamera(-1,1,1,-1,0,1),this.fullscreenScene.add(this.screen)),this.materials.has(e)||(this.materials.add(e),this.updateFullscreenMaterialInput(e)))}initializeSubpasses(){for(let e of this.subpasses)e.timer=this.timer,e.renderer=this.renderer,e.scene=this.scene,e.camera=this.camera,e.resolution.copy(this.resolution),e.viewport.copy(this.viewport),e.scissor.copy(this.scissor),e.attached=!0}updateSubpassResolution(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.resolution;for(let n of this.subpasses)n.resolution.pixelRatio=s,n.resolution.setBaseSize(e,t)}updateSubpassViewport(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.viewport;for(let n of this.subpasses)n.viewport.pixelRatio=s,n.viewport.setBaseSize(e,t)}updateSubpassScissor(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.scissor;for(let n of this.subpasses)n.scissor.pixelRatio=s,n.scissor.setBaseSize(e,t)}updateOutputBufferSize(){var e,t;(t=(e=this.output.defaultBuffer)==null?void 0:e.value)==null||t.setSize(this.resolution.width,this.resolution.height)}updateViewportAndScissor(){let{baseWidth:e,baseHeight:t,scaledPixelRatio:s}=this.resolution;this.viewport.pixelRatio=s,this.viewport.setBaseSize(e,t),this.scissor.pixelRatio=s,this.scissor.setBaseSize(e,t)}updateFullscreenMaterialResolution(e){e instanceof G&&e.setSize(this.resolution.width,this.resolution.height)}updateFullscreenMaterialsResolution(){for(let e of this.materials)this.updateFullscreenMaterialResolution(e)}updateFullscreenMaterialInput(e){var t,s;e instanceof E.ShaderMaterial&&(e instanceof G&&(e.inputBuffer=(s=(t=this.input.defaultBuffer)==null?void 0:t.value)!=null?s:null),this.shaderDataTracker.applyDefines(e,this.input.defines).applyUniforms(e,this.input.uniforms))}updateFullscreenMaterialsInput(){for(let e of this.materials)this.updateFullscreenMaterialInput(e);this.shaderDataTracker.trackDefines(this.input.defines).trackUniforms(this.input.uniforms)}updateFullscreenMaterialsOutput(){for(let e of this.materials)e instanceof G&&(e.outputPrecision=this.output.frameBufferPrecisionHigh?"mediump":"lowp")}syncDefaultBuffers(){var o,l,c,f;let e=this.renderer,t=(l=(o=this.input.defaultBuffer)==null?void 0:o.value)!=null?l:null,s=(f=(c=this.output.defaultBuffer)==null?void 0:c.value)!=null?f:null;if(!this.autoSyncDefaultBuffers||e===null||t===null||s===null)return;let n=s.texture;n.needsUpdate=n.format!==t.format||n.internalFormat!==t.internalFormat||n.type!==t.type,n.needsUpdate&&(n.format=t.format,n.internalFormat=t.internalFormat,n.type=t.type),this.autoSRGB&&!this.output.frameBufferPrecisionHigh&&e.outputColorSpace===E.SRGBColorSpace&&n.colorSpace!==E.SRGBColorSpace&&(n.colorSpace=E.SRGBColorSpace,n.needsUpdate=!0),n.needsUpdate&&this.output.defaultBuffer.texture.setChanged()}isConvolutionPass(e){let t=this.fullscreenMaterial;if(t instanceof G&&/texture\s*\(\s*gBuffer.color/.test(t.fragmentShader))return!0;if(e){for(let s of this.subpasses)if(s.isConvolutionPass(e))return!0}return!1}checkRequirements(){}onInputChange(){}onOutputChange(){}onResolutionChange(){}onViewportChange(){}onScissorChange(){}onSceneChildAdded(e){}onSceneChildRemoved(e){}compile(){return I(this,null,function*(){if(this.renderer===null)return;let e=new E.Group;for(let s of this.materials)e.add(new E.Mesh(P.fullscreenGeometry,s));let t=[this.renderer.compileAsync(e,this.fullscreenCamera,this.fullscreenScene)];for(let s of this.subpasses)t.push(s.compile());yield Promise.all(t)})}createFramebuffer(){let{width:e,height:t}=this.resolution;return new E.WebGLRenderTarget(e,t,{depthBuffer:!1})}setChanged(){this.dispatchEvent({type:"change"})}applyViewport(e=null){let t=this.renderer;if(t===null)return;let s=this.viewport;if(s.enabled)e!==null?e.viewport.copy(s):t.setViewport(s.x,s.y,s.z,s.w);else if(e!==null){let{width:n,height:a}=e;e.viewport.set(0,0,n,a)}else{let{width:n,height:a}=t.getSize(Yt);t.setViewport(0,0,n,a)}}applyScissor(e=null){let t=this.renderer;if(t===null)return;let s=this.scissor;if(s.enabled)e!==null?(e.scissor.copy(s),e.scissorTest=!0):(t.setScissor(s.x,s.y,s.z,s.w),t.setScissorTest(!0));else if(e!==null){let{width:n,height:a}=e;e.scissor.set(0,0,n,a),e.scissorTest=!1}else if(t.getScissorTest()){let{width:n,height:a}=t.getSize(Yt);t.setScissor(0,0,n,a),t.setScissorTest(!1)}}setRenderTarget(e=null,t,s){var n;this.applyViewport(e),this.applyScissor(e),(n=this.renderer)==null||n.setRenderTarget(e,t,s)}renderFullscreen(){this.renderer!==null&&this.fullscreenMaterial!==null&&this.renderer.render(this.fullscreenScene,this.fullscreenCamera)}handleResolutionEvent(e){this.attached&&e.type==="change"&&(this.updateFullscreenMaterialsResolution(),this.updateOutputBufferSize(),this.onResolutionChange(),this.updateSubpassResolution(),this.updateViewportAndScissor())}handleViewportEvent(e){this.attached&&e.type==="change"&&(this.onViewportChange(),this.updateSubpassViewport())}handleScissorEvent(e){this.attached&&e.type==="change"&&(this.onScissorChange(),this.updateSubpassScissor())}handleInputEvent(e){this.attached&&e.type==="change"&&(this.updateFullscreenMaterialsInput(),this.syncDefaultBuffers(),this.onInputChange())}handleOutputEvent(e){this.attached&&e.type==="change"&&(this.updateOutputBufferSize(),this.updateFullscreenMaterialsOutput(),this.syncDefaultBuffers(),this.onOutputChange())}handleSceneEvent(e){if(this.attached)switch(e.type){case"childadded":this.onSceneChildAdded(e.child);break;case"childremoved":this.onSceneChildRemoved(e.child);break}}dispose(){this.input.dispose(),this.output.dispose(),this.shaderDataTracker.dispose();for(let e of this.materials)e==null||e.dispose();for(let e of this.disposables)e.dispose();for(let e of this.subpasses)e.dispose()}};i(P,"fullscreenGeometry",(()=>{let e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new E.BufferGeometry;return t.setAttribute("position",new E.BufferAttribute(e,3)),t})()),i(P,"idManager",new k),i(P,"sceneEventTargets",new WeakMap);var D=P;var F=v("three"),Bs=new Map([[F.FloatType,"highp"],[F.HalfFloatType,"mediump"],[F.UnsignedByteType,"lowp"]]),ys=new Map([[F.RedFormat,"float"],[F.RGFormat,"vec2"],[F.RGBFormat,"vec3"],[F.RGBAFormat,"vec4"]]);function fe(u){let r=new Map;for(let e=0,t=u.textures.length;e<t;++e){let s=u.textures[e];r.set(s.name,e)}return r}function Ae(u){let r=[];for(let e=0,t=u.textures.length;e<t;++e){let s=u.textures[e],n=Bs.get(s.type),a=ys.get(s.format),o=s.name.replace(/\W*/g,"");e===0&&r.push("#ifndef gl_FragColor"),r.push(`layout(location = ${e}) out ${n} ${a} out_FragData${e};`),o!==""&&r.push(`#define out_${o} out_FragData${e}`),e===0&&(r.push(`#define gl_FragColor out_FragData${e}`),r.push("#endif"))}return r.join(`
`)}function Pe(u){if(u.includes("pp_normal_codec_pars_fragment")||(u=u.replace(/(void\s+main\(\)\s+{)/,`
#include <pp_normal_codec_pars_fragment>
$1`)),!u.includes("pp_gbuffer_default_output_fragment")){let r=u.includes("clipping_planes_fragment");u=u.replace(r?/(#include\s+<clipping_planes_fragment>)/:/(void\s+main\(\)\s+{)/,`$1
#include <pp_gbuffer_default_output_fragment>
`)}return u}var M=v("three");var K=v("three"),ge=class extends K.ShaderMaterial{constructor(){super({name:"BackgroundMaterial",fragmentShader:K.ShaderLib.background.fragmentShader,vertexShader:K.ShaderLib.background.vertexShader,uniforms:K.UniformsUtils.clone(K.ShaderLib.background.uniforms),depthWrite:!1,depthTest:!1,fog:!1})}get map(){return this.uniforms.t2D.value}set map(r){this.uniforms.t2D.value=r}};var z=v("three"),ve=class extends z.ShaderMaterial{constructor(){super({name:"SkyBoxMaterial",fragmentShader:z.ShaderLib.backgroundCube.fragmentShader,vertexShader:z.ShaderLib.backgroundCube.vertexShader,uniforms:z.UniformsUtils.clone(z.ShaderLib.backgroundCube.uniforms),side:z.BackSide,depthWrite:!1,depthTest:!1,fog:!1})}get envMap(){return this.uniforms.envMap.value}set envMap(r){this.uniforms.envMap.value=r}};var te=new M.Euler,Ts=new M.Matrix4,Le=class extends M.Group{constructor(){super();i(this,"skyBox");i(this,"background");let e=new M.Mesh(new M.BoxGeometry(1,1,1),new ve);e.name="SkyBox",e.geometry.deleteAttribute("normal"),e.geometry.deleteAttribute("uv"),e.matrixAutoUpdate=!1,e.frustumCulled=!1,e.layers.enableAll(),this.skyBox=e,e.onBeforeRender=function(s,n,a){this.matrixWorld.copyPosition(a.matrixWorld)};let t=new M.Mesh(new M.PlaneGeometry(2,2),new ge);t.name="Background",t.geometry.deleteAttribute("normal"),t.matrixAutoUpdate=!1,t.frustumCulled=!1,t.layers.enableAll(),this.background=t,this.add(this.skyBox,this.background)}setClearValues(e){let t=new ve,s=new ge,n=new Map,a=[],o=[];for(let f of e.gBuffer){let p=typeof f[1]=="number"?"float":`vec${[...f[1]].length}`;n.set(`pp_${f[0]}`,new M.Uniform(f[1])),a.push(`uniform ${p} pp_${f[0]};`),o.push(`	#ifdef out_${f[0]}
		out_${f[0]} = pp_${f[0]};
#endif`)}let l=a.join(`
`),c=o.join(`
`);for(let f of[t,s]){f.fragmentShader=f.fragmentShader.replace(/(void main\(\) {)/,`
${l}
$1
${c}
`);for(let p of n)f.uniforms[p[0]]=p[1];f.onBeforeCompile=(p,x)=>{let m=x.getRenderTarget();if(m===null)return;let g=Ae(m);p.fragmentShader=g+`

`+p.fragmentShader}}this.skyBox.material.dispose(),this.background.material.dispose(),this.skyBox.material=t,this.background.material=s}update(e){let{skyBox:t,background:s}=this;if(t.visible=!1,s.visible=!1,!(e===null||!(e.background instanceof M.Texture)))if(e.background instanceof M.CubeTexture||e.background.mapping===M.CubeUVReflectionMapping){let n=e.background.isRenderTargetTexture?1:-1;te.copy(e.backgroundRotation),te.x*=-1,te.y*=-1,te.z*=-1,te.y*=n,te.z*=n,t.material.envMap=e.background,t.material.uniforms.flipEnvMap.value=n,t.material.uniforms.backgroundBlurriness.value=e.backgroundBlurriness,t.material.uniforms.backgroundIntensity.value=e.backgroundIntensity,t.material.uniforms.backgroundRotation.value.setFromMatrix4(Ts.makeRotationFromEuler(te)),t.visible=!0}else s.material.map=e.background,s.material.uniforms.backgroundIntensity.value=e.backgroundIntensity,s.visible=!0}dispose(){this.skyBox.material.dispose(),this.background.material.dispose()}};var Ie=class{constructor(r=!0,e=!0,t=!0){i(this,"gBuffer");i(this,"depth");i(this,"stencil");this.gBuffer=new Set(["Normal","ORM","Emission"]),this.color=r,this.depth=e,this.stencil=t}get color(){return this.gBuffer.has("Color")}set color(r){r?this.gBuffer.add("Color"):this.gBuffer.delete("Color")}};var Jt=v("three");var Ge=class extends Jt.EventDispatcher{constructor(){super();i(this,"_color");i(this,"_alpha");i(this,"gBuffer");this._color=null,this._alpha=null;let e=new _([["Normal",[0,0]],["ORM",[1,0,0,1]],["Emission",[0,0,0,1]]]);e.addEventListener("change",()=>this.setChanged()),this.gBuffer=e}get color(){return this._color}set color(e){this._color=e,this.setChanged()}get alpha(){return this._alpha}set alpha(e){this._alpha=e,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}};var Ms=new be.Color,A=new Float32Array(4),Z=class u extends D{constructor(e=!0,t=!0,s=!0){super("ClearPass");i(this,"clearFlags");i(this,"clearValues");i(this,"gBufferIndices");i(this,"background");i(this,"backgroundScene");this.clearFlags=new Ie(e,t,s),this.clearValues=new Ge,this.gBufferIndices=null,this.background=new Le,this.background.setClearValues(this.clearValues),this.clearValues.addEventListener("change",()=>this.background.setClearValues(this.clearValues)),this.backgroundScene=new be.Scene,this.backgroundScene.add(this.background),this.disposables.add(this.background)}clearBuffers(e,t){let s=this.clearFlags,n=this.clearValues.gBuffer;for(let a of t){let o=n.get(a[0]);!s.gBuffer.has(a[0])||o===void 0||(typeof o=="number"?(A[0]=o,A[1]=0,A[2]=0,A[3]=1):(A[0]=o.length>0?o[0]:0,A[1]=o.length>1?o[1]:0,A[2]=o.length>2?o[2]:0,A[3]=o.length>3?o[3]:1),e.clearBufferfv(e.COLOR,a[1],A))}}clear(e=this.clearValues.color){var a;let t=this.renderer,s=t.getContext(),n=(a=this.clearValues.alpha)!=null?a:t.getClearAlpha();e!=null||(e=t.getClearColor(Ms)),A[0]=e.r,A[1]=e.g,A[2]=e.b,A[3]=n,s.clearBufferfv(s.COLOR,0,A),this.gBufferIndices!==null&&this.gBufferIndices.size>1&&this.clearBuffers(s,this.gBufferIndices)}clearWithBackground(){let e=this.scene,t=this.camera,s=this.renderer;e.background instanceof be.Color?this.clear(e.background):(this.background.update(e),s.render(this.backgroundScene,t))}onOutputChange(){var t,s;let e=(s=(t=this.output.defaultBuffer)==null?void 0:t.value)!=null?s:null;this.gBufferIndices=e!==null?fe(e):null}compile(){return I(this,null,function*(){this.renderer===null||this.camera===null||(yield Promise.all([ne(u.prototype,this,"compile").call(this),this.renderer.compileAsync(this.backgroundScene,this.camera)]))})}render(){var n,a,o;if(this.renderer===null)return;let e=(a=(n=this.scene)==null?void 0:n.background)!=null?a:null,t=this.clearValues.color!==null,s=this.clearFlags;this.setRenderTarget((o=this.output.defaultBuffer)==null?void 0:o.value),(s.depth||s.stencil)&&this.renderer.clear(!1,s.depth,s.stencil),!t&&this.camera!==null&&e!==null?this.clearWithBackground():this.clear()}};var h=v("three");var er=v("three");var It=(o=>(o.COLOR="color",o.DEPTH="depth",o.NORMAL="normal",o.POSITION="position",o.ORM="orm",o.EMISSION="emission",o.LUMINANCE="luminance",o))(It||{});var Oe=class extends er.EventDispatcher{constructor(){super();i(this,"textureConfigs");i(this,"gBufferStructFields");i(this,"gBufferStructDeclaration");i(this,"gDataStructDeclaration");i(this,"gDataStructInitialization");i(this,"gDataDependencies");i(this,"gDataBufferSources");let e=new _,t=new _([["Color","color"],["Depth","depth"],["Normal","normal"],["ORM","orm"],["Emission","emission"]]),s=new _([["Color","FRAME_BUFFER_PRECISION sampler2D color;"],["Depth","DEPTH_BUFFER_PRECISION sampler2D depth;"],["Normal","mediump sampler2D normal;"],["ORM","lowp sampler2D orm;"],["Emission","mediump sampler2D emission;"]]),n=new _([["color","vec4 color;"],["depth","float depth;"],["normal","vec3 normal;"],["position","vec3 position;"],["orm","vec3 orm;"],["emission","vec3 emission;"],["luminance","float luminance;"]]),a=new _([["color","gData.color = texture(gBuffer.color, UV);"],["depth","gData.depth = readDepth(gBuffer.depth, UV);"],["normal","gData.normal = readNormal(gBuffer.normal, UV);"],["position","gData.position = getViewPosition(UV, gData.depth);"],["orm","gData.orm = texture(gBuffer.orm, UV).xyz;"],["emission","gData.emission = texture(gBuffer.emission, UV).rgb;"],["luminance","gData.luminance = luminance(gData.color.rgb);"]]),o=new _([["position",new Set(["depth"])],["luminance",new Set(["color"])]]),l=new _([["color",new Set(["Color"])],["depth",new Set(["Depth"])],["normal",new Set(["Normal"])],["position",new Set(["Depth"])],["orm",new Set(["ORM"])],["emission",new Set(["Emission"])],["luminance",new Set(["Color"])]]),c=()=>this.dispatchEvent({type:"change"});e.addEventListener("change",c),t.addEventListener("change",c),s.addEventListener("change",c),n.addEventListener("change",c),a.addEventListener("change",c),o.addEventListener("change",c),l.addEventListener("change",c),this.textureConfigs=e,this.gBufferStructFields=t,this.gBufferStructDeclaration=s,this.gDataStructDeclaration=n,this.gDataStructInitialization=a,this.gDataDependencies=o,this.gDataBufferSources=l}};var ce=class ce extends Set{constructor(e,t=ce.idManager.getNextId()){super();i(this,"_layer");i(this,"enabled");i(this,"exclusive");this._layer=t,(this._layer<1||this._layer>31)&&(console.warn("Layer out of range, resetting to 2"),ce.idManager.reset(2),this._layer=ce.idManager.getNextId()),this.enabled=!0,this.exclusive=!1,e!=null&&this.set(e)}get layer(){return this._layer}set layer(e){let t=this._layer;for(let s of this)s.layers.disable(t),s.layers.enable(e);this._layer=e}clear(){let e=this.layer;for(let t of this)t.layers.disable(e);super.clear()}add(e){return this.exclusive?e.layers.set(this.layer):e.layers.enable(this.layer),super.add(e)}delete(e){return this.has(e)&&e.layers.disable(this.layer),super.delete(e)}set(e){this.clear();for(let t of e)this.add(t);return this}toggle(e){let t;return this.has(e)?(this.delete(e),t=!1):(this.add(e),t=!0),t}setVisible(e){for(let t of this)e?t.layers.enable(0):t.layers.disable(0);return this}};i(ce,"idManager",new k(2));var Ue=ce;var xe=v("three");var tr=`#include <common>
#include <pp_default_output_pars_fragment>
#ifdef COLOR_WRITE
#include <dithering_pars_fragment>
#include <pp_input_buffer_pars_fragment>
#endif
#ifdef DEPTH_WRITE
#include <pp_depth_buffer_pars_fragment>
#endif
#ifdef USE_WEIGHTS
uniform vec4 channelWeights;
#endif
in vec2 vUv;void main(){
#ifdef COLOR_WRITE
vec4 texel=texture2D(inputBuffer,vUv);
#ifdef USE_WEIGHTS
texel*=channelWeights;
#endif
out_Color=texel;
#ifdef COLOR_SPACE_CONVERSION
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
#else
out_Color=vec4(0.0);
#endif
#ifdef DEPTH_WRITE
gl_FragDepth=texture(depthBuffer,vUv).r;
#endif
}`;var Ne=class extends G{constructor(){super({name:"CopyMaterial",fragmentShader:tr,vertexShader:_e,defines:{COLOR_SPACE_CONVERSION:!0,COLOR_WRITE:!0},uniforms:{depthBuffer:new xe.Uniform(null),channelWeights:new xe.Uniform(null)}}),this.depthFunc=xe.AlwaysDepth}get inputBuffer(){return super.inputBuffer}set inputBuffer(r){let e=r!==null;this.colorWrite!==e&&(e?this.defines.COLOR_WRITE=!0:delete this.defines.COLOR_WRITE,this.colorWrite=e,this.needsUpdate=!0),super.inputBuffer=r}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(r){let e=r!==null;this.depthWrite!==e&&(e?this.defines.DEPTH_WRITE=!0:delete this.defines.DEPTH_WRITE,this.depthTest=e,this.depthWrite=e,this.needsUpdate=!0),this.uniforms.depthBuffer.value=r}get colorSpaceConversion(){return this.defines.COLOR_SPACE_CONVERSION!==void 0}set colorSpaceConversion(r){this.colorSpaceConversion!==r&&(r?this.defines.COLOR_SPACE_CONVERSION=!0:delete this.defines.COLOR_SPACE_CONVERSION,this.needsUpdate=!0)}get channelWeights(){return this.uniforms.channelWeights.value}set channelWeights(r){r!==null?(this.defines.USE_WEIGHTS=!0,this.uniforms.channelWeights.value=r):delete this.defines.USE_WEIGHTS,this.needsUpdate=!0}};var Ve=class Ve extends D{constructor(r){super("CopyPass"),this.output.defaultBuffer=r!=null?r:this.createFramebuffer(),this.fullscreenMaterial=new Ne}get renderer(){return super.renderer}set renderer(r){super.renderer=r,this.initializeOutputBuffer()}initializeOutputBuffer(){var e,t;let r=(t=(e=this.output.defaultBuffer)==null?void 0:e.value)!=null?t:null;this.renderer!==null&&r!==null&&this.renderer.initRenderTarget(r)}configureDepthBuffer(){var s,n,a;let r=this.input.getBuffer("Depth"),e=(a=(n=(s=this.output.defaultBuffer)==null?void 0:s.value)==null?void 0:n.depthTexture)!=null?a:null,t=r===e;this.fullscreenMaterial.depthBuffer=r===null||t?null:r}onInputChange(){this.configureDepthBuffer()}onOutputChange(){this.configureDepthBuffer(),this.initializeOutputBuffer()}onResolutionChange(){this.initializeOutputBuffer()}blit(){var n,a,o,l;if(!Ve.blitEnabled)return!1;let r=(a=(n=this.input.defaultBuffer)==null?void 0:n.value)!=null?a:null,e=(l=(o=this.output.defaultBuffer)==null?void 0:o.value)!=null?l:null;if(this.renderer===null||r===null||e===null)return!1;let t=r.source.data;if(t.width!==e.width||t.height!==e.height)return!1;r.type===e.texture.type&&r.format===e.texture.format&&this.renderer.copyTextureToTexture(r,e.texture);let s=this.input.getBuffer("Depth");return s!==null&&e.depthTexture!==null&&s!==e.depthTexture&&s.type===e.depthTexture.type&&s.format===e.depthTexture.format&&this.renderer.copyTextureToTexture(s,e.depthTexture),!0}render(){var e,t,s;let r=(t=(e=this.input.defaultBuffer)==null?void 0:e.value)!=null?t:null;this.renderer===null||r===null||this.blit()||(this.setRenderTarget((s=this.output.defaultBuffer)==null?void 0:s.value),this.renderFullscreen())}};i(Ve,"blitEnabled",!1);var ke=Ve;var rr=v("three");var ze=class{constructor(){i(this,"registeredMaterials",new WeakSet);i(this,"_enabled");i(this,"_gBuffer");this._enabled=!0,this._gBuffer=null}get enabled(){return this._enabled}set enabled(r){this._enabled=r}get gBuffer(){return this._gBuffer}set gBuffer(r){this._gBuffer=r}applyTo(r){if(this.registeredMaterials.has(r))return;this.registeredMaterials.add(r);let e=r.onBeforeCompile,t=r.customProgramCacheKey;r.onBeforeCompile=(s,n)=>{if(r.onBeforeCompile!==e&&e.call(r,s,n),!(!this.enabled||this.gBuffer===null)&&(r instanceof rr.ShaderMaterial&&(s.fragmentShader=Pe(s.fragmentShader)),!s.fragmentShader.includes("out_FragData"))){let a=Ae(this.gBuffer);s.fragmentShader=a+`
`+s.fragmentShader}},r.customProgramCacheKey=()=>{var a,o;let s="";r.customProgramCacheKey!==t&&(s+=t.call(r));let n=(o=(a=this.gBuffer)==null?void 0:a.texture.uuid)!=null?o:"";return s+this.enabled+n}}};var Q=class u extends D{constructor(e,t,{alpha:s=!1,stencilBuffer:n=!1,depthBuffer:a=!0,frameBufferType:o=h.HalfFloatType,samples:l=0,gBufferConfig:c=new Oe}={}){super("GeometryPass");i(this,"selection");i(this,"copyPass");i(this,"gBufferShaderPlugin");i(this,"gBufferResource");i(this,"gBufferComponents");i(this,"alpha");i(this,"stencilBuffer");i(this,"depthBuffer");i(this,"frameBufferType");i(this,"gBufferConfig");i(this,"_samples");this.alpha=s,this.stencilBuffer=n,this.depthBuffer=a,this.frameBufferType=o,this._samples=l,this.selection=new Ue,this.selection.enabled=!1,this.gBufferConfig=c,this.copyPass=new ke,this.copyPass.enabled=!1,this.subpasses=[this.copyPass];let f=new ie;f.addEventListener("change",()=>this.updateGBuffer()),this.gBufferComponents=f,this.gBufferShaderPlugin=new ze,this.gBufferResource=new J,this.output.defaultBuffer=this.gBufferResource,this.scene=e,this.camera=t,this.updateTextureConfigs()}get enabled(){return super.enabled}set enabled(e){super.enabled!==e&&(super.enabled=e,this.gBufferShaderPlugin.enabled=e,this.invalidateMaterials())}get scene(){return super.scene}set scene(e){super.scene=e,e!==null&&this.onSceneChildAdded(e)}get samples(){return this._samples}set samples(e){var s,n;this._samples=e;let t=(n=(s=this.output.defaultBuffer)==null?void 0:s.value)!=null?n:null;t!==null&&t.samples!==e&&(t.samples=e,t.dispose())}get gBuffer(){return this.gBufferResource.value}get frameBufferPrecisionHigh(){return this.frameBufferType===h.HalfFloatType||this.frameBufferType===h.FloatType}get textureConfigs(){return Array.from(this.gBufferConfig.textureConfigs).filter(e=>this.gBufferComponents.has(e[0]))}get renderer(){return super.renderer}set renderer(e){super.renderer=e,this.updateOutputBufferColorSpace()}invalidateMaterial(e){if(!("material"in e))return;let t=Array.isArray(e.material)?e.material:[e.material];for(let s of t)s.needsUpdate=!0}invalidateMaterials(){var e;(e=this.scene)==null||e.traverse(t=>this.invalidateMaterial(t))}updateTextureConfigs(){let e=this.gBufferConfig.textureConfigs,t=this.frameBufferPrecisionHigh&&!this.alpha;e.set("Color",{minFilter:h.LinearFilter,magFilter:h.LinearFilter,type:this.frameBufferType,format:t?h.RGBFormat:h.RGBAFormat,internalFormat:t?"R11F_G11F_B10F":void 0,isColorBuffer:!0}),e.set("Normal",{minFilter:h.NearestFilter,magFilter:h.NearestFilter,type:h.HalfFloatType,format:h.RGFormat}),e.set("ORM",{minFilter:h.NearestFilter,magFilter:h.NearestFilter,type:h.UnsignedByteType,format:h.RGBAFormat}),e.set("Emission",{minFilter:h.LinearFilter,magFilter:h.LinearFilter,type:h.HalfFloatType,format:h.RGBAFormat}),this.updateGBuffer()}updateMaterial(e){if(!("material"in e))return;let t=Array.isArray(e.material)?e.material:[e.material];for(let s of t)this.gBufferShaderPlugin.applyTo(s)}updateOutputBufferColorSpace(){let e=this.gBuffer,t=this.renderer;if(e===null||t===null)return;let s=fe(e),n=this.autoSRGB&&!this.frameBufferPrecisionHigh&&t.outputColorSpace===h.SRGBColorSpace;for(let a of this.textureConfigs)if(a[1].isColorBuffer===!0&&s.has(a[0])){let o=s.get(a[0]),l=e.textures[o];l.colorSpace=n?h.SRGBColorSpace:h.NoColorSpace,l.needsUpdate=!0}}updateGBuffer(){var l,c,f;let e=this.output,t=this.gBufferComponents;if(!e.hasDefaultBuffer)e.defaultBuffer=this.gBufferResource;else if(e.defaultBuffer!==this.gBufferResource)return;if((c=(l=e.defaultBuffer.value)==null?void 0:l.depthTexture)==null||c.dispose(),(f=e.defaultBuffer.value)==null||f.dispose(),t.size===0){e.defaultBuffer=null,e.defines.clear();return}let{width:s,height:n}=this.resolution,a=this.textureConfigs,o=new h.WebGLRenderTarget(s,n,{stencilBuffer:this.stencilBuffer,depthBuffer:this.depthBuffer,samples:this.samples,count:a.length});for(let p=0,x=a.length;p<x;++p){let m=a[p],g=o.textures[p],w=m[1];g.name=m[0],g.minFilter=w.minFilter,g.magFilter=w.magFilter,g.format=w.format,g.type=w.type,w.internalFormat!==void 0&&(g.internalFormat=w.internalFormat)}e.defaultBuffer=o,this.configureDepthTexture(),this.updateOutputBufferColorSpace()}configureDepthTexture(){var n,a,o,l,c;let e=this.output;if(e.defaultBuffer!==this.gBufferResource)return;let t=(a=(n=e.defaultBuffer)==null?void 0:n.value)!=null?a:null;if(t===null)return;if(!this.gBufferComponents.has("Depth")){(o=t.depthTexture)==null||o.dispose(),t.depthTexture=null;return}let s=this.input.getBuffer("Depth");if(s!==null)t.depthTexture!==s&&((l=t.depthTexture)==null||l.dispose(),t.depthTexture=s);else{let f=new h.DepthTexture(1,1);f.name="Depth",f.format=this.stencilBuffer?h.DepthStencilFormat:h.DepthFormat,f.type=this.stencilBuffer?h.UnsignedInt248Type:h.FloatType,(c=t.depthTexture)==null||c.dispose(),t.depthTexture=f}}updateCopyPass(){var a,o,l,c,f;let e=(o=(a=this.input.defaultBuffer)==null?void 0:a.value)!=null?o:null,t=(c=(l=this.output.defaultBuffer)==null?void 0:l.value)!=null?c:null,s=e===(t==null?void 0:t.texture),n=((f=t==null?void 0:t.textures.length)!=null?f:0)>1;this.copyPass.enabled=e!==null&&!s&&!n}onInputChange(){this.configureDepthTexture();let e=this.copyPass;e.input.defaultBuffer=this.input.defaultBuffer,this.updateCopyPass(),this.input.buffers.has("Depth")?e.input.buffers.set("Depth",this.input.buffers.get("Depth")):e.input.buffers.delete("Depth")}onOutputChange(){var e,t;this.output.hasDefaultBuffer?this.configureDepthTexture():(this.gBufferResource.mute(),this.updateGBuffer(),this.gBufferResource.unmute()),this.gBufferShaderPlugin.gBuffer=(t=(e=this.output.defaultBuffer)==null?void 0:e.value)!=null?t:null,this.copyPass.output.defaultBuffer=this.output.defaultBuffer,this.updateCopyPass()}onResolutionChange(){this.copyPass.resolution.copy(this.resolution)}onSceneChildAdded(e){e.traverse(t=>this.updateMaterial(t))}compile(){return I(this,null,function*(){if(this.renderer===null||this.scene===null||this.camera===null)return;let e=[];e.push(ne(u.prototype,this,"compile").call(this)),e.push(this.renderer.compileAsync(this.scene,this.camera)),yield Promise.all(e)})}render(){var o;let{renderer:e,scene:t,camera:s}=this;if(e===null||t===null||s===null)return;let n=s.layers.mask,a=t.background;t.background=null,this.selection.enabled&&s.layers.set(this.selection.layer),this.copyPass.enabled&&this.copyPass.render(),this.setRenderTarget((o=this.output.defaultBuffer)==null?void 0:o.value),e.render(t,s),s.layers.mask=n,t.background=a}};function sr(u,r){for(let e of u.input.buffers.values())r.add(e);for(let e of u.output.buffers.values())r.add(e);for(let e of u.subpasses)sr(e,r)}var He=class{constructor(r){i(this,"pipelines");i(this,"activeResources");this.pipelines=r,this.activeResources=new Set}gatherResources(){let r=new Set;for(let e of this.pipelines)for(let t of e.passes)sr(t,r);return r}optimize(){let r=this.gatherResources();for(let e of this.activeResources)e instanceof q&&!r.has(e)&&e.dispose();this.activeResources=r}};var We=class u{constructor(){i(this,"pipelines");i(this,"resourceManager");i(this,"outputDefaultBuffers");i(this,"updating");this.pipelines=new Set,this.resourceManager=new He(this.pipelines),this.outputDefaultBuffers=new WeakMap,this.updating=!1}updateInput(r){let e=u.findMainGeometryPass(r),t=r.passes.filter(n=>n.enabled);for(let n=0,a=1,o=t.length;n<o;++n,++a){let l=t[n];if(l!==e){if(a<o&&l instanceof Z){let c=t[a];l.scene=c.scene,l.camera=c.camera}else!(l instanceof Q)&&e!==void 0&&(l.scene=e.scene,l.camera=e.camera);u.assignGBufferTextures(l,e)}}let s;for(let n=0,a=1,o=t.length;a<o;++n,++a){let l=t[n],c=t[a];!(l instanceof Z)&&l.output.hasDefaultBuffer&&l.output.defaultBuffer.value!==null&&(s=l.output.defaultBuffer),l.output.defines.forEach((f,p)=>c.input.defines.set(p,f)),l.output.uniforms.forEach((f,p)=>c.input.uniforms.set(p,f)),s===void 0?c.input.buffers.delete(ae.BUFFER_DEFAULT):s!==void 0&&(c.input.defaultBuffer=s.texture)}}restoreOutputBuffers(r){let e=this.outputDefaultBuffers;for(let t of r)if(t.output.defaultBuffer!==null&&e.has(t.output.defaultBuffer)){let s=e.get(t.output.defaultBuffer);e.delete(t.output.defaultBuffer),t.output.defaultBuffer=s}}updateOutput(r){let e=r.passes.filter(t=>t.enabled);if(r.autoRenderToScreen&&e.length>0){this.restoreOutputBuffers(e);let t=this.outputDefaultBuffers,s=e[e.length-1];s.output.defaultBuffer!==null&&(t.set(s.output.defaultBuffer,s.output.defaultBuffer.value),s.output.defaultBuffer=null)}for(let t=0,s=1,n=e.length;s<n;++t,++s){let a=e[t];if(a instanceof Z){let o=e[s];o.output.defines.forEach((l,c)=>a.output.defines.set(c,l)),o.output.uniforms.forEach((l,c)=>a.output.uniforms.set(c,l)),a.output.defaultBuffer=o.output.defaultBuffer}}}addPipeline(r){this.pipelines.add(r)}removePipeline(r){this.pipelines.delete(r)}updatePipeline(r){u.gatherGBufferComponents(r),this.updateOutput(r),this.updateInput(r)}update(){if(!this.updating){this.updating=!0;for(let r of this.pipelines)this.updatePipeline(r);this.resourceManager.optimize(),this.updating=!1}}static findMainGeometryPass(r){return r.passes.find(e=>e.enabled&&e instanceof Q)}static gatherGBufferComponents(r){let e=u.findMainGeometryPass(r);if(e===void 0)return;e.gBufferComponents.clear();for(let s of r.passes.filter(n=>n.enabled))for(let n of s.input.gBuffer)e.gBufferComponents.add(n);let t=r.passes.filter(s=>s.enabled&&s instanceof Q);if(!(t.length<=1||!e.gBufferComponents.has("Color")))for(let s=1,n=t.length;s<n;++s){let a=t[s];a.gBufferComponents.add("Color"),a.depthBuffer&&(a.gBufferComponents.add("Depth"),a.input.gBuffer.add("Depth"),e.gBufferComponents.add("Depth"))}}static assignGBufferTextures(r,e){if(e===void 0||e.gBuffer===null)return;r.input.gBufferConfig=e.gBufferConfig;let t=fe(e.gBuffer);for(let s of r.input.gBuffer)if(s==="Depth")r.input.buffers.set(s,new V(e.gBuffer.depthTexture));else if(t.has(s)){let n=t.get(s);r.input.buffers.set(s,new V(e.gBuffer.textures[n]))}}};var re=v("three");var y=v("three");var nr=`uniform mat4 projectionMatrix;uniform mat4 projectionMatrixInverse;uniform vec3 cameraParams;
#define CAMERA_NEAR cameraParams.x
#define CAMERA_FAR cameraParams.y
#define CAMERA_ASPECT cameraParams.z
#ifdef PERSPECTIVE_CAMERA
#define getViewZ(depth) perspectiveDepthToViewZ(depth, CAMERA_NEAR, CAMERA_FAR)
#else
#define getViewZ(depth) orthographicDepthToViewZ(depth, CAMERA_NEAR, CAMERA_FAR)
#endif
vec3 getViewPosition(const in vec2 screenPosition,const in float depth,const in float viewZ){vec4 clipPosition=vec4(vec3(screenPosition,depth)*2.0-1.0,1.0);float clipW=projectionMatrix[2][3]*viewZ+projectionMatrix[3][3];clipPosition*=clipW;return(projectionMatrixInverse*clipPosition).xyz;}vec3 getViewPosition(const in vec2 screenPosition,const in float depth){return getViewPosition(screenPosition,depth,getViewZ(depth));}`;var ir="vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}";var ar=`#ifndef gl_FragColor
layout(location=0)out OUTPUT_COLOR_PRECISION vec4 out_FragData0;
#define gl_FragColor out_FragData0
#ifndef out_Color
#define out_Color out_FragData0
#endif
#endif`;var or=`#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif`;var ur=`#ifdef GL_FRAGMENT_PRECISION_HIGH
#define DEPTH_BUFFER_PRECISION highp
#else
#define DEPTH_BUFFER_PRECISION mediump
#endif`;var lr=`float readDepth(sampler2D depthBuffer,const in vec2 uv,const in float near,const in float far){float depth=texture(depthBuffer,uv).r;
#ifdef USE_REVERSEDEPTHBUF
return 1.0-depth;
#else
#ifdef USE_LOGDEPTHBUF
float d=pow(2.0,depth*log2(far+1.0))-1.0;float a=far/(far-near);float b=far*near/(near-far);depth=a+b/d;
#endif
return depth;
#endif
}
#if defined(CAMERA_NEAR) && defined(CAMERA_FAR)
#define readDepth(depthBuffer, uv) readDepth(depthBuffer, uv, CAMERA_NEAR, CAMERA_FAR);
#endif`;var fr=`#ifdef FRAME_BUFFER_PRECISION_HIGH
#define FRAME_BUFFER_PRECISION mediump
#else
#define FRAME_BUFFER_PRECISION lowp
#endif`;var cr=`#ifdef out_Color
out_Color=vec4(0.0);
#endif
#ifdef out_Emission
out_Emission=vec4(0.0);
#endif
#ifdef out_ORM
out_ORM=vec4(0.0);
#endif
#ifdef out_Normal
out_Normal=vec2(0.0);
#endif`;var dr=`#ifdef FRAME_BUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif`;var pr="uint uhash(uint x){x+=x>>11;x ^=x<<7;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}uint uhash(uvec2 p){uint x=p.x;x+=x>>11;x ^=x<<7;x+=p.y;x ^=x<<6;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}uint uhash(uvec3 p){uint x=p.x;x+=x>>11;x ^=x<<7;x+=p.y;x ^=x<<3;x+=p.z ^(x>>14);x ^=x<<6;x+=x>>15;x ^=x<<5;x+=x>>12;x ^=x<<9;return x;}float urand(uint h){const uint mantissaMask=0x007FFFFFu;const uint one=0x3F800000u;h&=mantissaMask;h|=one;float r2=uintBitsToFloat(h);return r2-1.0;}float urand(float p){return urand(uhash(floatBitsToUint(p)));}float urand(vec2 p){return urand(uhash(floatBitsToUint(p)));}float urand(vec3 p){return urand(uhash(floatBitsToUint(p)));}";var hr="vec2 pp_encodeNormal(vec3 n){n/=(abs(n.x)+abs(n.y)+abs(n.z));n.xy=(n.z>=0.0)?n.xy:(1.0-abs(n.yx))*vec2(n.x>=0.0?1.0:-1.0,n.y>=0.0?1.0:-1.0);return n.xy;}vec3 pp_decodeNormal(vec2 f){vec3 n=vec3(f.x,f.y,1.0-abs(f.x)-abs(f.y));float t=clamp(-n.z,0.0,1.0);n.xy+=vec2(n.x>=0.0?-t:t,n.y>=0.0?-t:t);return normalize(n);}";var mr="vec3 readNormal(mediump sampler2D normalBuffer,const in vec2 uv){return pp_decodeNormal(texture(normalBuffer,uv).xy);}";var gr="uniform vec4 resolution;";var vr=`uniform mat4 viewMatrixInverse;
#define getWorldPosition(viewPosition) (viewMatrixInverse * vec4(viewPosition, 1.0)).xyz
#define getDistance(viewPosition) length(viewPosition)`;var Gt=`#ifdef out_Normal
out_Normal.xy=pp_encodeNormal(normal);
#endif`;var Ot=`#ifdef out_ORM
#ifdef USE_AOMAP
out_ORM.x=ambientOcclusion;
#else
out_ORM.x=1.0;
#endif
#endif`;var Ut=`#ifdef out_ORM
out_ORM.y=roughnessFactor;
#endif`;var br=`#ifdef out_ORM
out_ORM.y=material.roughness;
#endif`;var Nt=`#ifdef out_ORM
out_ORM.z=metalnessFactor;
#endif`;var kt=`#ifdef out_Emission
out_Emission=vec4(totalEmissiveRadiance,1.0);
#endif`;var Ee=class Ee{static register(){if(Ee.registered)return;Ee.registered=!0,Object.assign(y.ShaderChunk,{pp_camera_pars_fragment:nr,pp_colorspace_conversion_pars_fragment:ir,pp_default_output_pars_fragment:ar,pp_depth_buffer_pars_fragment:or,pp_depth_buffer_precision_pars_fragment:ur,pp_depth_utils_pars_fragment:lr,pp_frame_buffer_precision_pars_fragment:fr,pp_gbuffer_default_output_fragment:cr,pp_gbuffer_normal_fragment:Gt,pp_gbuffer_occlusion_fragment:Ot,pp_gbuffer_roughness_fragment:Ut,pp_gbuffer_metalness_fragment:Nt,pp_gbuffer_emission_fragment:kt,pp_input_buffer_pars_fragment:dr,pp_normal_codec_pars_fragment:hr,pp_noise_pars_fragment:pr,pp_normal_utils_pars_fragment:mr,pp_resolution_pars_fragment:gr,pp_world_utils_pars_fragment:vr}),y.ShaderChunk.normal_fragment_maps+=`
`+Gt,y.ShaderChunk.aomap_fragment+=`
`+Ot,y.ShaderChunk.roughnessmap_fragment+=`
`+Ut,y.ShaderChunk.lights_physical_fragment+=`
`+br,y.ShaderChunk.metalnessmap_fragment+=`
`+Nt,y.ShaderChunk.emissivemap_fragment+=`
`+kt;let r=[y.ShaderLib.background,y.ShaderLib.backgroundCube,y.ShaderLib.basic,y.ShaderLib.cube,y.ShaderLib.dashed,y.ShaderLib.lambert,y.ShaderLib.matcap,y.ShaderLib.phong,y.ShaderLib.physical,y.ShaderLib.points,y.ShaderLib.sprite,y.ShaderLib.standard,y.ShaderLib.toon];for(let e of r)e.fragmentShader=Pe(e.fragmentShader)}};i(Ee,"registered",!1);var je=Ee;var Rs=new re.Vector2,T=class T{constructor(r=null){i(this,"_timer");i(this,"_passes");i(this,"_renderer");i(this,"_autoRenderToScreen");i(this,"resolution");i(this,"updateStyle");je.register(),T.ioManager.addPipeline(this),this._timer=new re.Timer,this._passes=[],this._renderer=null,this._autoRenderToScreen=!0,this.resolution=new j,this.resolution.addEventListener("change",()=>this.onResolutionChange()),this.updateStyle=!0,this.renderer=r}get autoRenderToScreen(){return this._autoRenderToScreen}set autoRenderToScreen(r){this.autoRenderToScreen!==r&&(this._autoRenderToScreen=r,T.ioManager.update())}get renderer(){return this._renderer}set renderer(r){this._renderer=r;for(let e of this.passes)e.renderer=r;r!==null&&(r.autoClear=!1,this.setPixelRatio(r.getPixelRatio()),this.passes.length>0&&T.ioManager.update())}get timer(){return this._timer}get passes(){return this._passes}registerPass(r){T.registeredPasses.add(r),r.resolution.pixelRatio=this.resolution.scaledPixelRatio,r.resolution.copyBaseSize(this.resolution),r.renderer=this.renderer,r.timer=this.timer,r.attached=!0,r.addEventListener("toggle",T.listener),r.input.addEventListener("change",T.listener),r.output.addEventListener("change",T.listener)}unregisterPass(r){T.registeredPasses.delete(r),r.renderer=null,r.timer=null,r.attached=!1,r.removeEventListener("toggle",T.listener),r.input.removeEventListener("change",T.listener),r.output.removeEventListener("change",T.listener)}add(...r){for(let e of r){if(T.registeredPasses.has(e))throw new Error(`The pass "${e.name}" has already been added to a pipeline`);this.registerPass(e),this._passes.push(e)}T.ioManager.update()}remove(...r){let e=!1;for(let t of r){let s=this._passes,n=s.indexOf(t);n!==-1&&s.splice(n,1).length>0&&(this.unregisterPass(t),e=!0)}e&&T.ioManager.update()}removeAllPasses(){for(let r of this.passes)this.unregisterPass(r);this._passes=[],T.ioManager.update()}onResolutionChange(){let r=this.renderer;if(r===null){console.debug("Unable to update the render size because the renderer is null");return}let{baseWidth:e,baseHeight:t,pixelRatio:s,scaledPixelRatio:n,scale:a}=this.resolution,o=r.getSize(Rs);if(r.getPixelRatio()!==s&&r.setPixelRatio(s),a===1)(o.width!==e||o.height!==t)&&r.setSize(e,t,this.updateStyle);else{let l=e*a,c=t*a;(o.width!==l||o.height!==c)&&(this.updateStyle&&r.setSize(e,t,!0),r.setSize(l,c,!1))}for(let l of this.passes)l.resolution.pixelRatio=n,l.resolution.setBaseSize(e,t)}setPixelRatio(r){let e=this.updateStyle;this.updateStyle=!1,this.resolution.pixelRatio=r,this.updateStyle=e}setSize(r,e,t=!0){this.renderer!==null&&this.setPixelRatio(this.renderer.getPixelRatio());let s=this.updateStyle;this.updateStyle=t,this.resolution.setSize(r,e),this.updateStyle=s}setViewport(r,e=0,t=0,s=0){if(r instanceof re.Vector4){let n=r;r=n.x,e=n.y,t=n.z,s=n.w}for(let n of this.passes)n.viewport.set(r,e,t,s)}setScissor(r,e=0,t=0,s=0){if(r instanceof re.Vector4){let n=r;r=n.x,e=n.y,t=n.z,s=n.w}for(let n of this.passes)n.scissor.set(r,e,t,s)}compile(){return I(this,null,function*(){let r=[];for(let e of this.passes)r.push(e.compile());yield Promise.all(r)})}render(r){if(this.renderer===null)return;this._timer.update(r);let e=this.renderer,t=e.info.autoReset;t&&(e.info.reset(),e.info.autoReset=!1);for(let s of this.passes)s.enabled&&s.render();e.info.autoReset=t}dispose(){T.ioManager.removePipeline(this);for(let r of this.passes)r.dispose();this.removeAllPasses(),this._timer.dispose(),D.fullscreenGeometry.dispose()}};i(T,"ioManager",new We),i(T,"registeredPasses",new WeakSet),i(T,"listener",()=>T.ioManager.update());var $e=T;var Xe=class Xe{constructor(r,e,t=!1){i(this,"id");i(this,"name");i(this,"shader");i(this,"supportsHDR");this.id=Xe.idManager.getNextId(),this.name=r,this.shader=e,this.supportsHDR=t}};i(Xe,"idManager",new k);var d=Xe;var Ke=v("three");var qe=class extends Ke.EventDispatcher{constructor(e,t=1){super();i(this,"_blendFunction");i(this,"opacityUniform");this._blendFunction=e,this.opacityUniform=new Ke.Uniform(t)}get opacity(){return this.opacityUniform.value}set opacity(e){this.opacityUniform.value=e}get blendFunction(){return this._blendFunction}set blendFunction(e){this._blendFunction=e,this.dispatchEvent({type:"change"})}};var xr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Ze=class extends d{constructor(){super("add",xr,!0)}};var Er="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,src.a*opacity);}";var Qe=class extends d{constructor(){super("alpha",Er,!0)}};var Sr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=(dst.rgb+src.rgb)*0.5;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Ye=class extends d{constructor(){super("average",Sr,!0)}};var Br="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.xy,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Je=class extends d{constructor(){super("color",Br)}};var yr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=mix(step(0.0,b)*(1.0-min(vec3(1.0),(1.0-a)/max(b,1e-9))),vec3(1.0),step(1.0,a));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var et=class extends d{constructor(){super("color-burn",yr)}};var Tr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=step(0.0,a)*mix(min(vec3(1.0),a/max(1.0-b,1e-9)),vec3(1.0),step(1.0,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var tt=class extends d{constructor(){super("color-dodge",Tr)}};var Mr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var rt=class extends d{constructor(){super("darken",Mr,!0)}};var Rr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=abs(dst.rgb-src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var st=class extends d{constructor(){super("difference",Rr,!0)}};var _r="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb/max(src.rgb,1e-9);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var nt=class extends d{constructor(){super("divide",_r,!0)}};var it=class extends d{constructor(){super("dst",null,!0)}};var Cr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-2.0*dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var at=class extends d{constructor(){super("exclusion",Cr)}};var wr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb,1.0);vec3 b=min(src.rgb,1.0);vec3 c=mix(2.0*a*b,1.0-2.0*(1.0-a)*(1.0-b),step(0.5,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ot=class extends d{constructor(){super("hard-light",wr)}};var Dr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=step(1.0,dst.rgb+src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ut=class extends d{constructor(){super("hard-mix",Dr)}};var Fr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.x,a.yz));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var lt=class extends d{constructor(){super("hue",Fr)}};var Ar="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ft=class extends d{constructor(){super("invert",Ar)}};var Pr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=src.rgb*max(1.0-dst.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ct=class extends d{constructor(){super("invert-rgb",Pr)}};var Lr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var dt=class extends d{constructor(){super("lighten",Lr,!0)}};var Ir="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var pt=class extends d{constructor(){super("linear-burn",Ir)}};var Gr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb+src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var ht=class extends d{constructor(){super("linear-dodge",Gr)}};var Or="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(2.0*src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var mt=class extends d{constructor(){super("linear-light",Or)}};var Ur="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.xy,b.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var gt=class extends d{constructor(){super("luminosity",Ur)}};var Nr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,opacity);}";var de=class extends d{constructor(){super("mix",Nr,!0)}};var kr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var vt=class extends d{constructor(){super("multiply",kr,!0)}};var Vr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-abs(1.0-dst.rgb-src.rgb),0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var bt=class extends d{constructor(){super("negation",Vr)}};var zr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=2.0*src.rgb*dst.rgb;vec3 b=1.0-2.0*(1.0-src.rgb)*(1.0-dst.rgb);vec3 c=mix(a,b,step(0.5,dst.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var xt=class extends d{constructor(){super("overlay",zr)}};var Hr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 c=mix(mix(src2,dst.rgb,step(0.5*dst.rgb,src.rgb)),max(src2-1.0,vec3(0.0)),step(dst.rgb,src2-1.0));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Et=class extends d{constructor(){super("pin-light",Hr)}};var Wr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb*dst.rgb/max(1.0-src.rgb,1e-9),1.0);vec3 c=mix(a,src.rgb,step(1.0,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var St=class extends d{constructor(){super("reflect",Wr)}};var jr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.x,b.y,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Bt=class extends d{constructor(){super("saturation",jr)}};var $r="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return src;}";var pe=class extends d{constructor(){super("src",$r,!0)}};var Xr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-min(dst.rgb*src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var yt=class extends d{constructor(){super("screen",Xr)}};var qr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 d=dst.rgb+(src2-1.0);vec3 w=step(0.5,src.rgb);vec3 a=dst.rgb-(1.0-src2)*dst.rgb*(1.0-dst.rgb);vec3 b=mix(d*(sqrt(dst.rgb)-dst.rgb),d*dst.rgb*((16.0*dst.rgb-12.0)*dst.rgb+3.0),w*(1.0-step(0.25,dst.rgb)));vec3 c=mix(a,b,w);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Tt=class extends d{constructor(){super("soft-light",qr)}};var Kr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Mt=class extends d{constructor(){super("subtract",Kr)}};var Zr="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=mix(max(1.0-min((1.0-dst.rgb)/(2.0*src.rgb),1.0),0.0),min(dst.rgb/(2.0*(1.0-src.rgb)),1.0),step(0.5,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}";var Rt=class extends d{constructor(){super("vivid-light",Zr)}};var Vt=v("three");var _t=class extends D{constructor(e){super(e);i(this,"blendMode");i(this,"_fragmentShader");i(this,"_vertexShader");i(this,"_inputColorSpace");i(this,"_outputColorSpace");i(this,"gData");i(this,"optional");this.blendMode=new qe(new pe),this.blendMode.addEventListener("change",()=>this.setChanged()),this.input.addEventListener("change",()=>this.detectGDataUsage()),this._fragmentShader=null,this._vertexShader=null,this._inputColorSpace=Vt.NoColorSpace,this._outputColorSpace=Vt.NoColorSpace,this.gData=new Set,this.optional=!1}get enabled(){return super.enabled}set enabled(e){super.enabled!==e&&(this.optional=!0),super.enabled=e}get fragmentShader(){return this._fragmentShader}set fragmentShader(e){this._fragmentShader=e,this.detectGDataUsage(),this.setChanged()}get vertexShader(){return this._vertexShader}set vertexShader(e){this._vertexShader=e,this.setChanged()}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(e){this._inputColorSpace=e,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e,this.setChanged()}get hasMainImageFunction(){return this.fragmentShader===null?!1:/vec4\s+mainImage\s*\([a-z\s]*vec4\s+\w+,[a-z\s]*vec2\s+\w+,[a-z\s]*GData\s+\w+\)/.test(this.fragmentShader)}get hasMainUvFunction(){return this.fragmentShader===null?!1:/void\s+mainUv\s*\(\s*inout\s+vec2\s+\w+\)/.test(this.fragmentShader)}get hasMainSupportFunction(){return this.vertexShader===null?!1:/void\s+mainSupport\s*\([a-z\s]*vec2\s+\w+\)/.test(this.vertexShader)}detectGDataUsage(){var n,a;if(this.gData.clear(),this.input.gBufferConfig===null||!this.hasMainImageFunction)return;let e=this.fragmentShader,t=this.input.gBufferConfig,s=/GData\s+(\w+)/.exec(e)[1];for(let o of Object.values(It))if(e.includes(`${s}.${o}`)){for(let l of(n=t.gDataDependencies.get(o))!=null?n:[])this.gData.add(l);this.gData.add(o)}for(let o of this.gData)for(let l of(a=t.gDataBufferSources.get(o))!=null?a:[])this.input.gBuffer.has(l)||(this.input.gBuffer.add(l),console.warn(`${this.name} uses ${o} but does not declare input G-Buffer component ${l}`))}validate(){if(this.fragmentShader===null)throw new Error(`Missing fragment shader (${this.name})`);if(!this.hasMainImageFunction&&!this.hasMainUvFunction)throw new Error(`Could not find a valid mainImage or mainUv function (${this.name})`)}render(){}};var R=v("three");var Qr=`uniform vec3 scale;uniform vec3 offset;
#ifdef CUSTOM_INPUT_DOMAIN
uniform vec3 domainMin;uniform vec3 domainMax;
#endif
#ifdef LUT_PRECISION_HIGH
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler3D lut;
#else
uniform mediump sampler3D lut;
#endif
#else
uniform lowp sampler3D lut;
#endif
vec4 applyLUT(in vec3 rgb){rgb=scale*rgb+offset;
#ifdef TETRAHEDRAL_INTERPOLATION
vec3 p=floor(rgb);vec3 f=rgb-p;vec3 v1=(p+0.5)*LUT_TEXEL_WIDTH;vec3 v4=(p+1.5)*LUT_TEXEL_WIDTH;vec3 v2,v3;vec3 frac;if(f.r>=f.g){if(f.g>f.b){frac=f.rgb;v2=vec3(v4.x,v1.y,v1.z);v3=vec3(v4.x,v4.y,v1.z);}else if(f.r>=f.b){frac=f.rbg;v2=vec3(v4.x,v1.y,v1.z);v3=vec3(v4.x,v1.y,v4.z);}else{frac=f.brg;v2=vec3(v1.x,v1.y,v4.z);v3=vec3(v4.x,v1.y,v4.z);}}else{if(f.b>f.g){frac=f.bgr;v2=vec3(v1.x,v1.y,v4.z);v3=vec3(v1.x,v4.y,v4.z);}else if(f.r>=f.b){frac=f.grb;v2=vec3(v1.x,v4.y,v1.z);v3=vec3(v4.x,v4.y,v1.z);}else{frac=f.gbr;v2=vec3(v1.x,v4.y,v1.z);v3=vec3(v1.x,v4.y,v4.z);}}vec4 n1=texture(lut,v1);vec4 n2=texture(lut,v2);vec4 n3=texture(lut,v3);vec4 n4=texture(lut,v4);vec4 weights=vec4(1.0-frac.x,frac.x-frac.y,frac.y-frac.z,frac.z);vec4 result=weights*mat4(vec4(n1.r,n2.r,n3.r,n4.r),vec4(n1.g,n2.g,n3.g,n4.g),vec4(n1.b,n2.b,n3.b,n4.b),vec4(1.0));return vec4(result.rgb,1.0);
#else
return texture(lut,rgb);
#endif
}vec4 mainImage(const in vec4 inputColor,const in vec2 uv,const in GData gData){vec3 c=inputColor.rgb;
#ifdef CUSTOM_INPUT_DOMAIN
if(c.r>=domainMin.r&&c.g>=domainMin.g&&c.b>=domainMin.b&&c.r<=domainMax.r&&c.g<=domainMax.g&&c.b<=domainMax.b){c=applyLUT(c).rgb;}else{c=inputColor.rgb;}
#else
#ifdef TETRAHEDRAL_INTERPOLATION
c=clamp(c,0.0,1.0);
#endif
c=applyLUT(c).rgb;
#endif
return vec4(c,inputColor.a);}`;var Ct=class extends _t{constructor({lut:r=null,tetrahedralInterpolation:e=!1,inputColorSpace:t=R.SRGBColorSpace}={}){super("LUT3DEffect"),this.fragmentShader=Qr;let s=this.input.uniforms;s.set("lut",new R.Uniform(null)),s.set("scale",new R.Uniform(new R.Vector3)),s.set("offset",new R.Uniform(new R.Vector3)),s.set("domainMin",new R.Uniform(null)),s.set("domainMax",new R.Uniform(null));let n=this.input.defines;n.set("LUT_SIZE","0"),n.set("LUT_TEXEL_WIDTH","0"),n.set("LUT_TEXEL_HEIGHT","0"),this.tetrahedralInterpolation=e,this.inputColorSpace=t,this.lut=r}get lutPrecisionHigh(){return this.input.defines.has("LUT_PRECISION_HIGH")}set lutPrecisionHigh(r){this.lutPrecisionHigh!==r&&(r?this.input.defines.set("LUT_PRECISION_HIGH",!0):this.input.defines.delete("LUT_PRECISION_HIGH"),this.setChanged())}get lut(){return this.input.uniforms.get("lut").value}set lut(r){let{defines:e,uniforms:t}=this.input;if(t.get("lut").value=r,r===null)return;let s=r.image;e.set("LUT_SIZE",Math.min(s.width,s.height).toFixed(16)),e.set("LUT_TEXEL_WIDTH",(1/s.width).toFixed(16)),e.set("LUT_TEXEL_HEIGHT",(1/s.height).toFixed(16)),this.lutPrecisionHigh=r.type===R.FloatType||r.type===R.HalfFloatType;let n=r.userData,a=n.domainMin,o=n.domainMax;t.get("domainMin").value=a.clone(),t.get("domainMax").value=o.clone(),a.x!==0||a.y!==0||a.z!==0||o.x!==1||o.y!==1||o.z!==1?e.set("CUSTOM_INPUT_DOMAIN",!0):e.delete("CUSTOM_INPUT_DOMAIN"),this.configureTetrahedralInterpolation(),this.updateScaleOffset(),this.setChanged()}updateScaleOffset(){let r=this.lut;if(r===null)return;let e=Math.min(r.image.width,r.image.height),t=this.input.uniforms.get("scale").value,s=this.input.uniforms.get("offset").value,n=r.userData;if(this.tetrahedralInterpolation)if(this.input.defines.has("CUSTOM_INPUT_DOMAIN")){let a=n.domainMax.clone().sub(n.domainMin);t.setScalar(e-1).divide(a),s.copy(n.domainMin).negate().multiply(t)}else t.setScalar(e-1),s.setScalar(0);else if(this.input.defines.has("CUSTOM_INPUT_DOMAIN")){let a=n.domainMax.clone().sub(n.domainMin).multiplyScalar(e);t.setScalar(e-1).divide(a),s.copy(n.domainMin).negate().multiply(t).addScalar(1/(2*e))}else t.setScalar((e-1)/e),s.setScalar(1/(2*e))}configureTetrahedralInterpolation(){let r=this.lut;r!==null&&(r.minFilter=R.LinearFilter,r.magFilter=R.LinearFilter,this.tetrahedralInterpolation&&(r.minFilter=R.NearestFilter,r.magFilter=R.NearestFilter),r.needsUpdate=!0)}get tetrahedralInterpolation(){return this.input.defines.has("TETRAHEDRAL_INTERPOLATION")}set tetrahedralInterpolation(r){r?this.input.defines.set("TETRAHEDRAL_INTERPOLATION",!0):this.input.defines.delete("TETRAHEDRAL_INTERPOLATION"),this.configureTetrahedralInterpolation(),this.updateScaleOffset(),this.setChanged()}};var zt=v("three");var Yr=`#include <common>
#include <dithering_pars_fragment>
#include <packing>
#include <pp_camera_pars_fragment>
#include <pp_colorspace_conversion_pars_fragment>
#include <pp_default_output_pars_fragment>
#include <pp_depth_buffer_precision_pars_fragment>
#include <pp_depth_utils_pars_fragment>
#include <pp_frame_buffer_precision_pars_fragment>
#include <pp_noise_pars_fragment>
#include <pp_normal_codec_pars_fragment>
#include <pp_normal_utils_pars_fragment>
#include <pp_resolution_pars_fragment>
#define packFloatToRGBA(v) packDepthToRGBA(v)
#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)
$FRAGMENT_HEAD_GDATA$FRAGMENT_HEAD_GBUFFER uniform GBuffer gBuffer;uniform float time;in vec2 vUv;$FRAGMENT_HEAD_EFFECTS void main(){$FRAGMENT_MAIN_UV$FRAGMENT_MAIN_GDATA vec4 color0=gData.color;vec4 color1=vec4(0.0);$FRAGMENT_MAIN_IMAGE color0.a=clamp(color0.a,0.0,1.0);out_Color=color0;
#ifdef COLOR_SPACE_CONVERSION
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
}`;var Jr=`#include <pp_resolution_pars_fragment>
uniform vec3 cameraParams;uniform float time;out vec2 vUv;$VERTEX_HEAD void main(){vUv=position.xy*0.5+0.5;$VERTEX_MAIN_SUPPORT gl_Position=vec4(position.xy,1.0,1.0);}`;var Se=class extends G{constructor(){super({name:"EffectMaterial",defines:{COLOR_SPACE_CONVERSION:!0},uniforms:{gBuffer:new zt.Uniform(null),time:new zt.Uniform(0)}});i(this,"shaderDataTracker");this.shaderDataTracker=new ue,this.fragmentShader=`#include <pp_default_output_pars_fragment>

`+this.fragmentShader}get gBuffer(){return this.uniforms.gBuffer.value}set gBuffer(e){this.uniforms.gBuffer.value=e}get colorSpaceConversion(){return this.defines.COLOR_SPACE_CONVERSION!==void 0}set colorSpaceConversion(e){this.colorSpaceConversion!==e&&(e?this.defines.COLOR_SPACE_CONVERSION=!0:delete this.defines.COLOR_SPACE_CONVERSION,this.needsUpdate=!0)}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}setShaderParts(e){return this.fragmentShader=Yr.replace("$FRAGMENT_MAIN_IMAGE",e.get("$FRAGMENT_MAIN_IMAGE")).replace("$FRAGMENT_MAIN_GDATA",e.get("$FRAGMENT_MAIN_GDATA")).replace("$FRAGMENT_MAIN_UV",e.get("$FRAGMENT_MAIN_UV")).replace("$FRAGMENT_HEAD_EFFECTS",e.get("$FRAGMENT_HEAD_EFFECTS")).replace("$FRAGMENT_HEAD_GBUFFER",e.get("$FRAGMENT_HEAD_GBUFFER")).replace("$FRAGMENT_HEAD_GDATA",e.get("$FRAGMENT_HEAD_GDATA")),this.vertexShader=Jr.replace("$VERTEX_MAIN_SUPPORT",e.get("$VERTEX_MAIN_SUPPORT")).replace("$VERTEX_HEAD",e.get("$VERTEX_HEAD")),this.needsUpdate=!0,this}setDefines(e){return this.shaderDataTracker.applyDefines(this,e).trackDefines(e),this}setUniforms(e){return this.shaderDataTracker.applyUniforms(this,e).trackUniforms(e),this}dispose(){super.dispose(),this.shaderDataTracker.dispose()}};var is=v("three");var $=v("three");function Ht(u,r,e){for(let t of r){let s="$1"+u+t.charAt(0).toUpperCase()+t.slice(1),n=new RegExp("([^\\.])(\\b"+t+"\\b)","g");for(let a of e.entries())typeof a[1]=="string"&&e.set(a[0],a[1].replace(n,s))}}function es(u,r,e,t){var s;e.add(u);for(let n of(s=r.get(u))!=null?s:[])e.has(n)||es(n,r,e,t);t.push(u)}function ts(u,r=!1){let e=[],t=new Set;for(let s of u.keys())t.has(s)||es(s,u,t,e);return r?e:e.reverse()}var rs=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,ss=/struct\s+(\w*)/g,ns=/^\s*#define\s+(\w*)/gm,Be=class{constructor(){i(this,"defines");i(this,"uniforms");i(this,"shaderParts");i(this,"blendModes");i(this,"gData");i(this,"convolutionEffects");i(this,"uvTransformationEffects");i(this,"_colorSpace");this.shaderParts=new Map([["$FRAGMENT_HEAD_EFFECTS",""],["$FRAGMENT_HEAD_GBUFFER",""],["$FRAGMENT_HEAD_GDATA",""],["$FRAGMENT_MAIN_UV",""],["$FRAGMENT_MAIN_GDATA",""],["$FRAGMENT_MAIN_IMAGE",""],["$VERTEX_HEAD",""],["$VERTEX_MAIN_SUPPORT",""]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.gData=new Set(["color"]),this.convolutionEffects=new Set,this.uvTransformationEffects=new Set,this._colorSpace=$.LinearSRGBColorSpace}get uvTransformation(){return this.uvTransformationEffects.size>0}get colorSpace(){return this._colorSpace}set colorSpace(r){this._colorSpace=r}gatherVertexShaderTokens(r,e){for(let t of r.matchAll(/(?:out\s+\w+\s+(\w*?);)/g))for(let s of t[1].split(/\s*,\s*/))e.add(s);for(let t of r.matchAll(rs))e.add(t[1]);for(let t of r.matchAll(ss))e.add(t[1]);for(let t of r.matchAll(ns))e.add(t[1])}gatherFragmentShaderTokens(r,e){for(let t of r.matchAll(rs))e.add(t[1]);for(let t of r.matchAll(ss))e.add(t[1]);for(let t of r.matchAll(ns))e.add(t[1])}updateWorkingColorSpace(r){r.outputColorSpace!==$.NoColorSpace?this.colorSpace=r.outputColorSpace:r.inputColorSpace!==$.NoColorSpace&&(this.colorSpace=r.inputColorSpace)}integrateEffect(r,e){e.validate(),e.isConvolutionPass(!1)&&this.convolutionEffects.add(e);let t=e.fragmentShader,s=e.vertexShader,n=this.shaderParts,a=n.get("$FRAGMENT_HEAD_EFFECTS"),o=n.get("$FRAGMENT_MAIN_UV"),l=n.get("$FRAGMENT_MAIN_IMAGE"),c=n.get("$VERTEX_HEAD"),f=n.get("$VERTEX_MAIN_SUPPORT"),p=new Set;if(s!==null&&e.hasMainSupportFunction){this.gatherVertexShaderTokens(s,p);let m=/mainSupport\s*\([\w\s]*?uv\s*?\)/.test(s);f+=`	${r}MainSupport(`,f+=m?`vUv);
`:`);
`}e.hasMainUvFunction&&(o+=`	${r}MainUv(UV);
`,this.uvTransformationEffects.add(e));for(let m of e.gData)this.gData.add(m);if(e.hasMainImageFunction){this.gatherFragmentShaderTokens(t,p),e.inputColorSpace!==$.NoColorSpace&&e.inputColorSpace!==this.colorSpace&&(l+=e.inputColorSpace===$.SRGBColorSpace?`color0 = sRGBTransferOETF(color0);
	`:`color0 = sRGBTransferEOTF(color0);
	`),l+=`color1 = ${r}MainImage(color0, UV, gData);
	`;let m=e.blendMode;this.blendModes.set(m.blendFunction.id,m);let g=r+"BlendOpacity";this.uniforms.set(g,m.opacityUniform),l+=`color0 = blend${m.blendFunction.id}(color0, color1, ${g});

	`,a+=`uniform float ${g};

`,this.updateWorkingColorSpace(e)}for(let m of e.input.defines.keys())p.add(m.replace(/\([\w\s,]*\)/g,""));for(let m of e.input.uniforms.keys())p.add(m);p.delete("while"),p.delete("for"),p.delete("if"),e.input.uniforms.forEach((m,g)=>this.uniforms.set(r+g.charAt(0).toUpperCase()+g.slice(1),m)),e.input.defines.forEach((m,g)=>this.defines.set(r+g.charAt(0).toUpperCase()+g.slice(1),m));let x=new Map([["fragment",t],["vertex",s]]);Ht(r,p,this.defines),Ht(r,p,x),t=x.get("fragment"),s=x.get("vertex"),a+=t+`
`,s!==null&&(c+=s+`
`),n.set("$FRAGMENT_HEAD_EFFECTS",a),n.set("$FRAGMENT_MAIN_UV",o),n.set("$FRAGMENT_MAIN_IMAGE",l),n.set("$VERTEX_HEAD",c),n.set("$VERTEX_MAIN_SUPPORT",f),this.validate()}add(r){r.convolutionEffects.forEach(l=>this.convolutionEffects.add(l)),r.uvTransformationEffects.forEach(l=>this.uvTransformationEffects.add(l)),r.uniforms.forEach((l,c)=>this.uniforms.set(c,l)),r.defines.forEach((l,c)=>this.defines.set(c,l)),r.blendModes.forEach((l,c)=>this.blendModes.set(c,l)),r.gData.forEach(l=>this.gData.add(l));let e=this.shaderParts,t=e.get("$FRAGMENT_HEAD_EFFECTS"),s=e.get("$FRAGMENT_MAIN_UV"),n=e.get("$FRAGMENT_MAIN_IMAGE"),a=e.get("$VERTEX_HEAD"),o=e.get("$VERTEX_MAIN_SUPPORT");t+=r.shaderParts.get("$FRAGMENT_HEAD_EFFECTS"),s+=r.shaderParts.get("$FRAGMENT_MAIN_UV"),n+=r.shaderParts.get("$FRAGMENT_MAIN_IMAGE"),a+=r.shaderParts.get("$VERTEX_HEAD"),o+=r.shaderParts.get("$VERTEX_MAIN_SUPPORT"),e.set("$FRAGMENT_HEAD_EFFECTS",t),e.set("$FRAGMENT_MAIN_UV",s),e.set("$FRAGMENT_MAIN_IMAGE",n),e.set("$VERTEX_HEAD",a),e.set("$VERTEX_MAIN_SUPPORT",o),this.colorSpace!==r.colorSpace&&r.colorSpace!==$.NoColorSpace&&(this.colorSpace=r.colorSpace),this.validate()}validate(){if(this.convolutionEffects.size>1){let r=[...this.convolutionEffects].map(e=>e.name).join(", ");throw new Error(`Convolution effects cannot be merged (${r})`)}else if(this.convolutionEffects.size>0&&this.uvTransformation){let r=[...this.convolutionEffects,...this.uvTransformationEffects].map(e=>e.name).join(", ");throw new Error(`Effects that transform UVs are incompatible with convolution effects (${r})`)}}createGDataStructDeclaration(r){return["struct GData {",...Array.from(r.gDataStructDeclaration).filter(e=>this.gData.has(e[0])).map(e=>`	${e[1]}`),`};
`].join(`
`)}createGDataStructInitialization(r){let e=r.gDataDependencies,t=r.gDataStructInitialization,s=new Map(Array.from(this.gData).filter(n=>t.has(n)).map(n=>{var a;return[n,(a=e.get(n))!=null?a:[]]}));return["	GData gData;",...ts(s,!0).map(n=>`	${t.get(n)}`)].join(`
`)}createBlendFunctions(){let r=/\bblend\b/g,e=[];for(let t of this.blendModes.values()){let s=t.blendFunction.shader,n=`blend${t.blendFunction.id}`;e.push(s.replace(r,n))}return e.join(`
`)}};var U=class U{constructor(r){i(this,"shaderData");i(this,"defaultMaterial");i(this,"materialCache");i(this,"effectShaderDataCache");i(this,"activeMaterial");i(this,"_gBufferConfig");i(this,"_gBuffer");i(this,"_dithering");this.shaderData=r,this.defaultMaterial=new Se,this.materialCache=new Map,this.effectShaderDataCache=new Map,this.activeMaterial=null,this._gBufferConfig=null,this._gBuffer=null,this._dithering=!1}get materials(){return this.materialCache.values()}get gBufferConfig(){return this._gBufferConfig}set gBufferConfig(r){this._gBufferConfig!==r&&(this.dispose(),this._gBufferConfig=r)}get gBuffer(){return this._gBuffer}set gBuffer(r){this._gBuffer!==r&&(this.invalidateMaterialCache(),this._gBuffer=r)}get dithering(){return this._dithering}set dithering(r){if(this._dithering!==r){this._dithering=r;for(let e of this.materialCache.values())if(r&&e.outputPrecision!=="lowp"){console.info("Dithering only works on 8-bit colors");break}else e.dithering=r,e.needsUpdate=!0}}getEffectShaderData(r){let e=new Be,t=this.effectShaderDataCache;for(let s of r){if(!t.has(s)){let n=new Be;n.integrateEffect(`e${s.id}`,s),t.set(s,n)}s.blendMode.blendFunction.shader!==null&&e.add(t.get(s))}return e}createGBufferStructDeclaration(r){if(this.gBuffer===null)throw new Error("Missing G-Buffer information");return["struct GBuffer {",...Array.from(r.gBufferStructDeclaration).filter(e=>this.gBuffer.has(e[0])).map(e=>`	${e[1]}`),`};
`].join(`
`)}createMaterial(r){let t=U.getMaterialId(r)===U.DEFAULT_MATERIAL_ID?this.defaultMaterial:new Se,s=this.getEffectShaderData(r),n=this.gBufferConfig;n!==null&&(s.shaderParts.set("$FRAGMENT_HEAD_GBUFFER",this.createGBufferStructDeclaration(n)),s.shaderParts.set("$FRAGMENT_HEAD_GDATA",s.createGDataStructDeclaration(n)),s.shaderParts.set("$FRAGMENT_MAIN_GDATA",s.createGDataStructInitialization(n)));let a=s.shaderParts.get("$FRAGMENT_HEAD_EFFECTS");if(s.shaderParts.set("$FRAGMENT_HEAD_EFFECTS",a+s.createBlendFunctions()),s.colorSpace===is.SRGBColorSpace){let o=s.shaderParts.get("$FRAGMENT_MAIN_IMAGE");s.shaderParts.set("$FRAGMENT_MAIN_IMAGE",o+`color0 = sRGBTransferEOTF(color0);
	`)}if(s.uvTransformation){let o=s.shaderParts.get("$FRAGMENT_MAIN_UV");s.shaderParts.set("$FRAGMENT_MAIN_UV",`vec2 transformedUv = vUv;
`+o),s.defines.set("UV","transformedUv")}else s.defines.set("UV","vUv");s.shaderParts.forEach((o,l,c)=>c.set(l,o.trim().replace(/^#/,`
#`)));for(let o of this.shaderData.defines)s.defines.set(o[0],o[1]);for(let o of this.shaderData.uniforms)s.uniforms.set(o[0],o[1]);if(t!==this.defaultMaterial){for(let o of Object.entries(this.defaultMaterial.uniforms))t.uniforms[o[0]]=o[1];for(let o of Object.entries(this.defaultMaterial.defines))t.defines[o[0]]=o[1]}return t.setShaderParts(s.shaderParts).setDefines(s.defines).setUniforms(s.uniforms)}createMaterials(r){let e=r.filter(s=>s.optional),t=e.length>U.MAX_OPTIONAL_EFFECTS;if(e.length===0||t){let s=r.filter(a=>a.enabled),n=U.getMaterialId(s);this.materialCache.set(n,this.createMaterial(s));return}for(let s of this.getEffectCombinations(r)){let n=U.getMaterialId(s);this.materialCache.has(n)||this.materialCache.set(n,this.createMaterial(s))}}synchronizeMaterials(){if(this.activeMaterial===null)return;let r=this.activeMaterial,e=this.defaultMaterial;for(let t of Object.entries(e.defines))t[1]!==r.defines[t[0]]&&(e.defines[t[0]]=r.defines[t[0]],e.needsUpdate=!0);if(e.needsUpdate){for(let t of this.materialCache.values())if(t!==e){for(let s of Object.entries(e.defines))t.defines[s[0]]=s[1];t.needsUpdate=!0}}}getMaterial(r){if(this.gBufferConfig===null)return this.defaultMaterial;this.synchronizeMaterials();let e=r.filter(s=>s.enabled),t=U.getMaterialId(e);return this.materialCache.has(t)||this.createMaterials(r),this.activeMaterial=this.materialCache.get(t),this.activeMaterial}*getEffectCombinations(r){let e=r.filter(n=>n.optional),t=e.length,s=1<<t;for(let n=0;n<s;++n){let a=[];for(let o=0;o<t;++o)n&1<<o&&a.push(e[o]);yield r.filter(o=>!o.optional||a.includes(o))}}invalidateMaterialCache(){for(let r of this.materialCache.values())r.dispose();this.materialCache.clear()}invalidateShaderData(r){this.effectShaderDataCache.delete(r)}dispose(){this.invalidateMaterialCache(),this.effectShaderDataCache.clear()}static getMaterialId(r){return r.length===0?U.DEFAULT_MATERIAL_ID:r.map(e=>e.id).join("-")}};i(U,"MAX_OPTIONAL_EFFECTS",6),i(U,"DEFAULT_MATERIAL_ID","default");var wt=U;var Dt=class u extends D{constructor(...e){super("EffectPass");i(this,"effectMaterialManager");i(this,"effectListener");i(this,"gBufferConfigListener");i(this,"previousGBufferConfig");i(this,"disposed");i(this,"timeScale");this.output.defaultBuffer=this.createFramebuffer(),this.effectMaterialManager=new wt(this.input),this.effectMaterialManager.gBuffer=this.input.gBuffer,this.effectListener=t=>this.handleEffectEvent(t),this.gBufferConfigListener=t=>this.handleGBufferConfigEvent(t),this.previousGBufferConfig=null,this.effects=e,this.disposed=!1,this.timeScale=1}get subpasses(){return super.subpasses}set subpasses(e){for(let t of super.subpasses)t.removeEventListener("change",this.effectListener),t.removeEventListener("toggle",this.effectListener);super.subpasses=e,this.input.gBuffer.clear(),this.input.gBuffer.add("Color");for(let t of super.subpasses)this.copyGBufferComponents(t),t.addEventListener("change",this.effectListener),t.addEventListener("toggle",this.effectListener);this.updateMaterial(!0),this.disposed=!1}get effects(){return this.subpasses}set effects(e){let t=new Set(e);if(t.size<e.length){let s=e.filter(n=>!t.has(n)).map(n=>n.name);throw new Error(`Encountered duplicate effects: ${s.join(", ")}`)}this.subpasses=e}get dithering(){return this.effectMaterialManager.dithering}set dithering(e){this.effectMaterialManager.dithering=e}copyGBufferComponents(e){for(let t of e.input.gBuffer)this.input.gBuffer.add(t)}updateMaterial(e){e&&(this.effectMaterialManager.invalidateMaterialCache(),this.materials.clear()),this.fullscreenMaterial=this.effectMaterialManager.getMaterial(this.effects);for(let t of this.effectMaterialManager.materials)this.materials.add(t)}updateGBufferStruct(){var n,a;let e=this.input,t=e.gBufferConfig;if(t===null)return;let s=[];for(let o of e.gBuffer){let c=o==="Color"?(n=e.defaultBuffer)==null?void 0:n.value:(a=e.buffers.get(o))==null?void 0:a.value;s.push([t.gBufferStructFields.get(o),c!=null?c:null])}this.fullscreenMaterial.gBuffer=Object.fromEntries(s)}handleEffectEvent(e){switch(e.type){case"change":this.copyGBufferComponents(e.target),this.effectMaterialManager.invalidateShaderData(e.target),this.updateMaterial(!0);break;case"toggle":this.updateMaterial(!1);break}}handleGBufferConfigEvent(e){e.type==="change"&&this.updateMaterial(!0)}onGBufferConfigChange(){let e=this.input.gBufferConfig;this.previousGBufferConfig!==null&&this.previousGBufferConfig.removeEventListener("change",this.gBufferConfigListener),this.input.gBufferConfig!==null&&this.input.gBufferConfig.addEventListener("change",this.gBufferConfigListener),this.effectMaterialManager.gBufferConfig=e,this.previousGBufferConfig=e;for(let t of this.effects)t.input.gBufferConfig=e;this.updateMaterial(!0)}onInputChange(){this.updateGBufferStruct();for(let e of this.effects){e.removeEventListener("change",this.effectListener),e.input.buffers.clear();for(let t of this.input.buffers)e.input.buffers.set(t[0],t[1]);e.addEventListener("change",this.effectListener)}this.previousGBufferConfig!==this.input.gBufferConfig?this.onGBufferConfigChange():this.updateMaterial(!0)}checkRequirements(){for(let e of this.effects)e.checkRequirements()}compile(){return I(this,null,function*(){return this.updateMaterial(!1),ne(u.prototype,this,"compile").call(this)})}dispose(){for(let e of this.effects)e.removeEventListener("change",this.effectListener),e.removeEventListener("toggle",this.effectListener);this.input.gBufferConfig!==null&&this.input.gBufferConfig.removeEventListener("change",this.gBufferConfigListener),this.effectMaterialManager.dispose(),super.dispose(),this.disposed=!0}render(){var e;if(!(this.renderer===null||this.timer===null)){this.disposed&&(this.effects=[...this.effects]);for(let t of this.effects)t.enabled&&t.render();this.fullscreenMaterial.time+=this.timer.getDelta()*this.timeScale,this.setRenderTarget((e=this.output.defaultBuffer)==null?void 0:e.value),this.renderFullscreen()}}};var b=v("three");function as(u,r,e){let t=document.createElement("canvas"),s=t.getContext("2d");if(t.width=u,t.height=r,s===null)return t;if(e instanceof Image)s.drawImage(e,0,0);else{let n=s.createImageData(u,r);n.data.set(e),s.putImageData(n,0,0)}return t}var he=class u{constructor(r=0,e=0,t){i(this,"colorSpace");i(this,"width");i(this,"height");i(this,"data");this.colorSpace="srgb",this.width=r,this.height=e,this.data=t}toCanvas(){if(typeof document=="undefined")throw new Error("Failed to create canvas");return as(this.width,this.height,this.data)}static from(r){let{width:e,height:t}=r,s;if(r instanceof Image){let n=as(e,t,r),a=n.getContext("2d");if(n===null||a===null)throw new Error("Failed to create canvas");s=a.getImageData(0,0,e,t).data}else s=r.data;return new u(e,t,s)}};var os=`"use strict";(()=>{var B=Math.pow;var C=[new Float32Array(3),new Float32Array(3)],t=[new Float32Array(3),new Float32Array(3),new Float32Array(3),new Float32Array(3)],V=[[new Float32Array([0,0,0]),new Float32Array([1,0,0]),new Float32Array([1,1,0]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([1,0,0]),new Float32Array([1,0,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,0,1]),new Float32Array([1,0,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,1,0]),new Float32Array([1,1,0]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,1,0]),new Float32Array([0,1,1]),new Float32Array([1,1,1])],[new Float32Array([0,0,0]),new Float32Array([0,0,1]),new Float32Array([0,1,1]),new Float32Array([1,1,1])]];function P(o,r,a,m){let F=a[0]-r[0],A=a[1]-r[1],e=a[2]-r[2],i=o[0]-r[0],w=o[1]-r[1],y=o[2]-r[2],s=A*y-e*w,c=e*i-F*y,p=F*w-A*i,h=Math.sqrt(s*s+c*c+p*p),X=h*.5,l=s/h,u=c/h,f=p/h,b=-(o[0]*l+o[1]*u+o[2]*f),M=m[0]*l+m[1]*u+m[2]*f;return Math.abs(M+b)*X/3}function Y(o,r,a,m,F,A){let e=(a+m*r+F*r*r)*4;A[0]=o[e+0],A[1]=o[e+1],A[2]=o[e+2]}function W(o,r,a,m,F,A){let e=a*(r-1),i=m*(r-1),w=F*(r-1),y=Math.floor(e),s=Math.floor(i),c=Math.floor(w),p=Math.ceil(e),h=Math.ceil(i),X=Math.ceil(w),l=e-y,u=i-s,f=w-c;if(y===e&&s===i&&c===w)Y(o,r,e,i,w,A);else{let b;l>=u&&u>=f?b=V[0]:l>=f&&f>=u?b=V[1]:f>=l&&l>=u?b=V[2]:u>=l&&l>=f?b=V[3]:u>=f&&f>=l?b=V[4]:b=V[5];let[M,g,d,v]=b,x=C[0];x[0]=l,x[1]=u,x[2]=f;let n=C[1],Z=p-y,U=h-s,L=X-c;n[0]=Z*M[0]+y,n[1]=U*M[1]+s,n[2]=L*M[2]+c,Y(o,r,n[0],n[1],n[2],t[0]),n[0]=Z*g[0]+y,n[1]=U*g[1]+s,n[2]=L*g[2]+c,Y(o,r,n[0],n[1],n[2],t[1]),n[0]=Z*d[0]+y,n[1]=U*d[1]+s,n[2]=L*d[2]+c,Y(o,r,n[0],n[1],n[2],t[2]),n[0]=Z*v[0]+y,n[1]=U*v[1]+s,n[2]=L*v[2]+c,Y(o,r,n[0],n[1],n[2],t[3]);let T=P(g,d,v,x)*6,q=P(M,d,v,x)*6,S=P(M,g,v,x)*6,E=P(M,g,d,x)*6;t[0][0]*=T,t[0][1]*=T,t[0][2]*=T,t[1][0]*=q,t[1][1]*=q,t[1][2]*=q,t[2][0]*=S,t[2][1]*=S,t[2][2]*=S,t[3][0]*=E,t[3][1]*=E,t[3][2]*=E,A[0]=t[0][0]+t[1][0]+t[2][0]+t[3][0],A[1]=t[0][1]+t[1][1]+t[2][1]+t[3][1],A[2]=t[0][2]+t[1][2]+t[2][2]+t[3][2]}}var k=class{static expand(r,a){let m=Math.cbrt(r.length/4),F=new r.constructor(B(a,3)*4),A=r instanceof Uint8Array?255:1,e=new Float32Array(3),i=B(a,2),w=1/(a-1);for(let y=0;y<a;++y)for(let s=0;s<a;++s)for(let c=0;c<a;++c){let p=c*w,h=s*w,X=y*w,l=Math.round(c+s*a+y*i)*4;W(r,m,p,h,X,e),F[l+0]=e[0],F[l+1]=e[1],F[l+2]=e[2],F[l+3]=A}return F}};self.addEventListener("message",o=>{let r=o.data,a=k.expand(r.data,r.size);self.postMessage(a,[a.buffer]),close()});})();
`;var us=new b.Color,X=class u extends b.Data3DTexture{constructor(r,e){super(r,e,e,e),this.type=b.FloatType,this.minFilter=b.LinearFilter,this.unpackAlignment=1,this.needsUpdate=!0,this.userData={domainMin:new b.Vector3(0,0,0),domainMax:new b.Vector3(1,1,1)}}scaleUp(r,e=!0){return I(this,null,function*(){let t=this.image;return r<=t.width?Promise.reject(new Error("The target size must be greater than the current size")):new Promise((s,n)=>{let a=URL.createObjectURL(new Blob([os],{type:"text/javascript"})),o=new Worker(a);o.addEventListener("error",c=>n(c.error)),o.addEventListener("message",c=>{let f=new u(c.data,r);f.colorSpace=this.colorSpace,f.type=this.type,f.name=this.name,f.userData=this.userData,URL.revokeObjectURL(a),s(f)});let l=e&&t.data!==null?[t.data.buffer]:[];o.postMessage({data:t.data,size:r},l)})})}applyLUT(r){let e=this.image,t=r.image,s=Math.min(e.width,e.height,e.depth),n=Math.min(t.width,t.height,t.depth);if(s!==n)throw new Error("Size mismatch");if(r.type!==b.FloatType||this.type!==b.FloatType)throw new Error("Both LUTs must be FloatType textures");if(r.format!==b.RGBAFormat||this.format!==b.RGBAFormat)throw new Error("Both LUTs must be RGBA textures");if(e.data===null||t.data===null)throw new Error("The image data must not be null");let a=e.data,o=t.data,l=s,c=me(l,2),f=l-1;for(let p=0,x=me(l,3);p<x;++p){let m=p*4,g=a[m+0]*f,w=a[m+1]*f,H=a[m+2]*f,L=Math.round(g+w*l+H*c)*4;a[m+0]=o[L+0],a[m+1]=o[L+1],a[m+2]=o[L+2]}return this.needsUpdate=!0,this}convertToUint8(){if(this.type===b.FloatType){let r=this.image,e=r.data,t=new Uint8Array(e.length);for(let s=0,n=e.length;s<n;++s)t[s]=e[s]*255+.5;this.source.data=Object.assign({},r,{data:t}),this.type=b.UnsignedByteType,this.needsUpdate=!0}return this}convertToFloat(){if(this.type===b.UnsignedByteType){let r=this.image,e=r.data,t=new Float32Array(e.length);for(let s=0,n=e.length;s<n;++s)t[s]=e[s]/255;this.source.data=Object.assign({},r,{data:t}),this.type=b.FloatType,this.needsUpdate=!0}return this}convertLinearToSRGB(){let e=this.image.data;if(this.type!==b.FloatType)throw new Error("Color space conversion requires FloatType data");for(let t=0,s=e.length;t<s;t+=4)us.fromArray(e,t).convertLinearToSRGB().toArray(e,t);return this.colorSpace=b.SRGBColorSpace,this.needsUpdate=!0,this}convertSRGBToLinear(){let e=this.image.data;if(this.type!==b.FloatType)throw new Error("Color space conversion requires FloatType data");for(let t=0,s=e.length;t<s;t+=4)us.fromArray(e,t).convertSRGBToLinear().toArray(e,t);return this.colorSpace=b.LinearSRGBColorSpace,this.needsUpdate=!0,this}toDataTexture(){let r=this.image,e=r.width,t=r.height*r.depth,s=new b.DataTexture(r.data,e,t);return s.name=this.name,s.type=this.type,s.format=this.format,s.colorSpace=this.colorSpace,s.minFilter=b.LinearFilter,s.magFilter=b.LinearFilter,s.wrapS=this.wrapS,s.wrapT=this.wrapT,s.generateMipmaps=!1,s.needsUpdate=!0,s.userData=this.userData,s}clone(){return u.from(this)}static from(r){var f;let e=r.image,{width:t,height:s}=e,n=Math.min(t,s),a;if(e instanceof Image){let x=he.from(e).data;if(t>s){a=new Uint8Array(x.length);for(let m=0;m<n;++m)for(let g=0;g<n;++g)for(let w=0;w<n;++w){let H=(w+m*n+g*n*n)*4,L=(w+g*n+m*n*n)*4;a[L+0]=x[H+0],a[L+1]=x[H+1],a[L+2]=x[H+2],a[L+3]=x[H+3]}}else a=new Uint8Array(x.buffer)}else a=e.data.slice();let o=new u(a,n);o.colorSpace=r.colorSpace,o.type=r.type,o.name=r.name;let l=(f=r.userData)!=null?f:{},c=o.userData;return l.domainMin!==void 0&&l.domainMax!==void 0&&(c.domainMin.copy(l.domainMin),c.domainMax.copy(l.domainMax)),o}static createNeutral(r){let e=new Float32Array(me(r,3)*4),t=me(r,2),s=1/(r-1);for(let a=0;a<r;++a)for(let o=0;o<r;++o)for(let l=0;l<r;++l){let c=(a+o*r+l*t)*4;e[c+0]=a*s,e[c+1]=o*s,e[c+2]=l*s,e[c+3]=1}let n=new u(e,r);return n.name="neutral",n}};var ps=v("three/examples/jsm/loaders/LUT3dlLoader.js"),hs=v("three/examples/jsm/loaders/LUTCubeLoader.js"),ms=v("tweakpane"),At=v("spatial-controls");var Cs=Math.PI/180,ws=180/Math.PI;function ls(u,r=16/9){return Math.atan(Math.tan(u*Cs*.5)/r)*ws*2}var fs=v("@tweakpane/plugin-essentials");var Ds=[new Ze,new Qe,new Ye,new Je,new et,new tt,new rt,new st,new nt,new it,new at,new ot,new ut,new lt,new ft,new ct,new dt,new pt,new ht,new mt,new gt,new de,new vt,new bt,new xt,new Et,new St,new Bt,new pe,new yt,new Tt,new Mt,new Rt],Wt=Object.fromEntries(Ds.map(u=>[u.name,u]));function cs(u){u.registerPlugin(fs.EssentialsPlugin);let r=u.addBlade({view:"fpsgraph",rows:2});return r.on("tick",()=>{if(r.fps===null)return;let e=Math.round(r.fps)*1.5;e>r.max&&(r.max=e)}),r}function ds(u,r){let e={blendFunction:r.blendFunction.name};u.addBinding(r,"opacity",{min:0,max:1,step:.001}),u.addBinding(e,"blendFunction",{options:Ft(Object.keys(Wt))}).on("change",t=>r.blendFunction=Wt[t.value])}function Ft(u){return u.reduce((r,e)=>(r[e]=e,r),{})}var jt=["localhost","127.0.0.1","","[::1]"].includes(window.location.hostname);var gs=new Map([["neutral-2",null],["neutral-4",null],["neutral-8",null],["png/bleach-bypass","png/bleach-bypass.png"],["png/candle-light","png/candle-light.png"],["png/cool-contrast","png/cool-contrast.png"],["png/warm-contrast","png/warm-contrast.png"],["png/desaturated-fog","png/desaturated-fog.png"],["png/evening","png/evening.png"],["png/fall","png/fall.png"],["png/filmic1","png/filmic1.png"],["png/filmic2","png/filmic2.png"],["png/matrix-green","png/matrix-green.png"],["png/strong-amber","png/strong-amber.png"],["3dl/sepia","3dl/sepia.3dl"],["3dl/cinematic","3dl/presetpro-cinematic.3dl"],["cube/cinematic","cube/presetpro-cinematic.cube"],["cube/django-25","cube/django-25.cube"]]);function As(){let u=new Map,r=new S.LoadingManager,e=new S.TextureLoader(r),t=new ps.LUT3dlLoader(r),s=new hs.LUTCubeLoader(r),n=X.createNeutral(2);n.name="neutral-2",u.set(n.name,n);let a=X.createNeutral(4);a.name="neutral-4",u.set(a.name,a);let o=X.createNeutral(8);return o.name="neutral-8",u.set(o.name,o),new Promise((l,c)=>{r.onLoad=()=>l(u),r.onError=f=>c(new Error(`Failed to load ${f}`)),e.load(`${document.baseURI}img/textures/photos/GEDC0053.jpg`,f=>{f.colorSpace=S.SRGBColorSpace,u.set("photo",f)});for(let f of gs)f[1]!==null&&(/.3dl$/im.test(f[1])?t.load(`${document.baseURI}img/textures/lut/${f[1]}`,p=>{let x=X.from(p.texture3D);x.name=f[0],u.set(f[0],x)}):/.cube$/im.test(f[1])?s.load(`${document.baseURI}img/textures/lut/${f[1]}`,p=>{let x=X.from(p.texture3D);x.name=f[0],u.set(f[0],x)}):e.load(`${document.baseURI}img/textures/lut/${f[1]}`,p=>{p.name=f[0],p.generateMipmaps=!1,p.minFilter=S.LinearFilter,p.magFilter=S.LinearFilter,p.wrapS=S.ClampToEdgeWrapping,p.wrapT=S.ClampToEdgeWrapping,p.flipY=!1,u.set(f[0],X.from(p))}))})}window.addEventListener("load",()=>{As().then(u=>{let r=new S.WebGLRenderer({powerPreference:"high-performance",antialias:!1,stencil:!1,depth:!1});r.setPixelRatio(window.devicePixelRatio),r.debug.checkShaderErrors=jt,r.setClearAlpha(0);let e=new S.PerspectiveCamera,t=new At.SpatialControls(e.position,e.quaternion,r.domElement),s=t.settings;s.general.mode=At.ControlMode.THIRD_PERSON,s.zoom.sensitivity=.05,s.zoom.damping=.1,s.rotation.sensitivity=0,s.translation.enabled=!1,t.position.set(0,0,1.4);let n=new S.Scene,a=new S.Mesh(new S.PlaneGeometry,new S.MeshBasicMaterial({map:u.get("photo")}));a.scale.x=2,n.add(a);let o=document.getElementById("viewport"),l=document.createElement("img");l.title="This is a compressed preview image",l.classList.add("lut","hidden"),o.append(l);let c=u.get("png/filmic1"),f=new Ct({lut:c});f.blendMode.blendFunction=new de;let p=new $e(r);p.add(new Z,new Q(n,e,{alpha:!0}),new Dt(f));let x=new ms.Pane({container:o.querySelector(".tp")}),m=cs(x),g={lut:f.lut.name,"3D texture":!0,"base size":f.lut.image.width,"scale up":!1,"target size":48},w=null;function H(){let C=f.lut.clone().convertToUint8().toDataTexture().image;he.from(C).toCanvas().toBlob(N=>{N!==null&&(w=URL.createObjectURL(N),l.src=w,l.classList.remove("hidden"))})}H();function L(){let C=u.get(g.lut),N=Math.min(C.image.width,C.image.height),Xt=g["scale up"]&&g["target size"]>N,Pt;Xt?(console.time("Tetrahedral Upscaling"),Pt=C.scaleUp(g["target size"],!1),document.body.classList.add("progress")):Pt=Promise.resolve(C.clone()),Pt.then(ye=>{Xt&&(console.timeEnd("Tetrahedral Upscaling"),document.body.classList.remove("progress")),f.lut.dispose(),g["base size"]=N,r.getContext().getExtension("OES_texture_float_linear")===null&&(console.log("Linear float filtering not supported, converting to Uint8"),ye.convertToUint8()),f.lut=ye,H()}).catch(ye=>console.error(ye))}let se=x.addFolder({title:"Settings"});se.addBinding(g,"lut",{options:Ft([...gs.keys()])}).on("change",L),se.addBinding(f,"tetrahedralInterpolation"),se.addBinding(g,"base size",{readonly:!0,format:C=>C.toFixed(0)}),se.addBinding(g,"scale up").on("change",L),se.addBinding(g,"target size",{options:Ft([32,48,64,128])}).on("change",L),ds(se,f.blendMode);function $t(){let C=o.clientWidth,N=o.clientHeight;e.aspect=C/N,e.fov=ls(90,Math.max(e.aspect,16/9)),e.updateProjectionMatrix(),p.setSize(C,N)}window.addEventListener("resize",$t),$t();function vs(C){m.begin(),t.update(C),p.render(C),m.end()}p.compile().then(()=>{let C=new IntersectionObserver(N=>r.setAnimationLoop(N[0].isIntersecting?vs:null),{threshold:.75});o.prepend(r.domElement),C.observe(o)}).catch(C=>console.error(C))})});})();
